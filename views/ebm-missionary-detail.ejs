<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | EBM Missionary Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .detail-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .detail-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .profile-header {
            display: flex;
            align-items: start;
            gap: 30px;
            margin-bottom: 30px;
        }
        .profile-photo {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            object-fit: cover;
            border: 5px solid #f8f9fa;
        }
        .profile-photo-placeholder {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
            border: 5px solid #f8f9fa;
        }
        .info-section {
            margin-bottom: 30px;
        }
        .info-section h4 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .info-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .info-row:hover {
            background: #f8f9fa;
        }
        .info-label {
            font-weight: 600;
            color: #666;
        }
        .info-value {
            color: #333;
        }
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }
        .status-complete { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-minimal { background: #f8d7da; color: #721c24; }
        .back-button {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .empty-value {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="detail-container">
        <div class="back-button">
            <a href="/ebm/missionaries" class="btn btn-outline-light">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
            <a href="/ebm/dashboard" class="btn btn-outline-light">
                <i class="bi bi-house"></i> Dashboard
            </a>
            <% if (user) { %>
                <span class="btn btn-outline-light ms-auto" style="pointer-events: none;">
                    <i class="bi bi-person"></i> <%= user.username %>
                </span>
            <% } %>
        </div>

        <div class="detail-card">
            <div class="profile-header">
                <% if (missionary.missionPhoto && missionary.missionPhoto.url && missionary.missionPhoto.url !== 'N') { %>
                    <img src="<%= missionary.missionPhoto.url %>" alt="<%= missionary.displayName %>" class="profile-photo">
                <% } else if (missionary.currentPhoto && missionary.currentPhoto.url) { %>
                    <img src="<%= missionary.currentPhoto.url %>" alt="<%= missionary.displayName %>" class="profile-photo">
                <% } else { %>
                    <div class="profile-photo-placeholder">
                        <%= missionary.firstName.charAt(0) %><%= missionary.lastName.charAt(0) %>
                    </div>
                <% } %>
                
                <div class="flex-grow-1">
                    <h1><%= missionary.displayName %></h1>
                    <h4 class="text-muted"><%= missionary.missionTitle || 'Missionary' %></h4>
                    <p class="text-muted mb-2">
                        <i class="bi bi-calendar"></i>
                        <% if (missionary.serviceStartDate && missionary.serviceEndDate) { %>
                            <%= new Date(missionary.serviceStartDate).toLocaleDateString() %> - 
                            <%= new Date(missionary.serviceEndDate).toLocaleDateString() %>
                        <% } else { %>
                            Service dates not available
                        <% } %>
                    </p>
                    <span class="status-badge status-<%= missionary.dataStatus %>">
                        <%= missionary.dataStatus.toUpperCase() %>
                    </span>
                    <% if (missionary.needsVerification) { %>
                        <span class="badge bg-warning ms-2">Needs Verification</span>
                    <% } %>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="editMissionary()">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <% if (missionary.needsVerification) { %>
                <button class="btn btn-success" onclick="verifyMissionary()">
                    <i class="bi bi-check-circle"></i> Mark as Verified
                </button>
                <% } %>
                <button class="btn btn-danger" onclick="deleteMissionary()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-envelope"></i> Contact Information</h4>
                <div class="info-row">
                    <div class="info-label">Email:</div>
                    <div class="info-value">
                        <% if (missionary.email) { %>
                            <a href="mailto:<%= missionary.email %>"><%= missionary.email %></a>
                            <% if (missionary.badEmail) { %>
                                <span class="badge bg-danger ms-2">Invalid Email</span>
                            <% } %>
                        <% } else { %>
                            <span class="empty-value">Not provided</span>
                        <% } %>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Phone:</div>
                    <div class="info-value">
                        <%= missionary.phone || '<span class="empty-value">Not provided</span>' %>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Homepage:</div>
                    <div class="info-value">
                        <% if (missionary.homepage) { %>
                            <a href="<%= missionary.homepage %>" target="_blank"><%= missionary.homepage %></a>
                        <% } else { %>
                            <span class="empty-value">Not provided</span>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Address -->
        <% if (missionary.currentAddress && (missionary.currentAddress.address1 || missionary.currentAddress.city)) { %>
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-geo-alt"></i> Current Address</h4>
                <div class="info-row">
                    <div class="info-label">Address:</div>
                    <div class="info-value">
                        <% if (missionary.currentAddress.address1) { %>
                            <%= missionary.currentAddress.address1 %><br>
                            <% if (missionary.currentAddress.address2) { %>
                                <%= missionary.currentAddress.address2 %><br>
                            <% } %>
                            <%= missionary.currentAddress.city %><% if (missionary.currentAddress.state) { %>, <%= missionary.currentAddress.state %><% } %>
                            <%= missionary.currentAddress.zip || '' %><br>
                            <%= missionary.currentAddress.country || 'USA' %>
                        <% } else { %>
                            <span class="empty-value">Not provided</span>
                        <% } %>
                    </div>
                </div>
                <% if (missionary.currentAddress.phone) { %>
                <div class="info-row">
                    <div class="info-label">Phone:</div>
                    <div class="info-value"><%= missionary.currentAddress.phone %></div>
                </div>
                <% } %>
            </div>
        </div>
        <% } %>

        <!-- Permanent Address -->
        <% if (missionary.permanentAddress && (missionary.permanentAddress.address1 || missionary.permanentAddress.city)) { %>
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-house"></i> Permanent Address</h4>
                <div class="info-row">
                    <div class="info-label">Address:</div>
                    <div class="info-value">
                        <% if (missionary.permanentAddress.address1) { %>
                            <%= missionary.permanentAddress.address1 %><br>
                            <% if (missionary.permanentAddress.address2) { %>
                                <%= missionary.permanentAddress.address2 %><br>
                            <% } %>
                            <%= missionary.permanentAddress.city %><% if (missionary.permanentAddress.state) { %>, <%= missionary.permanentAddress.state %><% } %>
                            <%= missionary.permanentAddress.zip || '' %><br>
                            <%= missionary.permanentAddress.country || '' %>
                        <% } else { %>
                            <span class="empty-value">Not provided</span>
                        <% } %>
                    </div>
                </div>
                <% if (missionary.permanentAddress.phone) { %>
                <div class="info-row">
                    <div class="info-label">Phone:</div>
                    <div class="info-value"><%= missionary.permanentAddress.phone %></div>
                </div>
                <% } %>
            </div>
        </div>
        <% } %>

        <!-- Family Information -->
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-people"></i> Family Information</h4>
                <div class="info-row">
                    <div class="info-label">Spouse:</div>
                    <div class="info-value">
                        <%= (missionary.spouse && missionary.spouse.name) || '<span class="empty-value">Not provided</span>' %>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Children:</div>
                    <div class="info-value">
                        <% if (missionary.children && missionary.children.length > 0) { %>
                            <ul class="mb-0">
                                <% missionary.children.forEach(child => { %>
                                    <li><%= child.name %></li>
                                <% }); %>
                            </ul>
                        <% } else { %>
                            <span class="empty-value">Not provided</span>
                        <% } %>
                    </div>
                </div>
                <% if (missionary.maidenName) { %>
                <div class="info-row">
                    <div class="info-label">Maiden Name:</div>
                    <div class="info-value"><%= missionary.maidenName %></div>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Work Information -->
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-briefcase"></i> Work & Education</h4>
                <div class="info-row">
                    <div class="info-label">Occupation:</div>
                    <div class="info-value">
                        <%= missionary.occupation || '<span class="empty-value">Not provided</span>' %>
                    </div>
                </div>
                <% if (missionary.work) { %>
                <div class="info-row">
                    <div class="info-label">Work:</div>
                    <div class="info-value">
                        <%= missionary.work %>
                        <% if (missionary.workUrl) { %>
                            <br><a href="<%= missionary.workUrl %>" target="_blank"><%= missionary.workUrl %></a>
                        <% } %>
                    </div>
                </div>
                <% } %>
                <% if (missionary.education) { %>
                <div class="info-row">
                    <div class="info-label">Education:</div>
                    <div class="info-value"><%= missionary.education %></div>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Areas Served -->
        <% if (missionary.areasServed && missionary.areasServed.length > 0) { %>
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-geo-alt"></i> Areas Served</h4>
                <div class="info-row">
                    <div class="info-value">
                        <div class="d-flex flex-wrap gap-2">
                            <% missionary.areasServed.forEach(area => { %>
                                <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <%= area.name || 'Unknown Area' %>
                                </span>
                            <% }); %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Companionships -->
        <% if (companions && companions.length > 0) { %>
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-people-fill"></i> Companions</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Companion</th>
                                <th>Area</th>
                                <th>Period</th>
                                <th>Duration</th>
                                <th>Role</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% companions.forEach(comp => { %>
                                <tr>
                                    <td>
                                        <strong><%= comp.companion.displayName || `${comp.companion.firstName} ${comp.companion.lastName}` %></strong>
                                    </td>
                                    <td>
                                        <% if (comp.companionship.area && comp.companionship.area.name) { %>
                                            <%= comp.companionship.area.name %>
                                        <% } else { %>
                                            <span class="text-muted fst-italic">Area not recorded</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (comp.companionship.startDate) { %>
                                            <%= new Date(comp.companionship.startDate).toLocaleDateString() %>
                                            <% if (comp.companionship.endDate) { %>
                                                - <%= new Date(comp.companionship.endDate).toLocaleDateString() %>
                                            <% } else { %>
                                                - Present
                                            <% } %>
                                        <% } else { %>
                                            <span class="text-muted">Date unknown</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (comp.companionship.duration) { %>
                                            <%= comp.companionship.duration %> weeks
                                        <% } else { %>
                                            <span class="text-muted">-</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (comp.role) { %>
                                            <span class="badge bg-info"><%= comp.role %></span>
                                        <% } %>
                                        <% if (comp.companionship.isDistrictLeadership) { %>
                                            <span class="badge bg-warning">District Leader</span>
                                        <% } %>
                                        <% if (comp.companionship.isZoneLeadership) { %>
                                            <span class="badge bg-danger">Zone Leader</span>
                                        <% } %>
                                        <% if (comp.companionship.isTraining) { %>
                                            <span class="badge bg-success">Training</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Notes & Additional Info -->
        <% if (missionary.notes || missionary.other) { %>
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-journal-text"></i> Notes & Additional Information</h4>
                <% if (missionary.notes) { %>
                <div class="info-row">
                    <div class="info-label">Notes:</div>
                    <div class="info-value" style="white-space: pre-wrap;"><%= missionary.notes %></div>
                </div>
                <% } %>
                <% if (missionary.other) { %>
                <div class="info-row">
                    <div class="info-label">Other Info:</div>
                    <div class="info-value" style="white-space: pre-wrap;"><%= missionary.other %></div>
                </div>
                <% } %>
            </div>
        </div>
        <% } %>

        <!-- Legacy Data -->
        <% if (missionary.legacyData && (missionary.legacyData.alumId || missionary.legacyData.userId)) { %>
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-database"></i> Legacy Database Information</h4>
                <% if (missionary.legacyData.alumId) { %>
                <div class="info-row">
                    <div class="info-label">Alumni ID:</div>
                    <div class="info-value"><%= missionary.legacyData.alumId %></div>
                </div>
                <% } %>
                <% if (missionary.legacyData.personId) { %>
                <div class="info-row">
                    <div class="info-label">Person ID:</div>
                    <div class="info-value"><%= missionary.legacyData.personId %></div>
                </div>
                <% } %>
                <% if (missionary.legacyData.userId) { %>
                <div class="info-row">
                    <div class="info-label">User ID:</div>
                    <div class="info-value"><%= missionary.legacyData.userId %></div>
                </div>
                <% } %>
                <% if (missionary.legacyData.lastNow) { %>
                <div class="info-row">
                    <div class="info-label">Previous Name:</div>
                    <div class="info-value"><%= missionary.legacyData.lastNow %></div>
                </div>
                <% } %>
                <% if (missionary.legacyData.addDate) { %>
                <div class="info-row">
                    <div class="info-label">Added to DB:</div>
                    <div class="info-value"><%= new Date(missionary.legacyData.addDate).toLocaleDateString() %></div>
                </div>
                <% } %>
                <% if (missionary.legacyData.lastUpdate) { %>
                <div class="info-row">
                    <div class="info-label">Last Updated:</div>
                    <div class="info-value"><%= new Date(missionary.legacyData.lastUpdate).toLocaleDateString() %></div>
                </div>
                <% } %>
                <% if (missionary.legacyData.lang1Counter !== null && missionary.legacyData.lang1Counter !== undefined) { %>
                <div class="info-row">
                    <div class="info-label">Language Counters:</div>
                    <div class="info-value">
                        Lang 1: <%= missionary.legacyData.lang1Counter %> | 
                        Lang 2: <%= missionary.legacyData.lang2Counter || 0 %>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
        <% } %>

        <!-- Metadata -->
        <div class="detail-card">
            <div class="info-section">
                <h4><i class="bi bi-info-circle"></i> System Information</h4>
                <div class="info-row">
                    <div class="info-label">Mission:</div>
                    <div class="info-value">
                        <%= missionary.missionName %>
                        <% if (missionary.missionId) { %>
                            (ID: <%= missionary.missionId %>)
                        <% } %>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Data Status:</div>
                    <div class="info-value">
                        <span class="status-badge status-<%= missionary.dataStatus %>">
                            <%= missionary.dataStatus.toUpperCase() %>
                        </span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">Added By:</div>
                    <div class="info-value">
                        <% if (missionary.addedBy) { %>
                            <%= missionary.addedBy.username || missionary.addedBy.firstName || 'Unknown' %>
                        <% } else { %>
                            System Import
                        <% } %>
                    </div>
                </div>
                <% if (missionary.verifiedBy) { %>
                <div class="info-row">
                    <div class="info-label">Verified By:</div>
                    <div class="info-value">
                        <%= missionary.verifiedBy.username || missionary.verifiedBy.firstName || 'Unknown' %>
                        on <%= new Date(missionary.verifiedDate).toLocaleDateString() %>
                    </div>
                </div>
                <% } %>
                <div class="info-row">
                    <div class="info-label">Created:</div>
                    <div class="info-value"><%= new Date(missionary.createdAt).toLocaleString() %></div>
                </div>
                <div class="info-row">
                    <div class="info-label">Last Modified:</div>
                    <div class="info-value"><%= new Date(missionary.updatedAt).toLocaleString() %></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function editMissionary() {
            // TODO: Implement edit modal or redirect to edit page
            alert('Edit functionality coming soon!');
        }

        async function verifyMissionary() {
            if (!confirm('Mark this missionary record as verified?')) return;
            
            try {
                const response = await fetch('/ebm/missionaries/<%= missionary._id %>/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('Missionary verified successfully!');
                    window.location.reload();
                } else {
                    alert('Failed to verify missionary');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }

        async function deleteMissionary() {
            if (!confirm('Are you sure you want to delete this missionary record? This action cannot be undone.')) return;
            
            try {
                const response = await fetch('/ebm/missionaries/<%= missionary._id %>', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Missionary deleted successfully');
                    window.location.href = '/ebm/missionaries';
                } else {
                    alert('Failed to delete missionary');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
