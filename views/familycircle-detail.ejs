<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= circle.name %> - Family Circle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <%- include('partials/user-dropdown-styles') %>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h2 {
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .main-container {
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .page-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .page-header h1 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .back-btn {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 15px;
            display: inline-block;
        }
        .back-btn:hover {
            color: #764ba2;
        }
        .section-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .section-title {
            color: #667eea;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .member-item:last-child {
            border-bottom: none;
        }
        .member-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .member-details h5 {
            margin: 0;
            color: #333;
            font-weight: 600;
        }
        .member-meta {
            color: #999;
            font-size: 0.9rem;
        }
        .role-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .role-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .role-member {
            background: #e9ecef;
            color: #666;
        }
        .btn-custom {
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-invite {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .btn-invite:hover {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
            transform: scale(1.05);
        }
        .btn-danger-custom {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        .btn-danger-custom:hover {
            background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
            transform: scale(1.05);
        }
        .invitation-item {
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .invitation-email {
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .invitation-meta {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .invite-code {
            background: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #764ba2;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-accepted {
            background: #d4edda;
            color: #155724;
        }
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        .modal-content {
            border-radius: 15px;
        }
        .form-label {
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .form-control {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h2><i class="fas fa-users"></i> <%= circle.name %></h2>
        </div>
        <div class="header-actions">
            <a href="/greatestjoy/familycircles" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Back to Circles
            </a>
            <a href="/greatestjoy/dashboard" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-heart me-1"></i>Gallery
            </a>
            
            <!-- User Dropdown -->
            <% if (typeof user !== 'undefined' && user) { %>
                <div class="user-profile-section">
                    <%- include('partials/user-dropdown', { user: user }) %>
                </div>
            <% } %>
        </div>
    </div>

    <div class="main-container">

        <div class="page-header">
            <h1><i class="fas fa-users"></i> <%= circle.name %></h1>
            <% if (circle.description) { %>
                <p><%= circle.description %></p>
            <% } %>
            <div class="mt-3">
                <span class="role-badge role-<%= userRole %>">
                    <i class="fas fa-<%= userRole === 'admin' ? 'crown' : 'user' %>"></i>
                    You are <%= userRole === 'admin' ? 'an Admin' : 'a Member' %>
                </span>
            </div>
        </div>

        <!-- Members Section -->
        <div class="section-card">
            <div class="section-title">
                <span><i class="fas fa-users"></i> Members (<%= circle.members.length %>)</span>
            </div>
            <% circle.members.forEach(member => { %>
                <div class="member-item">
                    <div class="member-info">
                        <div class="member-avatar">
                            <%= member.user.firstName.charAt(0) %><%= member.user.lastName.charAt(0) %>
                        </div>
                        <div class="member-details">
                            <h5><%= member.user.firstName %> <%= member.user.lastName %></h5>
                            <div class="member-meta">
                                <i class="fas fa-envelope"></i> <%= member.user.email %>
                                <span class="mx-2">•</span>
                                <i class="fas fa-calendar"></i> Joined <%= new Date(member.joinedDate).toLocaleDateString() %>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="role-badge role-<%= member.role %>">
                            <%= member.role %>
                        </span>
                        <% if (userRole === 'admin' && member.role !== 'admin') { %>
                            <button class="btn btn-danger-custom btn-sm btn-custom" 
                                    onclick="removeMember('<%= member.user._id %>', '<%= member.user.firstName %> <%= member.user.lastName %>')">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        <% } %>
                    </div>
                </div>
            <% }); %>
        </div>

        <!-- Family Member Profiles Section -->
        <div class="section-card">
            <div class="section-title">
                <span><i class="fas fa-user-friends"></i> Family Member Profiles (<%= circle.familyMembers ? circle.familyMembers.length : 0 %>)</span>
                <button class="btn btn-primary btn-custom" data-bs-toggle="modal" data-bs-target="#addFamilyMemberModal">
                    <i class="fas fa-plus"></i> Add Family Member
                </button>
            </div>
            
            <% if (circle.familyMembers && circle.familyMembers.length > 0) { %>
                <% circle.familyMembers.forEach(familyMember => { %>
                    <div class="member-item">
                        <div class="member-info">
                            <div class="member-avatar">
                                <%= familyMember.name.split(' ').map(n => n.charAt(0).toUpperCase()).join('').substring(0, 2) %>
                            </div>
                            <div class="member-details">
                                <h5><%= familyMember.name %></h5>
                                <div class="member-meta">
                                    <i class="fas fa-heart"></i> <%= familyMember.relationship.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') %>
                                    <% if (familyMember.gender && familyMember.gender !== 'prefer-not-to-say') { %>
                                        <span class="mx-2">•</span>
                                        <i class="fas fa-<%= familyMember.gender === 'male' ? 'mars' : familyMember.gender === 'female' ? 'venus' : 'genderless' %>"></i> 
                                        <%= familyMember.gender.charAt(0).toUpperCase() + familyMember.gender.slice(1) %>
                                    <% } %>
                                    <% if (familyMember.birthDate) { %>
                                        <span class="mx-2">•</span>
                                        <i class="fas fa-birthday-cake"></i> <%= new Date(familyMember.birthDate).toLocaleDateString() %>
                                    <% } %>
                                </div>
                                <% if (familyMember.notes) { %>
                                    <div class="member-meta mt-1">
                                        <i class="fas fa-sticky-note"></i> <%= familyMember.notes %>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm btn-custom" 
                                    onclick="editFamilyMember('<%= familyMember._id %>', '<%= familyMember.name %>', '<%= familyMember.relationship %>', '<%= familyMember.gender %>', '<%= familyMember.birthDate ? new Date(familyMember.birthDate).toISOString().split('T')[0] : '' %>', '<%= familyMember.notes || '' %>')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger-custom btn-sm btn-custom" 
                                    onclick="removeFamilyMember('<%= familyMember._id %>', '<%= familyMember.name %>')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <p class="text-muted text-center py-4">
                    <i class="fas fa-user-friends"></i> No family member profiles yet. Add your first family member!
                </p>
            <% } %>
        </div>

        <!-- Invitations Section (Admin only) -->
        <% if (userRole === 'admin') { %>
            <div class="section-card">
                <div class="section-title">
                    <span><i class="fas fa-envelope"></i> Invitations</span>
                    <button class="btn btn-invite btn-custom" data-bs-toggle="modal" data-bs-target="#inviteModal">
                        <i class="fas fa-user-plus"></i> Invite Member
                    </button>
                </div>

                <% if (circle.invitations && circle.invitations.length > 0) { %>
                    <% circle.invitations.forEach(invitation => { %>
                        <div class="invitation-item">
                            <div class="invitation-email">
                                <i class="fas fa-envelope"></i> <%= invitation.email %>
                            </div>
                            <div class="invitation-meta">
                                Sent <%= new Date(invitation.sentDate).toLocaleDateString() %>
                                <% if (invitation.expiresAt) { %>
                                    • Expires <%= new Date(invitation.expiresAt).toLocaleDateString() %>
                                <% } %>
                            </div>
                            <div class="invite-code">
                                <span>
                                    <%= request.protocol %>://<%= request.get('host') %>/greatestjoy/familycircles/join/<%= invitation.inviteCode %>
                                </span>
                                <button class="copy-btn" onclick="copyInviteLink('<%= request.protocol %>://<%= request.get('host') %>/greatestjoy/familycircles/join/<%= invitation.inviteCode %>')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <span class="status-badge status-<%= invitation.status %>">
                                <%= invitation.status %>
                            </span>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="text-muted text-center py-4">
                        <i class="fas fa-inbox"></i> No pending invitations
                    </p>
                <% } %>
            </div>
        <% } %>
    </div>

    <!-- Add Family Member Modal -->
    <div class="modal fade" id="addFamilyMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add Family Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/greatestjoy/familycircles/<%= circle._id %>/family-members" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   placeholder="e.g., Emma Johnson">
                        </div>
                        <div class="mb-3">
                            <label for="relationship" class="form-label">Relationship *</label>
                            <select class="form-select" id="relationship" name="relationship" required>
                                <option value="">Select relationship...</option>
                                <option value="grandchild">Grandchild</option>
                                <option value="great-grandchild">Great-Grandchild</option>
                                <option value="child">Child</option>
                                <option value="grandparent">Grandparent</option>
                                <option value="great-grandparent">Great-Grandparent</option>
                                <option value="parent">Parent</option>
                                <option value="sibling">Sibling</option>
                                <option value="spouse">Spouse</option>
                                <option value="aunt">Aunt</option>
                                <option value="uncle">Uncle</option>
                                <option value="cousin">Cousin</option>
                                <option value="niece">Niece</option>
                                <option value="nephew">Nephew</option>
                                <option value="in-law">In-Law</option>
                                <option value="step-relative">Step-Relative</option>
                                <option value="friend">Friend</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="prefer-not-to-say">Prefer not to say</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="birthDate" class="form-label">Birth Date</label>
                            <input type="date" class="form-control" id="birthDate" name="birthDate">
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" 
                                      placeholder="Additional information about this family member..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-custom">
                            <i class="fas fa-save"></i> Add Family Member
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Family Member Modal -->
    <div class="modal fade" id="editFamilyMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Family Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editFamilyMemberForm" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="edit_name" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="edit_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_relationship" class="form-label">Relationship *</label>
                            <select class="form-select" id="edit_relationship" name="relationship" required>
                                <option value="">Select relationship...</option>
                                <option value="grandchild">Grandchild</option>
                                <option value="great-grandchild">Great-Grandchild</option>
                                <option value="child">Child</option>
                                <option value="grandparent">Grandparent</option>
                                <option value="great-grandparent">Great-Grandparent</option>
                                <option value="parent">Parent</option>
                                <option value="sibling">Sibling</option>
                                <option value="spouse">Spouse</option>
                                <option value="aunt">Aunt</option>
                                <option value="uncle">Uncle</option>
                                <option value="cousin">Cousin</option>
                                <option value="niece">Niece</option>
                                <option value="nephew">Nephew</option>
                                <option value="in-law">In-Law</option>
                                <option value="step-relative">Step-Relative</option>
                                <option value="friend">Friend</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_gender" class="form-label">Gender</label>
                            <select class="form-select" id="edit_gender" name="gender">
                                <option value="prefer-not-to-say">Prefer not to say</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_birthDate" class="form-label">Birth Date</label>
                            <input type="date" class="form-control" id="edit_birthDate" name="birthDate">
                        </div>
                        <div class="mb-3">
                            <label for="edit_notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="edit_notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-custom">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div class="modal fade" id="inviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Invite Family Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/greatestjoy/familycircles/<%= circle._id %>/invite" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="email" name="email" required 
                                   placeholder="family@example.com">
                            <small class="text-muted">An invitation link will be sent to this email</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-invite btn-custom">
                            <i class="fas fa-paper-plane"></i> Send Invitation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyInviteLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('Invite link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function removeMember(userId, userName) {
            if (confirm(`Are you sure you want to remove ${userName} from this circle?`)) {
                fetch(`/greatestjoy/familycircles/<%= circle._id %>/members/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to remove member');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('An error occurred');
                });
            }
        }

        function editFamilyMember(id, name, relationship, gender, birthDate, notes) {
            document.getElementById('edit_name').value = name;
            document.getElementById('edit_relationship').value = relationship;
            document.getElementById('edit_gender').value = gender;
            document.getElementById('edit_birthDate').value = birthDate;
            document.getElementById('edit_notes').value = notes;
            
            document.getElementById('editFamilyMemberForm').action = 
                `/greatestjoy/familycircles/<%= circle._id %>/family-members/${id}`;
            
            const modal = new bootstrap.Modal(document.getElementById('editFamilyMemberModal'));
            modal.show();
        }

        function removeFamilyMember(memberId, memberName) {
            if (confirm(`Are you sure you want to remove ${memberName} from the family member profiles?`)) {
                fetch(`/greatestjoy/familycircles/<%= circle._id %>/family-members/${memberId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to remove family member');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('An error occurred');
                });
            }
        }
    </script>
</body>
</html>
