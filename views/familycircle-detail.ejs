<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= circle.name %> - Family Circle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <%- include('partials/user-dropdown-styles') %>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .page-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .page-header h1 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .back-btn {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 15px;
            display: inline-block;
        }
        .back-btn:hover {
            color: #764ba2;
        }
        .section-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .section-title {
            color: #667eea;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .member-item:last-child {
            border-bottom: none;
        }
        .member-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .member-details h5 {
            margin: 0;
            color: #333;
            font-weight: 600;
        }
        .member-meta {
            color: #999;
            font-size: 0.9rem;
        }
        .role-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .role-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .role-member {
            background: #e9ecef;
            color: #666;
        }
        .btn-custom {
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-invite {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .btn-invite:hover {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
            transform: scale(1.05);
        }
        .btn-danger-custom {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        .btn-danger-custom:hover {
            background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
            transform: scale(1.05);
        }
        .invitation-item {
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .invitation-email {
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .invitation-meta {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .invite-code {
            background: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #764ba2;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-accepted {
            background: #d4edda;
            color: #155724;
        }
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        .modal-content {
            border-radius: 15px;
        }
        .form-label {
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .form-control {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
    </style>
</head>
<body>
    <%- include('partials/user-dropdown') %>

    <div class="main-container">
        <a href="/greatestjoy/familycircles" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Circles
        </a>

        <div class="page-header">
            <h1><i class="fas fa-users"></i> <%= circle.name %></h1>
            <% if (circle.description) { %>
                <p><%= circle.description %></p>
            <% } %>
            <div class="mt-3">
                <span class="role-badge role-<%= userRole %>">
                    <i class="fas fa-<%= userRole === 'admin' ? 'crown' : 'user' %>"></i>
                    You are <%= userRole === 'admin' ? 'an Admin' : 'a Member' %>
                </span>
            </div>
        </div>

        <!-- Members Section -->
        <div class="section-card">
            <div class="section-title">
                <span><i class="fas fa-users"></i> Members (<%= circle.members.length %>)</span>
            </div>
            <% circle.members.forEach(member => { %>
                <div class="member-item">
                    <div class="member-info">
                        <div class="member-avatar">
                            <%= member.user.firstName.charAt(0) %><%= member.user.lastName.charAt(0) %>
                        </div>
                        <div class="member-details">
                            <h5><%= member.user.firstName %> <%= member.user.lastName %></h5>
                            <div class="member-meta">
                                <i class="fas fa-envelope"></i> <%= member.user.email %>
                                <span class="mx-2">•</span>
                                <i class="fas fa-calendar"></i> Joined <%= new Date(member.joinedDate).toLocaleDateString() %>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="role-badge role-<%= member.role %>">
                            <%= member.role %>
                        </span>
                        <% if (userRole === 'admin' && member.role !== 'admin') { %>
                            <button class="btn btn-danger-custom btn-sm btn-custom" 
                                    onclick="removeMember('<%= member.user._id %>', '<%= member.user.firstName %> <%= member.user.lastName %>')">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        <% } %>
                    </div>
                </div>
            <% }); %>
        </div>

        <!-- Invitations Section (Admin only) -->
        <% if (userRole === 'admin') { %>
            <div class="section-card">
                <div class="section-title">
                    <span><i class="fas fa-envelope"></i> Invitations</span>
                    <button class="btn btn-invite btn-custom" data-bs-toggle="modal" data-bs-target="#inviteModal">
                        <i class="fas fa-user-plus"></i> Invite Member
                    </button>
                </div>

                <% if (circle.invitations && circle.invitations.length > 0) { %>
                    <% circle.invitations.forEach(invitation => { %>
                        <div class="invitation-item">
                            <div class="invitation-email">
                                <i class="fas fa-envelope"></i> <%= invitation.email %>
                            </div>
                            <div class="invitation-meta">
                                Sent <%= new Date(invitation.sentDate).toLocaleDateString() %>
                                <% if (invitation.expiresAt) { %>
                                    • Expires <%= new Date(invitation.expiresAt).toLocaleDateString() %>
                                <% } %>
                            </div>
                            <div class="invite-code">
                                <span>
                                    <%= request.protocol %>://<%= request.get('host') %>/greatestjoy/familycircles/join/<%= invitation.inviteCode %>
                                </span>
                                <button class="copy-btn" onclick="copyInviteLink('<%= request.protocol %>://<%= request.get('host') %>/greatestjoy/familycircles/join/<%= invitation.inviteCode %>')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <span class="status-badge status-<%= invitation.status %>">
                                <%= invitation.status %>
                            </span>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="text-muted text-center py-4">
                        <i class="fas fa-inbox"></i> No pending invitations
                    </p>
                <% } %>
            </div>
        <% } %>
    </div>

    <!-- Invite Modal -->
    <div class="modal fade" id="inviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Invite Family Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/greatestjoy/familycircles/<%= circle._id %>/invite" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="email" name="email" required 
                                   placeholder="family@example.com">
                            <small class="text-muted">An invitation link will be sent to this email</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-invite btn-custom">
                            <i class="fas fa-paper-plane"></i> Send Invitation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyInviteLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('Invite link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function removeMember(userId, userName) {
            if (confirm(`Are you sure you want to remove ${userName} from this circle?`)) {
                fetch(`/greatestjoy/familycircles/<%= circle._id %>/members/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to remove member');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('An error occurred');
                });
            }
        }
    </script>
</body>
</html>
