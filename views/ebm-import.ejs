<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - EBM Alumni</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 2rem 0;
        }

        .import-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #667eea;
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .import-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px dashed #667eea;
            transition: all 0.3s;
        }

        .import-card:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-zone {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .instruction-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 5px;
        }

        .sample-table {
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .progress-section {
            display: none;
            margin-top: 2rem;
        }

        .result-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 5px;
            display: none;
        }

        .error-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 5px;
            display: none;
        }

        .tab-button {
            background: #e9ecef;
            border: none;
            padding: 1rem 2rem;
            margin-right: 0.5rem;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        textarea {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="import-container">
            <!-- Header -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-file-import me-2"></i>Import Mission Data
                        </h1>
                        <p class="text-muted mb-0">Import missionaries, areas, and companionships from CSV, Excel, or JSON</p>
                    </div>
                    <div>
                        <a href="/ebm/dashboard" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Import Tabs -->
            <div class="mb-3">
                <button class="tab-button active" onclick="showTab('csv')">CSV/Excel Import</button>
                <button class="tab-button" onclick="showTab('json')">JSON Import</button>
                <button class="tab-button" onclick="showTab('manual')">Manual Entry</button>
            </div>

            <!-- CSV/Excel Import Tab -->
            <div id="csv-tab" class="tab-content active">
                <!-- Import Type Selector -->
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="fas fa-list me-2"></i>Select Import Type:</label>
                    <select id="importType" class="form-select form-select-lg" onchange="updateInstructions()">
                        <option value="missionaries">Missionaries (Alumni Data)</option>
                        <option value="areas">Mission Areas</option>
                        <option value="missionary-areas">Missionary-Area Relationships</option>
                        <option value="areabook">Area Book (Companion/Area Notes)</option>
                        <option value="companionships">Companionships</option>
                    </select>
                </div>

                <!-- Dynamic Instructions -->
                <div class="instruction-box" id="missionariesInstructions">
                    <h5><i class="fas fa-info-circle me-2"></i>Missionaries CSV Format</h5>
                    <p class="mb-2">Your CSV should include these columns from the SQL alumni table:</p>
                    <ul class="mb-0">
                        <li><strong>Required:</strong> firstname, lastname</li>
                        <li><strong>Recommended:</strong> alum_id, start_date, end_date, email, cur_city, cur_state</li>
                        <li><strong>Optional:</strong> spouse, children, cur_add1, cur_add2, pmt_add1, occupation, homepage, areabook (or area_book, area_companions), etc.</li>
                        <li><strong>Note:</strong> The areabook field stores original companion/area information that helps match companions with areas served</li>
                    </ul>
                </div>

                <div class="instruction-box" id="areasInstructions" style="display: none;">
                    <h5><i class="fas fa-info-circle me-2"></i>Mission Areas CSV Format</h5>
                    <p class="mb-2">Your CSV should include these columns:</p>
                    <ul class="mb-0">
                        <li><strong>Required:</strong> area_id, area_nam (or area_name)</li>
                        <li><strong>Example:</strong> 1,Banbury</li>
                        <li><strong>Note:</strong> Import areas first, then link them to missionaries</li>
                    </ul>
                </div>

                <div class="instruction-box" id="missionaryAreasInstructions" style="display: none;">
                    <h5><i class="fas fa-info-circle me-2"></i>Missionary-Area Relationships CSV Format</h5>
                    <p class="mb-2">Your CSV should include these columns:</p>
                    <ul class="mb-0">
                        <li><strong>Required:</strong> alum_id (or a_id) and area_id</li>
                        <li><strong>Example:</strong> 1,18 (links alumId=1 to area_id=18)</li>
                        <li><strong>Optional:</strong> alum_area, area_sequ (ignored during import)</li>
                        <li><strong>Note:</strong> Make sure missionaries and areas are already imported</li>
                    </ul>
                </div>

                <div class="instruction-box" id="areabookInstructions" style="display: none;">
                    <h5><i class="fas fa-info-circle me-2"></i>Area Book CSV Format</h5>
                    <p class="mb-2">Your CSV should include these columns:</p>
                    <ul class="mb-0">
                        <li><strong>Required:</strong> alum_id, areabook (or area_book, area_companions)</li>
                        <li><strong>Example:</strong> 86,"Elder Jones - Coventry\nElder Smith - Birmingham"</li>
                        <li><strong>Note:</strong> This updates only the areabook field with original companion/area information</li>
                        <li><strong>Tip:</strong> The areabook field helps match companions with areas they served together</li>
                    </ul>
                </div>

                <div class="instruction-box" id="companionshipsInstructions" style="display: none;">
                    <h5><i class="fas fa-info-circle me-2"></i>Companionships CSV Format</h5>
                    <p class="mb-2">Your CSV should include these columns:</p>
                    <ul class="mb-0">
                        <li><strong>Required:</strong> companicrm1_id (first missionary), rm2_id (second missionary), area_id</li>
                        <li><strong>Example:</strong> 1,1,203 (companionship between alumId=1 and alumId=1 in area_id=203)</li>
                        <li><strong>Optional:</strong> real_comp (1 for real companionship, 0 for other)</li>
                        <li><strong>Note:</strong> Make sure missionaries and areas are already imported</li>
                    </ul>
                </div>

                <div class="import-card">
                    <div class="upload-zone" onclick="document.getElementById('csvFile').click()">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h4>Click to Upload CSV or Excel File</h4>
                        <p class="text-muted">or drag and drop file here</p>
                        <input type="file" id="csvFile" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(this)">
                    </div>
                    <div id="csvFileName" class="mt-3 text-center" style="display: none; background-color: #f0f0f0; padding: 15px; border-radius: 5px;">
                        <strong>Selected:</strong> <span id="csvFileNameText" style="color: #667eea; font-weight: bold;"></span>
                        <button class="btn btn-primary btn-lg ms-3" onclick="processCSV()">
                            <i class="fas fa-upload me-2"></i>Process File
                        </button>
                    </div>
                </div>

                <!-- Sample CSV Template -->
                <div class="mt-4">
                    <h5 class="section-title">Sample CSV Template</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered sample-table">
                            <thead class="table-light">
                                <tr>
                                    <th>firstName</th>
                                    <th>lastName</th>
                                    <th>maidenName</th>
                                    <th>email</th>
                                    <th>serviceStartDate</th>
                                    <th>serviceEndDate</th>
                                    <th>currentCity</th>
                                    <th>currentState</th>
                                    <th>spouseName</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>John</td>
                                    <td>Smith</td>
                                    <td></td>
                                    <td>john.smith@email.com</td>
                                    <td>1998-01-15</td>
                                    <td>2000-01-15</td>
                                    <td>Birmingham</td>
                                    <td>Alabama</td>
                                    <td>Mary Johnson</td>
                                </tr>
                                <tr>
                                    <td>Sarah</td>
                                    <td>Williams</td>
                                    <td>Brown</td>
                                    <td>sarah.w@email.com</td>
                                    <td>1999-06-20</td>
                                    <td>2001-01-20</td>
                                    <td>London</td>
                                    <td>England</td>
                                    <td>David Williams</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate()">
                        <i class="fas fa-download me-2"></i>Download Template CSV
                    </button>
                </div>
            </div>

            <!-- JSON Import Tab -->
            <div id="json-tab" class="tab-content">
                <div class="instruction-box">
                    <h5><i class="fas fa-info-circle me-2"></i>JSON Format Instructions</h5>
                    <p class="mb-0">Paste your JSON data below. It should be an array of missionary objects with fields like firstName, lastName, email, etc.</p>
                </div>

                <div class="mb-3">
                    <label class="form-label section-title">Paste JSON Data:</label>
                    <textarea class="form-control" id="jsonData" rows="15" placeholder='[
  {
    "firstName": "John",
    "lastName": "Smith",
    "email": "john@email.com",
    "serviceStartDate": "1998-01-15",
    "serviceEndDate": "2000-01-15",
    "currentCity": "Birmingham",
    "currentState": "Alabama"
  }
]'></textarea>
                </div>
                <button class="btn btn-primary btn-lg" onclick="processJSON()">
                    <i class="fas fa-upload me-2"></i>Import JSON Data
                </button>
            </div>

            <!-- Manual Entry Tab -->
            <div id="manual-tab" class="tab-content">
                <div class="instruction-box">
                    <h5><i class="fas fa-info-circle me-2"></i>Quick Manual Entry</h5>
                    <p class="mb-0">Use this form to quickly add multiple missionaries. Fill in the details and click "Add to List" for each person.</p>
                </div>

                <form id="manualEntryForm" class="mb-4">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="manualFirstName" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="manualLastName" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Maiden Name</label>
                            <input type="text" class="form-control" id="manualMaidenName">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="manualEmail">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="manualStartDate">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="manualEndDate">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Current City</label>
                            <input type="text" class="form-control" id="manualCity">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Current State/Country</label>
                            <input type="text" class="form-control" id="manualState">
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" onclick="addManualEntry()">
                        <i class="fas fa-plus me-2"></i>Add to List
                    </button>
                    <button type="reset" class="btn btn-outline-secondary">Clear Form</button>
                </form>

                <div id="manualList" style="display: none;">
                    <h5 class="section-title">Pending Entries (<span id="manualCount">0</span>)</h5>
                    <div id="manualEntries" class="mb-3"></div>
                    <button class="btn btn-primary btn-lg" onclick="submitManualEntries()">
                        <i class="fas fa-save me-2"></i>Save All (<span id="manualCountBtn">0</span>) Missionaries
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <h5 class="section-title">Processing...</h5>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                         id="progressBar" style="width: 0%"></div>
                </div>
                <p class="mt-2 text-center" id="progressText">Starting import...</p>
            </div>

            <!-- Result Box -->
            <div class="result-box" id="resultBox">
                <h5><i class="fas fa-check-circle me-2"></i>Import Successful!</h5>
                <p id="resultText" style="white-space: pre-wrap;"></p>
                <div id="detailedResults" class="mt-3" style="display: none;">
                    <hr>
                    <h6><i class="fas fa-chart-bar me-2"></i>Detailed Import Statistics</h6>
                    <div id="detailedStatsContent" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem; background: #f8f9fa; padding: 1rem; border-radius: 5px; white-space: pre-wrap;"></div>
                </div>
            </div>

            <!-- Error Box -->
            <div class="error-box" id="errorBox">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Import Error</h5>
                <p id="errorText" style="white-space: pre-wrap;"></p>
            </div>

            <!-- Import Logs History -->
            <div id="importLogsSection" class="mt-4" style="display: none;">
                <h5 class="section-title"><i class="fas fa-history me-2"></i>Import History</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp</th>
                                <th>Type</th>
                                <th>Results</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="importLogsTable">
                            <!-- Logs will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let csvData = null;
        let manualEntries = [];

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function updateInstructions() {
            const importType = document.getElementById('importType').value;
            
            // Hide all instruction boxes
            document.getElementById('missionariesInstructions').style.display = 'none';
            document.getElementById('areasInstructions').style.display = 'none';
            document.getElementById('missionaryAreasInstructions').style.display = 'none';
            document.getElementById('areabookInstructions').style.display = 'none';
            document.getElementById('companionshipsInstructions').style.display = 'none';
            
            // Show relevant instruction box
            if (importType === 'missionaries') {
                document.getElementById('missionariesInstructions').style.display = 'block';
            } else if (importType === 'areas') {
                document.getElementById('areasInstructions').style.display = 'block';
            } else if (importType === 'missionary-areas') {
                document.getElementById('missionaryAreasInstructions').style.display = 'block';
            } else if (importType === 'areabook') {
                document.getElementById('areabookInstructions').style.display = 'block';
            } else if (importType === 'companionships') {
                document.getElementById('companionshipsInstructions').style.display = 'block';
            }
            
            // Keep file selection visible if file is selected
            if (csvData) {
                document.getElementById('csvFileName').style.display = 'block';
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            console.log('handleFileSelect called', file ? file.name : 'no file');
            
            if (file) {
                csvData = file;
                const fileNameDisplay = document.getElementById('csvFileName');
                const fileNameText = document.getElementById('csvFileNameText');
                
                fileNameText.textContent = file.name;
                fileNameDisplay.style.display = 'block';
                
                console.log('File selected:', file.name, 'Size:', file.size, 'bytes');
                console.log('Display set to block, element:', fileNameDisplay);
            } else {
                console.error('No file in input.files[0]');
            }
        }

        async function processCSV() {
            if (!csvData) {
                alert('Please select a file first');
                console.error('No file selected - csvData is null');
                return;
            }

            const importType = document.getElementById('importType').value;
            console.log('Processing CSV:', csvData.name, 'Type:', importType, 'Size:', csvData.size);

            try {
                showProgress();
                updateProgress(10, 'Uploading file...');
                
                // Upload the entire CSV file to the server
                const formData = new FormData();
                formData.append('csvFile', csvData);
                formData.append('importType', importType);
                
                updateProgress(30, 'Processing CSV on server...');
                
                const response = await fetch('/ebm/import', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                hideProgress();
                
                if (result.success) {
                    // Build detailed message
                    let summaryMessage = result.message || 'Import completed successfully';
                    let detailedStats = '';
                    
                    // Add detailed stats based on import type
                    if (importType === 'missionaries') {
                        summaryMessage = `✅ Imported ${result.imported} new missionaries\n↻ Updated ${result.updated} existing missionaries`;
                        detailedStats = `MISSIONARIES IMPORT RESULTS
${'='.repeat(60)}
✓ New missionaries imported: ${result.imported}
↻ Existing missionaries updated: ${result.updated}
${result.errors && result.errors.length > 0 ? '✗ Errors encountered: ' + result.errors.length : ''}
${'='.repeat(60)}`;
                    } else if (importType === 'areas') {
                        summaryMessage = `✅ Imported ${result.imported} new areas\n↻ Updated ${result.updated} existing areas\n⊘ Skipped ${result.skipped} blank/invalid records`;
                        detailedStats = `MISSION AREAS IMPORT RESULTS
${'='.repeat(60)}
✓ New areas imported: ${result.imported}
↻ Existing areas updated: ${result.updated}
⊘ Skipped (blank/invalid): ${result.skipped}
${result.errors && result.errors.length > 0 ? '✗ Errors encountered: ' + result.errors.length : ''}
${'='.repeat(60)}`;

                        // Add skipped details
                        if (result.skippedDetails && result.skippedDetails.length > 0) {
                            detailedStats += `\n\nSKIPPED RECORDS (showing first ${Math.min(5, result.skippedDetails.length)}):\n`;
                            result.skippedDetails.slice(0, 5).forEach((detail, i) => {
                                detailedStats += `${i + 1}. ${detail.reason} - area_id: ${detail.row.area_id}, name: ${detail.row.area_nam || detail.row.area_name || 'N/A'}\n`;
                            });
                        }

                        // Add error details
                        if (result.errorDetails && result.errorDetails.length > 0) {
                            detailedStats += `\n\nERROR DETAILS (showing first ${Math.min(5, result.errorDetails.length)}):\n`;
                            result.errorDetails.slice(0, 5).forEach((detail, i) => {
                                detailedStats += `${i + 1}. area_id: ${detail.area_id}, name: ${detail.name || 'N/A'}\n   Error: ${detail.error}\n`;
                            });
                        }
                    } else if (importType === 'missionary-areas') {
                        summaryMessage = `✅ Linked ${result.linked} new missionary-area connections\n↷ Already linked: ${result.alreadyLinked}\n⊘ Skipped: ${result.skipped}`;
                        detailedStats = `MISSIONARY-AREA RELATIONSHIPS IMPORT RESULTS
${'='.repeat(60)}
✓ New connections linked: ${result.linked}
↷ Already linked: ${result.alreadyLinked}
⊘ Skipped (blank/invalid): ${result.skipped}
⚠️  Missionaries not found: ${result.notFoundMissionary || 0}
⚠️  Areas not found: ${result.notFoundArea || 0}
${result.errors && result.errors.length > 0 ? '✗ Errors encountered: ' + result.errors.length : ''}
${'='.repeat(60)}`;
                        
                        if (result.notFoundMissionary > 0) {
                            summaryMessage += `\n⚠️  Missionaries not found: ${result.notFoundMissionary}`;
                        }
                        if (result.notFoundArea > 0) {
                            summaryMessage += `\n⚠️  Areas not found: ${result.notFoundArea}`;
                        }
                    } else if (importType === 'areabook') {
                        summaryMessage = `✅ Updated ${result.updated} missionary areabook records\n⊘ Skipped: ${result.skipped}`;
                        detailedStats = `AREA BOOK IMPORT RESULTS\n${'='.repeat(60)}\n✓ Records updated: ${result.updated}\n⊘ Skipped (blank/invalid): ${result.skipped}\n⚠️  Missionaries not found: ${result.notFound || 0}\n${result.errors && result.errors.length > 0 ? '✗ Errors encountered: ' + result.errors.length : ''}\n${'='.repeat(60)}`;
                        
                        if (result.notFound > 0) {
                            summaryMessage += `\n⚠️  Missionaries not found: ${result.notFound}`;
                        }
                    } else if (importType === 'companionships') {
                        summaryMessage = `✅ Created ${result.created} new companionships\n↷ Already exists: ${result.alreadyExists}\n⊘ Skipped: ${result.skipped}`;
                        detailedStats = `COMPANIONSHIPS IMPORT RESULTS
${'='.repeat(60)}
✓ New companionships created: ${result.created}
↷ Already exist: ${result.alreadyExists}
⊘ Skipped (blank/invalid): ${result.skipped}
⚠️  First missionary not found: ${result.notFoundMissionary1 || 0}
⚠️  Second missionary not found: ${result.notFoundMissionary2 || 0}
⚠️  Areas not found: ${result.notFoundArea || 0}
${result.errors && result.errors.length > 0 ? '✗ Errors encountered: ' + result.errors.length : ''}
${'='.repeat(60)}`;
                        
                        if (result.notFoundMissionary1 > 0) {
                            summaryMessage += `\n⚠️  First missionary not found: ${result.notFoundMissionary1}`;
                        }
                        if (result.notFoundMissionary2 > 0) {
                            summaryMessage += `\n⚠️  Second missionary not found: ${result.notFoundMissionary2}`;
                        }
                        if (result.notFoundArea > 0) {
                            summaryMessage += `\n⚠️  Areas not found: ${result.notFoundArea}`;
                        }
                    }
                    
                    if (result.errors && result.errors.length > 0) {
                        summaryMessage += `\n\n❌ Errors (${result.errors.length}):\n`;
                        detailedStats += `\n\nERROR DETAILS:\n`;
                        result.errors.slice(0, 10).forEach((err, index) => {
                            summaryMessage += `${index + 1}. ${err.name}: ${err.error}\n`;
                            detailedStats += `${index + 1}. ${err.name}: ${err.error}\n`;
                        });
                        if (result.errors.length > 10) {
                            summaryMessage += `... and ${result.errors.length - 10} more errors`;
                            detailedStats += `... and ${result.errors.length - 10} more errors\n`;
                        }
                    }
                    
                    // Save to import history
                    saveImportToHistory(importType, result, summaryMessage);
                    
                    showResult(summaryMessage, detailedStats);
                    
                    // Show import logs section
                    loadImportHistory();
                    
                    // Redirect after a longer delay to allow reading results
                    setTimeout(() => {
                        if (importType === 'missionaries') {
                            window.location.href = '/ebm/missionaries';
                        } else {
                            window.location.href = '/ebm/dashboard';
                        }
                    }, 5000);
                } else {
                    showError(result.error || 'Import failed');
                }
            } catch (error) {
                hideProgress();
                showError('Upload error: ' + error.message);
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                data.push(obj);
            }

            return data;
        }

        async function processJSON() {
            const jsonText = document.getElementById('jsonData').value.trim();
            if (!jsonText) {
                alert('Please paste JSON data');
                return;
            }

            try {
                showProgress();
                updateProgress(10, 'Parsing JSON...');
                
                const data = JSON.parse(jsonText);
                if (!Array.isArray(data)) {
                    throw new Error('JSON must be an array of objects');
                }

                updateProgress(30, `Processing ${data.length} records...`);
                await importMissionaries(data);
            } catch (error) {
                showError('Invalid JSON: ' + error.message);
            }
        }

        async function importMissionaries(data) {
            let successCount = 0;
            let errorCount = 0;
            const total = data.length;

            for (let i = 0; i < data.length; i++) {
                const missionary = data[i];
                updateProgress(30 + (i / total * 60), `Importing ${i + 1} of ${total}...`);

                try {
                    const response = await fetch('/ebm/missionaries', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(missionary)
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }

                // Small delay to prevent overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            hideProgress();
            showResult(`Successfully imported ${successCount} missionaries. ${errorCount > 0 ? errorCount + ' failed.' : ''}`);
        }

        function addManualEntry() {
            const firstName = document.getElementById('manualFirstName').value;
            const lastName = document.getElementById('manualLastName').value;

            if (!firstName || !lastName) {
                alert('First name and last name are required');
                return;
            }

            const entry = {
                firstName,
                lastName,
                maidenName: document.getElementById('manualMaidenName').value,
                email: document.getElementById('manualEmail').value,
                serviceStartDate: document.getElementById('manualStartDate').value,
                serviceEndDate: document.getElementById('manualEndDate').value,
                currentCity: document.getElementById('manualCity').value,
                currentState: document.getElementById('manualState').value
            };

            manualEntries.push(entry);
            updateManualList();
            document.getElementById('manualEntryForm').reset();
        }

        function updateManualList() {
            const count = manualEntries.length;
            document.getElementById('manualCount').textContent = count;
            document.getElementById('manualCountBtn').textContent = count;

            if (count > 0) {
                document.getElementById('manualList').style.display = 'block';
                const container = document.getElementById('manualEntries');
                container.innerHTML = manualEntries.map((entry, index) => `
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span>${entry.firstName} ${entry.lastName} ${entry.maidenName ? '(' + entry.maidenName + ')' : ''}</span>
                        <button class="btn btn-sm btn-danger" onclick="removeManualEntry(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            } else {
                document.getElementById('manualList').style.display = 'none';
            }
        }

        function removeManualEntry(index) {
            manualEntries.splice(index, 1);
            updateManualList();
        }

        async function submitManualEntries() {
            if (manualEntries.length === 0) return;
            await importMissionaries(manualEntries);
            manualEntries = [];
            updateManualList();
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultBox').style.display = 'none';
            document.getElementById('errorBox').style.display = 'none';
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showResult(text, detailedStats) {
            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('resultText').textContent = text;
            
            if (detailedStats) {
                document.getElementById('detailedResults').style.display = 'block';
                document.getElementById('detailedStatsContent').textContent = detailedStats;
            }
        }

        function showError(text) {
            hideProgress();
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorText').textContent = text;
        }

        function saveImportToHistory(importType, result, summary) {
            const history = JSON.parse(localStorage.getItem('ebmImportHistory') || '[]');
            
            history.unshift({
                timestamp: new Date().toISOString(),
                importType: importType,
                result: result,
                summary: summary
            });
            
            // Keep only last 20 imports
            if (history.length > 20) {
                history.splice(20);
            }
            
            localStorage.setItem('ebmImportHistory', JSON.stringify(history));
        }

        function loadImportHistory() {
            const history = JSON.parse(localStorage.getItem('ebmImportHistory') || '[]');
            
            if (history.length === 0) {
                return;
            }
            
            document.getElementById('importLogsSection').style.display = 'block';
            const tbody = document.getElementById('importLogsTable');
            
            tbody.innerHTML = history.slice(0, 10).map((log, index) => {
                const date = new Date(log.timestamp);
                const dateStr = date.toLocaleString();
                
                let resultSummary = '';
                if (log.importType === 'missionaries') {
                    resultSummary = `Imported: ${log.result.imported}, Updated: ${log.result.updated}`;
                } else if (log.importType === 'areas') {
                    resultSummary = `Imported: ${log.result.imported}, Updated: ${log.result.updated}`;
                } else if (log.importType === 'missionary-areas') {
                    resultSummary = `Linked: ${log.result.linked}, Already: ${log.result.alreadyLinked}`;
                } else if (log.importType === 'companionships') {
                    resultSummary = `Created: ${log.result.created}, Already: ${log.result.alreadyExists}`;
                }
                
                return `
                    <tr>
                        <td><small>${dateStr}</small></td>
                        <td><span class="badge bg-primary">${log.importType}</span></td>
                        <td><small>${resultSummary}</small></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewImportDetails(${index})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewImportDetails(index) {
            const history = JSON.parse(localStorage.getItem('ebmImportHistory') || '[]');
            const log = history[index];
            
            if (!log) return;
            
            alert(log.summary);
        }

        function downloadTemplate() {
            const csv = 'firstName,lastName,maidenName,email,serviceStartDate,serviceEndDate,currentCity,currentState,spouseName\nJohn,Smith,,john.smith@email.com,1998-01-15,2000-01-15,Birmingham,Alabama,Mary Johnson\nSarah,Williams,Brown,sarah.w@email.com,1999-06-20,2001-01-20,London,England,David Williams';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ebm-missionary-template.csv';
            a.click();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            updateInstructions();
            loadImportHistory();
        });
    </script>
</body>

</html>
