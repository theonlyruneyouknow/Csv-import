<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .upload-container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .upload-title {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .preview-container {
            margin-top: 20px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4193 100%);
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/greatestjoy/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Gallery
        </a>
    </div>

    <div class="upload-container">
        <h2 class="upload-title">
            <i class="fas fa-cloud-upload-alt"></i>
            <%= media ? 'Edit Memory' : 'Upload New Memory' %>
        </h2>

        <form action="<%= media ? `/greatestjoy/media/${media._id}?_method=PUT` : '/greatestjoy/upload' %>" method="POST">
            <div class="form-section">
                <label class="form-label"><strong>Title *</strong></label>
                <input type="text" class="form-control" name="title" value="<%= media ? media.title : '' %>" required>
            </div>

            <div class="form-section">
                <label class="form-label"><strong>Media Type *</strong></label>
                <select class="form-select" name="mediaType" id="mediaType" <%= media ? 'disabled' : '' %> required>
                    <option value="photo" <%= media && media.mediaType === 'photo' ? 'selected' : '' %>>Photo</option>
                    <option value="video" <%= media && media.mediaType === 'video' ? 'selected' : '' %>>Video</option>
                </select>
            </div>

            <div class="form-section">
                <label class="form-label"><strong>Image/Video URL *</strong></label>
                <input type="url" class="form-control" name="url" id="mediaUrl" 
                       value="<%= media ? media.url : '' %>" 
                       <%= media ? 'readonly' : '' %>
                       placeholder="https://example.com/image.jpg or https://youtu.be/..." 
                       onchange="previewMedia()" required>
                <small class="text-muted">
                    <strong>How to get shareable links:</strong><br>
                    üì∏ <strong>Google Photos:</strong> Open photo ‚Üí Share ‚Üí Create link ‚Üí Copy<br>
                    ‚òÅÔ∏è <strong>iCloud:</strong> Select photo ‚Üí Share ‚Üí Copy iCloud Link<br>
                    üìÅ <strong>OneDrive/Dropbox:</strong> Right-click ‚Üí Share ‚Üí Copy link<br>
                    üé• <strong>YouTube:</strong> Click Share button ‚Üí Copy link<br>
                    üí° <strong>Tip:</strong> Make sure the link points directly to the image/video file or is a shareable public link
                </small>
            </div>

            <div class="form-section" id="thumbnailSection" style="display: none;">
                <label class="form-label"><strong>Video Thumbnail URL</strong></label>
                <input type="url" class="form-control" name="thumbnailUrl" 
                       value="<%= media && media.thumbnailUrl ? media.thumbnailUrl : '' %>" 
                       placeholder="https://example.com/thumbnail.jpg">
                <small class="text-muted">
                    Optional: Paste a URL to a thumbnail image for the video preview. 
                    YouTube thumbnails are automatically generated, but you can provide a custom one.
                </small>
            </div>

            <div class="preview-container" id="previewContainer" style="display: none;">
                <img id="preview" class="preview-image" alt="Preview">
            </div>

            <!-- People Tagging Section -->
            <div class="form-section">
                <label class="form-label">
                    <strong><i class="fas fa-users"></i> Tag People in This Photo/Video</strong>
                </label>
                <small class="text-muted d-block mb-3">
                    Add family members who appear in or are related to this memory
                </small>
                
                <div id="peopleContainer">
                    <!-- Person entries will be added here -->
                </div>
                
                <button type="button" class="btn btn-secondary btn-sm" onclick="addPerson()">
                    <i class="fas fa-plus"></i> Add Person
                </button>
                <input type="hidden" name="peopleData" id="peopleData">
            </div>

            <!-- Family Circles Section -->
            <% if (circles && circles.length > 0) { %>
                <div class="form-section">
                    <label class="form-label">
                        <strong><i class="fas fa-users-cog"></i> Share with Family Circles</strong>
                    </label>
                    <small class="text-muted d-block mb-2">
                        Select which family circles can see this memory
                    </small>
                    <% circles.forEach(circle => { %>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="circles" 
                                   value="<%= circle._id %>" id="circle_<%= circle._id %>">
                            <label class="form-check-label" for="circle_<%= circle._id %>">
                                <%= circle.name %> (<%= circle.members.length %> members)
                            </label>
                        </div>
                    <% }); %>
                </div>
            <% } %>

            <div class="form-section">
                <label class="form-label"><strong>Description</strong></label>
                <textarea class="form-control" name="description" rows="3" 
                          placeholder="Tell us about this special moment..."><%= media && media.description ? media.description : '' %></textarea>
            </div>

            <div class="form-section">
                <label class="form-label"><strong>Capture Date</strong></label>
                <input type="date" class="form-control" name="captureDate" 
                       value="<%= media && media.captureDate ? new Date(media.captureDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0] %>">
            </div>

            <div class="form-section">
                <label class="form-label"><strong>Album</strong></label>
                <input type="text" class="form-control" name="album" 
                       value="<%= media && media.album ? media.album : '' %>" 
                       list="albumsList" 
                       placeholder="e.g., First Birthday, Summer 2025">
                <datalist id="albumsList">
                    <% if (albums && albums.length > 0) { %>
                        <% albums.forEach(album => { %>
                            <option value="<%= album %>">
                        <% }); %>
                    <% } %>
                </datalist>
            </div>

            <div class="form-section">
                <label class="form-label"><strong>Location</strong></label>
                <input type="text" class="form-control" name="location" 
                       value="<%= media && media.location ? media.location : '' %>" 
                       placeholder="e.g., Grandma's House, Zoo, Beach">
            </div>

            <div class="form-section">
                <label class="form-label"><strong>Tags</strong></label>
                <input type="text" class="form-control" name="tags" 
                       value="<%= media && media.tags ? media.tags.join(', ') : '' %>" 
                       placeholder="birthday, smile, first steps, family fun">
                <small class="text-muted">Add tags separated by commas to help organize and search your memories</small>
            </div>

            <div class="form-section">
                <label class="form-label"><strong>Visibility</strong></label>
                <select class="form-select" name="visibility">
                    <option value="circle" <%= !media || media.visibility === 'circle' ? 'selected' : '' %>>Selected Circles Only</option>
                    <option value="family" <%= media && media.visibility === 'family' ? 'selected' : '' %>>All Family</option>
                    <option value="private" <%= media && media.visibility === 'private' ? 'selected' : '' %>>Private (Only Me)</option>
                    <option value="public" <%= media && media.visibility === 'public' ? 'selected' : '' %>>Public</option>
                </select>
                <small class="text-muted">
                    Choose who can see this memory. "Selected Circles Only" shares with checked circles above.
                </small>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i><%= media ? 'Update Memory' : 'Upload Memory' %>
                </button>
                <a href="/greatestjoy/dashboard" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <script>
        function previewMedia() {
            const url = document.getElementById('mediaUrl').value;
            const preview = document.getElementById('preview');
            const previewContainer = document.getElementById('previewContainer');
            
            if (url) {
                preview.src = url;
                previewContainer.style.display = 'block';
            } else {
                previewContainer.style.display = 'none';
            }
        }

        document.getElementById('mediaType').addEventListener('change', function() {
            const thumbnailSection = document.getElementById('thumbnailSection');
            if (this.value === 'video') {
                thumbnailSection.style.display = 'block';
            } else {
                thumbnailSection.style.display = 'none';
            }
        });

        // Show thumbnail section if editing video
        window.onload = function() {
            const mediaType = document.getElementById('mediaType').value;
            if (mediaType === 'video') {
                document.getElementById('thumbnailSection').style.display = 'block';
            }
            
            // Show preview if editing
            <% if (media && media.url) { %>
                previewMedia();
            <% } %>

            // Add initial person entry
            addPerson();
        };

        // Dynamic people tagging
        let personCount = 0;
        const relationshipTypes = [
            'grandchild', 'great-grandchild', 'child', 'grandparent',
            'great-grandparent', 'parent', 'sibling', 'spouse',
            'aunt', 'uncle', 'cousin', 'niece', 'nephew',
            'in-law', 'step-relative', 'friend', 'other'
        ];

        function addPerson() {
            personCount++;
            const container = document.getElementById('peopleContainer');
            const personDiv = document.createElement('div');
            personDiv.className = 'person-entry mb-3 p-3 border rounded';
            personDiv.id = `person_${personCount}`;
            personDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0"><i class="fas fa-user"></i> Person ${personCount}</h6>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removePerson(${personCount})">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control person-name" required
                               placeholder="e.g., Emma Smith">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Relationship *</label>
                        <select class="form-select person-relationship" required>
                            ${relationshipTypes.map(rel => 
                                `<option value="${rel}">${rel.split('-').map(w => 
                                    w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Birth Date</label>
                        <input type="date" class="form-control person-birthdate">
                    </div>
                </div>
            `;
            container.appendChild(personDiv);
        }

        function removePerson(id) {
            const personDiv = document.getElementById(`person_${id}`);
            if (personDiv) {
                personDiv.remove();
            }
        }

        // Before form submission, collect all people data
        document.querySelector('form').addEventListener('submit', function(e) {
            const people = [];
            document.querySelectorAll('.person-entry').forEach(entry => {
                const name = entry.querySelector('.person-name').value;
                const relationship = entry.querySelector('.person-relationship').value;
                const birthDate = entry.querySelector('.person-birthdate').value;
                
                if (name) {
                    people.push({
                        name,
                        relationship,
                        birthDate: birthDate || null
                    });
                }
            });
            
            document.getElementById('peopleData').value = JSON.stringify(people);
        });

    </script>
</body>
</html>
