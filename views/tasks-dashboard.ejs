<!DOCTYPE html>
<html>
<head>
    <title>Task Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        /* Navigation Styles */
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navigation-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-section {
            position: relative;
        }

        .nav-accordion-btn, .nav-imports-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .nav-accordion-btn:hover, .nav-imports-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
        }

        .accordion-icon, .dropdown-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .accordion-icon.rotated, .dropdown-icon.rotated {
            transform: rotate(180deg);
        }

        .nav-accordion-content, .nav-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .nav-accordion-content.show, .nav-dropdown-content.show {
            max-height: 400px;
            opacity: 1;
            transform: translateY(0);
        }

        .nav-accordion-item, .nav-dropdown-item {
            display: block;
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .nav-accordion-item:hover, .nav-dropdown-item:hover {
            background: #f8f9fa;
            color: #007bff;
        }

        .nav-accordion-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .user-status-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: #28a745;
            border: 2px solid white;
            border-radius: 50%;
        }

        .dropdown-user-info {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .dropdown-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }

        .dropdown-user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .dropdown-user-role {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .dropdown-user-status {
            font-size: 11px;
            color: #28a745;
            font-weight: 500;
        }

        .auth-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Responsive Navigation */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
                text-align: center;
            }

            .navigation-container {
                justify-content: center;
                gap: 10px;
            }

            .nav-accordion-btn, .nav-imports-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .nav-accordion-content, .nav-dropdown-content {
                min-width: 180px;
            }

            .user-info {
                justify-content: center;
            }
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .stat-card.total { border-left-color: #6c757d; }
        .stat-card.pending { border-left-color: #ffc107; }
        .stat-card.in-progress { border-left-color: #17a2b8; }
        .stat-card.completed { border-left-color: #28a745; }
        .stat-card.overdue { border-left-color: #dc3545; }
        .stat-card.critical { border-left-color: #e74c3c; }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .task-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: transform 0.2s;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .task-card.priority-low { border-left-color: #28a745; }
        .task-card.priority-medium { border-left-color: #ffc107; }
        .task-card.priority-high { border-left-color: #fd7e14; }
        .task-card.priority-critical { border-left-color: #dc3545; }

        .task-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .task-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .task-tags {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .task-tag {
            background: #e9ecef;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #495057;
        }

        .priority-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .priority-low { background: #d4edda; color: #155724; }
        .priority-medium { background: #fff3cd; color: #856404; }
        .priority-high { background: #f8d7da; color: #721c24; }
        .priority-critical { background: #f5c6cb; color: #721c24; font-weight: bold; }

        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-on-hold { background: #e2e3e5; color: #383d41; }

        .overdue {
            background: #f8d7da !important;
            border-left-color: #dc3545 !important;
        }

        .due-soon {
            background: #fff3cd !important;
        }

        .filters-section {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .btn-create-task {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
        }

        .related-items {
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .related-po {
            color: #17a2b8;
            text-decoration: none;
            margin-right: 0.5rem;
        }

        .related-po:hover {
            text-decoration: underline;
        }

        .related-vendor {
            color: #6f42c1;
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-weight: 500;
            margin-right: 0.25rem;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .days-until {
            font-weight: 500;
        }

        .days-until.overdue {
            color: #dc3545;
        }

        .days-until.due-soon {
            color: #fd7e14;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .form-floating label {
            color: #6c757d;
        }

        #taskForm .form-control:focus,
        #taskForm .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        /* P.O.D. Button Styles */
        .pod-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .pod-button:hover {
            background: linear-gradient(135deg, #218838, #1ea583);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            color: white;
            text-decoration: none;
        }

        .pod-button .arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .pod-button:hover .arrow {
            transform: translateX(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tasks"></i> Task Management Dashboard</h1>
            
            <!-- P.O.D. Button -->
            <a href="/" class="pod-button">
                <span class="arrow">‚Üê</span>
                <span>P.O.D.</span>
            </a>
            
            <div class="d-flex align-items-center justify-content-between flex-grow-1">
                <!-- Navigation Container -->
                <div class="navigation-container">
                    <!-- Dashboards Accordion -->
                    <div class="nav-section">
                        <button class="nav-accordion-btn" onclick="toggleAccordion('managersAccordion')">
                            üìä Dashboards <span class="accordion-icon">‚ñº</span>
                        </button>
                        <div id="managersAccordion" class="nav-accordion-content">
                            <a href="/" class="nav-accordion-item">üè† PO Dashboard</a>
                            <a href="/receiving" class="nav-accordion-item">üöö Receiving Dashboard</a>
                            <a href="/dropship" class="nav-accordion-item">üö¢ Dropship Dashboard</a>
                            <a href="/vendors" class="nav-accordion-item">üè¢ Vendors Dashboard</a>
                            <a href="/tasks" class="nav-accordion-item" style="background: #e3f2fd; color: #1976d2; font-weight: 600;">üìã Tasks Dashboard</a>
                            <div class="nav-accordion-divider"></div>
                            <a href="/purchase-orders/line-items-manager" class="nav-accordion-item">üì¶ Line Items Manager</a>
                            <a href="/purchase-orders/tracking-dashboard" class="nav-accordion-item">üöö Tracking Dashboard</a>
                            <a href="/purchase-orders/notes-manager" class="nav-accordion-item">üìù Notes Manager</a>
                        </div>
                    </div>

                    <!-- Combined Options Button -->
                    <div class="nav-section">
                        <button class="nav-accordion-btn" onclick="toggleAccordion('optionsAccordion')">
                            ‚öôÔ∏è Options <span class="accordion-icon">‚ñº</span>
                        </button>
                        <div id="optionsAccordion" class="nav-accordion-content">
                            <a href="/upload" class="nav-accordion-item">üì§ Upload CSV</a>
                            <a href="/organic-vendors" class="nav-accordion-item">üå± Organic Vendors</a>
                            <a href="/purchase-orders/trouble-seed" class="nav-accordion-item">‚ö†Ô∏è Trouble Seed</a>
                            <a href="/purchase-orders/orphaned-line-items" class="nav-accordion-item">üßπ Orphaned Items</a>
                            <a href="/email-client" class="nav-accordion-item">üìß Email Client</a>
                            
                            <!-- Admin Options (only for admin/manager users) -->
                            <% if (typeof user !== 'undefined' && user && (user.role === 'admin' || user.role === 'manager')) { %>
                            <div class="nav-accordion-divider"></div>
                            <a href="/auth/admin/users" class="nav-accordion-item">üë• User Management</a>
                            <a href="/auth/admin/audit-logs" class="nav-accordion-item">üìä Audit Logs</a>
                            <% if (user.role === 'admin' || user.role === 'manager') { %>
                            <a href="/auth/admin/test-email" class="nav-accordion-item">üìß Test Email</a>
                            <% } %>
                            <% } %>
                        </div>
                    </div>

                    <!-- Import Section -->
                    <div class="nav-section">
                        <button class="nav-imports-btn" onclick="toggleImportsDropdown()">
                            üìÅ Import <span class="dropdown-icon">‚ñº</span>
                        </button>
                        <div id="importsDropdown" class="nav-dropdown-content">
                            <a href="/upload" class="nav-dropdown-item">üìÑ Purchase Orders CSV</a>
                            <a href="/upload" class="nav-dropdown-item">üì¶ Line Items CSV</a>
                            <button class="nav-dropdown-item" onclick="openNetSuiteImportModal()">üè¢ NetSuite PO
                                Form</button>
                        </div>
                    </div>
                </div>
                
                <!-- User Info -->
                <% if (typeof user !== 'undefined' && user) { %>
                <div class="user-info" title="<%= user.firstName %> <%= user.lastName %> (<%= user.role %>) - Online">
                    <div class="user-avatar">
                        <%= user.firstName ? user.firstName.charAt(0).toUpperCase() : 'U' %><%= user.lastName ? user.lastName.charAt(0).toUpperCase() : '' %>
                        <div class="user-status-indicator" title="Online"></div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <!-- User Info Header -->
                            <li class="dropdown-user-info">
                                <div class="dropdown-user-avatar">
                                    <%= user.firstName ? user.firstName.charAt(0).toUpperCase() : 'U' %><%= user.lastName ? user.lastName.charAt(0).toUpperCase() : '' %>
                                </div>
                                <div class="dropdown-user-details">
                                    <div class="dropdown-user-name"><%= user.firstName %> <%= user.lastName %></div>
                                    <div class="dropdown-user-role"><%= user.role %></div>
                                    <div class="dropdown-user-status">Online</div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider" style="margin: 0;"></li>
                            
                            <% if (user.permissions && user.permissions.manageUsers) { %>
                            <li><a class="dropdown-item" href="/auth/admin/users">
                                <i class="fas fa-users me-2"></i>User Management
                            </a></li>
                            <li><a class="dropdown-item" href="/auth/admin/audit-logs">
                                <i class="fas fa-history me-2"></i>Audit Logs
                            </a></li>
                            <% } %>
                            <% if (user.role === 'admin' || user.role === 'manager') { %>
                            <li><a class="dropdown-item" href="/auth/admin/test-email">
                                <i class="fas fa-envelope me-2"></i>Test Email
                            </a></li>
                            <% } %>
                            <% if ((user.permissions && user.permissions.manageUsers) || user.role === 'admin' || user.role === 'manager') { %>
                            <li><hr class="dropdown-divider"></li>
                            <% } %>
                            <li>
                                <form action="/auth/logout" method="POST" style="margin: 0;">
                                    <button type="submit" class="dropdown-item" style="border: none; background: none; width: 100%; text-align: left;">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
                <% } else { %>
                <div class="user-info">
                    <span class="auth-status bg-warning text-dark">Not Authenticated</span>
                    <a href="/auth/login" class="btn btn-primary btn-sm">Login</a>
                </div>
                <% } %>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-number"><%= stats.total %></div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-number"><%= stats.pending %></div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card in-progress">
                <div class="stat-number"><%= stats.inProgress %></div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-number"><%= stats.completed %></div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card overdue">
                <div class="stat-number"><%= stats.overdue %></div>
                <div class="stat-label">Overdue</div>
            </div>
            <div class="stat-card critical">
                <div class="stat-number"><%= stats.critical %></div>
                <div class="stat-label">Critical Priority</div>
            </div>
        </div>

        <!-- Filters and Actions -->
        <div class="filters-section">
            <!-- Quick Filter Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; flex-wrap: wrap; align-items: center;">
                <span style="font-weight: 600; color: #495057; margin-right: 5px;">Quick Filters:</span>
                <button type="button" class="btn btn-sm quick-filter-btn" id="quickTodayBtn" onclick="applyQuickFilter('today')"
                        style="background: #e3f2fd; color: #1976d2; border: 1px solid #1976d2; font-weight: 500;">
                    üìÖ Today
                </button>
                <button type="button" class="btn btn-sm quick-filter-btn" id="quickHighBtn" onclick="applyQuickFilter('high')"
                        style="background: #fff3e0; color: #f57c00; border: 1px solid #f57c00; font-weight: 500;">
                    üî• High Priority
                </button>
                <button type="button" class="btn btn-sm quick-filter-btn" id="quickOldestBtn" onclick="applyQuickFilter('oldest')"
                        style="background: #f3e5f5; color: #7b1fa2; border: 1px solid #7b1fa2; font-weight: 500;">
                    ‚è∞ Oldest First
                </button>
                <button type="button" class="btn btn-sm quick-filter-btn" id="quickAllBtn" onclick="applyQuickFilter('all')"
                        style="background: #e8f5e9; color: #388e3c; border: 1px solid #388e3c; font-weight: 500;">
                    üìã All Tasks
                </button>
            </div>
            
            <form method="GET" id="filterForm">
                <div class="filters-row">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="search" name="search" 
                               value="<%= filters.search %>" placeholder="Search tasks...">
                        <label for="search">Search Tasks</label>
                    </div>

                    <div class="form-floating">
                        <select class="form-select" id="status" name="status">
                            <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All Statuses</option>
                            <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                            <option value="in-progress" <%= filters.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                            <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
                            <option value="on-hold" <%= filters.status === 'on-hold' ? 'selected' : '' %>>On Hold</option>
                            <option value="cancelled" <%= filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                        </select>
                        <label for="status">Status</label>
                    </div>

                    <div class="form-floating">
                        <select class="form-select" id="priority" name="priority">
                            <option value="all" <%= filters.priority === 'all' ? 'selected' : '' %>>All Priorities</option>
                            <option value="low" <%= filters.priority === 'low' ? 'selected' : '' %>>Low</option>
                            <option value="medium" <%= filters.priority === 'medium' ? 'selected' : '' %>>Medium</option>
                            <option value="high" <%= filters.priority === 'high' ? 'selected' : '' %>>High</option>
                            <option value="critical" <%= filters.priority === 'critical' ? 'selected' : '' %>>Critical</option>
                        </select>
                        <label for="priority">Priority</label>
                    </div>

                    <div class="form-floating">
                        <select class="form-select" id="category" name="category">
                            <option value="all" <%= filters.category === 'all' ? 'selected' : '' %>>All Categories</option>
                            <option value="seed-sourcing" <%= filters.category === 'seed-sourcing' ? 'selected' : '' %>>Seed Sourcing</option>
                            <option value="po-management" <%= filters.category === 'po-management' ? 'selected' : '' %>>PO Management</option>
                            <option value="vendor-contact" <%= filters.category === 'vendor-contact' ? 'selected' : '' %>>Vendor Contact</option>
                            <option value="quality-check" <%= filters.category === 'quality-check' ? 'selected' : '' %>>Quality Check</option>
                            <option value="inventory" <%= filters.category === 'inventory' ? 'selected' : '' %>>Inventory</option>
                            <option value="shipping" <%= filters.category === 'shipping' ? 'selected' : '' %>>Shipping</option>
                            <option value="general" <%= filters.category === 'general' ? 'selected' : '' %>>General</option>
                        </select>
                        <label for="category">Category</label>
                    </div>

                    <div class="form-floating">
                        <select class="form-select" id="sortBy" name="sortBy">
                            <option value="dueDate" <%= filters.sortBy === 'dueDate' ? 'selected' : '' %>>Due Date</option>
                            <option value="priority" <%= filters.sortBy === 'priority' ? 'selected' : '' %>>Priority</option>
                            <option value="createdAt" <%= filters.sortBy === 'createdAt' ? 'selected' : '' %>>Created Date</option>
                            <option value="title" <%= filters.sortBy === 'title' ? 'selected' : '' %>>Title</option>
                        </select>
                        <label for="sortBy">Sort By</label>
                    </div>

                    <div>
                        <button type="submit" class="btn btn-outline-primary me-2">Filter</button>
                        <button type="button" class="btn btn-create-task" data-bs-toggle="modal" data-bs-target="#taskModal">
                            <i class="fas fa-plus"></i> New Task
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Tasks List -->
        <div class="row">
            <div class="col-12">
                <% if (tasks.length === 0) { %>
                    <div class="text-center py-5">
                        <h4 class="text-muted">No tasks found</h4>
                        <p class="text-muted">Create your first task to get started!</p>
                        <button class="btn btn-create-task" data-bs-toggle="modal" data-bs-target="#taskModal">
                            <i class="fas fa-plus"></i> Create First Task
                        </button>
                    </div>
                <% } else { %>
                    <% tasks.forEach(function(task) { 
                        const daysUntil = Math.ceil((new Date(task.dueDate) - currentDate) / (1000 * 60 * 60 * 24));
                        const isOverdue = daysUntil < 0;
                        const isDueSoon = daysUntil >= 0 && daysUntil <= 3;
                    %>
                        <div class="task-card priority-<%= task.priority %> <%= isOverdue ? 'overdue' : '' %> <%= isDueSoon ? 'due-soon' : '' %>" 
                             data-task-created="<%= task.createdAt %>" 
                             data-task-due="<%= task.dueDate %>">
                            <div class="task-header">
                                <div class="flex-grow-1">
                                    <div class="task-title"><%= task.title %></div>
                                    <div class="task-meta">
                                        <span class="priority-badge priority-<%= task.priority %>">
                                            <%= task.priority.charAt(0).toUpperCase() + task.priority.slice(1) %>
                                        </span>
                                        <span class="status-badge status-<%= task.status %>">
                                            <%= task.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) %>
                                        </span>
                                        <span class="days-until <%= isOverdue ? 'overdue' : isDueSoon ? 'due-soon' : '' %>">
                                            <i class="fas fa-calendar"></i>
                                            <% if (isOverdue) { %>
                                                <%= Math.abs(daysUntil) %> days overdue
                                            <% } else if (daysUntil === 0) { %>
                                                Due today
                                            <% } else if (daysUntil === 1) { %>
                                                Due tomorrow
                                            <% } else { %>
                                                Due in <%= daysUntil %> days
                                            <% } %>
                                        </span>
                                        <% if (task.assignedTo) { %>
                                            <span><i class="fas fa-user"></i> <%= task.assignedTo %></span>
                                        <% } %>
                                        <span><i class="fas fa-tag"></i> <%= task.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) %></span>
                                    </div>
                                </div>
                            </div>

                            <% if (task.description) { %>
                                <div class="task-description text-muted mb-2">
                                    <%= task.description %>
                                </div>
                            <% } %>

                            <% if (task.relatedPOs && task.relatedPOs.length > 0) { %>
                                <div class="related-items">
                                    <strong>Related POs:</strong>
                                    <% task.relatedPOs.forEach(function(po) { %>
                                        <a href="/purchase-orders?poNumber=<%= po.poNumber %>" class="related-po">
                                            <%= po.poNumber %> (<%= po.vendor %>)
                                        </a>
                                    <% }); %>
                                </div>
                            <% } %>

                            <% if (task.relatedVendors && task.relatedVendors.length > 0) { %>
                                <div class="related-items">
                                    <strong>Related Vendors:</strong>
                                    <% task.relatedVendors.forEach(function(vendor, index) { %>
                                        <span class="related-vendor"><%= vendor %></span><% if (index < task.relatedVendors.length - 1) { %>, <% } %>
                                    <% }); %>
                                </div>
                            <% } %>

                            <% if (task.relatedSeeds && task.relatedSeeds.length > 0) { %>
                                <div class="related-items">
                                    <strong>Related Seeds:</strong>
                                    <% task.relatedSeeds.forEach(function(seed, index) { %>
                                        <%= seed.itemName %><% if (seed.sku) { %> (<%= seed.sku %>)<% } %><% if (index < task.relatedSeeds.length - 1) { %>, <% } %>
                                    <% }); %>
                                </div>
                            <% } %>

                            <% if (task.tags && task.tags.length > 0) { %>
                                <div class="task-tags">
                                    <% task.tags.forEach(function(tag) { %>
                                        <span class="task-tag"><%= tag %></span>
                                    <% }); %>
                                </div>
                            <% } %>

                            <div class="task-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editTask('<%= task._id %>')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <% if (task.status !== 'completed') { %>
                                    <button class="btn btn-sm btn-outline-success" onclick="markCompleted('<%= task._id %>')">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                <% } %>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('<%= task._id %>')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalTitle">Create New Task</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId" name="taskId">
                        
                        <!-- Vendor suggestions datalist -->
                        <datalist id="vendorSuggestions">
                            <option value="SLOOT FARM">
                            <option value="NEW WORLD TRUFFIERES">
                            <option value="MEADOWLARK HEARTH">
                            <option value="SEED SAVERS EXCHANGE">
                            <option value="JOHNNY'S SEEDS">
                            <option value="HIGH MOWING SEEDS">
                            <option value="SOUTHERN EXPOSURE">
                            <option value="FEDCO SEEDS">
                        </datalist>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="title" name="title" required>
                                    <label for="title">Task Title *</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="priority" name="priority" required>
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                    </select>
                                    <label for="priority">Priority</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-floating">
                                <textarea class="form-control" id="description" name="description" style="height: 100px;"></textarea>
                                <label for="description">Description</label>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="general">General</option>
                                        <option value="seed-sourcing">Seed Sourcing</option>
                                        <option value="po-management">PO Management</option>
                                        <option value="vendor-contact">Vendor Contact</option>
                                        <option value="quality-check">Quality Check</option>
                                        <option value="inventory">Inventory</option>
                                        <option value="shipping">Shipping</option>
                                    </select>
                                    <label for="category">Category</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="dueDate" name="dueDate" required>
                                    <label for="dueDate">Due Date *</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="assignedTo" name="assignedTo">
                                    <label for="assignedTo">Assigned To</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="datetime-local" class="form-control" id="reminderDate" name="reminderDate">
                                    <label for="reminderDate">Reminder Date</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="estimatedHours" name="estimatedHours" min="0" step="0.5">
                                    <label for="estimatedHours">Estimated Hours</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="tags" name="tags" placeholder="e.g., urgent, seeds, vendor">
                                <label for="tags">Tags (comma-separated)</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Related Purchase Orders</label>
                            <div id="relatedPOsContainer">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addRelatedPO()">
                                    <i class="fas fa-plus"></i> Add PO
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Related Vendors</label>
                            <div id="relatedVendorsContainer">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addRelatedVendor()">
                                    <i class="fas fa-plus"></i> Add Vendor
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Related Seeds</label>
                            <div id="relatedSeedsContainer">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addRelatedSeed()">
                                    <i class="fas fa-plus"></i> Add Seed
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="handleCancelButton()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-submit filters when changed
        document.querySelectorAll('#filterForm select, #filterForm input').forEach(element => {
            element.addEventListener('change', function() {
                if (this.type !== 'text') {
                    document.getElementById('filterForm').submit();
                }
            });
        });

        // Search with delay
        let searchTimeout;
        document.getElementById('search').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                document.getElementById('filterForm').submit();
            }, 500);
        });

        // Set default due date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dueDate').value = today;
        });

        // Handle cancel button to return to previous dashboard
        function handleCancelButton() {
            const returnUrl = sessionStorage.getItem('taskReturnUrl');
            if (returnUrl) {
                sessionStorage.removeItem('taskReturnUrl');
                console.log('üîÑ Cancel: Redirecting back to:', returnUrl);
                window.location.href = returnUrl;
            }
            // If no return URL, just close modal (default Bootstrap behavior)
        }

        // Task management functions
        async function saveTask() {
            const form = document.getElementById('taskForm');
            const formData = new FormData(form);
            const taskId = formData.get('taskId');
            
            const taskData = Object.fromEntries(formData.entries());
            
            // Debug: Log the form data
            console.log('üìù Form data being sent:', taskData);
            
            // Collect related PO numbers
            const relatedPONumbers = [];
            const poInputs = document.querySelectorAll('input[name="relatedPONumber"]');
            poInputs.forEach(input => {
                if (input.value.trim()) {
                    relatedPONumbers.push(input.value.trim());
                }
            });
            taskData.relatedPONumbers = relatedPONumbers;
            console.log('üîó Related PO Numbers:', relatedPONumbers);
            
            // Collect related vendors
            const relatedVendors = [];
            const vendorInputs = document.querySelectorAll('input[name="relatedVendor"]');
            vendorInputs.forEach(input => {
                if (input.value.trim()) {
                    relatedVendors.push(input.value.trim());
                }
            });
            taskData.relatedVendors = relatedVendors;
            
            // Collect related seeds
            const relatedSeeds = [];
            const seedCards = document.querySelectorAll('#relatedSeedsContainer .card');
            seedCards.forEach(card => {
                const itemName = card.querySelector('input[name="seedItemName"]')?.value?.trim();
                const sku = card.querySelector('input[name="seedSku"]')?.value?.trim();
                const quantity = card.querySelector('input[name="seedQuantity"]')?.value?.trim();
                const unit = card.querySelector('select[name="seedUnit"]')?.value;
                
                if (itemName || sku) {
                    relatedSeeds.push({
                        itemName: itemName || '',
                        sku: sku || '',
                        quantity: quantity ? parseInt(quantity) : 0,
                        unit: unit || 'each'
                    });
                }
            });
            taskData.relatedSeeds = relatedSeeds;
            
            console.log('üìã Final task data to send:', taskData);
            
            try {
                const url = taskId ? `/tasks/${taskId}` : '/tasks/create';
                const method = taskId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Don't reload immediately, let the caller handle navigation
                    return { success: true, result };
                } else {
                    alert('Error saving task: ' + result.error);
                    return { success: false, error: result.error };
                }
            } catch (error) {
                console.error('Save task error:', error);
                alert('Error saving task');
                return { success: false, error: error.message };
            }
        }

        async function editTask(taskId) {
            try {
                const response = await fetch(`/tasks/${taskId}`);
                const result = await response.json();
                
                if (result.success) {
                    const task = result.task;
                    
                    // Populate form
                    document.getElementById('taskId').value = task._id;
                    document.getElementById('title').value = task.title;
                    document.getElementById('description').value = task.description || '';
                    document.getElementById('priority').value = task.priority;
                    document.getElementById('category').value = task.category;
                    document.getElementById('dueDate').value = task.dueDate.split('T')[0];
                    document.getElementById('assignedTo').value = task.assignedTo || '';
                    document.getElementById('estimatedHours').value = task.estimatedHours || '';
                    document.getElementById('tags').value = task.tags ? task.tags.join(', ') : '';
                    
                    if (task.reminderDate) {
                        const reminderDate = new Date(task.reminderDate);
                        document.getElementById('reminderDate').value = reminderDate.toISOString().slice(0, 16);
                    }
                    
                    // Clear and populate related POs
                    const relatedPOsContainer = document.getElementById('relatedPOsContainer');
                    // Remove all existing PO inputs (keep only the "Add Related PO" button)
                    const existingInputs = relatedPOsContainer.querySelectorAll('.input-group');
                    existingInputs.forEach(input => input.remove());
                    
                    // Add existing related POs to the form
                    if (task.relatedPOs && task.relatedPOs.length > 0) {
                        task.relatedPOs.forEach(po => {
                            const poDiv = document.createElement('div');
                            poDiv.className = 'input-group mb-2';
                            poDiv.innerHTML = `
                                <input type="text" class="form-control" name="relatedPONumber" placeholder="Enter PO Number (e.g., PO10946)" 
                                       value="${po.poNumber}" oninput="clearValidation(this)" onblur="validatePO(this)">
                                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            relatedPOsContainer.insertBefore(poDiv, relatedPOsContainer.lastElementChild);
                        });
                    }
                    
                    // Clear and populate related vendors
                    const relatedVendorsContainer = document.getElementById('relatedVendorsContainer');
                    // Remove all existing vendor inputs (keep only the "Add Vendor" button)
                    const existingVendorInputs = relatedVendorsContainer.querySelectorAll('.input-group');
                    existingVendorInputs.forEach(input => input.remove());
                    
                    // Add existing related vendors to the form
                    if (task.relatedVendors && task.relatedVendors.length > 0) {
                        task.relatedVendors.forEach(vendor => {
                            const vendorDiv = document.createElement('div');
                            vendorDiv.className = 'input-group mb-2';
                            vendorDiv.innerHTML = `
                                <input type="text" class="form-control" name="relatedVendor" placeholder="Enter Vendor Name" 
                                       value="${vendor}" list="vendorSuggestions">
                                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            relatedVendorsContainer.insertBefore(vendorDiv, relatedVendorsContainer.lastElementChild);
                        });
                    }
                    
                    document.getElementById('taskModalTitle').textContent = 'Edit Task';
                    new bootstrap.Modal(document.getElementById('taskModal')).show();
                }
            } catch (error) {
                console.error('Edit task error:', error);
                alert('Error loading task');
            }
        }

        async function markCompleted(taskId) {
            try {
                const response = await fetch(`/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'completed' })
                });

                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error updating task: ' + result.error);
                }
            } catch (error) {
                console.error('Complete task error:', error);
                alert('Error completing task');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error deleting task: ' + result.error);
                }
            } catch (error) {
                console.error('Delete task error:', error);
                alert('Error deleting task');
            }
        }

        function addRelatedPO() {
            // Create PO selection interface
            const container = document.getElementById('relatedPOsContainer');
            const poDiv = document.createElement('div');
            poDiv.className = 'input-group mb-2';
            poDiv.innerHTML = `
                <input type="text" class="form-control" name="relatedPONumber" placeholder="Enter PO Number (e.g., PO10946)" 
                       oninput="clearValidation(this)" onblur="validatePO(this)">
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.insertBefore(poDiv, container.lastElementChild);
        }

        function addRelatedVendor() {
            // Create vendor input interface
            const container = document.getElementById('relatedVendorsContainer');
            const vendorDiv = document.createElement('div');
            vendorDiv.className = 'input-group mb-2';
            vendorDiv.innerHTML = `
                <input type="text" class="form-control" name="relatedVendor" placeholder="Enter Vendor Name" 
                       list="vendorSuggestions">
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.insertBefore(vendorDiv, container.lastElementChild);
        }

        function addRelatedSeed() {
            // Create seed input interface
            const container = document.getElementById('relatedSeedsContainer');
            const seedDiv = document.createElement('div');
            seedDiv.className = 'card mb-2';
            seedDiv.innerHTML = `
                <div class="card-body p-2">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" name="seedItemName" placeholder="Item Name">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm" name="seedSku" placeholder="SKU">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control form-control-sm" name="seedQuantity" placeholder="Qty">
                        </div>
                        <div class="col-md-2">
                            <select class="form-control form-control-sm" name="seedUnit">
                                <option value="lbs">lbs</option>
                                <option value="oz">oz</option>
                                <option value="each">each</option>
                                <option value="packets">packets</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.card').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.insertBefore(seedDiv, container.lastElementChild);
        }

        // Clear validation state while typing
        function clearValidation(input) {
            input.classList.remove('is-valid', 'is-invalid');
            input.title = '';
        }

        // Validate PO number exists
        async function validatePO(input) {
            const poNumber = input.value.trim();
            
            // Clear validation if empty
            if (!poNumber) {
                input.classList.remove('is-valid', 'is-invalid');
                input.title = '';
                return;
            }

            // Show loading state
            input.classList.remove('is-valid', 'is-invalid');
            input.title = 'Validating...';

            try {
                const response = await fetch(`/purchase-orders/api/validate-po/${poNumber}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.exists) {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    input.title = `‚úì Valid PO - Vendor: ${data.po.vendor || 'Unknown'}`;
                } else {
                    input.classList.remove('is-valid');
                    input.classList.add('is-invalid');
                    input.title = '‚úó PO not found in database';
                }
            } catch (error) {
                console.error('Error validating PO:', error);
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                input.title = '‚úó Error validating PO - check connection';
            }
        }

        // Clear form when modal is hidden
        document.getElementById('taskModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskModalTitle').textContent = 'Create New Task';
            
            // Reset due date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dueDate').value = today;
            
            // Clear related POs container (remove all input groups, keep only the "Add Related PO" button)
            const relatedPOsContainer = document.getElementById('relatedPOsContainer');
            const existingInputs = relatedPOsContainer.querySelectorAll('.input-group');
            existingInputs.forEach(input => input.remove());
            
            // Clear related vendors container (remove all input groups, keep only the "Add Vendor" button)
            const relatedVendorsContainer = document.getElementById('relatedVendorsContainer');
            const existingVendorInputs = relatedVendorsContainer.querySelectorAll('.input-group');
            existingVendorInputs.forEach(input => input.remove());
        });

        // Handle URL parameters for task management from other dashboards
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if we should create a task for a specific PO
            if (urlParams.has('createTaskForPO')) {
                const poId = urlParams.get('createTaskForPO');
                const poNumber = urlParams.get('poNumber');
                const returnUrl = urlParams.get('returnUrl');
                
                console.log('üéØ Creating task for PO:', poNumber);
                
                // Pre-fill the form with PO information
                setTimeout(() => {
                    // Set task title with PO reference
                    document.getElementById('title').value = `Task for ${poNumber}`;
                    
                    // Add the PO to related POs
                    addRelatedPO();
                    const poInputs = document.querySelectorAll('input[name="relatedPONumber"]');
                    if (poInputs.length > 0) {
                        poInputs[poInputs.length - 1].value = poNumber;
                    }
                    
                    // Set category to PO management
                    document.getElementById('category').value = 'po-management';
                    
                    // Store return URL for later use
                    if (returnUrl) {
                        sessionStorage.setItem('taskReturnUrl', returnUrl);
                    }
                    
                    // Open the task creation modal
                    document.getElementById('taskModalTitle').textContent = `Create Task for ${poNumber}`;
                    new bootstrap.Modal(document.getElementById('taskModal')).show();
                }, 500);
            }
            
            // Check if we should edit a specific task
            if (urlParams.has('editTask')) {
                const taskId = urlParams.get('editTask');
                const returnUrl = urlParams.get('returnUrl');
                
                console.log('‚úèÔ∏è Editing task:', taskId);
                
                if (returnUrl) {
                    sessionStorage.setItem('taskReturnUrl', returnUrl);
                }
                
                // Trigger edit task after a short delay to ensure page is loaded
                setTimeout(() => {
                    editTask(taskId);
                }, 500);
            }
        });

        // Override the saveTask function to handle return navigation
        document.addEventListener('DOMContentLoaded', function() {
            const originalSaveTask = window.saveTask;
            
            window.saveTask = async function() {
                const result = await originalSaveTask();
                
                if (result && result.success) {
                    // After successful save, check if we should redirect back
                    const returnUrl = sessionStorage.getItem('taskReturnUrl');
                    if (returnUrl) {
                        sessionStorage.removeItem('taskReturnUrl');
                        console.log('üîÑ Redirecting back to:', returnUrl);
                        // Add a small delay to ensure the save is complete
                        setTimeout(() => {
                            window.location.href = returnUrl;
                        }, 1000);
                    } else {
                        // Default behavior - reload the page
                        location.reload();
                    }
                }
                
                return result;
            };
        });

        // Add a back button to the modal when coming from another dashboard
        function addBackButtonToModal() {
            const returnUrl = sessionStorage.getItem('taskReturnUrl');
            if (returnUrl) {
                const modalFooter = document.querySelector('#taskModal .modal-footer');
                const backButton = document.createElement('button');
                backButton.type = 'button';
                backButton.className = 'btn btn-outline-secondary me-auto';
                backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Dashboard';
                backButton.onclick = function() {
                    sessionStorage.removeItem('taskReturnUrl');
                    window.location.href = returnUrl;
                };
                modalFooter.insertBefore(backButton, modalFooter.firstChild);
            }
        }

        // Add back button when modal is shown
        document.getElementById('taskModal').addEventListener('shown.bs.modal', function() {
            addBackButtonToModal();
        });

        // Remove back button when modal is hidden
        document.getElementById('taskModal').addEventListener('hidden.bs.modal', function() {
            const backButton = document.querySelector('#taskModal .btn-outline-secondary');
            if (backButton && backButton.innerHTML.includes('Back to Dashboard')) {
                backButton.remove();
            }
        });

        // Navigation Functions
        function closeAllDropdowns() {
            // Close all accordion dropdowns
            const accordions = document.querySelectorAll('.nav-accordion-content');
            accordions.forEach(accordion => {
                accordion.classList.remove('show');
            });
            
            // Close imports dropdown
            const importsDropdown = document.getElementById('importsDropdown');
            if (importsDropdown) {
                importsDropdown.classList.remove('show');
            }
            
            // Reset all icons
            const accordionIcons = document.querySelectorAll('.accordion-icon');
            accordionIcons.forEach(icon => {
                icon.classList.remove('rotated');
            });
            const importsIcon = document.querySelector('.nav-imports-btn .dropdown-icon');
            if (importsIcon) {
                importsIcon.classList.remove('rotated');
            }
        }

        function toggleAccordion(accordionId) {
            // Close all other dropdowns first
            closeAllDropdowns();
            
            const content = document.getElementById(accordionId);
            const button = document.querySelector(`button[onclick="toggleAccordion('${accordionId}')"]`);
            const icon = button ? button.querySelector('.accordion-icon') : null;

            if (content) {
                content.classList.toggle('show');
            }
            if (icon) {
                icon.classList.toggle('rotated');
            }
        }

        function toggleImportsDropdown() {
            // Close all other dropdowns first
            closeAllDropdowns();
            
            const content = document.getElementById('importsDropdown');
            const icon = document.querySelector('.nav-imports-btn .dropdown-icon');

            content.classList.toggle('show');
            icon.classList.toggle('rotated');
        }

        function openNetSuiteImportModal() {
            alert('NetSuite Import Modal functionality would be implemented here for the Tasks Dashboard');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            const navigationContainer = document.querySelector('.navigation-container');
            
            // If click is outside navigation container, close all dropdowns/accordions
            if (navigationContainer && !navigationContainer.contains(event.target)) {
                closeAllDropdowns();
            }
        });

        // Quick filter functionality
        function applyQuickFilter(filterType) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Update button styles
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.style.background = '#e8eaf6';
                btn.style.color = '#5e35b1';
                btn.style.border = '1px solid #5e35b1';
                btn.style.fontWeight = '500';
            });
            
            const activeBtn = document.getElementById(
                filterType === 'today' ? 'quickTodayBtn' : 
                filterType === 'high' ? 'quickHighBtn' : 
                filterType === 'oldest' ? 'quickOldestBtn' : 
                'quickAllBtn'
            );
            if (activeBtn) {
                activeBtn.style.background = '#5e35b1';
                activeBtn.style.color = 'white';
                activeBtn.style.border = '1px solid #5e35b1';
                activeBtn.style.fontWeight = '600';
            }
            
            // Build query parameters based on filter type
            let url = '/tasks?';
            
            if (filterType === 'today') {
                // Tasks due today - use search parameter to filter client-side
                url += 'quickFilter=today';
            } else if (filterType === 'high') {
                // High and critical priority
                url += 'priority=high&quickFilter=highPriority';
            } else if (filterType === 'oldest') {
                // Sort by oldest creation date
                url += 'sortBy=createdAt&sortOrder=asc&quickFilter=oldest';
            } else {
                // All tasks with default sorting
                url += 'sortBy=dueDate&sortOrder=asc';
            }
            
            window.location.href = url;
        }

        // Check if quick filter is active on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const quickFilter = urlParams.get('quickFilter');
            
            if (quickFilter === 'today') {
                // Filter tasks that are created today or due today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                document.querySelectorAll('.task-card').forEach(card => {
                    const taskData = card.getAttribute('data-task-created');
                    const taskDue = card.getAttribute('data-task-due');
                    
                    const createdDate = taskData ? new Date(taskData) : null;
                    if (createdDate) createdDate.setHours(0, 0, 0, 0);
                    
                    const dueDate = taskDue ? new Date(taskDue) : null;
                    if (dueDate) dueDate.setHours(0, 0, 0, 0);
                    
                    const isToday = (createdDate && createdDate.getTime() === today.getTime()) || 
                                   (dueDate && dueDate.getTime() === today.getTime());
                    
                    if (!isToday) {
                        card.style.display = 'none';
                    }
                });
                
                document.getElementById('quickTodayBtn').style.background = '#5e35b1';
                document.getElementById('quickTodayBtn').style.color = 'white';
                document.getElementById('quickTodayBtn').style.fontWeight = '600';
            } else if (quickFilter === 'highPriority') {
                document.getElementById('quickHighBtn').style.background = '#5e35b1';
                document.getElementById('quickHighBtn').style.color = 'white';
                document.getElementById('quickHighBtn').style.fontWeight = '600';
            } else if (quickFilter === 'oldest') {
                document.getElementById('quickOldestBtn').style.background = '#5e35b1';
                document.getElementById('quickOldestBtn').style.color = 'white';
                document.getElementById('quickOldestBtn').style.fontWeight = '600';
            }
        });
    </script>
</body>
</html>
