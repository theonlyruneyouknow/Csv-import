<!DOCTYPE html>
<html>

<head>
    <title>Purchase Orders Dashboard</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            padding-top: 80px;
            /* Space for sticky header */
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            padding: 0 15px;
        }

        @media (min-width: 1920px) {
            .container {
                max-width: 98%;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .header.scrolled {
            padding: 8px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .header.scrolled h1 {
            font-size: 1.3rem;
            margin: 0;
        }

        .header h1 {
            transition: font-size 0.3s ease;
            margin: 0;
        }

        /* Enhanced Navigation Styles */
        .navigation-container {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        /* User Profile Styles */
        .user-profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #dee2e6;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .user-dropdown {
            position: relative;
            display: inline-block;
        }

        .user-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 280px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1001;
            border: 1px solid #dee2e6;
            margin-top: 10px;
        }

        .user-dropdown-content.show {
            display: block;
        }

        .user-dropdown-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-info strong {
            font-size: 18px;
            color: #212529;
            font-weight: 600;
            display: block;
        }

        .user-info .user-role {
            color: #6c757d;
            font-size: 14px;
            display: block;
        }

        .user-info .user-status {
            color: #28a745;
            font-size: 13px;
            display: block;
            font-weight: 500;
        }

        .user-dropdown-item {
            padding: 14px 20px;
            color: #495057;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            font-size: 15px;
            border: none;
            background: white;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .user-dropdown-item:hover {
            background: #f8f9fa;
        }

        .user-dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .user-dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #e9ecef;
        }

        .dropdown-icon {
            font-size: 18px;
            width: 20px;
            display: inline-block;
            text-align: center;
        }

        .user-dropdown-item.logout:hover {
            background: #fff5f5;
        }

        .nav-section {
            position: relative;
        }

        /* Accordion Styles */
        .nav-accordion-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 120px;
            justify-content: space-between;
        }

        .nav-accordion-btn:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-accordion-content {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            border: 1px solid #dee2e6;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            margin-top: 5px;
        }

        .nav-accordion-content.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-accordion-item {
            display: block;
            padding: 12px 16px;
            color: #495057;
            text-decoration: none;
            border-bottom: 1px solid #f1f3f4;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .nav-accordion-item:last-child {
            border-bottom: none;
            border-radius: 0 0 6px 6px;
        }

        .nav-accordion-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .nav-accordion-item:hover {
            background: #f8f9fa;
            color: #28a745;
            text-decoration: none;
            padding-left: 20px;
        }

        /* Options Button Styles */
        .nav-options-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 100px;
            justify-content: space-between;
        }

        .nav-options-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Imports Button Styles */
        .nav-imports-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 100px;
            justify-content: space-between;
        }

        .nav-imports-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Forms Button Styles */
        .nav-forms-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 100px;
            justify-content: space-between;
        }

        .nav-forms-btn:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Dropdown Styles */
        .nav-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            border: 1px solid #dee2e6;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            margin-top: 5px;
        }

        .nav-dropdown-content.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #495057;
            text-decoration: none;
            border-bottom: 1px solid #f1f3f4;
            transition: all 0.2s ease;
            font-size: 14px;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .nav-dropdown-item:last-child {
            border-bottom: none;
            border-radius: 0 0 6px 6px;
        }

        .nav-dropdown-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .nav-dropdown-item:hover {
            background: #f8f9fa;
            color: #007bff;
            text-decoration: none;
            padding-left: 20px;
        }

        /* Icon animations */
        .accordion-icon,
        .dropdown-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .accordion-icon.rotated,
        .dropdown-icon.rotated {
            transform: rotate(180deg);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .navigation-container {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }

            .nav-section {
                width: 100%;
            }

            .nav-accordion-btn,
            .nav-options-btn,
            .nav-imports-btn {
                width: 100%;
                justify-content: space-between;
            }

            .nav-accordion-content,
            .nav-dropdown-content {
                position: static;
                min-width: 100%;
                margin-top: 0;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }

        /* Hide old button styles */
        .manage-status-btn,
        .notes-manager-btn {
            display: none;
        }

        /* NetSuite Import Modal Styles */
        .netsuite-import-modal {
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .netsuite-import-modal textarea {
            width: 100%;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .netsuite-import-modal .form-group {
            margin-bottom: 20px;
        }

        .netsuite-import-modal .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .netsuite-import-modal select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .netsuite-import-modal .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .netsuite-import-modal .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .netsuite-import-modal .btn-primary {
            background: #007bff;
            color: white;
        }

        .netsuite-import-modal .btn-primary:hover {
            background: #0056b3;
        }

        .netsuite-import-modal .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .netsuite-import-modal .btn-secondary:hover {
            background: #545b62;
        }

        .netsuite-import-modal .btn-info {
            background: #17a2b8;
            color: white;
        }

        .netsuite-import-modal .btn-info:hover {
            background: #138496;
        }

        .import-mode-options {
            margin-top: 10px;
        }

        /* Preview Modal Styles */
        .preview-modal-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #f8f9fa;
        }

        /* Ensure modal body stays as flex container */
        #netsuitePreviewModal .modal-body {
            overflow: hidden !important;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        .preview-table th,
        .preview-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #dee2e6;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .preview-table tr.new-item {
            background: #d4edda;
        }

        .preview-table tr.updated-item {
            background: #fff3cd;
        }

        .preview-table tr.removed-item {
            background: #f8d7da;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .preview-table tr.unchanged-item {
            background: #f8f9fa;
        }

        .preview-diff {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .preview-old-value {
            color: #dc3545;
            text-decoration: line-through;
            font-size: 12px;
        }

        .preview-new-value {
            color: #28a745;
            font-weight: 600;
        }

        .preview-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .preview-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .preview-legend-box {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .preview-warning {
            padding: 12px 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .preview-warning h4 {
            margin: 0 0 8px 0;
            color: #856404;
            font-size: 14px;
        }

        .preview-warning ul {
            margin: 0;
            padding-left: 20px;
            color: #856404;
        }

        .preview-error {
            padding: 12px 15px;
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .preview-error h4 {
            margin: 0 0 8px 0;
            color: #721c24;
            font-size: 14px;
        }

        .preview-error ul {
            margin: 0;
            padding-left: 20px;
            color: #721c24;
        }

        .preview-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .preview-summary-item {
            padding: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .preview-summary-item strong {
            display: block;
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .preview-summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .preview-summary-item.new .value {
            color: #28a745;
        }

        .preview-summary-item.updated .value {
            color: #ffc107;
        }

        .preview-summary-item.removed .value {
            color: #dc3545;
        }

        .checkbox-label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 2px;
            transform: scale(1.2);
        }

        .option-description {
            font-size: 12px;
            color: #666;
            margin: 0;
            padding-left: 22px;
            line-height: 1.4;
        }

        .option-description strong {
            color: #333;
        }

        .upload-btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
        }

        /* Filters Section */
        .filters {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky;
            top: 80px;
            /* Below the header */
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .filter-row.actions-row {
            grid-template-columns: repeat(6, 1fr);
        }

        #advancedFiltersRow {
            grid-template-columns: repeat(4, 1fr);
            background: #f0f0f5;
            padding: 10px;
            border-radius: 4px;
        }

        #advancedFiltersToggle {
            transition: all 0.2s ease;
        }

        #advancedFiltersToggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .filters.scrolled {
            padding: 8px 12px;
            top: 60px;
            /* Adjust for compact header */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            gap: 8px;
        }

        .filters.scrolled .filter-row {
            gap: 8px;
        }

        .filters.scrolled .filter-group label {
            font-size: 9px;
            margin-bottom: 2px;
        }

        .filters.scrolled .filter-group input,
        .filters.scrolled .filter-group select {
            padding: 4px 6px;
            font-size: 12px;
        }

        .filters.scrolled .clear-filters,
        .filters.scrolled .btn {
            padding: 5px 8px;
            font-size: 11px;
            margin-top: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .filter-group input,
        .filter-group select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Search input wrapper for clear button */
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input-wrapper input {
            flex: 1;
            padding-right: 35px;
        }

        .search-clear-btn {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            color: #6c757d;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            transition: color 0.2s;
            display: none;
        }

        .search-clear-btn:hover {
            color: #dc3545;
        }

        .search-clear-btn.visible {
            display: block;
        }

        /* Search History Dropdown */
        .search-history-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: -1px;
        }

        .search-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
            font-weight: bold;
            color: #495057;
        }

        .clear-history-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .clear-history-btn:hover {
            background: #f8d7da;
        }

        .search-history-dropdown ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .search-history-dropdown li {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            color: #333;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-history-dropdown li:last-child {
            border-bottom: none;
        }

        .search-history-dropdown li:hover {
            background: #f8f9fa;
        }

        .search-history-item-text {
            flex: 1;
        }

        .search-history-item-icon {
            color: #6c757d;
            font-size: 11px;
            margin-left: 8px;
        }

        .search-history-empty {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 13px;
            font-style: italic;
        }

        /* Action buttons in filter grid */
        .filter-group.filter-actions {
            display: flex;
            align-items: flex-end;
            padding-top: 15px;
        }

        .filter-group.filter-actions button {
            width: 100%;
            padding: 6px 10px;
            font-size: 13px;
        }

        .clear-filters {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 13px;
        }

        .clear-filters:hover {
            background: #5a6268;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Sticky Table Headers */
        #purchaseOrdersTable thead {
            position: sticky;
            top: 140px;
            /* Below header (60px compact) + filters (varies) */
            z-index: 998;
            /* Below filters (999) */
            transition: top 0.3s ease;
        }

        /* Adjust sticky position when filters are compact */
        .filters.scrolled~table thead,
        .filters.scrolled~div table thead {
            top: 110px;
            /* Compact header (60px) + compact filters (~50px) */
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th:hover {
            background-color: #e9ecef;
        }

        th.sortable::after {
            content: ' ↕️';
            font-size: 12px;
            color: #6c757d;
        }

        th.sort-asc::after {
            content: ' ↑';
            color: #007bff;
        }

        th.sort-desc::after {
            content: ' ↓';
            color: #007bff;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        tr.hidden {
            display: none;
        }

        /* Improved font sizes - 16px for better readability */
        .notes-cell {
            min-width: 200px;
            position: relative;
        }

        /* Enhanced Notes Styles - Notes appear below the row */
        .notes-row {
            display: none;
            /* Hidden by default */
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }

        .notes-row.expanded {
            display: table-row;
        }

        /* Enhanced Tracking Styles - Tracking appears below the row */
        .tracking-row {
            display: none;
            /* Hidden by default */
            background: #f0f8ff;
            border-left: 4px solid #17a2b8;
        }

        .tracking-row.expanded {
            display: table-row;
        }

        /* Line Items Count Column Styles */
        .line-items-count-cell {
            width: 80px;
            text-align: center;
            padding: 8px 4px;
            vertical-align: middle;
        }

        .line-items-count-display,
        .no-line-items-display {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .line-items-count-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 50px;
            justify-content: center;
        }

        .line-items-count-btn:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .line-items-count-btn .count-number {
            font-weight: 700;
            font-size: 15px;
        }

        .import-netsuite-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 36px;
        }

        .import-netsuite-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .update-netsuite-btn {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-left: 4px;
            min-width: 30px;
            min-height: 30px;
        }

        .update-netsuite-btn:hover {
            background: #e0a800;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Responsive design for Line Items column */
        @media (max-width: 768px) {
            .line-items-count-cell {
                width: 60px;
                padding: 4px 2px;
            }

            .line-items-count-btn,
            .import-netsuite-btn,
            .update-netsuite-btn {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 35px;
                min-height: 30px;
            }

            .update-netsuite-btn {
                margin-left: 2px;
                min-width: 25px;
                min-height: 25px;
                font-size: 11px;
            }

            .line-items-count-btn .count-number {
                font-size: 13px;
            }
        }

        /* Line Items Styles */
        .line-items-row {
            display: none;
            background: #f0f8ff;
            border-left: 4px solid #28a745;
        }

        .line-items-row.expanded {
            display: table-row;
        }

        .line-items-cell-expanded {
            padding: 15px;
            border: none;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .line-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
            padding: 15px;
            padding-bottom: 10px;
            background: white;
        }

        .line-items-title {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
        }

        .line-items-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .line-items-status {
            font-size: 12px;
            color: #28a745;
            font-weight: 500;
            margin-left: 10px;
        }

        .show-received-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .show-received-toggle:hover {
            background: #5a6268;
        }

        .show-received-toggle.active {
            background: #007bff;
        }

        .show-received-toggle.active:hover {
            background: #0056b3;
        }

        .line-items-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .line-items-close:hover {
            background: #5a6268;
        }

        .line-items-container {
            padding: 0;
        }

        .line-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .line-item.received {
            background: #f8f9fa;
            border-color: #28a745;
            border-left: 4px solid #28a745;
        }

        .line-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .line-item-date {
            font-size: 11px;
            color: #6c757d;
        }

        .line-item-status {
            display: flex;
            align-items: center;
        }

        .received-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .received-toggle:hover {
            background: #5a6268;
        }

        .received-toggle.received {
            background: #28a745;
        }

        .received-toggle.received:hover {
            background: #218838;
        }

        .line-item-memo {
            font-size: 13px;
            color: #495057;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .line-item-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .line-item-sku {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .line-item-sku label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
            margin: 0;
        }

        .sku-input {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .line-item-status-dropdown {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .line-item-status-dropdown label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
            margin: 0;
        }

        .item-status-select {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .line-item-tracking-input {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .line-item-tracking-input label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
            margin: 0;
        }

        .tracking-input {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .line-item-tracking-carrier {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .line-item-tracking-carrier label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
            margin: 0;
        }

        .carrier-select {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        /* Styles for tracking section without tracking number */
        .line-item-tracking.no-tracking {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .line-item-tracking.no-tracking .line-item-tracking-number {
            color: #856404;
        }

        /* Line item tracking styles */
        .line-item-tracking {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 8px;
            padding: 8px;
            background: #e3f2fd;
            border-radius: 4px;
            border-left: 3px solid #2196f3;
        }

        .line-item-tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .line-item-tracking-number {
            font-size: 11px;
            color: #1976d2;
            font-weight: 600;
        }

        .line-item-tracking-update-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .line-item-tracking-update-btn:hover {
            background: #1976d2;
        }

        .line-item-tracking-update-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .line-item-tracking-status {
            font-size: 11px;
            color: #424242;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .line-item-tracking-status .status-badge {
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .line-item-tracking-status .status-delivered {
            background: #e8f5e8;
            color: #2e7d2e;
        }

        .line-item-tracking-status .status-transit {
            background: #fff3cd;
            color: #856404;
        }

        .line-item-tracking-status .status-pending {
            background: #f8f9fa;
            color: #6c757d;
        }

        .line-item-tracking-status .status-alert {
            background: #f8d7da;
            color: #721c24;
        }

        .line-item-tracking-info {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        .line-item-notes {
            font-size: 12px;
            color: #495057;
            background: #e9ecef;
            padding: 6px 8px;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .line-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f1f3f4;
            font-size: 11px;
        }

        .line-item-eta {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .line-item-eta label {
            color: #6c757d;
            font-weight: 500;
            margin: 0;
        }

        .line-item-notes-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .line-item-notes-input label {
            color: #6c757d;
            font-weight: 500;
            margin: 0;
        }

        .notes-input {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            min-width: 150px;
        }

        .eta-input {
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 11px;
            color: #495057;
        }

        .eta-input:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .received-date {
            color: #28a745;
            font-weight: 500;
        }

        .line-item.received.hidden {
            display: none;
        }

        .all-received-message {
            text-align: center;
            padding: 20px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            color: #155724;
            font-weight: 500;
        }

        /* Line Items Table Styles */
        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
            background: white;
        }

        .line-items-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .line-items-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 11px;
            text-transform: uppercase;
            border-bottom: 2px solid #dee2e6;
        }

        .line-items-table td {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .line-items-table tbody tr:hover {
            background: #f8f9fa;
        }

        .line-items-table .line-item-row.received {
            background: #f0f9f0;
        }

        .line-items-table .line-item-row.received:hover {
            background: #e6f5e6;
        }

        .line-items-table .description-cell {
            max-width: 300px;
            white-space: normal;
            line-height: 1.4;
        }

        .line-items-table .received-cell {
            text-align: center;
            width: 80px;
        }

        .received-toggle-inline {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .received-toggle-inline:hover {
            background: #5a6268;
            transform: scale(1.1);
        }

        .received-toggle-inline.received {
            background: #28a745;
        }

        .received-toggle-inline.received:hover {
            background: #218838;
        }

        .line-items-table .status-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        .line-items-table .status-no-variances {
            background: #d4edda;
            color: #155724;
        }

        .line-items-summary {
            padding: 10px;
            background: #e7f5ff;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #004085;
        }

        /* EAD Combined Dropdown Styles for Line Items */
        .ead-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 160px;
        }

        .ead-dropdown {
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
        }

        .ead-value {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ead-dropdown:hover {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
        }

        .ead-dropdown.open {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
        }

        .ead-dropdown-arrow {
            font-size: 10px;
            color: #6c757d;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .ead-dropdown.open .ead-dropdown-arrow {
            transform: rotate(180deg);
        }

        .ead-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1050;
            min-width: 140px;
            width: auto;
            display: none;
            margin-top: 2px;
        }

        .ead-menu.show {
            display: block;
        }

        .ead-period-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
            min-width: 100px;
        }

        .ead-period-option:last-of-type {
            border-bottom: none;
        }

        .ead-period-option:hover {
            background: #e9ecef;
        }

        .ead-period-option .arrow {
            font-size: 10px;
            color: #6c757d;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .ead-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 140px;
            width: auto;
            display: none;
            z-index: 1051;
            margin-left: 2px;
        }

        .ead-period-option:hover .ead-submenu {
            display: block;
        }

        .ead-month-option {
            padding: 8px 16px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
            white-space: nowrap;
        }

        .ead-month-option:hover {
            background: #007bff;
            color: white;
        }

        .ead-clear-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
            color: #dc3545;
            font-weight: 500;
            border-top: 2px solid #e9ecef;
        }

        .ead-clear-option:hover {
            background: #f8d7da;
        }

        /* Fix overflow for table cells containing EAD dropdowns */
        td:has(.ead-container) {
            overflow: visible !important;
            position: relative;
        }

        /* Pre-Purchase Orders Styles */
        .pre-purchase-section {
            display: none;
            /* Hidden by default */
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .pre-purchase-section.show {
            display: block;
            /* Show when toggled */
        }

        .pre-purchase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pre-purchase-header h2 {
            margin: 0;
            color: #495057;
            font-size: 1.3em;
        }

        .add-pre-po-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .add-pre-po-btn:hover {
            background: #218838;
        }

        .pre-purchase-orders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .pre-po-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #6c757d;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .pre-po-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .pre-po-card.priority-urgent {
            border-left-color: #dc3545;
        }

        .pre-po-card.priority-high {
            border-left-color: #fd7e14;
        }

        .pre-po-card.priority-medium {
            border-left-color: #ffc107;
        }

        .pre-po-card.priority-low {
            border-left-color: #28a745;
        }

        .pre-po-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .pre-po-title {
            font-weight: 600;
            font-size: 16px;
            color: #212529;
            flex: 1;
            margin-right: 10px;
        }

        .pre-po-priority {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .pre-po-priority.urgent {
            background: #f8d7da;
            color: #721c24;
        }

        .pre-po-priority.high {
            background: #ffeaa7;
            color: #856404;
        }

        .pre-po-priority.medium {
            background: #fff3cd;
            color: #856404;
        }

        .pre-po-priority.low {
            background: #d4edda;
            color: #155724;
        }

        .pre-po-body {
            margin-bottom: 15px;
        }

        .pre-po-vendor {
            font-size: 14px;
            color: #495057;
            margin-bottom: 8px;
        }

        .pre-po-items {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 10px;
            line-height: 1.4;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #dee2e6;
            font-family: 'Courier New', monospace;
        }

        .pre-po-description {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .pre-po-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 12px;
            color: #6c757d;
        }

        .pre-po-amount {
            font-weight: 600;
            color: #28a745;
        }

        .pre-po-status {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .pre-po-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pre-po-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .edit-pre-po-btn {
            background: #007bff;
            color: white;
        }

        .edit-pre-po-btn:hover {
            background: #0056b3;
        }

        .convert-pre-po-btn {
            background: #28a745;
            color: white;
        }

        .convert-pre-po-btn:hover {
            background: #218838;
        }

        .delete-pre-po-btn {
            background: #dc3545;
            color: white;
        }

        .delete-pre-po-btn:hover {
            background: #c82333;
        }

        .no-pre-pos {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .no-line-items {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .loading-line-items {
            text-align: center;
            color: #6c757d;
            padding: 20px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .notes-cell-expanded {
            padding: 15px;
            border: none;
            border-top: 1px solid #dee2e6;
        }

        .notes-container {
            position: relative;
            width: 100%;
            max-width: 100%;
        }

        .notes-input {
            width: 100%;
            border: 1px solid #ddd;
            background: white;
            padding: 10px;
            border-radius: 4px;
            min-height: 80px;
            font-size: 16px;
            resize: vertical;
            font-family: Arial, sans-serif;
        }

        .notes-input:focus {
            border: 1px solid #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .notes-input.has-notes {
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .notes-input.saving {
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        /* Notes toggle in the main row */
        .notes-toggle-cell {
            text-align: center;
            vertical-align: middle;
            width: 140px;
            /* Width for 3 buttons (notes, tracking, task) side by side */
            min-width: 140px;
        }

        .notes-toggle-cell>div {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
        }

        @media (max-width: 1366px) {
            .notes-toggle-cell {
                width: 110px;
                min-width: 110px;
            }

            .notes-toggle-cell>div {
                flex-wrap: wrap;
            }
        }

        .notes-toggle {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .notes-toggle:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .notes-toggle.has-notes {
            background: #28a745;
        }

        .notes-toggle.has-notes:hover {
            background: #218838;
        }

        .po-details-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .po-details-btn:hover {
            background: #5a6268;
            transform: scale(1.05);
        }

        /* Notes header with actions */
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .notes-title {
            font-weight: bold;
            color: #495057;
            font-size: 16px;
        }

        .notes-actions {
            display: flex;
            gap: 8px;
        }

        .notes-close {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .notes-close:hover {
            background: #5a6268;
        }

        /* Tracking header with actions */
        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #bee5eb;
        }

        .tracking-title {
            font-weight: bold;
            color: #0c5460;
            font-size: 16px;
        }

        .tracking-actions {
            display: flex;
            gap: 8px;
        }

        .tracking-close {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .tracking-close:hover {
            background: #138496;
        }

        /* Email Vendor Row Styles */
        .email-vendor-row {
            display: none;
            background: #e3f2fd;
            border-left: 4px solid #007bff;
        }

        .email-vendor-row.expanded {
            display: table-row;
        }

        .email-vendor-cell-expanded {
            padding: 15px;
            border: none;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .email-vendor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .email-vendor-title {
            font-weight: bold;
            color: #007bff;
            font-size: 16px;
        }

        .email-vendor-actions {
            display: flex;
            gap: 8px;
        }

        .email-vendor-close {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .email-vendor-close:hover {
            background: #0056b3;
        }

        .email-vendor-container {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #90caf9;
        }

        .email-po-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }

        .email-po-info h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .email-po-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            color: #6c757d;
            font-size: 13px;
        }

        .email-po-details > div {
            padding: 5px 0;
        }

        .email-po-details strong {
            color: #495057;
        }

        .email-vendor-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .email-form-group label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .email-template-select,
        .email-recipient-input,
        .email-subject-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        .email-template-select:focus,
        .email-recipient-input:focus,
        .email-subject-input:focus,
        .email-body-textarea:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .email-body-textarea {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: Arial, sans-serif;
            resize: vertical;
            width: 100%;
            min-height: 250px;
        }

        .email-body-code {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            width: 100%;
            min-height: 250px;
            background: #f8f9fa;
        }

        .email-body-preview {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            min-height: 250px;
            background: white;
        }

        .view-mode-tabs {
            display: flex;
            gap: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 3px;
            background: #f8f9fa;
        }

        .view-mode-tab {
            flex: 1;
            padding: 8px 12px;
            background: white;
            border: 1px solid transparent;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s;
        }

        .view-mode-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .view-mode-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .template-manage-btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .template-manage-btn:hover {
            transform: scale(1.05);
        }

        .template-modified-notice {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            color: #856404;
            font-size: 13px;
            margin-top: 10px;
        }

        .save-as-template-btn,
        .update-template-btn {
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .save-as-template-btn:hover,
        .update-template-btn:hover {
            background: #0056b3;
        }

        .update-template-btn {
            background: #28a745;
        }

        .update-template-btn:hover {
            background: #218838;
        }

        .email-vendor-suggestions {
            font-size: 12px;
            color: #6c757d;
            margin-top: 3px;
        }

        .email-form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .email-track-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
        }

        .email-track-checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }

        .email-buttons {
            display: flex;
            gap: 10px;
        }

        .email-cancel-btn,
        .email-send-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .email-cancel-btn {
            background: #6c757d;
            color: white;
        }

        .email-cancel-btn:hover {
            background: #5a6268;
        }

        .email-send-btn {
            background: #007bff;
            color: white;
        }

        .email-send-btn:hover {
            background: #0056b3;
        }

        .email-send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .tracking-cell-expanded {
            padding: 15px;
        }

        .tracking-container {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #bee5eb;
        }

        .tracking-info-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tracking-info-item {
            flex: 1;
            min-width: 200px;
        }

        .tracking-info-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .tracking-info-value {
            color: #212529;
            font-size: 14px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            word-break: break-word;
        }

        .tracking-link {
            color: #007bff;
            text-decoration: none;
        }

        .tracking-link:hover {
            text-decoration: underline;
        }

        .tracking-button-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .tracking-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tracking-action-btn.primary {
            background: #17a2b8;
            color: white;
        }

        .tracking-action-btn.primary:hover {
            background: #138496;
        }

        .tracking-action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .tracking-action-btn.secondary:hover {
            background: #5a6268;
        }

        /* Status Dropdown - 16px font */
        .status-select {
            width: 100%;
            border: 1px solid #ddd;
            background: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 16px;
        }

        .status-select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .status-select.has-status {
            background: #e7f3ff;
            border-color: #007bff;
        }

        .status-select.saving {
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        /* Adjusted column widths - PO number smaller, vendor larger */
        .po-number {
            font-family: monospace;
            color: #495057;
            font-size: 16px;
            font-weight: bold;
            width: 140px;
            /* Increased slightly for URL button */
            position: relative;
        }

        /* PO Number URL functionality */
        .po-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .po-link {
            color: #007bff;
            text-decoration: none;
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
        }

        .po-link:hover {
            text-decoration: underline;
            color: #0056b3;
        }

        .po-text {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            color: #495057;
        }

        .vendor-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .vendor-link:hover {
            text-decoration: underline;
            color: #0056b3;
        }

        .url-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .url-btn:hover {
            opacity: 1;
            background: #5a6268;
        }

        .url-btn.has-url {
            background: #28a745;
        }

        .url-btn.has-url:hover {
            background: #218838;
        }

        .copy-po-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.2s ease;
            margin-left: 2px;
        }

        .copy-po-btn:hover {
            opacity: 1;
            background: #0056b3;
        }

        .copy-po-btn.copied {
            background: #28a745;
        }

        /* Priority System */
        .priority-cell {
            width: 80px;
            text-align: center;
        }

        .priority-select {
            width: 70px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 4px;
            background: white;
            cursor: pointer;
        }

        .priority-select option.priority-1 {
            background-color: #ffe6e6;
            color: #d63384;
        }

        .priority-select option.priority-2 {
            background-color: #fce8f3;
            color: #e83e8c;
        }

        .priority-select option.priority-3 {
            background-color: #fff3cd;
            color: #fd7e14;
        }

        .priority-select option.priority-4 {
            background-color: #fff9db;
            color: #ffc107;
        }

        .priority-select option.priority-5 {
            background-color: #d4edda;
            color: #198754;
        }

        /* Priority select background colors based on value */
        .priority-select[data-priority="1"] {
            background-color: #ffe6e6;
            color: #d63384;
            border-color: #d63384;
        }

        .priority-select[data-priority="2"] {
            background-color: #fce8f3;
            color: #e83e8c;
            border-color: #e83e8c;
        }

        .priority-select[data-priority="3"] {
            background-color: #fff3cd;
            color: #fd7e14;
            border-color: #fd7e14;
        }

        .priority-select[data-priority="4"] {
            background-color: #fff9db;
            color: #ffc107;
            border-color: #ffc107;
        }

        .priority-select[data-priority="5"] {
            background-color: #d4edda;
            color: #198754;
            border-color: #198754;
        }

        /* PO Type System */
        .po-type-cell {
            width: 100px;
            text-align: center;
            min-width: 100px;
        }

        .po-type-select {
            width: 100%;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 4px 6px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .po-type-select:hover {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .po-type-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }

        .po-type-select option.type-seed {
            background-color: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .po-type-select option.type-hardgood {
            background-color: #e2e3e5;
            color: #383d41;
            font-weight: 600;
        }

        /* Dynamic PO Type select option and background colors */
        <% poTypeOptions.forEach(type=> { %>
        .po-type-select option.type-<%=type.name.toLowerCase() %> {
            background-color: <%=type.color %>22;
            color: <%=type.color %>;
            font-weight: 600;
        }

        .po-type-select[data-type="<%= type.name %>"] {
            background-color: <%=type.color %>22;
            color: <%=type.color %>;
            border-color: <%=type.color %>;
            border-width: 2px;
        }
        <% }) %>

        /* URL Modal */
        .url-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .url-modal-content {
            background-color: white;
            margin: 20% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .url-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .url-modal-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
        }

        .url-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
        }

        .url-close:hover {
            color: #495057;
        }

        .url-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .url-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }

        .url-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .url-save-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .url-save-btn:hover {
            background: #0056b3;
        }

        .url-save-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .url-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .url-remove-btn:hover {
            background: #c82333;
        }

        .url-cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .url-cancel-btn:hover {
            background: #5a6268;
        }

        .vendor {
            width: 380px;
            /* Increased for better vendor name display */
            word-wrap: break-word;
        }

        .date-cell {
            width: 100px;
        }

        .update-date-cell {
            width: 140px;
            font-size: 14px;
        }

        .next-update-cell {
            width: 140px;
        }

        /* Last Update display styling (read-only timestamp) */
        .last-update-cell {
            width: 140px;
        }

        .last-update-display {
            font-size: 12px;
            color: #6c757d;
            padding: 4px 6px;
            background: #f8f9fa;
            border-radius: 3px;
            border: 1px solid #e9ecef;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .last-update-display.has-update {
            color: #495057;
            background: #e7f3ff;
            border-color: #b3d9ff;
        }

        .last-update-display.no-update {
            color: #adb5bd;
            font-style: italic;
        }

        /* Date input styling (deprecated but kept for backward compatibility) */
        .date-input {
            width: 100%;
            min-width: 130px;
            max-width: 100%;
            border: 1px solid #ddd;
            background: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            color: #495057;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .date-input:focus {
            background: white;
            border: 1px solid #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .date-input.has-date {
            background: #e7f3ff;
            border-color: #b3d9ff;
        }

        .date-input.saving {
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        .date-input.overdue {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* Shipping tracking display */
        .shipping-tracking {
            font-size: 13px;
            color: #6c757d;
        }

        .shipping-tracking.has-tracking {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }

        .shipping-tracking.has-tracking:hover {
            color: #0056b3;
        }

        .shipping-tracking-input {
            width: 100%;
            max-width: 150px;
            transition: all 0.2s ease;
        }

        .shipping-tracking-input:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .shipping-tracking-input.has-tracking {
            border-color: #007bff;
            background-color: #f8f9ff;
        }

        .shipping-tracking-cell {
            min-width: 180px;
            max-width: 180px;
        }

        /* Default behavior: tracking column hidden until explicitly shown */
        .shipping-tracking-cell {
            display: none;
        }

        /* Show tracking column when tracking is explicitly enabled */
        .show-tracking .shipping-tracking-cell {
            display: table-cell !important;
            background-color: #f8f9fa;
            /* Light background to indicate it's active */
            border-left: 3px solid #28a745;
            /* Green border to indicate active state */
        }

        /* Default behavior: NS Status column hidden until explicitly shown */
        .ns-status-cell {
            display: none;
        }

        /* Show NS Status column when explicitly enabled */
        .show-ns-status .ns-status-cell {
            display: table-cell !important;
        }

        /* Default behavior: Location column hidden until explicitly shown */
        .location-cell {
            display: none;
            min-width: 150px;
            max-width: 250px;
        }

        /* Show Location column when explicitly enabled */
        .show-location .location-cell {
            display: table-cell !important;
        }

        /* On smaller screens, add mobile indicator */
        @media (max-width: 1400px) {

            /* Show a hint that tracking column can be toggled */
            #toggleTrackingBtn {
                position: relative;
            }

            #toggleTrackingBtn::after {
                content: "📱";
                position: absolute;
                top: -2px;
                right: -2px;
                font-size: 10px;
            }
        }

        /* Tracking column header indicator when visible */
        .show-tracking .shipping-tracking-cell .toggle-tracking-column-btn {
            background: #28a745;
            color: white;
        }

        /* On larger screens, remove the green border for cleaner look */
        @media (min-width: 1401px) {
            .show-tracking .shipping-tracking-cell {
                border-left: none;
                /* Remove border on larger screens where it's naturally visible */
                background-color: transparent;
            }
        }

        /* Tracking toggle button styles */
        .tracking-toggle-btn {
            background: #ffc107;
            /* Yellow for no status */
            color: #212529;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-left: 4px;
        }

        .tracking-toggle-btn.has-status {
            background: #007bff;
            /* Blue when there's tracking status */
            color: white;
        }

        .tracking-toggle-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        /* Manage Attachments Button */
        .manage-attachments-btn {
            background: #fffacd;
            /* Pale yellow for documents */
            color: #000;
            border: 1px solid #e6e6b8;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .manage-attachments-btn.has-attachments {
            background: #ffeb3b;
            /* Brighter yellow when there are attachments */
            color: #000;
            border-color: #d4c935;
        }

        .manage-attachments-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
            background: #fff9c4;
        }

        /* Dropship Toggle Button */
        .dropship-toggle-btn {
            background: #e0e0e0;
            /* Gray for non-dropship */
            color: #666;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .dropship-toggle-btn.is-dropship {
            background: #ff9800;
            /* Orange for dropship POs */
            color: white;
            opacity: 1;
            box-shadow: 0 0 8px rgba(255, 152, 0, 0.5);
        }

        .dropship-toggle-btn:hover {
            transform: scale(1.05);
            opacity: 1;
        }

        .dropship-toggle-btn.is-dropship:hover {
            background: #f57c00;
        }

        /* Toggle Switch for Dropship Filter */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: #ff9800;
            /* Orange for dropship */
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-switch input:focus+.toggle-slider {
            box-shadow: 0 0 1px #ff9800;
        }

        /* Hover effect for toggle */
        .toggle-slider:hover {
            background-color: #bbb;
        }

        .toggle-switch input:checked+.toggle-slider:hover {
            background-color: #f57c00;
            /* Darker orange on hover */
        }

        /* Create Task Button */
        .create-task-btn {
            background: #17a2b8;
            /* Teal/Cyan */
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .create-task-btn:hover {
            transform: scale(1.05);
            background: #138496;
        }

        /* Email Vendor Button */
        .email-vendor-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .email-vendor-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .email-vendor-btn.email-sent {
            background: #6c757d;
        }

        .email-vendor-btn.email-sent:hover {
            background: #5a6268;
        }

        /* Toggle tracking visibility button */
        .toggle-tracking-column-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 10px;
            transition: all 0.2s ease;
        }

        .toggle-tracking-column-btn:hover {
            background: #5a6268;
        }

        .tracking-container {
            position: relative;
        }

        .tracking-input-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 2px;
        }

        .shipping-carrier-select {
            min-width: 80px;
            flex-shrink: 0;
        }

        .tracking-actions {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }

        .tracking-actions .btn {
            padding: 1px 4px;
            font-size: 10px;
            line-height: 1;
            border-radius: 3px;
        }

        .tracking-status {
            font-size: 10px;
            margin-top: 2px;
            padding: 2px 4px;
            border-radius: 3px;
            background-color: #f8f9fa;
        }

        .tracking-status.status-delivered {
            background-color: #d4edda;
            color: #155724;
        }

        .tracking-status.status-transit {
            background-color: #cce7ff;
            color: #004085;
        }

        .tracking-status.status-expired {
            background-color: #f8d7da;
            color: #721c24;
        }

        .tracking-status.status-alert {
            background-color: #fff3cd;
            color: #856404;
        }

        /* Toast notification for tracking actions */
        .tracking-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 9999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .tracking-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .tracking-toast.error {
            background-color: #dc3545;
        }

        .tracking-toast.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .notes-cell {
            min-width: 200px;
        }

        .status-cell {
            min-width: 150px;
        }

        .eta-cell {
            width: 140px;
            text-align: center;
        }

        .eta-input {
            width: 100%;
            min-width: 130px;
            max-width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .eta-input:hover {
            border-color: #007bff;
        }

        .eta-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .ns-status-cell {
            min-width: 120px;
        }

        /* NS Status display styling - 16px font */
        .ns-status-display {
            color: #856404;
            background: #fff3cd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            display: inline-block;
        }

        /* Combined Stats Section */
        .stats-combined {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .stat-item .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        .stat-item .stat-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .stat-divider {
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
            font-weight: 300;
        }

        .export-excel-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .export-excel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Status Management Modal */
        .status-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .status-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .status-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
        }

        .status-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .status-close:hover {
            color: #495057;
        }

        .status-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .status-add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .status-add-btn:hover {
            background: #218838;
        }

        .status-add-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .status-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 5px;
            background: #f8f9fa;
        }

        .status-item.default {
            background: #e7f3ff;
            border-color: #b3d9ff;
        }

        .status-item-name {
            font-size: 16px;
        }

        .status-item.default .status-item-name::after {
            content: " (default)";
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }

        .status-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .status-delete-btn:hover {
            background: #c82333;
        }

        .status-delete-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .manage-status-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .manage-status-btn:hover {
            background: #5a6268;
        }

        .notes-manager-btn {
            background: #28a745;
            color: white;
            padding: 6px 12px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .notes-manager-btn:hover {
            background: #218838;
        }

        /* Notes History Modal */
        .notes-history-content {
            max-height: 500px;
            overflow-y: auto;
        }

        .note-item {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 10px;
            padding: 12px;
            background: white;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .note-date {
            font-weight: bold;
        }

        .note-content {
            padding: 8px 0;
            font-size: 14px;
            line-height: 1.4;
            color: #495057;
            white-space: pre-wrap;
        }

        .note-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

        .note-delete-btn:hover {
            background: #c82333;
        }

        /* PO Details Modal Tabs */
        .po-details-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .tab-button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            border-radius: 5px 5px 0 0;
            margin-right: 2px;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            border-color: #dee2e6;
            position: relative;
            z-index: 1;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: white;
        }

        .tab-content {
            display: none;
            min-height: 300px;
        }

        .tab-content.active {
            display: block;
        }

        .po-details-line-items {
            max-height: 500px;
            overflow-y: auto;
        }

        .po-details-notes-history {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Attachments Section Styles */
        .attachments-section {
            padding: 20px;
        }

        .attachments-header {
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
        }

        .attachments-header h4 {
            margin: 0 0 8px 0;
            color: #343a40;
            font-size: 18px;
        }

        .attachments-description {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }

        .attachment-upload-form {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .upload-form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .upload-form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .form-group input[type="file"],
        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .file-hint {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
        }

        .upload-attachment-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .upload-attachment-btn:hover {
            background: #0056b3;
        }

        .upload-attachment-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .attachments-list h5 {
            margin: 0 0 15px 0;
            color: #343a40;
            font-size: 16px;
        }

        .attachments-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .attachment-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: box-shadow 0.2s;
        }

        .attachment-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .attachment-info {
            flex: 1;
            min-width: 0;
        }

        .attachment-filename {
            font-weight: 500;
            color: #343a40;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .attachment-meta {
            font-size: 12px;
            color: #6c757d;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .attachment-actions {
            display: flex;
            gap: 8px;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .attachment-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .download-btn {
            background: #28a745;
            color: white;
        }

        .download-btn:hover {
            background: #1e7e34;
            color: white;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .no-attachments {
            text-align: center;
            color: #6c757d;
            padding: 30px;
            font-style: italic;
        }

        .attachment-type-badge {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .upload-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }

        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .line-items-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #495057;
        }

        /* Tracking Details Modal */
        .tracking-details-content {
            padding: 20px 0;
        }

        .tracking-info-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .tracking-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tracking-number {
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
        }

        .carrier-info {
            font-size: 14px;
            color: #6c757d;
        }

        .tracking-status-display {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .tracking-actions-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tracking-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tracking-action-btn.primary {
            background: #007bff;
            color: white;
        }

        .tracking-action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .tracking-action-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .no-notes {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; margin-bottom: 1rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4>Refreshing Dashboard...</h4>
            <p>Please wait while we update the page</p>
        </div>
    </div>

    <!-- Quick Upload Modal with NetSuite Integration -->
    <div id="quickUploadModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); overflow-y: auto;">
        <div class="modal-content" style="position: relative; background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <span class="close" onclick="closeQuickUpload()" style="position: absolute; right: 15px; top: 10px; font-size: 28px; font-weight: bold; cursor: pointer; color: #999;">&times;</span>
            
            <!-- Header -->
            <h2 style="margin: 0 0 8px 0; color: #333; font-size: 22px;">⚡ Quick CSV Upload</h2>
            <p style="color: #666; margin: 0 0 18px 0; font-size: 14px;">
                Download from NetSuite and upload in one seamless workflow
                <a href="/manage-po-urls" style="margin-left: 10px; font-size: 12px; text-decoration: none;">
                    🔗 Manage URLs
                </a>
            </p>

            <!-- NetSuite Button -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; padding: 15px; margin-bottom: 18px;">
                <div style="display: flex; align-items: center; justify-content: space-between; color: white; gap: 15px;">
                    <div style="flex: 1;">
                        <strong style="font-size: 16px; display: block; margin-bottom: 4px;">🌐 Step 1: Download from NetSuite</strong>
                        <p style="margin: 0; font-size: 12px; opacity: 0.9;">Opens NetSuite export page in a new window</p>
                        <p style="margin: 4px 0 0 0; font-size: 11px; opacity: 0.8;">Looking for: <code style="background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 3px; font-size: 10px;">OpenPurchaseOrdersPendingBill(Rune)NTK*.csv</code></p>
                    </div>
                    <button onclick="openNetSuiteWindow()" class="btn btn-light btn-lg" style="margin-left: 12px; padding: 12px 24px; font-size: 15px; font-weight: 600; white-space: nowrap;">
                        🪟 Open NetSuite
                    </button>
                </div>
            </div>

            <form id="quickUploadForm" action="/purchase-orders/upload" method="post" enctype="multipart/form-data" style="margin: 0;">
                
                <!-- Auto-detect Section -->
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px 10px 0 0; padding: 12px 15px; color: white;">
                    <strong style="font-size: 15px;">🎯 Step 2: Upload CSV</strong>
                    <p style="margin: 3px 0 0 0; font-size: 11px; opacity: 0.9;">Select your downloaded NetSuite export file</p>
                </div>

                <div style="border: 2px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px; padding: 18px; background: white;">
                    
                    <!-- Auto-detect button -->
                    <div style="margin-bottom: 15px;">
                        <button type="button" onclick="autoDetectLatestFile()" class="btn btn-lg" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; font-weight: 600; font-size: 15px; border-radius: 8px;">
                            🔍 Quick Select Latest CSV
                        </button>
                        <p style="margin: 6px 0 0 0; font-size: 11px; text-align: center; color: #666;">
                            Opens file picker to select your CSV file
                        </p>
                    </div>

                    <div style="text-align: center; margin: 15px 0; color: #999; font-weight: 600; font-size: 13px;">— OR —</div>

                    <!-- Manual Upload Zone -->
                    <div class="upload-zone" id="dropZone" style="border: 3px dashed #667eea; border-radius: 10px; padding: 35px 20px; text-align: center; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); cursor: pointer; transition: all 0.3s ease;">
                        <div class="upload-icon" style="font-size: 48px; margin-bottom: 10px;">📁</div>
                        <p style="font-size: 16px; font-weight: 600; color: #333; margin: 0 0 8px 0;">Drop CSV file here or click to browse</p>
                        <p style="color: #666; margin: 0 0 12px 0; font-size: 12px;">Supports .csv files from NetSuite exports</p>
                        <input type="file" name="csvFile" id="quickCsvFile" accept=".csv" required style="display: none;">
                        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('quickCsvFile').click()" style="padding: 10px 32px; font-size: 14px; border-radius: 8px;">📂 Choose File Manually</button>
                        <div id="selectedFileName" style="margin-top: 12px; padding: 10px; background: #e8f5e9; border-radius: 6px; display: none;">
                            <span style="color: #2e7d32; font-weight: 600; font-size: 13px;">✓ Selected: </span>
                            <span id="fileNameText" style="color: #1b5e20; word-break: break-all; font-size: 12px;"></span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="margin-top: 18px; text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeQuickUpload()" style="margin-right: 8px; padding: 9px 20px; font-size: 14px;">Cancel</button>
                        <button type="submit" id="quickUploadBtn" class="btn btn-success btn-lg" disabled style="padding: 9px 28px; font-size: 15px;">🚀 Upload & Import</button>
                    </div>
                </div>
            </form>

            <!-- Upload Progress -->
            <div id="uploadProgress" style="display: none; margin-top: 15px;">
                <div style="background: #f0f0f0; border-radius: 8px; overflow: hidden; height: 25px;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 13px;"></div>
                </div>
                <p id="uploadStatus" style="text-align: center; margin-top: 8px; color: #666; font-size: 13px;">Uploading...</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Purchase Orders Dashboard</h1>
            <div class="navigation-container">
                <!-- Dashboard Button -->
                <div class="nav-section">
                    <a href="/purchase-orders" class="nav-accordion-btn active" style="text-decoration: none;">
                        🏠 Dashboard
                    </a>
                </div>

                <!-- Managers Accordion -->
                <div class="nav-section">
                    <button class="nav-accordion-btn" onclick="toggleAccordion('managersAccordion')">
                        📊 Managers <span class="accordion-icon">▼</span>
                    </button>
                    <div id="managersAccordion" class="nav-accordion-content">
                        <a href="/excel-reports" class="nav-accordion-item">📊 Excel Reports Manager</a>
                        <a href="/manage-auto-reports" class="nav-accordion-item">🔄 Auto-Reports Manager</a>
                        <a href="/statistics/dashboard" class="nav-accordion-item">📈 Daily Statistics</a>
                        <a href="/vendors" class="nav-accordion-item">🏢 Vendors</a>
                        <a href="/purchase-orders/trouble-seed" class="nav-accordion-item">⚠️ Trouble Seed</a>
                        <a href="/purchase-orders/line-items-manager" class="nav-accordion-item">📦 Line Items
                            Manager</a>
                        <a href="/purchase-orders/tracking-dashboard" class="nav-accordion-item">🚚 Tracking
                            Dashboard</a>
                        <a href="/shipments/dashboard" class="nav-accordion-item">📦 Shipment Management</a>
                        <a href="/purchase-orders/orphaned-line-items" class="nav-accordion-item">🧹 Orphaned Items</a>
                        <a href="/purchase-orders/notes-manager" class="nav-accordion-item">📝 Notes Manager</a>
                        <a href="/organic-vendors" class="nav-accordion-item">🌱 Organic Vendors</a>
                        <a href="/purchase-orders/unreceived-items-report" class="nav-accordion-item">📋 Unreceived
                            Items Report</a>
                        <a href="/purchase-orders/waiting-for-approval" class="nav-accordion-item">⏳ Waiting for
                            Approval</a>
                        <a href="/dropshipments" class="nav-accordion-item">📦 Dropshipment Tracking</a>
                        <a href="/seed-catalog/search" class="nav-accordion-item">🌱 AI Seed Catalog</a>
                        <a href="/seed-catalog/vendors" class="nav-accordion-item">🏪 Manage Seed Vendors</a>
                    </div>
                </div>

                <!-- Combined Options Button -->
                <div class="nav-section">
                    <button class="nav-options-btn" onclick="toggleOptionsDropdown()">
                        ⚙️ Options <span class="dropdown-icon">▼</span>
                    </button>
                    <div id="optionsDropdown" class="nav-dropdown-content">
                        <button class="nav-dropdown-item" onclick="togglePrePurchaseSection()">
                            📋 Pre-Purchase Orders
                        </button>
                        <button class="nav-dropdown-item" onclick="openStatusModal()">
                            🏷️ Manage PO Status Options
                        </button>
                        <button class="nav-dropdown-item" onclick="openLineItemStatusModal()">
                            📋 Manage Line Item Status Options
                        </button>
                        <button class="nav-dropdown-item" onclick="openCarrierModal()">
                            🚚 Manage Carriers
                        </button>
                        <button class="nav-dropdown-item" onclick="openPoTypeModal()">
                            📦 Manage PO Types
                        </button>
                        <button class="nav-dropdown-item" onclick="window.location.href='/vendors/manage-po-types'">
                            🏷️ Vendor Default PO Types
                        </button>
                        <button class="nav-dropdown-item" onclick="openAssigneeModal()">
                            👥 Manage Assignees
                        </button>
                        <button class="nav-dropdown-item" onclick="openFormsManagement()">
                            📝 Manage Forms
                        </button>
                        <a href="/forms" class="nav-dropdown-item">
                            📄 Forms & Files
                        </a>
                        <a href="/excel-files/manage" class="nav-dropdown-item">
                            📊 Manage Excel Files
                        </a>
                        <a href="/manage-email-templates" class="nav-dropdown-item">
                            📧 Email Templates
                        </a>
                    </div>
                </div>

                <!-- Imports Section -->
                <div class="nav-section">
                    <button class="nav-imports-btn" onclick="toggleImportsDropdown()">
                        📁 Import <span class="dropdown-icon">▼</span>
                    </button>
                    <div id="importsDropdown" class="nav-dropdown-content">
                        <button class="nav-dropdown-item" onclick="openQuickUpload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">⚡ Quick Upload (Downloads)</button>
                        <a href="/upload" class="nav-dropdown-item">📄 Upload CSV</a>
                        <a href="/organic-vendors" class="nav-dropdown-item">🌱 Organic Vendors</a>
                        <a href="/trouble-seed" class="nav-dropdown-item">⚠️ Trouble Seed</a>
                        <a href="/orphaned-line-items" class="nav-dropdown-item">� Orphaned Items</a>
                        <button class="nav-dropdown-item" onclick="fixMissingVendorsBoth()">🔗 Fix Missing Vendors
                            (Both)</button>
                        <button class="nav-dropdown-item" onclick="fixMainVendors()">🔧 Fix Main Vendors</button>
                        <button class="nav-dropdown-item" onclick="fixOrganicVendors()">🌱 Fix Organic Vendors</button>
                        <button class="nav-dropdown-item" onclick="openEmailClient()">📧 Email Client</button>
                        <a href="/auth/admin/users" class="nav-dropdown-item">👥 User Management</a>
                    </div>
                </div>

                <!-- Dropship Module -->
                <div class="nav-section">
                    <a href="/dropship" class="nav-accordion-btn" style="text-decoration: none;">
                        🚚 Dropship Processor
                    </a>
                </div>

                <!-- Task Management -->
                <div class="nav-section">
                    <a href="/tasks" class="nav-accordion-btn" style="text-decoration: none;">
                        ✅ Task Management
                    </a>
                </div>

                <!-- Forms Section -->
                <div class="nav-section">
                    <button class="nav-forms-btn" onclick="toggleFormsDropdown()">
                        📋 Forms <span class="dropdown-icon">▼</span>
                    </button>
                    <div id="formsDropdown" class="nav-dropdown-content">
                        <!-- Dynamic forms will be loaded here -->
                    </div>
                </div>

                <!-- User Profile -->
                <% if (user) { %>
                    <div class="user-profile-section">
                        <div class="user-dropdown">
                            <div class="user-avatar" onclick="toggleUserDropdown()">
                                <%= user.firstName ? user.firstName.charAt(0).toUpperCase() : '' %>
                                    <%= user.lastName ? user.lastName.charAt(0).toUpperCase() : '' %>
                            </div>
                            <div id="userDropdown" class="user-dropdown-content">
                                <div class="user-dropdown-header">
                                    <div class="user-avatar-large">
                                        <%= user.firstName ? user.firstName.charAt(0).toUpperCase() : '' %>
                                            <%= user.lastName ? user.lastName.charAt(0).toUpperCase() : '' %>
                                    </div>
                                    <div class="user-info">
                                        <strong>
                                            <%= user.firstName %>
                                                <%= user.lastName %>
                                        </strong>
                                        <small class="user-role">Admin</small>
                                        <small class="user-status">● Online</small>
                                    </div>
                                </div>
                                <a href="/auth/admin/users" class="user-dropdown-item">
                                    <span class="dropdown-icon">�</span> User Management
                                </a>
                                <a href="/auth/admin/audit-logs" class="user-dropdown-item">
                                    <span class="dropdown-icon">🔄</span> Audit Logs
                                </a>
                                <a href="/auth/admin/test-email" class="user-dropdown-item">
                                    <span class="dropdown-icon">✉️</span> Test Email
                                </a>
                                <% if (user.email && (user.email.toLowerCase() === 'theonlyruneyouknow@gmail.com' || user.email.toLowerCase() === 'rlarsen@territorialseed.com')) { %>
                                <div class="dropdown-divider"></div>
                                <div class="user-dropdown-header" style="padding: 8px 15px; font-size: 12px; color: #6c757d;">
                                    <span class="dropdown-icon">ᚱ</span> Rune Modules
                                </div>
                                <a href="/story/dashboard" class="user-dropdown-item">
                                    <span class="dropdown-icon">📖</span> Story
                                </a>
                                <a href="/medicine/dashboard" class="user-dropdown-item">
                                    <span class="dropdown-icon">💊</span> Medicine
                                </a>
                                <a href="/bulletin" class="user-dropdown-item">
                                    <span class="dropdown-icon">📌</span> Bulletin
                                </a>
                                <% } %>
                                <form action="/auth/logout" method="POST" style="margin: 0;">
                                    <button type="submit" class="user-dropdown-item logout">
                                        <span class="dropdown-icon">🚪</span> Logout
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <% } %>
            </div>
        </div>

        <!-- NetSuite Import Modal -->
        <div id="netsuiteImportModal" class="modal" style="display: none;">
            <div class="modal-content netsuite-import-modal"
                style="max-height: 90vh; display: flex; flex-direction: column;">
                <div class="modal-header" style="flex-shrink: 0;">
                    <h3>Import NetSuite PO Form Data</h3>
                    <span class="close" onclick="closeNetSuiteImportModal()">&times;</span>
                </div>
                <div class="modal-body" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px;">
                    <p>Paste your NetSuite PO form data below. The system will automatically parse the line items and
                        associate them with the corresponding purchase order.</p>

                    <div class="form-group">
                        <label for="netsuiteData">NetSuite PO Form Data:</label>
                        <textarea id="netsuiteData"
                            placeholder="Paste your NetSuite PO form data here...

Format Option 1 (Headers in single line):
Item	Vendor Name	Quantity	Description	VENDOR DESC	Rate	Units	On Hand	Available	Received	Billed	Amount	Match Bill To Receipt	Expected Receipt Date	Bill Variance Status	Closed	Expected Arrival Date	History
BR114 : BR114/OR.M		250	ASPABROC (ordering)	ASPABROC (ordering)	26.25	M	58.142	58.142	0	0	6,562.50		3/13/2025				History

Format Option 2 (Headers on separate lines):
Item
Vendor Name
Quantity
Description
VENDOR DESC
Rate
Units
On Hand
Available
Received
Billed
Amount
Match Bill To Receipt
Expected Receipt Date
Bill Variance Status
Closed
Expected Arrival Date
History
FL2948 : FL2948/OR.M	 	100	MEXICAN SUNFLOWER FIESTA DEL SOL : Min Germ; 70%	FIESTA DEL SOL	24.78	M	157.32	157.32	100	100	2,478.00	 	8/6/2025	No Variances	 	 	History"></textarea>
                        <p style="margin-top: 8px; font-size: 12px; color: #6c757d;">
                            💡 Copy the line items table from NetSuite (including headers) and paste it here.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="targetPO">Target Purchase Order (Optional):</label>
                        <select id="targetPO">
                            <option value="">Auto-detect from data...</option>
                            <% purchaseOrders.forEach(po=> { %>
                                <option value="<%= po._id %>">
                                    <%= po.poNumber %> - <%= po.vendor %>
                                </option>
                                <% }); %>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="import-mode-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="addToExisting" />
                                <span class="checkmark"></span>
                                Add to existing line items (instead of replacing them)
                            </label>
                            <p class="option-description">
                                <strong>Unchecked (Default):</strong> Replace all existing line items with the new
                                data<br>
                                <strong>Checked:</strong> Add the imported items to any existing line items
                            </p>
                        </div>
                    </div>
                </div>
                <div class="form-actions"
                    style="flex-shrink: 0; border-top: 1px solid #dee2e6; padding: 15px 20px; background: #f8f9fa; margin: 0;">
                    <button class="btn btn-secondary" onclick="closeNetSuiteImportModal()">Cancel</button>
                    <button class="btn btn-info" onclick="previewNetSuiteImport()"
                        style="background: #17a2b8; color: white;">📋 Preview Changes</button>
                    <button class="btn btn-primary" onclick="processNetSuiteImport()">Import Line Items</button>
                </div>
            </div>
        </div>

        <!-- NetSuite Import Preview Modal -->
        <div id="netsuitePreviewModal" class="modal" style="display: none;">
            <div class="modal-content"
                style="max-width: 1400px; width: 95%; max-height: 85vh; display: flex; flex-direction: column;">
                <div class="modal-header" style="padding: 12px 20px;">
                    <h3 style="margin: 0; font-size: 18px;">📋 Preview Import Changes</h3>
                    <span class="close" onclick="closePreviewModal()">&times;</span>
                </div>
                <div class="modal-body"
                    style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 15px 20px;">
                    <div id="previewSummary"
                        style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 4px; flex-shrink: 0;">
                        <!-- Summary will be populated by JavaScript -->
                    </div>

                    <div id="previewWarnings" style="margin-bottom: 12px; flex-shrink: 0;">
                        <!-- Warnings will be populated if there are issues -->
                    </div>

                    <div id="previewContent" class="preview-modal-content">
                        <!-- Preview table will be populated by JavaScript -->
                    </div>

                    <div class="form-actions"
                        style="margin-top: 12px; flex-shrink: 0; border-top: 1px solid #dee2e6; padding-top: 12px;">
                        <button class="btn btn-secondary" onclick="closePreviewModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmAndImport()">✓ Confirm & Import</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pre-Purchase Orders Section -->
        <div class="pre-purchase-section">
            <div class="pre-purchase-header">
                <h2>📋 Pre-Purchase Orders<% if (prePurchaseOrders && prePurchaseOrders.length> 0) { %> (<%=
                            prePurchaseOrders.length %>)<% } %>
                </h2>
                <button class="add-pre-po-btn" onclick="addPrePurchaseOrder()">➕ Add Pre-PO</button>
            </div>

            <% if (prePurchaseOrders && prePurchaseOrders.length> 0) { %>
                <div class="pre-purchase-orders">
                    <% prePurchaseOrders.forEach((prePO, index)=> { %>
                        <div class="pre-po-card priority-<%= prePO.priority.toLowerCase() %>" data-id="<%= prePO._id %>"
                            data-priority="<%= prePO.priority.toLowerCase() %>"
                            data-receive-date="<%= prePO.receiveDate || '' %>" data-status="<%= prePO.status %>">
                            <div class="pre-po-header">
                                <div class="pre-po-title">📦 <strong>
                                        <%= prePO.vendor %>
                                    </strong></div>
                                <div class="pre-po-priority <%= prePO.priority.toLowerCase() %>">
                                    <%= prePO.priority %>
                                </div>
                            </div>
                            <div class="pre-po-body">
                                <% if (prePO.items) { %>
                                    <div class="pre-po-items">
                                        <%= prePO.items.substring(0, 100) %>
                                            <%= prePO.items.length> 100 ? '...' : '' %>
                                    </div>
                                    <% } %>
                                        <div class="pre-po-meta">
                                            <span class="pre-po-status">📋 <%= prePO.status %></span>
                                            <% if (prePO.receiveDate) { %>
                                                <span class="pre-po-date">🗓️ <%= new
                                                        Date(prePO.receiveDate).toLocaleDateString() %></span>
                                                <% } %>
                                        </div>
                            </div>
                            <div class="pre-po-actions">
                                <button class="edit-pre-po-btn" onclick="editPrePurchaseOrder('<%= prePO._id %>')">✏️
                                    Edit</button>
                                <button class="convert-pre-po-btn"
                                    onclick="convertPrePurchaseOrder('<%= prePO._id %>')">🔄 Convert to PO</button>
                                <button class="delete-pre-po-btn"
                                    onclick="deletePrePurchaseOrder('<%= prePO._id %>')">🗑️ Delete</button>
                            </div>
                        </div>
                        <% }); %>
                </div>
                <% } else { %>
                    <div class="no-pre-pos">
                        <p>No pre-purchase orders yet. Start planning your purchases!</p>
                    </div>
                    <% } %>
        </div>

        <% if (purchaseOrders.length> 0) { %>
            <!-- Combined Stats and Results Section -->
            <div class="stats-combined">
                <div class="stat-item">
                    <span class="stat-number" id="totalCount">
                        <%= purchaseOrders.length %>
                    </span>
                    <span class="stat-label">Total POs</span>
                </div>
                <div class="stat-divider">|</div>
                <div class="stat-item">
                    <span class="stat-number" id="notesCount">
                        <%= purchaseOrders.filter(po=> po.notes && po.notes.trim()).length %>
                    </span>
                    <span class="stat-label">With Notes</span>
                </div>
                <div class="stat-divider">|</div>
                <div class="stat-item">
                    <span class="stat-number" id="visibleCount">
                        <%= purchaseOrders.length %>
                    </span>
                    <span class="stat-label">Showing</span>
                </div>
                <div class="stat-divider">|</div>
                <div class="stat-item">
                    <a href="/purchase-orders/download/latest-excel" class="export-excel-btn"
                        title="Download auto-refreshed Excel file (updates every hour)">
                        📊 Download Latest Excel
                    </a>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters" id="filtersSection">
                <!-- Main Filters Row -->
                <div class="filter-row">
                    <div class="filter-group" style="position: relative;">
                        <label>Search Vendor, PO#, or Tracking#</label>
                        <div class="search-input-wrapper">
                            <input type="text" id="searchFilter" placeholder="Type to search..." autocomplete="off">
                            <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearchField()"
                                title="Clear search">✕</button>
                        </div>
                        <div id="searchHistoryDropdown" class="search-history-dropdown" style="display: none;">
                            <div class="search-history-header">
                                <span>Recent Searches</span>
                                <button onclick="clearSearchHistory()" class="clear-history-btn">Clear</button>
                            </div>
                            <ul id="searchHistoryList"></ul>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Priority Filter</label>
                        <select id="priorityFilter">
                            <option value="all">All Priorities</option>
                            <option value="1">🔴 1 (Highest)</option>
                            <option value="2">🩷 2 (High)</option>
                            <option value="3">🟠 3 (Medium)</option>
                            <option value="4">🟡 4 (Low)</option>
                            <option value="5">🟢 5 (Lowest)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>NS Status Filter</label>
                        <select id="nsStatusFilter">
                            <option value="all">All NS Statuses</option>
                            <% uniqueNSStatuses.forEach(status=> { %>
                                <option value="<%= status %>">
                                    <%= status %>
                                </option>
                                <% }); %>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Status Filter</label>
                        <select id="statusFilter">
                            <option value="all">All Statuses</option>
                            <% uniqueStatuses.forEach(status=> { %>
                                <option value="<%= status %>">
                                    <%= status %>
                                </option>
                                <% }); %>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Notes Filter</label>
                        <select id="notesFilter">
                            <option value="all">All POs</option>
                            <option value="with-notes">With Notes Only</option>
                            <option value="without-notes">Without Notes Only</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label style="margin-bottom: 5px;">Show "Not my concern"</label>
                        <label style="display: flex; align-items: center; gap: 5px; margin-top: 19px;">
                            <input type="checkbox" id="showNotMyConcern" style="margin: 0;">
                            <span style="font-size: 12px;">Show hidden POs</span>
                        </label>
                    </div>

                    <div class="filter-group">
                        <label style="margin-bottom: 5px;">Show "Pending Bill"</label>
                        <label style="display: flex; align-items: center; gap: 5px; margin-top: 19px;">
                            <input type="checkbox" id="showPendingBill" style="margin: 0;">
                            <span style="font-size: 12px;">Show billed POs</span>
                        </label>
                    </div>

                    <div class="filter-group">
                        <label style="margin-bottom: 5px;">Partial Receives</label>
                        <label style="display: flex; align-items: center; gap: 5px; margin-top: 19px;">
                            <input type="checkbox" id="showOnlyPartialReceives" style="margin: 0;">
                            <span style="font-size: 12px;">Show partial receives</span>
                        </label>
                    </div>

                    <div class="filter-group">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <label style="margin: 0;">PO Type Filter</label>
                            <button class="btn btn-sm" onclick="selectAllPoTypes()"
                                style="padding: 2px 6px; font-size: 10px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;"
                                title="Check all PO types">
                                ✓ All
                            </button>
                            <button class="btn btn-sm" onclick="clearAllPoTypes()"
                                style="padding: 2px 6px; font-size: 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;"
                                title="Uncheck all PO types">
                                ✕ Clear
                            </button>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: nowrap; overflow-x: auto;">
                            <% poTypeOptions.forEach(type=> { %>
                                <label style="display: flex; align-items: center; gap: 3px; white-space: nowrap;"
                                    title="Show <%= type.name %> POs">
                                    <input type="checkbox" id="filter<%= type.name %>" checked style="margin: 0;">
                                    <span style="font-size: 12px; font-weight: 600; color: <%= type.color %>;">
                                        <%= type.emoji %>
                                            <%= type.name %>
                                    </span>
                                </label>
                                <% }) %>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label style="margin-bottom: 5px;">&nbsp;</label>
                        <button onclick="toggleAdvancedFilters()" id="advancedFiltersToggle" 
                            style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-top: 4px;"
                            title="Show/hide advanced filters">
                            ⚙️ Advanced
                        </button>
                    </div>
                </div>

                <!-- Advanced Filters Row (Initially Hidden) -->
                <div class="filter-row" id="advancedFiltersRow" style="display: none; padding-top: 10px; border-top: 1px solid #dee2e6; margin-top: 10px;">
                    <div class="filter-group">
                        <label for="locationFilter">📍 Location</label>
                        <select id="locationFilter">
                            <option value="">All Locations</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label style="margin-bottom: 5px;">Missing URLs</label>
                        <label style="display: flex; align-items: center; gap: 5px; margin-top: 19px;">
                            <input type="checkbox" id="showOnlyMissingUrls" style="margin: 0;">
                            <span style="font-size: 12px;">No URLs only</span>
                        </label>
                    </div>

                    <div class="filter-group">
                        <label style="margin-bottom: 5px;">No Line Items</label>
                        <label style="display: flex; align-items: center; gap: 5px; margin-top: 19px;">
                            <input type="checkbox" id="showOnlyNoLineItems" style="margin: 0;">
                            <span style="font-size: 12px;">No items only</span>
                        </label>
                    </div>

                    <div class="filter-group">
                        <label style="margin-bottom: 5px;">Missing ETA</label>
                        <label style="display: flex; align-items: center; gap: 5px; margin-top: 19px;">
                            <input type="checkbox" id="showOnlyMissingEta" style="margin: 0;">
                            <span style="font-size: 12px;">No ETA only</span>
                        </label>
                    </div>
                </div>

                <!-- Second Row: Action Buttons -->
                <div class="filter-row actions-row">
                    <div class="filter-group filter-actions">
                        <button class="btn btn-sm btn-outline-info" onclick="toggleTaskViewer()"
                            id="taskViewerBtn" title="Show/Hide Task Management Viewer" style="width: 100%;">
                            📋 <span id="taskViewerText">Show Tasks</span>
                        </button>
                    </div>

                    <div class="filter-group filter-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/purchase-orders/tracking-dashboard'"
                            id="bulkTrackingBtn" title="Manage shipment tracking" style="width: 100%;">
                            🚚 Update Tracking
                        </button>
                    </div>

                    <div class="filter-group filter-actions">
                        <button class="btn btn-sm btn-outline-success" onclick="window.location.href='/manage-po-urls'"
                            title="Manage PO URLs and Types" style="width: 100%;">
                            🔗 Manage URLs
                        </button>
                    </div>

                    <div class="filter-group filter-actions">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTrackingColumn()"
                            id="toggleTrackingBtn" title="Show/Hide tracking column" style="width: 100%;">
                            👁️ <span id="trackingColumnText">Show Tracking</span>
                        </button>
                    </div>

                    <div class="filter-group filter-actions">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleNSStatusColumn()"
                            id="toggleNSStatusBtn" title="Show/Hide NS Status column" style="width: 100%;">
                            📦 <span id="nsStatusColumnText">Show NS Status</span>
                        </button>
                    </div>

                    <div class="filter-group filter-actions">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleLocationColumn()"
                            id="toggleLocationBtn" title="Show/Hide Location column" style="width: 100%;">
                            📍 <span id="locationColumnText">Show Location</span>
                        </button>
                    </div>

                    <!-- Pending Supervisor Approval toggle button -->
                    <div class="filter-group filter-actions">
                        <button class="btn btn-sm btn-outline-secondary" onclick="togglePendingSupervisorApproval()"
                            id="togglePendingSupervisorBtn" title="Show/Hide Pending Supervisor Approval POs" style="width: 100%;">
                            📋 <span id="pendingSupervisorText">Show Pending Supervisor</span>
                        </button>
                        <!-- Hidden checkbox for actual filter state -->
                        <input type="checkbox" id="showPendingSupervisorApproval" style="display: none;">
                    </div>

                    <!-- Clear Filters button -->
                    <div class="filter-group filter-actions">
                        <button class="clear-filters" onclick="clearAllFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            
            <!-- Task Reminder Notifications -->
            <div id="reminderContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 400px;"></div>
            
            <!-- Task Management Viewer (Collapsible) -->
            <div id="taskViewerSection" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <h4 style="margin: 0; color: #2c3e50; font-weight: 600;">
                                📋 Task Management Dashboard
                                <span id="taskCountSpan" style="font-size: 0.8rem; color: #7f8c8d; font-weight: normal; margin-left: 10px;">
                                    (<%= allTasks ? allTasks.length : 0 %> tasks)
                                </span>
                            </h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-sm" id="todayTasksBtn" onclick="filterTasksCompact('today')" 
                                        style="background: #e3f2fd; color: #1976d2; border: 1px solid #1976d2; font-weight: 500; padding: 4px 12px;">
                                    📅 Today
                                </button>
                                <button class="btn btn-sm" id="highPriorityBtn" onclick="filterTasksCompact('high')" 
                                        style="background: #fff3e0; color: #f57c00; border: 1px solid #f57c00; font-weight: 500; padding: 4px 12px;">
                                    🔥 High Priority
                                </button>
                                <button class="btn btn-sm" id="oldestTasksBtn" onclick="filterTasksCompact('oldest')" 
                                        style="background: #f3e5f5; color: #7b1fa2; border: 1px solid #7b1fa2; font-weight: 500; padding: 4px 12px;">
                                    ⏰ Oldest First
                                </button>
                                <button class="btn btn-sm" id="allTasksBtn" onclick="filterTasksCompact('all')" 
                                        style="background: #5e35b1; color: white; border: 1px solid #5e35b1; font-weight: 600; padding: 4px 12px;">
                                    📋 All
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-success" onclick="showQuickTaskForm()" style="font-weight: 500;">
                                ➕ Quick Add Task
                            </button>
                            <button class="btn btn-sm btn-info" onclick="showAccomplishmentsModal()" style="font-weight: 500;">
                                📊 View Accomplishments
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/tasks'" style="font-weight: 500;">
                                Open Full Dashboard →
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Task Form (Hidden by default) -->
                    <div id="quickTaskForm" style="display: none; background: #f8f9fa; border: 2px solid #667eea; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h5 style="margin: 0; color: #2c3e50; font-weight: 600;">✨ Quick Add Task</h5>
                            <button onclick="hideQuickTaskForm()" style="background: transparent; border: none; color: #6c757d; font-size: 1.2rem; cursor: pointer; padding: 0; margin-left: auto;">×</button>
                        </div>
                        <form onsubmit="saveQuickTask(event)" style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <input type="text" id="quickTaskTitle" placeholder="Task title / subject line..." required
                                       style="width: 100%; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.95rem;">
                            </div>
                            <div>
                                <textarea id="quickTaskNote" placeholder="Quick note (optional)..." rows="2"
                                          style="width: 100%; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem; resize: vertical;"></textarea>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9rem;">
                                    <input type="checkbox" id="quickTaskCompleted" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>✅ Mark as completed</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9rem;">
                                    <input type="radio" name="taskPosition" value="top" checked style="cursor: pointer;">
                                    <span>Add to top</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9rem;">
                                    <input type="radio" name="taskPosition" value="bottom" style="cursor: pointer;">
                                    <span>Add to bottom</span>
                                </label>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="submit" class="btn btn-sm btn-primary" style="font-weight: 500;">
                                    💾 Save Task
                                </button>
                                <button type="button" onclick="hideQuickTaskForm()" class="btn btn-sm btn-secondary" style="font-weight: 500;">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Accomplishments Report Modal (Hidden by default) -->
                    <div id="accomplishmentsModal" style="display: none; background: #f8f9fa; border: 2px solid #667eea; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
                            <h5 style="margin: 0; color: #2c3e50; font-weight: 600;">📊 Accomplishments Report</h5>
                            <button onclick="hideAccomplishmentsModal()" style="background: transparent; border: none; color: #6c757d; font-size: 1.5rem; cursor: pointer; padding: 0;">×</button>
                        </div>
                        
                        <!-- Date Range Selector -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: end; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; font-size: 0.9rem;">Start Date:</label>
                                <input type="date" id="accomplishmentStartDate" 
                                       style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; font-size: 0.9rem;">End Date:</label>
                                <input type="date" id="accomplishmentEndDate" 
                                       style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadAccomplishments()" class="btn btn-sm btn-primary" style="font-weight: 500;">
                                    📊 Generate Report
                                </button>
                                <button onclick="setTodayRange()" class="btn btn-sm btn-outline-secondary" style="font-weight: 500;">
                                    Today
                                </button>
                                <button onclick="setThisWeekRange()" class="btn btn-sm btn-outline-secondary" style="font-weight: 500;">
                                    This Week
                                </button>
                            </div>
                        </div>
                        
                        <!-- Report Content -->
                        <div id="accomplishmentReportContent" style="background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 20px; min-height: 300px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; white-space: pre-wrap; line-height: 1.6;">
                            <p style="text-align: center; color: #6c757d;">Select a date range and click "Generate Report" to view accomplishments.</p>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; flex-wrap: wrap;">
                            <button onclick="copyAccomplishmentReport()" id="copyReportBtn" class="btn btn-sm btn-primary" style="font-weight: 500;" disabled>
                                📋 Copy Report
                            </button>
                            <button onclick="emailAccomplishmentReport()" id="emailReportBtn" class="btn btn-sm btn-warning" style="font-weight: 500;" disabled>
                                📧 Email Report
                            </button>
                            <button onclick="saveAccomplishmentReport()" id="saveReportBtn" class="btn btn-sm btn-success" style="font-weight: 500;" disabled>
                                💾 Save Report
                            </button>
                            <button onclick="downloadAccomplishmentReport()" id="downloadReportBtn" class="btn btn-sm btn-info" style="font-weight: 500;" disabled>
                                📥 Download as File
                            </button>
                            <button onclick="viewPastReports()" class="btn btn-sm btn-outline-secondary" style="font-weight: 500;">
                                📚 View Past Reports
                            </button>
                        </div>
                        
                        <!-- Notes Field -->
                        <div style="margin-top: 15px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px; font-size: 0.9rem;">Notes (optional):</label>
                            <textarea id="reportNotes" placeholder="Add any notes about this report..." rows="2"
                                      style="width: 100%; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem; resize: vertical;"></textarea>
                        </div>
                    </div>
                    
                    <% if (allTasks && allTasks.length > 0) { %>
                        <% 
                        // Store all tasks for client-side filtering
                        const allTasksJson = JSON.stringify(allTasks.map(task => ({
                            _id: task._id.toString(),
                            title: task.title,
                            description: task.description || '',
                            status: task.status,
                            priority: task.priority,
                            category: task.category,
                            dueDate: task.dueDate,
                            createdAt: task.createdAt,
                            assignedTo: task.assignedTo || '',
                            relatedPONumbers: task.relatedPONumbers || [],
                            relatedPOs: task.relatedPOs ? task.relatedPOs.map(po => ({ _id: po._id.toString(), poNumber: po.poNumber })) : []
                        })));
                        %>
                        <script>
                            window.allTasksData = <%- allTasksJson %>;
                        </script>
                        <div id="compactTasksGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">
                            <% allTasks.slice(0, 8).forEach(task => { 
                                const priorityColors = {
                                    'critical': '#dc3545',
                                    'high': '#fd7e14',
                                    'medium': '#ffc107',
                                    'low': '#28a745'
                                };
                                const statusColors = {
                                    'pending': '#6c757d',
                                    'in-progress': '#0dcaf0',
                                    'completed': '#198754',
                                    'cancelled': '#adb5bd',
                                    'on-hold': '#fd7e14'
                                };
                                const statusIcons = {
                                    'pending': '⏳',
                                    'in-progress': '🔄',
                                    'completed': '✅',
                                    'cancelled': '❌',
                                    'on-hold': '⏸️'
                                };
                                const priorityIcons = {
                                    'critical': '🔴',
                                    'high': '🟠',
                                    'medium': '🟡',
                                    'low': '🟢'
                                };
                                
                                const dueDate = new Date(task.dueDate);
                                const now = new Date();
                                const isOverdue = dueDate < now && task.status !== 'completed';
                                const dueDateStr = dueDate.toLocaleDateString();
                            %>
                                <div class="task-card-clickable" 
                                     data-task-url="/tasks?taskId=<%= task._id %>"
                                     style="background: <%= isOverdue ? '#fff5f5' : '#f8f9fa' %>; border-left: 4px solid <%= priorityColors[task.priority] %>; border-radius: 8px; padding: 15px; transition: all 0.3s ease; cursor: pointer;" 
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    
                                    <!-- Header -->
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div style="flex: 1; padding-right: 10px;">
                                            <div style="font-weight: 600; color: #2c3e50; font-size: 0.95rem; margin-bottom: 5px; line-height: 1.3;">
                                                <%= task.title %>
                                            </div>
                                            <% if (task.description) { %>
                                                <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 8px; line-height: 1.4; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis;">
                                                    <%= task.description.substring(0, 80) %><%= task.description.length > 80 ? '...' : '' %>
                                                </div>
                                            <% } %>
                                        </div>
                                        <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                            <button class="task-edit-btn" 
                                                    data-task-id="<%= task._id %>"
                                                    style="background: #0d6efd; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#0b5ed7'" 
                                                    onmouseout="this.style.background='#0d6efd'"
                                                    title="Edit task">
                                                ✏️ Edit
                                            </button>
                                            <button class="task-archive-btn"
                                                    data-task-id="<%= task._id %>"
                                                    style="background: #6c757d; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#5c636a'" 
                                                    onmouseout="this.style.background='#6c757d'"
                                                    title="Archive task">
                                                📦 Archive
                                            </button>
                                            <button class="task-delete-btn"
                                                    data-task-id="<%= task._id %>"
                                                    data-task-title="<%= task.title %>"
                                                    style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#bb2d3b'" 
                                                    onmouseout="this.style.background='#dc3545'"
                                                    title="Delete task">
                                                🗑️ Delete
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Badges -->
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                                        <span style="background: <%= statusColors[task.status] %>; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">
                                            <%= statusIcons[task.status] %> <%= task.status.replace('-', ' ').toUpperCase() %>
                                        </span>
                                        <span style="background: <%= priorityColors[task.priority] %>; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">
                                            <%= priorityIcons[task.priority] %> <%= task.priority.toUpperCase() %>
                                        </span>
                                        <% if (task.category) { %>
                                            <span style="background: #e9ecef; color: #495057; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                                📁 <%= task.category.replace('-', ' ').toUpperCase() %>
                                            </span>
                                        <% } %>
                                    </div>
                                    
                                    <!-- Footer Info -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #6c757d; padding-top: 10px; border-top: 1px solid #e9ecef;">
                                        <div>
                                            <% if (isOverdue) { %>
                                                <span style="color: #dc3545; font-weight: 600;">⚠️ OVERDUE</span>
                                            <% } else { %>
                                                <span>📅 Due: <%= dueDateStr %></span>
                                            <% } %>
                                        </div>
                                        <div>
                                            <% if (task.assignedTo) { %>
                                                <span>👤 <%= task.assignedTo %></span>
                                            <% } else { %>
                                                <span style="color: #adb5bd;">Unassigned</span>
                                            <% } %>
                                        </div>
                                    </div>
                                    
                                    <!-- Related POs -->
                                    <% if (task.relatedPONumbers && task.relatedPONumbers.length > 0) { %>
                                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef; font-size: 0.75rem;">
                                            <span style="color: #6c757d;">🔗 POs: </span>
                                            <% task.relatedPONumbers.slice(0, 3).forEach((poNum, idx) => { %>
                                                <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 8px; margin-right: 4px; font-weight: 500;">
                                                    <%= poNum %>
                                                </span>
                                            <% }); %>
                                            <% if (task.relatedPONumbers.length > 3) { %>
                                                <span style="color: #6c757d;">+<%= task.relatedPONumbers.length - 3 %> more</span>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </div>
                            <% }); %>
                        </div>
                        
                        <% if (allTasks.length > 8) { %>
                            <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='/tasks'" style="font-weight: 500;">
                                    View All <%= allTasks.length %> Tasks →
                                </button>
                            </div>
                        <% } %>
                    <% } else { %>
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">📋</div>
                            <h5 style="color: #495057; margin-bottom: 10px;">No Tasks Found</h5>
                            <p style="margin-bottom: 20px;">Get started by creating your first task</p>
                            <button class="btn btn-primary btn-sm" onclick="window.location.href='/tasks'" style="font-weight: 500;">
                                Create Task
                            </button>
                        </div>
                    <% } %>
                </div>
            </div>
            <% } %>

                <% if (purchaseOrders.length===0) { %>
                    <div style="text-align: center; padding: 60px; color: #6c757d;">
                        <h3>No Purchase Orders Found</h3>
                        <p>Upload a CSV file to get started</p>
                        <a href="/upload" class="upload-btn">📁 Upload CSV</a>
                    </div>
                    <% } else { %>
                        <table id="purchaseOrdersTable">
                            <thead>
                                <tr>
                                    <th class="sortable date-cell" data-column="date">Date</th>
                                    <th class="sortable po-number" data-column="poNumber">PO Number</th>
                                    <th class="sortable priority-cell" data-column="priority">Priority</th>
                                    <th class="sortable po-type-cell" data-column="poType">Type</th>
                                    <th class="sortable vendor" data-column="vendor">Vendor</th>
                                    <th class="sortable assignee-cell" data-column="assignedTo"
                                        style="text-align: center;">ASGN</th>
                                    <th class="sortable line-items-count-cell" data-column="lineItemsCount">Line Items
                                    </th>
                                    <th class="sortable eta-cell" data-column="eta">ETA</th>
                                    <th class="sortable ns-status-cell" data-column="nsStatus">NS Status</th>
                                    <th class="sortable status-cell" data-column="status">Status</th>
                                    <th class="sortable shipping-tracking-cell" data-column="shippingTracking">Tracking
                                        <br><small style="font-weight: normal;">(Carrier & #)</small>
                                        <button class="toggle-tracking-column-btn" onclick="toggleTrackingColumn()"
                                            title="Show/Hide tracking column">
                                            👁️
                                        </button>
                                    </th>
                                    <th class="sortable last-update-cell" data-column="lastUpdate">Last Update</th>
                                    <th class="sortable location-cell" data-column="location">📍 Location</th>
                                    <th class="notes-toggle-cell">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% purchaseOrders.forEach((po, index)=> {
                                    let lineItemLocations = '';
                                    if (po.lineItems && po.lineItems.length > 0) {
                                    const locs = po.lineItems.map(item => item.locationName).filter(loc => loc);
                                    const itemLocs = [...new Set(locs)];
                                    lineItemLocations = itemLocs.length > 0 ? itemLocs.join(', ') : '';
                                    }
                                    const displayLocation = lineItemLocations || po.location || '';

                                    // Create a safe version of po for JSON serialization (avoid circular references)
                                    const safePoData = {
                                    _id: po._id,
                                    poNumber: po.poNumber,
                                    vendor: po.vendor,
                                    date: po.date,
                                    eta: po.eta,
                                    status: po.status,
                                    nsStatus: po.nsStatus,
                                    priority: po.priority,
                                    poType: po.poType || 'Seed',
                                    isDropship: po.isDropship,
                                    location: po.location,
                                    lineItemCount: po.lineItemCount,
                                    poUrl: po.poUrl || '',
                                    notes: po.notes || '',
                                    shippingTracking: po.shippingTracking || '',
                                    lineItems: po.lineItems || []
                                    };
                                    %>
                                    <!-- Main data row -->
                                    <tr data-po='<%= JSON.stringify(safePoData) %>' data-index="<%= index %>"
                                        data-line-item-locations="<%= displayLocation %>">
                                        <td class="date-cell">
                                            <%= po.date %>
                                        </td>
                                        <td class="po-number">
                                            <div class="po-container">
                                                <% if (po.poUrl && po.poUrl.trim()) { %>
                                                    <a href="<%= po.poUrl %>" target="_blank" class="po-link"
                                                        title="Open <%= po.poNumber %> link">
                                                        <%= po.poNumber %>
                                                    </a>
                                                    <% } else { %>
                                                        <span class="po-text">
                                                            <%= po.poNumber %>
                                                        </span>
                                                        <% } %>
                                                            <button
                                                                class="url-btn <%= po.poUrl && po.poUrl.trim() ? 'has-url' : '' %>"
                                                                data-id="<%- po._id %>" data-po="<%- po.poNumber %>"
                                                                data-url="<%- po.poUrl || '' %>"
                                                                title="<%= po.poUrl && po.poUrl.trim() ? 'Edit URL' : 'Add URL' %>">
                                                                🔗
                                                            </button>
                                                            <button class="copy-po-btn" data-po="<%- po.poNumber %>"
                                                                title="Copy PO Number">
                                                                📋
                                                            </button>
                                                            <button
                                                                class="manage-attachments-btn <%= po.attachments && po.attachments.length > 0 ? 'has-attachments' : '' %>"
                                                                type="button" data-po-id="<%= po._id %>"
                                                                data-po-number="<%= po.poNumber %>"
                                                                onclick="console.log('🔴 BUTTON CLICKED!', this); openPoDetailsModal('<%= po._id %>', '<%= po.poNumber %>').then(() => { const tab = document.querySelector('.tab-button[onclick*=\'attachments\']'); if (tab) tab.click(); }); return false;"
                                                                title="<%= po.attachments && po.attachments.length > 0 ? 'Manage ' + po.attachments.length + ' attachment(s)' : 'Manage attachments' %>">
                                                                D
                                                            </button>
                                                            <button
                                                                class="dropship-toggle-btn <%= (po.isDropship || (po.location && po.location.toLowerCase().includes('dropship'))) ? 'is-dropship' : '' %>"
                                                                data-id="<%- po._id %>" data-po="<%- po.poNumber %>"
                                                                data-is-dropship="<%= (po.isDropship || (po.location && po.location.toLowerCase().includes('dropship'))) ? 'true' : 'false' %>"
                                                                title="<%= (po.isDropship || (po.location && po.location.toLowerCase().includes('dropship'))) ? 'Dropship PO - Click to unmark' : 'Click to mark as dropship' %>">
                                                                🚚
                                                            </button>
                                            </div>
                                        </td>
                                        <td class="priority-cell">
                                            <select class="priority-select" data-id="<%= po._id %>"
                                                data-po="<%= po.poNumber %>"
                                                title="Set priority for PO <%= po.poNumber %>">
                                                <option value="1" <%=(po.priority || 3)==1 ? 'selected' : '' %>
                                                    class="priority-1">🔴 1</option>
                                                <option value="2" <%=(po.priority || 3)==2 ? 'selected' : '' %>
                                                    class="priority-2">🩷 2</option>
                                                <option value="3" <%=(po.priority || 3)==3 ? 'selected' : '' %>
                                                    class="priority-3">🟠 3</option>
                                                <option value="4" <%=(po.priority || 3)==4 ? 'selected' : '' %>
                                                    class="priority-4">🟡 4</option>
                                                <option value="5" <%=(po.priority || 3)==5 ? 'selected' : '' %>
                                                    class="priority-5">🟢 5</option>
                                            </select>
                                        </td>
                                        <td class="po-type-cell">
                                            <select class="po-type-select" data-id="<%= po._id.toString() %>"
                                                data-po="<%= po.poNumber %>" data-type="<%= po.poType || 'Seed' %>"
                                                title="Set type for PO <%= po.poNumber %>">
                                                <% poTypeOptions.forEach(type=> { %>
                                                    <option value="<%= type.name %>" <%=(po.poType || 'Seed'
                                                        )===type.name ? 'selected' : '' %> class="type-<%=
                                                            type.name.toLowerCase() %>">
                                                            <%= type.emoji %>
                                                                <%= type.name %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                        </td>
                                        <td class="vendor" title="<%= po.vendor %>">
                                            <% if (po.linkedVendor && po.linkedVendor._id) { %>
                                                <a href="/vendors/<%= po.linkedVendor._id %>" class="vendor-link"
                                                    title="View vendor details for <%= po.vendor %>">
                                                    <%= po.vendor %>
                                                </a>
                                                <% } else if (po.linkedVendor) { %>
                                                    <a href="/vendors/<%= po.linkedVendor %>" class="vendor-link"
                                                        title="View vendor details for <%= po.vendor %>">
                                                        <%= po.vendor %>
                                                    </a>
                                                    <% } else { %>
                                                        <%= po.vendor %>
                                                            <% } %>
                                        </td>
                                        <td class="assignee-cell" style="text-align: center;">
                                            <select class="assignee-select" data-po-id="<%= po._id %>"
                                                onchange="updateAssignment(this)"
                                                style="min-width: 60px; font-size: 11px; padding: 2px 4px;">
                                                <option value="">-</option>
                                                <% assignees.forEach(assignee=> { %>
                                                    <option value="<%= assignee._id %>" <%=po.assignedTo &&
                                                        po.assignedTo._id &&
                                                        po.assignedTo._id.toString()===assignee._id.toString()
                                                        ? 'selected' : '' %>>
                                                        <%= assignee.initials %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                        </td>
                                        <td class="line-items-count-cell">
                                            <% if (po.lineItems && po.lineItems.length> 0) { %>
                                                <div class="line-items-count-display">
                                                    <button class="po-details-btn" data-index="<%= index %>"
                                                        data-id="<%= po._id %>" data-po="<%= po.poNumber %>"
                                                        title="View PO details: <%= po.lineItems.filter(item => item.received).length %> received / <%= po.lineItems.length %> total">
                                                        📦 <span class="count-number">
                                                            <% const totalItems = po.lineItems.length; const receivedItems = po.lineItems.filter(item => item.received).length; %>
                                                            <%= receivedItems %>/<%= totalItems %>
                                                        </span>
                                                    </button>
                                                    <button class="update-netsuite-btn" data-po-id="<%= po._id %>"
                                                        data-po-number="<%= po.poNumber %>"
                                                        title="Update line items for PO <%= po.poNumber %>">
                                                        🔄
                                                    </button>
                                                </div>
                                                <% } else { %>
                                                    <div class="no-line-items-display">
                                                        <button class="po-details-btn" data-index="<%= index %>"
                                                            data-id="<%= po._id %>" data-po="<%= po.poNumber %>"
                                                            title="View PO details for <%= po.poNumber %>">
                                                            📋 Details
                                                        </button>
                                                        <button class="import-netsuite-btn" data-po-id="<%= po._id %>"
                                                            data-po-number="<%= po.poNumber %>"
                                                            title="Import NetSuite line items for PO <%= po.poNumber %>">
                                                            📥
                                                        </button>
                                                    </div>
                                                    <% } %>
                                        </td>
                                        <td class="eta-cell">
                                            <input type="date" class="eta-input" data-id="<%= po._id %>"
                                                data-po="<%= po.poNumber %>"
                                                value="<%= po.eta ? new Date(po.eta).toISOString().split('T')[0] : '' %>"
                                                title="ETA for PO <%= po.poNumber %>">
                                        </td>
                                        <td class="ns-status-cell">
                                            <span class="ns-status-display">
                                                <%= po.nsStatus %>
                                            </span>
                                        </td>
                                        <td class="status-cell">
                                            <select class="status-select <%= po.status ? 'has-status' : '' %>"
                                                data-id="<%= po._id %>" data-po="<%= po.poNumber %>"
                                                title="Custom Status for PO <%= po.poNumber %>">
                                                <option value="">Select Status...</option>
                                                <% statusOptions.forEach(option=> { %>
                                                    <option value="<%= option %>" <%=po.status===option ? 'selected'
                                                        : '' %>>
                                                        <%= option %>
                                                    </option>
                                                    <% }); %>
                                            </select>
                                        </td>
                                        <td class="shipping-tracking-cell">
                                            <div class="tracking-container">
                                                <div class="tracking-input-row">
                                                    <select class="shipping-carrier-select form-control-sm"
                                                        data-po-id="<%= po._id %>"
                                                        style="font-size: 12px; border: 1px solid #ddd; padding: 4px 8px; width: 80px; margin-right: 4px;">
                                                        <option value="FedEx" <%=(po.shippingCarrier || 'FedEx'
                                                            )==='FedEx' ? 'selected' : '' %>>FedEx</option>
                                                        <option value="UPS" <%=(po.shippingCarrier || 'FedEx' )==='UPS'
                                                            ? 'selected' : '' %>>UPS</option>
                                                        <option value="USPS" <%=(po.shippingCarrier || 'FedEx'
                                                            )==='USPS' ? 'selected' : '' %>>USPS</option>
                                                        <option value="DHL" <%=(po.shippingCarrier || 'FedEx' )==='DHL'
                                                            ? 'selected' : '' %>>DHL</option>
                                                        <option value="Amazon" <%=(po.shippingCarrier || 'FedEx'
                                                            )==='Amazon' ? 'selected' : '' %>>Amazon</option>
                                                        <option value="OnTrac" <%=(po.shippingCarrier || 'FedEx'
                                                            )==='OnTrac' ? 'selected' : '' %>>OnTrac</option>
                                                        <option value="LaserShip" <%=(po.shippingCarrier || 'FedEx'
                                                            )==='LaserShip' ? 'selected' : '' %>>LaserShip</option>
                                                        <option value="Canada Post" <%=(po.shippingCarrier || 'FedEx'
                                                            )==='Canada Post' ? 'selected' : '' %>>Canada Post</option>
                                                        <option value="Other" <%=(po.shippingCarrier || 'FedEx'
                                                            )==='Other' ? 'selected' : '' %>>Other</option>
                                                    </select>
                                                    <input type="text" class="shipping-tracking-input form-control-sm"
                                                        placeholder="Enter tracking #"
                                                        value="<%= po.shippingTracking || '' %>"
                                                        data-po-id="<%= po._id %>"
                                                        style="font-size: 12px; border: 1px solid #ddd; padding: 4px 8px; flex: 1;">
                                                </div>
                                                <% if (po.shippingTracking) { %>
                                                    <div class="tracking-actions">
                                                        <button class="btn btn-sm btn-outline-primary tracking-info-btn"
                                                            data-tracking="<%= po.shippingTracking %>"
                                                            data-carrier="<%= po.shippingCarrier || 'FedEx' %>"
                                                            data-po-id="<%= po._id %>" title="Get tracking info">
                                                            🔍
                                                        </button>
                                                        <button
                                                            class="btn btn-sm btn-outline-success tracking-update-btn"
                                                            data-po-id="<%= po._id %>" title="Update tracking">
                                                            🔄
                                                        </button>
                                                    </div>
                                                    <div class="tracking-status" data-po-id="<%= po._id %>">
                                                        <small class="text-muted">Click 🔍 to check status</small>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </td>
                                        <td class="last-update-cell">
                                            <span
                                                class="last-update-display <%= po.lastUpdate ? 'has-update' : 'no-update' %>"
                                                title="Last modification: <%= po.lastUpdate ? new Date(po.lastUpdate).toLocaleString() : 'Never updated' %>">
                                                <%= po.lastUpdate ? new Date(po.lastUpdate).toLocaleString('en-US', {
                                                    month: 'short' , day: 'numeric' , year: 'numeric' , hour: '2-digit'
                                                    , minute: '2-digit' }) : '-' %>
                                            </span>
                                        </td>
                                        <td class="location-cell">
                                            <% if (displayLocation) { %>
                                                <span style="font-size: 13px; color: #495057;">
                                                    <%= displayLocation %>
                                                </span>
                                                <% } else { %>
                                                    <span style="font-size: 13px; color: #999;">No locations</span>
                                                    <% } %>
                                        </td>
                                        <td class="notes-toggle-cell">
                                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                                <button
                                                    class="notes-toggle <%= po.notes && po.notes.trim() ? 'has-notes' : '' %>"
                                                    type="button" data-index="<%= index %>"
                                                    title="<%= po.notes && po.notes.trim() ? 'View/Edit notes' : 'Add notes' %>">
                                                    <%= po.notes && po.notes.trim() ? '📝' : '➕' %>
                                                </button>
                                                <button
                                                    class="tracking-toggle-btn <%= po.shippingTracking ? 'has-status' : '' %>"
                                                    type="button" data-index="<%= index %>" data-po-id="<%= po._id %>"
                                                    data-tracking="<%= po.shippingTracking || '' %>"
                                                    data-carrier="<%= po.shippingCarrier || 'FedEx' %>"
                                                    title="<%= po.shippingTracking ? 'Tracking: ' + po.shippingTracking + ' (' + (po.shippingCarrier || 'FedEx') + ')' : 'View tracking information' %>">
                                                    🚚
                                                </button>
                                                <button class="create-task-btn" type="button" data-po-id="<%= po._id %>"
                                                    data-po-number="<%= po.poNumber %>" data-vendor="<%= po.vendor %>"
                                                    title="Create task for PO <%= po.poNumber %> and vendor <%= po.vendor %>">
                                                    ✅
                                                </button>
                                                <button class="email-vendor-btn <%= po.lastEmailSent ? 'email-sent' : '' %>" 
                                                    type="button" 
                                                    data-po-id="<%= po._id %>"
                                                    data-po-number="<%= po.poNumber %>" 
                                                    data-vendor="<%= po.vendor %>"
                                                    data-linked-vendor-id="<%= po.linkedVendor ? po.linkedVendor._id : '' %>"
                                                    data-has-unreceived="<%= po.lineItems && po.lineItems.some(item => !item.received) ? 'true' : 'false' %>"
                                                    title="<%= po.lastEmailSent ? 'Last emailed: ' + new Date(po.lastEmailSent).toLocaleDateString() + ' - Click to email again' : 'Email vendor about unreceived items' %>">
                                                    📧
                                                </button>
                                                <button class="email-vendor-btn <%= po.lastEmailSent ? 'email-sent' : '' %>" 
                                                    type="button" 
                                                    data-po-id="<%= po._id %>"
                                                    data-po-number="<%= po.poNumber %>" 
                                                    data-vendor="<%= po.vendor %>"
                                                    data-has-unreceived="<%= po.lineItems && po.lineItems.some(item => !item.received) %>"
                                                    title="<%= po.lastEmailSent ? 'Last emailed: ' + new Date(po.lastEmailSent).toLocaleDateString() : 'Email vendor about status' %>">
                                                    📧
                                                </button>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Expandable line items row -->
                                    <tr class="line-items-row" id="line-items-row-<%= index %>">
                                        <td colspan="11" class="line-items-cell-expanded">
                                            <div class="line-items-header">
                                                <div class="line-items-title">Line Items for PO <%= po.poNumber %>
                                                        <span class="line-items-status"
                                                            id="line-items-status-<%= index %>"></span>
                                                </div>
                                                <div class="line-items-actions">
                                                    <button class="show-received-toggle" id="show-received-<%= index %>"
                                                        style="display: none;">
                                                        👁️ Show Received
                                                    </button>
                                                    <button class="line-items-close"
                                                        data-index="<%= index %>">Close</button>
                                                </div>
                                            </div>
                                            <div class="line-items-container" id="line-items-container-<%= index %>">
                                                <div class="loading-line-items">Loading line items...</div>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Expandable notes row -->
                                    <tr class="notes-row" id="notes-row-<%= index %>">
                                        <td colspan="11" class="notes-cell-expanded">
                                            <div class="notes-header">
                                                <div class="notes-title">Notes for PO <%= po.poNumber %>
                                                </div>
                                                <div class="notes-actions">
                                                    <button class="notes-close" data-index="<%= index %>">Close</button>
                                                </div>
                                            </div>
                                            <div class="notes-container">
                                                <textarea
                                                    class="notes-input <%= po.notes && po.notes.trim() ? 'has-notes' : '' %>"
                                                    data-id="<%= po._id %>" data-po="<%= po.poNumber %>"
                                                    data-index="<%= index %>"
                                                    placeholder="Add detailed notes for <%= po.poNumber %>... (These notes persist across CSV uploads)"><%= po.notes %></textarea>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Expandable tracking row -->
                                    <tr class="tracking-row" id="tracking-row-<%= index %>">
                                        <td colspan="11" class="tracking-cell-expanded">
                                            <div class="tracking-header">
                                                <div class="tracking-title">🚚 Tracking Information for PO <%=
                                                        po.poNumber %>
                                                </div>
                                                <div class="tracking-actions">
                                                    <button class="tracking-close"
                                                        data-index="<%= index %>">Close</button>
                                                </div>
                                            </div>
                                            <div class="tracking-container">
                                                <% if (po.shippingTracking) { %>
                                                    <div class="tracking-info-row">
                                                        <div class="tracking-info-item">
                                                            <div class="tracking-info-label">Tracking Number</div>
                                                            <div class="tracking-info-value">
                                                                <a href="#" class="tracking-link"
                                                                    onclick="openTrackingUrl('<%= po.shippingTracking %>', '<%= po.shippingCarrier || 'FedEx' %>'); return false;">
                                                                    <%= po.shippingTracking %>
                                                                </a>
                                                            </div>
                                                        </div>
                                                        <div class="tracking-info-item">
                                                            <div class="tracking-info-label">Carrier</div>
                                                            <div class="tracking-info-value">
                                                                <%= po.shippingCarrier || 'FedEx' %>
                                                            </div>
                                                        </div>
                                                        <div class="tracking-info-item">
                                                            <div class="tracking-info-label">Vendor</div>
                                                            <div class="tracking-info-value">
                                                                <%= po.vendor %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="tracking-button-group">
                                                        <button class="tracking-action-btn primary"
                                                            onclick="openTrackingUrl('<%= po.shippingTracking %>', '<%= po.shippingCarrier || 'FedEx' %>')">
                                                            🌐 View on <%= po.shippingCarrier || 'FedEx' %> Website
                                                        </button>
                                                        <button class="tracking-action-btn secondary"
                                                            onclick="checkTrackingStatus('<%= po._id %>', '<%= po.shippingTracking %>', '<%= po.shippingCarrier || 'FedEx' %>')">
                                                            🔍 Check Status
                                                        </button>
                                                        <button class="tracking-action-btn secondary"
                                                            onclick="updateTrackingInfo('<%= po._id %>')">
                                                            ✏️ Update Tracking
                                                        </button>
                                                    </div>
                                                    <% } else { %>
                                                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                                                            <p>No tracking information available for this PO.</p>
                                                            <button class="tracking-action-btn primary"
                                                                onclick="updateTrackingInfo('<%= po._id %>')">
                                                                ➕ Add Tracking Information
                                                            </button>
                                                        </div>
                                                        <% } %>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Expandable email vendor row -->
                                    <tr class="email-vendor-row" id="email-vendor-row-<%= index %>">
                                        <td colspan="11" class="email-vendor-cell-expanded">
                                            <div class="email-vendor-header">
                                                <div class="email-vendor-title">📧 Email Vendor - Status Request for PO <%= po.poNumber %>
                                                </div>
                                                <div class="email-vendor-actions">
                                                    <button class="email-vendor-close"
                                                        data-index="<%= index %>">Close</button>
                                                </div>
                                            </div>
                                            <div class="email-vendor-container">
                                                <!-- PO Info Display -->
                                                <div class="email-po-info" id="email-po-info-<%= index %>">
                                                    <h4>Purchase Order Details</h4>
                                                    <div class="email-po-details">
                                                        <!-- Details will be loaded dynamically -->
                                                    </div>
                                                </div>

                                                <!-- Email Form -->
                                                <form class="email-vendor-form" id="email-vendor-form-<%= index %>" data-po-id="<%= po._id %>" data-po-number="<%= po.poNumber %>" data-vendor="<%= po.vendor %>" data-linked-vendor-id="<%= po.linkedVendor ? po.linkedVendor._id : '' %>">
                                                    <!-- Email Template Selection -->
                                                    <div class="email-form-group">
                                                        <label>Email Template:</label>
                                                        <div style="display: flex; gap: 8px; align-items: center;">
                                                            <select class="email-template-select" data-index="<%= index %>" style="flex: 1;">
                                                                <option value="">Loading templates...</option>
                                                            </select>
                                                            <button type="button" class="template-manage-btn" onclick="window.open('/manage-email-templates', '_blank')" title="Manage Templates">
                                                                ⚙️
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- View Mode Toggle -->
                                                    <div class="email-form-group">
                                                        <label>View Mode:</label>
                                                        <div class="view-mode-tabs" data-index="<%= index %>">
                                                            <button type="button" class="view-mode-tab active" data-mode="preview" data-index="<%= index %>" onclick="switchViewMode('<%= index %>', 'preview')">
                                                                👁️ Preview
                                                            </button>
                                                            <button type="button" class="view-mode-tab" data-mode="edit" data-index="<%= index %>" onclick="switchViewMode('<%= index %>', 'edit')">
                                                                ✏️ Edit
                                                            </button>
                                                            <button type="button" class="view-mode-tab" data-mode="code" data-index="<%= index %>" onclick="switchViewMode('<%= index %>', 'code')">
                                                                💻 Code
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Recipient Email -->
                                                    <div class="email-form-group">
                                                        <label>To:</label>
                                                        <input type="email" class="email-recipient-input" required placeholder="vendor@example.com">
                                                        <small class="email-vendor-suggestions" id="email-suggestions-<%= index %>">
                                                            <!-- Vendor contact suggestions will appear here -->
                                                        </small>
                                                    </div>

                                                    <!-- Subject -->
                                                    <div class="email-form-group">
                                                        <label>Subject:</label>
                                                        <input type="text" class="email-subject-input" required>
                                                    </div>

                                                    <!-- Message Body -->
                                                    <div class="email-form-group">
                                                        <label>Message:</label>
                                                        <div class="email-body-preview" id="email-body-preview-<%= index %>" style="display: none;">
                                                            <!-- Rendered preview will appear here -->
                                                        </div>
                                                        <textarea class="email-body-textarea" id="email-body-edit-<%= index %>" rows="12" required style="display: block;"></textarea>
                                                        <textarea class="email-body-code" id="email-body-code-<%= index %>" rows="12" style="display: none; font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                                                        <div class="template-modified-notice" id="template-modified-<%= index %>" style="display: none;">
                                                            ⚠️ Template has been modified
                                                            <button type="button" class="save-as-template-btn" onclick="saveAsTemplate('<%= index %>')">
                                                                💾 Save as New Template
                                                            </button>
                                                            <button type="button" class="update-template-btn" onclick="updateTemplate('<%= index %>')" style="display: none;">
                                                                🔄 Update Current Template
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Actions -->
                                                    <div class="email-form-actions">
                                                        <label class="email-track-label">
                                                            <input type="checkbox" class="email-track-checkbox" checked>
                                                            <span>Track this communication</span>
                                                        </label>
                                                        <div class="email-buttons">
                                                            <button type="button" class="email-cancel-btn" data-index="<%= index %>">
                                                                Cancel
                                                            </button>
                                                            <button type="submit" class="email-send-btn">
                                                                📧 Send Email
                                                            </button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>

                        <div class="no-results" id="noResults" style="display: none;">
                            <h3>No Purchase Orders Match Your Filters</h3>
                            <p>Try adjusting your search criteria or clearing the filters.</p>
                        </div>
                        <% } %>
    </div>

    <!-- Status Management Modal -->
    <div id="statusModal" class="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <div class="status-modal-title">Manage Status Options</div>
                <button class="status-close" onclick="closeStatusModal()">&times;</button>
            </div>

            <div class="status-form">
                <input type="text" id="statusInput" class="status-input" placeholder="Enter new status option..."
                    maxlength="50">
                <button id="addStatusBtn" class="status-add-btn" onclick="addStatusOption()">Add</button>
            </div>

            <div id="statusList" class="status-list">
                <!-- Status options will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Line Item Status Management Modal -->
    <div id="lineItemStatusModal" class="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <div class="status-modal-title">Manage Line Item Status Options</div>
                <button class="status-close" onclick="closeLineItemStatusModal()">&times;</button>
            </div>

            <div class="status-form">
                <input type="text" id="lineItemStatusInput" class="status-input"
                    placeholder="Enter new line item status option..." maxlength="50">
                <button id="addLineItemStatusBtn" class="status-add-btn"
                    onclick="addLineItemStatusOption()">Add</button>
            </div>

            <div id="lineItemStatusList" class="status-list">
                <!-- Line item status options will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Carrier Management Modal -->
    <div id="carrierModal" class="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <div class="status-modal-title">Manage Carrier Options</div>
                <button class="status-close" onclick="closeCarrierModal()">&times;</button>
            </div>

            <div class="status-form">
                <input type="text" id="carrierInput" class="status-input" placeholder="Enter new carrier option..."
                    maxlength="50">
                <button id="addCarrierBtn" class="status-add-btn" onclick="addCarrierOption()">Add</button>
            </div>

            <div id="carrierList" class="status-list">
                <!-- Carrier options will be loaded here -->
            </div>
        </div>
    </div>

    <!-- PO Type Management Modal -->
    <div id="poTypeModal" class="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <div class="status-modal-title">Manage PO Type Options</div>
                <button class="status-close" onclick="closePoTypeModal()">&times;</button>
            </div>

            <div class="status-form">
                <input type="text" id="poTypeNameInput" class="status-input" placeholder="Enter type name..."
                    maxlength="30">
                <input type="text" id="poTypeEmojiInput" class="status-input" placeholder="Emoji (e.g., 🌱)"
                    maxlength="5" style="width: 80px; margin-left: 10px;">
                <input type="color" id="poTypeColorInput" class="status-input" value="#6c757d"
                    style="width: 60px; height: 38px; margin-left: 10px; cursor: pointer;">
                <button id="addPoTypeBtn" class="status-add-btn" onclick="addPoTypeOption()">Add</button>
            </div>

            <div id="poTypeList" class="status-list">
                <!-- PO type options will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Assignee Management Modal -->
    <div id="assigneeModal" class="status-modal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <div class="status-modal-title">Manage Assignees</div>
                <button class="status-close" onclick="closeAssigneeModal()">&times;</button>
            </div>

            <div class="status-form">
                <input type="text" id="assigneeNameInput" class="status-input" placeholder="Enter name..."
                    maxlength="100">
                <input type="text" id="assigneeInitialsInput" class="status-input" placeholder="Initials" maxlength="5"
                    style="width: 80px; margin-left: 10px; text-transform: uppercase;">
                <input type="email" id="assigneeEmailInput" class="status-input" placeholder="Email (optional)"
                    style="width: 200px; margin-left: 10px;">
                <input type="color" id="assigneeColorInput" class="status-input" value="#3498db"
                    style="width: 60px; height: 38px; margin-left: 10px; cursor: pointer;">
                <button id="addAssigneeBtn" class="status-add-btn" onclick="addAssignee()">Add</button>
            </div>

            <div id="assigneeList" class="status-list">
                <!-- Assignees will be loaded here -->
            </div>
        </div>
    </div>

    <!-- URL Management Modal -->
    <div id="urlModal" class="url-modal">
        <div class="url-modal-content">
            <div class="url-modal-header">
                <div class="url-modal-title" id="urlModalTitle">Add URL for PO</div>
                <button class="url-close" onclick="closeUrlModal()">&times;</button>
            </div>

            <div class="url-form">
                <label for="urlInput">URL:</label>
                <input type="url" id="urlInput" class="url-input" placeholder="https://example.com">

                <div class="url-actions">
                    <button id="urlRemoveBtn" class="url-remove-btn" onclick="removeUrl()" style="display: none;">Remove
                        URL</button>
                    <button class="url-cancel-btn" onclick="closeUrlModal()">Cancel</button>
                    <button id="urlSaveBtn" class="url-save-btn" onclick="saveUrl()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PO Details Modal -->
    <div id="poDetailsModal" class="status-modal">
        <div class="status-modal-content" style="max-width: 1000px;">
            <div class="status-modal-header">
                <div class="status-modal-title" id="poDetailsTitle">PO Details</div>
                <button class="status-close" onclick="closePoDetailsModal()">&times;</button>
            </div>

            <div class="po-details-tabs">
                <button class="tab-button active" onclick="showTab('lineItems')">📦 Line Items</button>
                <button class="tab-button" onclick="showTab('notesHistory')">📋 Notes History</button>
                <button class="tab-button" onclick="showTab('attachments')">📎 Documents</button>
            </div>

            <div id="lineItemsTab" class="tab-content active">
                <div id="poDetailsLineItems" class="po-details-line-items">
                    <!-- Line items will be loaded here -->
                </div>
            </div>

            <div id="notesHistoryTab" class="tab-content">
                <div id="poDetailsNotesHistory" class="po-details-notes-history">
                    <!-- Notes history will be loaded here -->
                </div>
            </div>

            <div id="attachmentsTab" class="tab-content">
                <div class="attachments-section">
                    <div class="attachments-header">
                        <h4>Document Attachments</h4>
                        <p class="attachments-description">Upload purchase orders, invoices, packing slips, and other
                            documents related to this PO.</p>
                    </div>

                    <div class="attachment-upload-form">
                        <form id="attachmentUploadForm" enctype="multipart/form-data">
                            <input type="hidden" id="attachmentPOId" name="poId">

                            <div class="upload-form-row">
                                <div class="form-group">
                                    <label for="attachmentFile">Select File:</label>
                                    <input type="file" id="attachmentFile" name="attachment"
                                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.txt" required>
                                    <small class="file-hint">Supported: PDF, Images, Word, Excel, Text files (Max:
                                        10MB)</small>
                                </div>

                                <div class="form-group">
                                    <label for="documentType">Document Type:</label>
                                    <select id="documentType" name="documentType">
                                        <option value="Purchase Order">Purchase Order</option>
                                        <option value="Invoice">Invoice</option>
                                        <option value="Packing Slip">Packing Slip</option>
                                        <option value="Bill of Lading (BOL)">Bill of Lading (BOL)</option>
                                        <option value="Shipping Confirmation">Shipping Confirmation</option>
                                        <option value="Receipt">Receipt</option>
                                        <option value="Quote">Quote</option>
                                        <option value="Contract">Contract</option>
                                        <option value="Specification Sheet">Specification Sheet</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="attachmentDescription">Description (Optional):</label>
                                <input type="text" id="attachmentDescription" name="description"
                                    placeholder="Brief description of this document...">
                            </div>

                            <button type="submit" class="upload-attachment-btn">
                                📎 Upload Document
                            </button>
                        </form>
                    </div>

                    <div class="attachments-list">
                        <h5>Uploaded Documents:</h5>
                        <div id="attachmentsList" class="attachments-container">
                            <!-- Attachments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tracking Details Modal -->
    <div id="trackingDetailsModal" class="status-modal">
        <div class="status-modal-content" style="max-width: 600px;">
            <div class="status-modal-header">
                <div class="status-modal-title" id="trackingDetailsTitle">Tracking Information</div>
                <button class="status-close" onclick="closeTrackingDetailsModal()">&times;</button>
            </div>

            <div id="trackingDetailsContent" class="tracking-details-content">
                <!-- Tracking details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="status-modal">
        <div class="status-modal-content" style="max-width: 500px;">
            <div class="status-modal-header">
                <div class="status-modal-title">Create Task</div>
                <button class="status-close" onclick="closeCreateTaskModal()">&times;</button>
            </div>

            <div class="status-modal-body" style="padding: 20px;">
                <form id="createTaskForm">
                    <input type="hidden" id="taskPOId" name="poId">

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="taskTitle" style="display: block; margin-bottom: 5px; font-weight: 500;">Task
                            Title:</label>
                        <input type="text" id="taskTitle" name="title" required
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="taskDescription"
                            style="display: block; margin-bottom: 5px; font-weight: 500;">Description:</label>
                        <textarea id="taskDescription" name="description" rows="4"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="taskDueDate" style="display: block; margin-bottom: 5px; font-weight: 500;">Due
                            Date:</label>
                        <input type="date" id="taskDueDate" name="dueDate"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="taskPriority"
                            style="display: block; margin-bottom: 5px; font-weight: 500;">Priority:</label>
                        <select id="taskPriority" name="priority"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Related To:</label>
                        <div id="taskRelatedInfo"
                            style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 14px;">
                            <!-- PO and vendor info will be displayed here -->
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeCreateTaskModal()"
                            style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit"
                            style="padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">
                            Create Task
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vendor Email Modal -->
    <div id="vendorEmailModal" class="status-modal">
        <div class="status-modal-content" style="max-width: 800px;">
            <div class="status-modal-header">
                <div class="status-modal-title">📧 Email Vendor - Status Request</div>
                <button class="status-close" onclick="closeVendorEmailModal()">&times;</button>
            </div>

            <div class="status-modal-body" style="padding: 20px;">
                <form id="vendorEmailForm">
                    <input type="hidden" id="emailPOId" name="poId">
                    <input type="hidden" id="emailLinkedVendorId" name="linkedVendorId">

                    <!-- PO Info Display -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Purchase Order Details</h4>
                        <div id="vendorEmailPOInfo" style="color: #6c757d;">
                            <!-- PO details will be loaded here -->
                        </div>
                    </div>

                    <!-- Email Template Selection -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="emailTemplate" style="display: block; margin-bottom: 5px; font-weight: 500;">Email Template:</label>
                        <select id="emailTemplate" name="template" onchange="loadEmailTemplate()"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">-- Select Template --</option>
                            <option value="default">Default Status Request</option>
                            <option value="urgent">Urgent Follow-up</option>
                            <option value="custom">Custom Message</option>
                        </select>
                    </div>

                    <!-- Recipient Email -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="recipientEmail" style="display: block; margin-bottom: 5px; font-weight: 500;">To:</label>
                        <input type="email" id="recipientEmail" name="recipient" required
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                            placeholder="vendor@example.com">
                        <small id="vendorEmailSuggestions" style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                            <!-- Vendor contact suggestions will appear here -->
                        </small>
                    </div>

                    <!-- Subject -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="emailSubject" style="display: block; margin-bottom: 5px; font-weight: 500;">Subject:</label>
                        <input type="text" id="emailSubject" name="subject" required
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <!-- Message Body -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="emailBody" style="display: block; margin-bottom: 5px; font-weight: 500;">Message:</label>
                        <textarea id="emailBody" name="body" rows="12" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: Arial, sans-serif;"></textarea>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                        <div>
                            <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="trackEmail" name="trackEmail" checked>
                                <span style="font-size: 14px;">Track this communication</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" onclick="closeVendorEmailModal()"
                                style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit"
                                style="padding: 8px 24px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                📧 Send Email
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    </div>

    <script>
        console.log('🚀 Dashboard JavaScript starting to load...');

        // Navigation Functions
        function toggleAccordion(accordionId) {
            const content = document.getElementById(accordionId);
            if (!content) return;

            const button = content.previousElementSibling;
            const icon = button ? button.querySelector('.accordion-icon') : null;

            content.classList.toggle('show');
            if (icon) {
                icon.classList.toggle('rotated');
            }
        }

        function toggleOptionsDropdown() {
            const content = document.getElementById('optionsDropdown');
            const icon = document.querySelector('.nav-options-btn .dropdown-icon');

            content.classList.toggle('show');
            icon.classList.toggle('rotated');

            // Close other dropdowns
            document.getElementById('importsDropdown').classList.remove('show');
            document.querySelector('.nav-imports-btn .dropdown-icon').classList.remove('rotated');
        }

        function toggleImportsDropdown() {
            const content = document.getElementById('importsDropdown');
            const icon = document.querySelector('.nav-imports-btn .dropdown-icon');

            content.classList.toggle('show');
            icon.classList.toggle('rotated');

            // Close other dropdowns
            document.getElementById('optionsDropdown').classList.remove('show');
            document.querySelector('.nav-options-btn .dropdown-icon').classList.remove('rotated');
        }

        // ============ QUICK UPLOAD FUNCTIONALITY ============
        
        async function openQuickUpload() {
            // Load the latest NetSuite URL
            await loadNetSuiteUrl();
            
            document.getElementById('quickUploadModal').style.display = 'block';
            // Close the imports dropdown
            document.getElementById('importsDropdown').classList.remove('show');
            document.querySelector('.nav-imports-btn .dropdown-icon').classList.remove('rotated');
        }

        function closeQuickUpload() {
            document.getElementById('quickUploadModal').style.display = 'none';
            document.getElementById('quickUploadForm').reset();
            document.getElementById('selectedFileName').style.display = 'none';
            document.getElementById('quickUploadBtn').disabled = true;
            document.getElementById('uploadProgress').style.display = 'none';
        }

        // Track if NetSuite window was opened
        let netsuiteWindowOpened = false;
        let autoDetectEnabled = false;
        let netsuiteWindow = null;
        let netsuiteUrl = 'https://4774474.app.netsuite.com/app/reporting/reportrunner.nl?cr=545&reload=T&whence=&siaT=1763569172700'; // Default
        const DEBUG = true; // Enable debug logging

        function debugLog(message, data = null) {
            if (DEBUG) {
                console.log(`[Quick Upload Debug] ${message}`, data || '');
            }
        }

        // Load NetSuite URL from server
        async function loadNetSuiteUrl() {
            try {
                const response = await fetch('/api/get-netsuite-url');
                const data = await response.json();
                if (data.success && data.url) {
                    netsuiteUrl = data.url;
                    debugLog('NetSuite URL loaded from server:', netsuiteUrl);
                }
            } catch (error) {
                debugLog('Error loading NetSuite URL, using default:', error);
            }
        }

        // Open NetSuite in a new window
        function openNetSuiteWindow() {
            debugLog('Opening NetSuite window with URL:', netsuiteUrl);
            
            // Calculate window position (centered but not maximized)
            const width = 1200;
            const height = 900;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            netsuiteWindow = window.open(
                netsuiteUrl,
                '_blank',
                `popup=yes,width=${width},height=${height},left=${left},top=${top},toolbar=yes,location=yes,status=yes,menubar=yes,scrollbars=yes,resizable=yes`
            );

            if (netsuiteWindow) {
                netsuiteWindow.focus();
                netsuiteWindowOpened = true;
                autoDetectEnabled = true;
                debugLog('NetSuite window opened successfully', { opened: netsuiteWindowOpened, autoDetect: autoDetectEnabled });
                
                // Monitor when NetSuite window closes
                const checkWindowClosed = setInterval(() => {
                    if (netsuiteWindow && netsuiteWindow.closed) {
                        debugLog('NetSuite window was closed by user');
                        clearInterval(checkWindowClosed);
                        // Show notification to click auto-detect button
                        setTimeout(() => {
                            debugLog('Showing auto-detect reminder...');
                            if (autoDetectEnabled) {
                                // Highlight the auto-detect button
                                const autoDetectBtn = document.querySelector('button[onclick="autoDetectLatestFile()"]');
                                if (autoDetectBtn) {
                                    autoDetectBtn.style.animation = 'pulse 1.5s ease-in-out 3';
                                    autoDetectBtn.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.6)';
                                }
                                alert('✅ NetSuite window closed!\\n\\n📁 File downloaded?\\n\\n👉 Click "🔍 Quick Select Latest CSV" to choose it');
                            }
                        }, 500);
                    }
                }, 500);
                
                // Show a helpful message
                setTimeout(() => {
                    alert('💡 NetSuite export page opened!\\n\\n1. Click the export/download button in NetSuite\\n2. Close the NetSuite window when done\\n3. Click "Quick Select" to choose the file');
                }, 500);
            } else {
                debugLog('NetSuite window blocked!');
                alert('⚠️ Pop-up blocked!\\n\\nPlease allow pop-ups for this site and try again.');
            }
        }

        // Simplified auto-detect - just opens file picker for CSV files
        async function autoDetectLatestFile() {
            debugLog('Quick select function called');
            const fileInput = document.getElementById('quickCsvFile');
            
            // Simply trigger the file input click
            fileInput.click();
            debugLog('File picker opened');
        }

        // Check auth status before critical operations
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth-status', {
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Auth check failed:', error);
                return false;
            }
        }

        // Handle file selection
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM Content Loaded - initializing event listeners');
            const fileInput = document.getElementById('quickCsvFile');
            const dropZone = document.getElementById('dropZone');
            const uploadForm = document.getElementById('quickUploadForm');

            // File input change handler
            fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    document.getElementById('fileNameText').textContent = fileName;
                    document.getElementById('selectedFileName').style.display = 'block';
                    document.getElementById('quickUploadBtn').disabled = false;
                }
            });

            // Drag and drop handlers
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#764ba2';
                this.style.background = 'linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%)';
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#667eea';
                this.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#667eea';
                this.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    fileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                } else {
                    alert('Please drop a CSV file');
                }
            });

            // Click handler for drop zone
            dropZone.addEventListener('click', function(e) {
                if (e.target !== dropZone && e.target.closest('button')) {
                    return; // Let button handle the click
                }
                fileInput.click();
            });

            // Form submission with progress
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const progressDiv = document.getElementById('uploadProgress');
                const progressBar = document.getElementById('progressBar');
                const statusText = document.getElementById('uploadStatus');
                const uploadBtn = document.getElementById('quickUploadBtn');

                // Show progress
                progressDiv.style.display = 'block';
                uploadBtn.disabled = true;
                progressBar.style.width = '0%';
                statusText.textContent = 'Uploading...';

                // Simulate progress (since we can't track real upload progress easily)
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = Math.round(progress) + '%';
                }, 200);

                try {
                    const response = await fetch('/purchase-orders/upload', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        },
                        body: formData
                    });

                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';

                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        statusText.textContent = '✅ Upload complete! Opening Manage URLs...';
                        statusText.style.color = '#2e7d32';
                        
                        setTimeout(() => {
                            showLoadingOverlay();
                            window.location.href = result.redirect || '/manage-po-urls';
                        }, 1000);
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (error) {
                    clearInterval(progressInterval);
                    statusText.textContent = '❌ Upload failed: ' + error.message;
                    statusText.style.color = '#c62828';
                    uploadBtn.disabled = false;
                    
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 3000);
                }
            });
        });

        // ============ END QUICK UPLOAD FUNCTIONALITY ============

        function toggleFormsDropdown() {
            const content = document.getElementById('formsDropdown');
            const icon = document.querySelector('.nav-forms-btn .dropdown-icon');

            content.classList.toggle('show');
            icon.classList.toggle('rotated');

            // Close other dropdowns
            document.getElementById('optionsDropdown').classList.remove('show');
            document.querySelector('.nav-options-btn .dropdown-icon').classList.remove('rotated');
            document.getElementById('importsDropdown').classList.remove('show');
            document.querySelector('.nav-imports-btn .dropdown-icon').classList.remove('rotated');
        }

        async function loadForms() {
            try {
                // Fetch both forms and links
                const [formsResponse, linksResponse] = await Promise.all([
                    fetch('/forms/api/forms'),
                    fetch('/forms/api/links')
                ]);

                const formsData = await formsResponse.json();
                const linksData = await linksResponse.json();

                const dropdown = document.getElementById('formsDropdown');
                let items = [];

                // Add forms
                if (formsData.success && formsData.forms.length > 0) {
                    items.push('<div style="padding: 5px 15px; font-weight: 600; font-size: 11px; color: #7f8c8d; text-transform: uppercase;">Forms</div>');
                    items = items.concat(formsData.forms.map(form =>
                        `<a href="/forms/${form._id}" class="nav-dropdown-item" target="_blank">📋 ${form.name}</a>`
                    ));
                }

                // Add links
                if (linksData.success && linksData.links.length > 0) {
                    if (items.length > 0) {
                        items.push('<div style="padding: 5px 15px; margin-top: 8px; font-weight: 600; font-size: 11px; color: #7f8c8d; text-transform: uppercase;">Links</div>');
                    }
                    items = items.concat(linksData.links.map(link =>
                        `<a href="${link.url}" class="nav-dropdown-item" ${link.openInNewTab ? 'target="_blank"' : ''}>🔗 ${link.name}</a>`
                    ));
                }

                if (items.length > 0) {
                    dropdown.innerHTML = items.join('');
                } else {
                    dropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #7f8c8d;">No forms or links available</div>';
                }
            } catch (error) {
                console.error('Error loading forms and links:', error);
            }
        }

        function openFormsManagement() {
            window.location.href = '/forms/manage';
        }


        // Toggle Pre-Purchase Orders section visibility
        function togglePrePurchaseSection() {
            const section = document.querySelector('.pre-purchase-section');
            section.classList.toggle('show');

            // Scroll to the section if it's being shown
            if (section.classList.contains('show')) {
                section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Close the options dropdown
            document.getElementById('optionsDropdown').classList.remove('show');
            document.querySelector('.nav-options-btn .dropdown-icon').classList.remove('rotated');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            // Find sections by their button content
            const managersAccordion = document.getElementById('managersAccordion');
            const optionsDropdown = document.getElementById('optionsDropdown');
            const importsDropdown = document.getElementById('importsDropdown');
            const formsDropdown = document.getElementById('formsDropdown');
            const userSection = document.querySelector('.user-dropdown');

            // Close Managers accordion if clicking outside
            if (managersAccordion) {
                const managersSection = managersAccordion.closest('.nav-section');
                if (managersSection && !managersSection.contains(event.target)) {
                    managersAccordion.classList.remove('show');
                    const managersIcon = managersSection.querySelector('.accordion-icon');
                    if (managersIcon) managersIcon.classList.remove('rotated');
                }
            }

            // Close Options dropdown if clicking outside
            if (optionsDropdown) {
                const optionsSection = optionsDropdown.closest('.nav-section');
                if (optionsSection && !optionsSection.contains(event.target)) {
                    optionsDropdown.classList.remove('show');
                    const optionsIcon = optionsSection.querySelector('.dropdown-icon');
                    if (optionsIcon) optionsIcon.classList.remove('rotated');
                }
            }

            // Close Imports dropdown if clicking outside
            if (importsDropdown) {
                const importsSection = importsDropdown.closest('.nav-section');
                if (importsSection && !importsSection.contains(event.target)) {
                    importsDropdown.classList.remove('show');
                    const importsIcon = importsSection.querySelector('.dropdown-icon');
                    if (importsIcon) importsIcon.classList.remove('rotated');
                }
            }

            // Close Forms dropdown if clicking outside
            if (formsDropdown) {
                const formsSection = formsDropdown.closest('.nav-section');
                if (formsSection && !formsSection.contains(event.target)) {
                    formsDropdown.classList.remove('show');
                    const formsIcon = formsSection.querySelector('.dropdown-icon');
                    if (formsIcon) formsIcon.classList.remove('rotated');
                }
            }

            // Close user dropdown if clicking outside
            if (userSection && !userSection.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        // NetSuite Import Functions
        function openNetSuiteImportModal(isUpdate = false, poNumber = '') {
            const modal = document.getElementById('netsuiteImportModal');
            const modalTitle = modal.querySelector('.modal-header h3');
            const modalDescription = modal.querySelector('.modal-body p');
            const importButton = modal.querySelector('.btn-primary');

            if (isUpdate && poNumber) {
                modalTitle.textContent = `Update Line Items for PO ${poNumber}`;
                modalDescription.textContent = 'Paste your updated NetSuite PO form data below. This will update the existing line items for this purchase order.';
                importButton.textContent = 'Update Line Items';
            } else if (poNumber) {
                modalTitle.textContent = `Import Line Items for PO ${poNumber}`;
                modalDescription.textContent = 'Paste your NetSuite PO form data below. The system will automatically parse the line items and associate them with this purchase order.';
                importButton.textContent = 'Import Line Items';
            } else {
                modalTitle.textContent = 'Import NetSuite PO Form Data';
                modalDescription.textContent = 'Paste your NetSuite PO form data below. The system will automatically parse the line items and associate them with the corresponding purchase order.';
                importButton.textContent = 'Import Line Items';
            }

            modal.style.display = 'block';

            // Close imports dropdown if it's open
            const importsDropdown = document.getElementById('importsDropdown');
            const dropdownIcon = document.querySelector('.nav-imports-btn .dropdown-icon');
            if (importsDropdown) {
                importsDropdown.classList.remove('show');
            }
            if (dropdownIcon) {
                dropdownIcon.classList.remove('rotated');
            }
        }

        function closeNetSuiteImportModal() {
            document.getElementById('netsuiteImportModal').style.display = 'none';
            document.getElementById('netsuiteData').value = '';
            document.getElementById('targetPO').value = '';
            document.getElementById('addToExisting').checked = false;
        }

        function clearLineItemsData() {
            if (confirm('Clear all line items data from the text area?')) {
                document.getElementById('netsuiteData').value = '';
            }
        }

        function autoImportFromNetSuite() {
            const targetPO = document.getElementById('targetPO');
            const selectedPO = targetPO.value;
            
            // Get the PO number from the selected option
            let poNumber = '';
            if (selectedPO) {
                const selectedOption = targetPO.options[targetPO.selectedIndex];
                poNumber = selectedOption.text.split(' - ')[0]; // Extract "PO12061" from "PO12061 - Vendor Name"
            }
            
            // Build NetSuite URL
            let netsuiteUrl = 'https://td5930978.app.netsuite.com/app/accounting/transactions/purchord.nl';
            
            if (poNumber && poNumber.startsWith('PO')) {
                // Try to construct a direct link to the PO
                const poId = poNumber.replace('PO', '');
                alert(`🔄 Opening NetSuite for ${poNumber}...\n\n` +
                      `Instructions:\n` +
                      `1. Find and open your PO in NetSuite\n` +
                      `2. Scroll to the Items section\n` +
                      `3. Select and copy the entire line items table (including headers)\n` +
                      `4. Come back here and paste into the text area\n` +
                      `5. Click "Preview Changes" or "Import Line Items"`);
            } else {
                alert(`🔄 Opening NetSuite Purchase Orders...\n\n` +
                      `Instructions:\n` +
                      `1. Search for and open your PO\n` +
                      `2. Scroll to the Items section\n` +
                      `3. Select and copy the entire line items table (including headers)\n` +
                      `4. Come back here and paste into the text area\n` +
                      `5. Click "Preview Changes" or "Import Line Items"`);
            }
            
            // Open NetSuite in a new window
            const netsuiteWindow = window.open(netsuiteUrl, '_blank', 'width=1200,height=800');
            
            if (!netsuiteWindow) {
                alert('⚠️ Pop-up blocked!\n\nPlease allow pop-ups for this site and try again.');
            }
            
            // Focus back on the textarea after a moment
            setTimeout(() => {
                document.getElementById('netsuiteData').focus();
            }, 500);
        }


        // Vendor Reconciliation Functions
        async function fixMainVendors() {
            if (!confirm('This will create Vendor entries for all POs that don\'t have a linkedVendor and link them. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/purchase-orders/reconcile-main-vendors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    location.reload(); // Refresh to show updated data
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error fixing main vendors:', error);
                alert('Failed to fix main vendors: Network error');
            }
        }

        async function fixOrganicVendors() {
            if (!confirm('This will create OrganicVendor entries for all POs that don\'t have an organicVendor and link them. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/purchase-orders/reconcile-vendors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    location.reload(); // Refresh to show updated data
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error fixing organic vendors:', error);
                alert('Failed to fix organic vendors: Network error');
            }
        }

        async function fixMissingVendorsBoth() {
            if (!confirm('This will fix both Main Vendors and Organic Vendors. Continue?')) {
                return;
            }

            try {
                // First fix main vendors
                const mainResponse = await fetch('/purchase-orders/reconcile-main-vendors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const mainResult = await mainResponse.json();

                if (!mainResponse.ok) {
                    alert(`Error fixing main vendors: ${mainResult.error}`);
                    return;
                }

                // Then fix organic vendors
                const organicResponse = await fetch('/purchase-orders/reconcile-vendors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const organicResult = await organicResponse.json();

                if (organicResponse.ok) {
                    alert(`Successfully fixed both!\n\nMain Vendors: ${mainResult.message}\nOrganic Vendors: ${organicResult.message}`);
                    location.reload(); // Refresh to show updated data
                } else {
                    alert(`Main vendors fixed, but organic vendors failed: ${organicResult.error}`);
                }
            } catch (error) {
                console.error('Error fixing vendors:', error);
                alert('Failed to fix vendors: Network error');
            }
        }

        function openEmailClient() {
            alert('Email Client feature coming soon!');
        }

        async function processNetSuiteImport() {
            const netsuiteData = document.getElementById('netsuiteData').value.trim();
            const targetPOId = document.getElementById('targetPO').value;
            const addToExisting = document.getElementById('addToExisting').checked;

            if (!netsuiteData) {
                alert('Please paste the NetSuite PO form data');
                return;
            }

            try {
                const response = await fetch('/api/import-netsuite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data: netsuiteData,
                        targetPOId: targetPOId,
                        addToExisting: addToExisting
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Successfully imported ${result.imported} line items`);
                    closeNetSuiteImportModal();
                    location.reload(); // Refresh to show updated data
                } else {
                    alert(`Import failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('Import failed: Network error');
            }
        }

        // Preview Import Functions
        let previewData = null; // Store preview data for confirmation

        async function previewNetSuiteImport() {
            const netsuiteData = document.getElementById('netsuiteData').value.trim();
            const targetPOId = document.getElementById('targetPO').value;
            const addToExisting = document.getElementById('addToExisting').checked;

            if (!netsuiteData) {
                alert('Please paste the NetSuite PO form data');
                return;
            }

            try {
                // Call preview API endpoint
                const response = await fetch('/api/preview-netsuite-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data: netsuiteData,
                        targetPOId: targetPOId,
                        addToExisting: addToExisting
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    previewData = result;
                    displayPreview(result);
                    document.getElementById('netsuitePreviewModal').style.display = 'block';
                } else {
                    alert(`Preview failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Preview error:', error);
                alert('Preview failed: Network error');
            }
        }

        function displayPreview(data) {
            // Display summary
            const summaryHtml = `
                <div class="preview-summary-grid">
                    <div class="preview-summary-item new">
                        <strong>New Items</strong>
                        <div class="value">${data.summary.newItems || 0}</div>
                    </div>
                    <div class="preview-summary-item updated">
                        <strong>Updated Items</strong>
                        <div class="value">${data.summary.updatedItems || 0}</div>
                    </div>
                    <div class="preview-summary-item removed">
                        <strong>Removed Items</strong>
                        <div class="value">${data.summary.removedItems || 0}</div>
                    </div>
                    <div class="preview-summary-item">
                        <strong>Unchanged Items</strong>
                        <div class="value">${data.summary.unchangedItems || 0}</div>
                    </div>
                    <div class="preview-summary-item">
                        <strong>Total Items</strong>
                        <div class="value">${data.summary.totalItems || 0}</div>
                    </div>
                </div>
            `;
            document.getElementById('previewSummary').innerHTML = summaryHtml;

            // Display warnings/errors
            let warningsHtml = '';
            if (data.warnings && data.warnings.length > 0) {
                warningsHtml += '<div class="preview-warning"><h4>⚠️ Warnings:</h4><ul>';
                data.warnings.forEach(warning => {
                    warningsHtml += `<li>${warning}</li>`;
                });
                warningsHtml += '</ul></div>';
            }
            if (data.errors && data.errors.length > 0) {
                warningsHtml += '<div class="preview-error"><h4>❌ Errors:</h4><ul>';
                data.errors.forEach(error => {
                    warningsHtml += `<li>${error}</li>`;
                });
                warningsHtml += '</ul></div>';
            }
            document.getElementById('previewWarnings').innerHTML = warningsHtml;

            // Display legend
            const legendHtml = `
                <div class="preview-legend">
                    <div class="preview-legend-item">
                        <div class="preview-legend-box" style="background: #d4edda;"></div>
                        <span>New Item</span>
                    </div>
                    <div class="preview-legend-item">
                        <div class="preview-legend-box" style="background: #fff3cd;"></div>
                        <span>Updated Item</span>
                    </div>
                    <div class="preview-legend-item">
                        <div class="preview-legend-box" style="background: #f8d7da;"></div>
                        <span>Removed Item</span>
                    </div>
                    <div class="preview-legend-item">
                        <div class="preview-legend-box" style="background: #f8f9fa;"></div>
                        <span>Unchanged Item</span>
                    </div>
                </div>
            `;

            // Display preview table
            let tableHtml = legendHtml + '<table class="preview-table"><thead><tr>';
            tableHtml += '<th>Status</th><th>Item</th><th>Description</th><th>Quantity</th><th>Received</th><th>Billed</th><th>Rate</th><th>Changes</th>';
            tableHtml += '</tr></thead><tbody>';

            data.items.forEach(item => {
                const rowClass = item.changeType || 'unchanged-item';
                const statusIcon = {
                    'new-item': '🆕',
                    'updated-item': '📝',
                    'removed-item': '🗑️',
                    'unchanged-item': '✓'
                }[rowClass] || '';

                tableHtml += `<tr class="${rowClass}">`;
                tableHtml += `<td>${statusIcon}</td>`;
                tableHtml += `<td>${item.item || ''}</td>`;
                tableHtml += `<td>${item.memo || item.description || ''}</td>`;
                tableHtml += `<td>${formatQuantityChange(item, 'quantityExpected')}</td>`;
                tableHtml += `<td>${formatQuantityChange(item, 'quantityReceived')}</td>`;
                tableHtml += `<td>${formatQuantityChange(item, 'quantityBilled')}</td>`;
                tableHtml += `<td>${formatPriceChange(item, 'rate')}</td>`;
                tableHtml += `<td>${item.changes || ''}</td>`;
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            document.getElementById('previewContent').innerHTML = tableHtml;
        }

        function formatQuantityChange(item, field) {
            if (item.changeType === 'new-item') {
                return `<span class="preview-new-value">${item[field] || 0}</span>`;
            } else if (item.changes && item.changes.includes(field)) {
                return `
                    <div class="preview-diff">
                        <span class="preview-old-value">${item.old && item.old[field] !== undefined ? item.old[field] : 0}</span>
                        <span>→</span>
                        <span class="preview-new-value">${item[field] || 0}</span>
                    </div>
                `;
            }
            return item[field] || 0;
        }

        function formatPriceChange(item, field) {
            if (item.changeType === 'new-item') {
                return `<span class="preview-new-value">$${(item[field] || 0).toFixed(2)}</span>`;
            } else if (item.changes && item.changes.includes(field)) {
                return `
                    <div class="preview-diff">
                        <span class="preview-old-value">$${(item.old && item.old[field] !== undefined ? item.old[field] : 0).toFixed(2)}</span>
                        <span>→</span>
                        <span class="preview-new-value">$${(item[field] || 0).toFixed(2)}</span>
                    </div>
                `;
            }
            return `$${(item[field] || 0).toFixed(2)}`;
        }

        function closePreviewModal() {
            document.getElementById('netsuitePreviewModal').style.display = 'none';
            previewData = null;
        }

        async function confirmAndImport() {
            if (!previewData) {
                alert('No preview data available');
                return;
            }

            // Close preview modal
            closePreviewModal();

            // Process the actual import
            await processNetSuiteImport();
        }

        // Line Items Count Button Click Handler
        console.log('🎯 Registering main click event listener on document...');
        document.addEventListener('click', function (event) {
            // Log every click to verify event listener is working
            console.log('🖱️ CLICK DETECTED:', {
                target: event.target,
                tagName: event.target.tagName,
                className: event.target.className,
                id: event.target.id
            });

            if (event.target.closest('.line-items-count-btn')) {
                console.log('📦 Line items button clicked!');
                const btn = event.target.closest('.line-items-count-btn');
                const index = btn.dataset.index;
                console.log('📦 Button data:', { index, btn });

                // Trigger the line items view
                const lineItemsToggle = document.querySelector(`[data-index="${index}"][title*="View line items"]`);
                if (lineItemsToggle) {
                    console.log('✅ Found line items toggle, clicking...');
                    lineItemsToggle.click();
                } else {
                    console.error('❌ Line items toggle not found for index:', index);
                }
            }

            if (event.target.closest('.import-netsuite-btn')) {
                console.log('📥 Import NetSuite button clicked!');
                const btn = event.target.closest('.import-netsuite-btn');
                const poId = btn.dataset.poId;
                const poNumber = btn.dataset.poNumber;
                console.log('📥 Button data:', { poId, poNumber });

                // Set the target PO and open modal for importing
                document.getElementById('targetPO').value = poId;
                openNetSuiteImportModal(false, poNumber); // false = import mode
            }

            if (event.target.closest('.update-netsuite-btn')) {
                console.log('🔄 Update NetSuite button clicked!');
                const btn = event.target.closest('.update-netsuite-btn');
                const poId = btn.dataset.poId;
                const poNumber = btn.dataset.poNumber;
                console.log('🔄 Button data:', { poId, poNumber });

                // Set the target PO and open modal for updating
                document.getElementById('targetPO').value = poId;
                openNetSuiteImportModal(true, poNumber); // true = update mode
            }

            // Handle URL button clicks using event delegation
            if (event.target.closest('.url-btn')) {
                console.log('🔗 URL button clicked via event delegation!');
                const btn = event.target.closest('.url-btn');

                console.log('📋 Button data:', {
                    id: btn.getAttribute('data-id'),
                    po: btn.getAttribute('data-po'),
                    url: btn.getAttribute('data-url'),
                    className: btn.className
                });

                try {
                    currentUrlData = {
                        id: btn.getAttribute('data-id'),
                        poNumber: btn.getAttribute('data-po'),
                        url: btn.getAttribute('data-url') || ''
                    };
                    console.log('📝 Opening URL modal with data:', currentUrlData);
                    openUrlModal();
                    console.log('✅ URL modal opened successfully');
                } catch (error) {
                    console.error('❌ Error in URL button handler:', error);
                }
            }

            // Handle Copy PO button clicks using event delegation
            if (event.target.closest('.copy-po-btn')) {
                const btn = event.target.closest('.copy-po-btn');
                const poNumber = btn.getAttribute('data-po');

                try {
                    // Copy to clipboard
                    navigator.clipboard.writeText(poNumber).then(() => {
                        // Visual feedback
                        btn.classList.add('copied');
                        const originalTitle = btn.title;
                        btn.title = 'Copied!';

                        // Reset visual feedback after 2 seconds
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btn.title = originalTitle;
                        }, 2000);

                        console.log(`📋 Copied PO Number: ${poNumber}`);
                    }).catch(error => {
                        console.error('Failed to copy PO number:', error);
                        // Fallback for older browsers
                        fallbackCopyTextToClipboard(poNumber);
                    });
                } catch (error) {
                    console.error('❌ Error in copy PO button handler:', error);
                    fallbackCopyTextToClipboard(poNumber);
                }
            }

            // Handle PO Details button clicks using event delegation
            if (event.target.closest('.po-details-btn')) {
                const btn = event.target.closest('.po-details-btn');
                const index = btn.getAttribute('data-index');
                const poId = btn.getAttribute('data-id');
                const poNumber = btn.getAttribute('data-po');

                console.log('📦 PO Details button clicked:', { index, poId, poNumber });

                if (index !== null) {
                    const lineItemsRow = document.getElementById(`line-items-row-${index}`);

                    if (lineItemsRow) {
                        const isExpanded = lineItemsRow.classList.contains('expanded');

                        if (isExpanded) {
                            // Close the line items row
                            lineItemsRow.classList.remove('expanded');
                        } else {
                            // Open the line items row and load data
                            lineItemsRow.classList.add('expanded');

                            // Load line items data if not already loaded
                            const container = document.getElementById(`line-items-container-${index}`);
                            if (container && container.querySelector('.loading-line-items')) {
                                loadLineItemsInline(poId, index);
                            }
                        }
                    }
                } else {
                    console.error('❌ Missing index for PO details button');
                }
            }

            // Handle notes toggle buttons using event delegation
            if (event.target.closest('.notes-toggle')) {
                const btn = event.target.closest('.notes-toggle');
                const index = btn.getAttribute('data-index');
                const notesRow = document.getElementById(`notes-row-${index}`);

                if (notesRow) {
                    const isExpanded = notesRow.classList.contains('expanded');

                    if (isExpanded) {
                        notesRow.classList.remove('expanded');
                    } else {
                        notesRow.classList.add('expanded');
                        const textarea = notesRow.querySelector('.notes-input');
                        if (textarea) {
                            setTimeout(() => textarea.focus(), 100);
                        }
                    }
                }
            }

            // Handle tracking details toggle using event delegation
            if (event.target.closest('.tracking-toggle-btn')) {
                const btn = event.target.closest('.tracking-toggle-btn');
                const index = btn.getAttribute('data-index');
                const trackingRow = document.getElementById(`tracking-row-${index}`);

                if (trackingRow) {
                    const isExpanded = trackingRow.classList.contains('expanded');

                    if (isExpanded) {
                        trackingRow.classList.remove('expanded');
                    } else {
                        trackingRow.classList.add('expanded');
                    }
                }
            }

            // Handle "Show Received" toggle button using event delegation
            if (event.target.closest('.show-received-toggle')) {
                event.preventDefault(); // Prevent any onclick from firing
                const btn = event.target.closest('.show-received-toggle');
                const btnId = btn.getAttribute('id');
                const index = btnId ? btnId.replace('show-received-', '') : null;

                if (index !== null) {
                    console.log('👁️ Show Received button clicked for index:', index);
                    toggleReceivedItems(index);
                } else {
                    console.error('❌ Could not determine index for show-received button');
                }
            }

            // Handle line items close buttons using event delegation
            if (event.target.closest('.line-items-close')) {
                const btn = event.target.closest('.line-items-close');
                const index = btn.getAttribute('data-index');
                const lineItemsRow = document.getElementById(`line-items-row-${index}`);

                if (lineItemsRow) {
                    lineItemsRow.classList.remove('expanded');
                }
            }

            // Handle notes close buttons using event delegation
            if (event.target.closest('.notes-close')) {
                const btn = event.target.closest('.notes-close');
                const index = btn.getAttribute('data-index');
                const notesRow = document.getElementById(`notes-row-${index}`);

                if (notesRow) {
                    notesRow.classList.remove('expanded');
                }
            }

            // Handle tracking close buttons using event delegation
            if (event.target.closest('.tracking-close')) {
                const btn = event.target.closest('.tracking-close');
                const index = btn.getAttribute('data-index');
                const trackingRow = document.getElementById(`tracking-row-${index}`);

                if (trackingRow) {
                    trackingRow.classList.remove('expanded');
                }
            }

            // Handle manage attachments button using event delegation
            if (event.target.closest('.manage-attachments-btn')) {
                event.preventDefault();
                event.stopPropagation();

                const btn = event.target.closest('.manage-attachments-btn');
                const poId = btn.getAttribute('data-po-id');
                const poNumber = btn.getAttribute('data-po-number');

                console.log('🔴 RED BUTTON CLICKED! Event detected!', {
                    target: event.target,
                    btn: btn,
                    poId: poId,
                    poNumber: poNumber
                });

                if (poId && poNumber) {
                    console.log('📎 Opening modal for PO:', poNumber);
                    // Open PO Details modal and switch to attachments tab
                    openPoDetailsModal(poId, poNumber).then(() => {
                        console.log('✅ Modal opened, switching to attachments tab');
                        // Switch to attachments tab after modal opens
                        const attachmentsTabBtn = document.querySelector('.tab-button[onclick*="attachments"]');
                        console.log('📑 Attachments tab button:', attachmentsTabBtn);
                        if (attachmentsTabBtn) {
                            attachmentsTabBtn.click();
                            console.log('✅ Clicked attachments tab');
                        } else {
                            console.error('❌ Could not find attachments tab button');
                        }
                    }).catch(err => {
                        console.error('❌ Error opening modal:', err);
                    });
                } else {
                    console.error('❌ Missing PO ID or number for attachments button', { poId, poNumber });
                }
            }

            // Handle dropship toggle button using event delegation
            if (event.target.closest('.dropship-toggle-btn')) {
                const btn = event.target.closest('.dropship-toggle-btn');
                const poId = btn.getAttribute('data-id');
                const poNumber = btn.getAttribute('data-po');
                const isCurrentlyDropship = btn.getAttribute('data-is-dropship') === 'true';

                if (poId) {
                    toggleDropshipStatus(poId, poNumber, !isCurrentlyDropship, btn);
                }
            }

            // Handle create task button using event delegation
            if (event.target.closest('.create-task-btn')) {
                const btn = event.target.closest('.create-task-btn');
                const poId = btn.getAttribute('data-po-id');
                const poNumber = btn.getAttribute('data-po-number');
                const vendor = btn.getAttribute('data-vendor');

                if (poId && poNumber && vendor) {
                    console.log('✅ Create Task button clicked:', { poId, poNumber, vendor });
                    openCreateTaskModal(poId, poNumber, vendor);
                } else {
                    console.error('❌ Missing data for create task button:', { poId, poNumber, vendor });
                }
            }

            // Handle email vendor button using event delegation
            if (event.target.closest('.email-vendor-btn')) {
                const btn = event.target.closest('.email-vendor-btn');
                
                // Find the parent row to get the index
                const parentRow = btn.closest('tr');
                const index = parentRow.getAttribute('data-index') || Array.from(parentRow.parentElement.children).indexOf(parentRow);
                
                console.log('📧 Email Vendor button clicked, index:', index);
                
                // Toggle the email vendor row
                toggleEmailVendorRow(index);
            }

            // Handle email vendor close buttons
            if (event.target.closest('.email-vendor-close') || event.target.closest('.email-cancel-btn')) {
                const btn = event.target.closest('.email-vendor-close') || event.target.closest('.email-cancel-btn');
                const index = btn.getAttribute('data-index');
                const emailRow = document.getElementById(`email-vendor-row-${index}`);
                
                if (emailRow) {
                    emailRow.classList.remove('expanded');
                }
            }
        });
        console.log('✅ Main click event listener registered successfully!');

        let currentSort = { column: null, direction: null };

        // Helper function to update Last Update display in real-time
        function updateLastUpdateDisplay(poId, lastUpdate, lastUpdatedBy) {
            const row = document.querySelector(`tr[data-po-id="${poId}"]`);
            if (!row) return;

            const lastUpdateCell = row.querySelector('.last-update-cell');
            if (!lastUpdateCell) return;

            const displaySpan = lastUpdateCell.querySelector('.last-update-display');
            if (!displaySpan) return;

            if (lastUpdate) {
                const date = new Date(lastUpdate);
                const formatted = date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'America/Los_Angeles'
                });
                const fullTimestamp = date.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });

                displaySpan.textContent = formatted;
                displaySpan.classList.add('has-update');
                displaySpan.classList.remove('no-update');
                displaySpan.title = `Last modification: ${fullTimestamp}${lastUpdatedBy ? ' by ' + lastUpdatedBy : ''}`;
            } else {
                displaySpan.textContent = '-';
                displaySpan.classList.remove('has-update');
                displaySpan.classList.add('no-update');
                displaySpan.title = 'Never updated';
            }
        }

        // Enhanced Notes functionality - notes appear below each row
        // NOTE: All button event listeners are now handled via event delegation above
        // This ensures buttons work even after dynamic table updates (filtering, sorting, etc.)

        // Handle notes input with auto-save
        document.querySelectorAll('.notes-input').forEach(input => {
            let timeout;

            input.addEventListener('input', function () {
                const hasContent = this.value.trim().length > 0;
                const index = this.dataset.index;
                const toggleBtn = document.querySelector(`.notes-toggle[data-index="${index}"]`);

                // Update visual state
                if (hasContent) {
                    this.classList.add('has-notes');
                    toggleBtn.classList.add('has-notes');
                    toggleBtn.innerHTML = '📝';
                    toggleBtn.title = 'View/Edit notes';
                } else {
                    this.classList.remove('has-notes');
                    toggleBtn.classList.remove('has-notes');
                    toggleBtn.innerHTML = '➕';
                    toggleBtn.title = 'Add notes';
                }

                clearTimeout(timeout);

                // Show saving state
                this.classList.add('saving');

                timeout = setTimeout(() => {
                    const id = this.dataset.id;
                    const poNumber = this.dataset.po;
                    const notes = this.value;

                    fetch(`/purchase-orders/${id}/notes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Remove saving state
                            this.classList.remove('saving');

                            // Update stats after note change
                            updateStats();

                            console.log(`Notes saved for PO ${poNumber}`);
                        })
                        .catch(error => {
                            this.classList.remove('saving');
                            console.error('Error saving notes:', error);
                        });
                }, 1000);
            });
        });

        // Auto-save Status when changed
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', function () {
                const id = this.dataset.id;
                const poNumber = this.dataset.po;
                const status = this.value;

                // Show saving state
                this.classList.add('saving');

                fetch(`/purchase-orders/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Remove saving state and update appearance
                        this.classList.remove('saving');

                        if (status) {
                            this.classList.add('has-status');
                        } else {
                            this.classList.remove('has-status');
                        }

                        // Update the data attribute for filtering
                        const row = this.closest('tr');
                        const poData = JSON.parse(row.dataset.po);
                        poData.status = status;
                        row.dataset.po = JSON.stringify(poData);

                        // Update Last Update display if PO data is returned
                        if (data.po) {
                            updateLastUpdateDisplay(id, data.po.lastUpdate, data.po.lastUpdatedBy);
                        }

                        console.log(`Status saved for PO ${poNumber}: "${status}"`);
                    })
                    .catch(error => {
                        this.classList.remove('saving');
                        console.error('Error saving Status:', error);
                    });
            });
        });

        // Auto-save Priority when changed
        document.querySelectorAll('.priority-select').forEach(select => {
            select.addEventListener('change', function () {
                const id = this.dataset.id;
                const poNumber = this.dataset.po;
                const priority = this.value;

                // Show saving state
                this.classList.add('saving');

                // Update visual appearance immediately
                this.setAttribute('data-priority', priority);

                fetch(`/purchase-orders/${id}/priority`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priority: parseInt(priority) })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Remove saving state
                        this.classList.remove('saving');

                        // Update the data attribute for filtering
                        const row = this.closest('tr');
                        const poData = JSON.parse(row.dataset.po);
                        poData.priority = parseInt(priority);
                        row.dataset.po = JSON.stringify(poData);

                        // Update Last Update display if PO data is returned
                        if (data.po) {
                            updateLastUpdateDisplay(id, data.po.lastUpdate, data.po.lastUpdatedBy);
                        }

                        console.log(`Priority saved for PO ${poNumber}: ${priority}`);
                    })
                    .catch(error => {
                        this.classList.remove('saving');
                        console.error('Error saving Priority:', error);
                    });
            });

            // Set initial data-priority attribute
            const initialPriority = select.value || '3';
            select.setAttribute('data-priority', initialPriority);
        });

        // Last Update is now auto-managed by the system (no manual editing needed)

        // Auto-save ETA when changed
        document.querySelectorAll('.eta-input').forEach(etaInput => {
            etaInput.addEventListener('change', function () {
                const id = this.dataset.id;
                const poNumber = this.dataset.po;
                const eta = this.value;

                // Show saving state
                this.style.borderColor = '#ffc107';

                fetch(`/purchase-orders/${id}/eta`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ eta })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Reset border color to show success
                        this.style.borderColor = '#28a745';
                        setTimeout(() => {
                            this.style.borderColor = '';
                        }, 1000);

                        // Update Last Update display if PO data is returned
                        if (data.po) {
                            updateLastUpdateDisplay(id, data.po.lastUpdate, data.po.lastUpdatedBy);
                        }

                        console.log(`ETA saved for PO ${poNumber}: ${eta || 'cleared'}`);
                    })
                    .catch(error => {
                        // Show error state
                        this.style.borderColor = '#dc3545';
                        setTimeout(() => {
                            this.style.borderColor = '';
                        }, 2000);
                        console.error('Error saving ETA:', error);
                        alert('Failed to save ETA. Please try again.');
                    });
            });
        });

        // Auto-save Shipping Tracking when changed
        document.querySelectorAll('.shipping-tracking-input').forEach(trackingInput => {
            trackingInput.addEventListener('blur', function () {
                const id = this.dataset.poId;
                const shippingTracking = this.value.trim();
                const oldValue = this.getAttribute('data-old-value') || '';

                // Get carrier from the carrier select in the same tracking container
                const carrierSelect = this.closest('.tracking-container').querySelector('.shipping-carrier-select');
                const shippingCarrier = carrierSelect ? carrierSelect.value : 'FedEx';

                // Show saving state
                this.style.backgroundColor = '#e3f2fd';

                fetch(`/purchase-orders/${id}/shipping-tracking`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shippingTracking, shippingCarrier })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Remove saving state
                        this.style.backgroundColor = '';

                        // Update Last Update display if PO data is returned
                        if (data.po) {
                            updateLastUpdateDisplay(id, data.po.lastUpdate, data.po.lastUpdatedBy);
                        }

                        // Update appearance based on content
                        if (shippingTracking) {
                            this.classList.add('has-tracking');
                            this.style.borderColor = '#007bff';

                            // Show tracking actions and status if not already visible
                            console.log(`🔧 Setting up tracking UI for PO ${id} with tracking: ${shippingTracking} (${shippingCarrier})`);
                            updateTrackingUI(id, shippingTracking, shippingCarrier);

                            // Tracking number saved successfully
                            if (shippingTracking !== oldValue && shippingTracking) {
                                registerTrackingNumber(shippingTracking, shippingCarrier);
                            }
                        } else {
                            this.classList.remove('has-tracking');
                            this.style.borderColor = '#ddd';
                            console.log(`🔧 Hiding tracking UI for PO ${id}`);
                            hideTrackingUI(id);
                        }

                        // Update old value for comparison
                        this.setAttribute('data-old-value', shippingTracking);
                        console.log(`Shipping tracking saved: ${shippingTracking || 'cleared'} (${shippingCarrier})`);
                    })
                    .catch(error => {
                        this.style.backgroundColor = '';
                        console.error('Error saving shipping tracking:', error);
                    });
            });

            // Store initial value for comparison
            trackingInput.setAttribute('data-old-value', trackingInput.value);

            // Initialize tracking UI for inputs that already have values
            if (trackingInput.value.trim()) {
                const poId = trackingInput.dataset.poId;
                const trackingNumber = trackingInput.value.trim();
                console.log(`🚀 Initializing tracking UI for PO ${poId} with tracking: ${trackingNumber}`);
                updateTrackingUI(poId, trackingNumber);
            }

            // Also save on Enter key
            trackingInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    this.blur(); // Trigger the blur event
                }
            });
        });

        // Auto-save Shipping Carrier when changed
        document.querySelectorAll('.shipping-carrier-select').forEach(carrierSelect => {
            carrierSelect.addEventListener('change', function () {
                const id = this.dataset.poId;
                const shippingCarrier = this.value;

                // Get tracking number from the tracking input in the same container
                const trackingInput = this.closest('.tracking-container').querySelector('.shipping-tracking-input');
                const shippingTracking = trackingInput ? trackingInput.value.trim() : '';

                // Show saving state
                this.style.backgroundColor = '#e3f2fd';

                fetch(`/purchase-orders/${id}/shipping-tracking`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shippingTracking, shippingCarrier })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Remove saving state
                        this.style.backgroundColor = '';

                        // Update Last Update display if PO data is returned
                        if (data.po) {
                            updateLastUpdateDisplay(id, data.po.lastUpdate, data.po.lastUpdatedBy);
                        }

                        // Update tracking actions with new carrier
                        const trackingInfoBtn = this.closest('.tracking-container').querySelector('.tracking-info-btn');
                        if (trackingInfoBtn) {
                            trackingInfoBtn.setAttribute('data-carrier', shippingCarrier);
                        }

                        console.log(`Shipping carrier saved: ${shippingCarrier} for tracking: ${shippingTracking}`);
                    })
                    .catch(error => {
                        this.style.backgroundColor = '';
                        console.error('Error saving shipping carrier:', error);
                    });
            });
        });

        // Initialize existing tracking buttons on page load
        function initializeExistingTrackingButtons() {
            document.querySelectorAll('.tracking-info-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const trackingNumber = this.dataset.tracking;
                    const poId = this.dataset.poId;
                    getTrackingInfo(trackingNumber, poId);
                });
            });

            document.querySelectorAll('.tracking-update-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const poId = this.dataset.poId;
                    updatePOTracking(poId);
                });
            });
        }

        // Call initialization after a short delay to ensure DOM is ready
        setTimeout(initializeExistingTrackingButtons, 100);

        // Also handle clicks via event delegation for dynamically created buttons
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('tracking-info-btn')) {
                const trackingNumber = e.target.dataset.tracking;
                const poId = e.target.dataset.poId;
                getTrackingInfo(trackingNumber, poId);
            }

            if (e.target.classList.contains('tracking-update-btn')) {
                const poId = e.target.dataset.poId;
                updatePOTracking(poId);
            }
        });

        // Function to update tracking UI
        function updateTrackingUI(poId, trackingNumber, carrier = 'FedEx') {
            const input = document.querySelector(`[data-po-id="${poId}"].shipping-tracking-input`);
            if (!input) return;

            const container = input.closest('.tracking-container');

            // Check if actions already exist
            if (!container.querySelector('.tracking-actions')) {
                // Create tracking actions
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'tracking-actions';
                actionsDiv.innerHTML = `
                    <button class="btn btn-sm btn-outline-primary tracking-info-btn" 
                            data-tracking="${trackingNumber}"
                            data-carrier="${carrier}"
                            data-po-id="${poId}"
                            title="Get tracking info">
                        🔍
                    </button>
                    <button class="btn btn-sm btn-outline-success tracking-update-btn" 
                            data-po-id="${poId}"
                            title="Update tracking">
                        🔄
                    </button>
                `;

                // Create status div
                const statusDiv = document.createElement('div');
                statusDiv.className = 'tracking-status';
                statusDiv.setAttribute('data-po-id', poId);
                statusDiv.innerHTML = '<small class="text-muted">Click 🔍 to check status</small>';

                container.appendChild(actionsDiv);
                container.appendChild(statusDiv);

                // Add event listeners to the new buttons
                const infoBtn = actionsDiv.querySelector('.tracking-info-btn');
                const updateBtn = actionsDiv.querySelector('.tracking-update-btn');

                infoBtn.addEventListener('click', function () {
                    getTrackingInfo(this.dataset.tracking, this.dataset.poId);
                });

                updateBtn.addEventListener('click', function () {
                    updatePOTracking(this.dataset.poId);
                });

            } else {
                // Update existing tracking number in buttons
                const infoBtn = container.querySelector('.tracking-info-btn');
                if (infoBtn) {
                    infoBtn.dataset.tracking = trackingNumber;
                }
            }
        }

        // Function to hide tracking UI
        function hideTrackingUI(poId) {
            const input = document.querySelector(`[data-po-id="${poId}"].shipping-tracking-input`);
            if (!input) return;

            const container = input.closest('.tracking-container');
            if (!container) return;

            const actions = container.querySelector('.tracking-actions');
            const status = container.querySelector('.tracking-status');

            if (actions) actions.remove();
            if (status) status.remove();
        }

        // Function to get tracking info
        async function getTrackingInfo(trackingNumber, poId) {
            const statusDiv = document.querySelector(`.tracking-status[data-po-id="${poId}"]`);
            const infoBtn = document.querySelector(`.tracking-info-btn[data-po-id="${poId}"]`);

            // Show loading state
            if (statusDiv) {
                statusDiv.innerHTML = '<small class="text-muted">🔄 Checking...</small>';
            }
            if (infoBtn) {
                infoBtn.disabled = true;
            }

            try {
                const response = await fetch(`/purchase-orders/tracking/${trackingNumber}`);
                const result = await response.json();

                if (result.success && result.trackingInfo) {
                    const info = result.trackingInfo;
                    const statusClass = getTrackingStatusClass(info.status);

                    if (statusDiv) {
                        statusDiv.className = `tracking-status ${statusClass}`;
                        statusDiv.innerHTML = `
                            <div>${info.statusDescription}</div>
                            ${info.lastUpdate ? `<div>Updated: ${new Date(info.lastUpdate).toLocaleDateString()}</div>` : ''}
                            ${info.lastLocation ? `<div>Location: ${info.lastLocation}</div>` : ''}
                        `;
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.innerHTML = '<small class="text-warning">No tracking info found</small>';
                    }
                }
            } catch (error) {
                console.error('Error getting tracking info:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = '<small class="text-danger">Error checking status</small>';
                }
            } finally {
                if (infoBtn) {
                    infoBtn.disabled = false;
                }
            }
        }

        // Function to update PO tracking
        async function updatePOTracking(poId) {
            const updateBtn = document.querySelector(`.tracking-update-btn[data-po-id="${poId}"]`);
            const statusDiv = document.querySelector(`.tracking-status[data-po-id="${poId}"]`);

            // Show loading state
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.innerHTML = '⏳';
            }

            try {
                const response = await fetch(`/purchase-orders/${poId}/tracking/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    if (statusDiv) {
                        statusDiv.innerHTML = '<small class="text-success">✅ Tracking updated!</small>';
                    }
                    showTrackingToast(`🔄 ${result.message}`, 'success');
                    // Refresh tracking info after a moment
                    setTimeout(() => {
                        const trackingNumber = document.querySelector(`.tracking-info-btn[data-po-id="${poId}"]`)?.dataset.tracking;
                        if (trackingNumber) {
                            getTrackingInfo(trackingNumber, poId);
                        }
                    }, 1000);
                } else {
                    if (statusDiv) {
                        statusDiv.innerHTML = '<small class="text-warning">No tracking numbers to update</small>';
                    }
                    showTrackingToast('No tracking numbers to update', 'warning');
                }
            } catch (error) {
                console.error('Error updating tracking:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = '<small class="text-danger">Error updating tracking</small>';
                }
            } finally {
                if (updateBtn) {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = '🔄';
                }
            }
        }

        // Function to get CSS class for tracking status
        function getTrackingStatusClass(status) {
            switch (status) {
                case '40': return 'status-delivered';
                case '10': return 'status-transit';
                case '20': return 'status-expired';
                case '35': return 'status-undelivered';
                case '50': return 'status-alert';
                default: return '';
            }
        }

        // Toast notification system
        function showTrackingToast(message, type = 'success') {
            // Remove existing toast if any
            const existingToast = document.querySelector('.tracking-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `tracking-toast ${type}`;
            toast.textContent = message;

            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Bulk tracking update function
        async function updateAllTracking() {
            const btn = document.getElementById('bulkTrackingBtn');
            const originalText = btn.innerHTML;

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '⏳ Updating...';

            try {
                showTrackingToast('🚀 Starting bulk tracking update...', 'success');

                const response = await fetch('/purchase-orders/tracking/update-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    showTrackingToast(`✅ ${result.message}`, 'success');

                    // Refresh tracking status for visible POs after a short delay
                    setTimeout(() => {
                        document.querySelectorAll('.tracking-info-btn').forEach(btn => {
                            const trackingNumber = btn.dataset.tracking;
                            const poId = btn.dataset.poId;
                            if (trackingNumber && poId) {
                                getTrackingInfo(trackingNumber, poId);
                            }
                        });
                    }, 2000);
                } else {
                    showTrackingToast('No tracking numbers to update', 'warning');
                }
            } catch (error) {
                console.error('Error updating all tracking:', error);
                showTrackingToast('Error updating tracking', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // URL Management functionality
        let currentUrlData = { id: '', poNumber: '', url: '' };

        // Initialize URL button handlers when DOM is ready
        function initUrlButtons() {
            console.log('🔧 Initializing URL buttons...');
            const urlButtons = document.querySelectorAll('.url-btn');
            console.log(`📊 Found ${urlButtons.length} URL buttons`);

            if (urlButtons.length === 0) {
                console.warn('⚠️ No URL buttons found - checking DOM structure');
                const allButtons = document.querySelectorAll('button');
                console.log(`📊 Found ${allButtons.length} total buttons`);
                const tableRows = document.querySelectorAll('tbody tr');
                console.log(`📊 Found ${tableRows.length} table rows`);

                // Let's also check if buttons with the link emoji exist
                const linkButtons = document.querySelectorAll('button:contains("🔗")');
                console.log(`🔍 Found ${linkButtons.length} buttons with 🔗`);

                // Check for buttons in the po-container
                const poContainers = document.querySelectorAll('.po-container');
                console.log(`📦 Found ${poContainers.length} po-containers`);
                poContainers.forEach((container, i) => {
                    const buttonsInContainer = container.querySelectorAll('button');
                    console.log(`Container ${i + 1} has ${buttonsInContainer.length} buttons`);
                });
            }

            urlButtons.forEach((btn, index) => {
                console.log(`🔗 Setting up button ${index + 1}:`, {
                    element: btn,
                    id: btn.getAttribute('data-id'),
                    po: btn.getAttribute('data-po'),
                    url: btn.getAttribute('data-url'),
                    classes: btn.className
                });

                btn.addEventListener('click', function (event) {
                    event.preventDefault();
                    event.stopPropagation();

                    console.log('�️ URL button clicked!');
                    console.log('Button attributes:', {
                        id: this.getAttribute('data-id'),
                        po: this.getAttribute('data-po'),
                        url: this.getAttribute('data-url')
                    });

                    try {
                        currentUrlData = {
                            id: this.getAttribute('data-id'),
                            poNumber: this.getAttribute('data-po'),
                            url: this.getAttribute('data-url') || ''
                        };
                        console.log('📝 Opening URL modal with data:', currentUrlData);
                        openUrlModal();
                    } catch (error) {
                        console.error('❌ Error in URL button click handler:', error);
                    }
                });
            });

            console.log('✅ URL button initialization complete');
        }

        // Test function to verify URL button functionality
        function testUrlButtons() {
            console.log('🧪 Testing URL button functionality...');
            const urlButtons = document.querySelectorAll('.url-btn');
            console.log(`Found ${urlButtons.length} URL buttons for testing`);

            urlButtons.forEach((btn, index) => {
                console.log(`Button ${index + 1}:`, {
                    hasClickListener: btn.onclick !== null,
                    hasEventListeners: getEventListeners ? getEventListeners(btn) : 'DevTools required',
                    attributes: {
                        id: btn.getAttribute('data-id'),
                        po: btn.getAttribute('data-po'),
                        url: btn.getAttribute('data-url')
                    },
                    isVisible: btn.offsetParent !== null,
                    className: btn.className
                });
            });

            // Test clicking the first button programmatically
            if (urlButtons.length > 0) {
                console.log('🖱️ Testing programmatic click on first URL button...');
                const firstButton = urlButtons[0];
                console.log('About to trigger click event on:', firstButton);
                firstButton.click();
            }
        }

        function openUrlModal() {
            console.log('🎯 Opening URL modal...');
            const modal = document.getElementById('urlModal');
            const title = document.getElementById('urlModalTitle');
            const input = document.getElementById('urlInput');
            const removeBtn = document.getElementById('urlRemoveBtn');

            if (!modal) {
                console.error('❌ URL modal not found!');
                return;
            }

            title.textContent = `${currentUrlData.url ? 'Edit' : 'Add'} URL for PO ${currentUrlData.poNumber}`;
            input.value = currentUrlData.url;

            if (currentUrlData.url) {
                removeBtn.style.display = 'inline-block';
            } else {
                removeBtn.style.display = 'none';
            }

            modal.style.display = 'block';
            console.log('✅ Modal display set to block');
            setTimeout(() => input.focus(), 100);
        }

        function closeUrlModal() {
            document.getElementById('urlModal').style.display = 'none';
            document.getElementById('urlInput').value = '';
            currentUrlData = { id: '', poNumber: '', url: '' };
        }

        async function saveUrl() {
            const input = document.getElementById('urlInput');
            const saveBtn = document.getElementById('urlSaveBtn');
            const url = input.value.trim();

            // Basic URL validation
            if (url && !isValidUrl(url)) {
                alert('Please enter a valid URL (e.g., https://example.com)');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch(`/purchase-orders/${currentUrlData.id}/url`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const result = await response.json();

                if (response.ok) {
                    closeUrlModal();
                    // Refresh the page to update the UI
                    setTimeout(() => window.location.reload(), 300);
                } else {
                    alert(result.error || 'Error saving URL');
                }
            } catch (error) {
                console.error('Error saving URL:', error);
                alert('Error saving URL');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        async function removeUrl() {
            if (!confirm(`Remove URL for PO ${currentUrlData.poNumber}?`)) {
                return;
            }

            const removeBtn = document.getElementById('urlRemoveBtn');
            removeBtn.disabled = true;
            removeBtn.textContent = 'Removing...';

            try {
                const response = await fetch(`/purchase-orders/${currentUrlData.id}/url`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: '' })
                });

                const result = await response.json();

                if (response.ok) {
                    closeUrlModal();
                    // Refresh the page to update the UI
                    setTimeout(() => window.location.reload(), 300);
                } else {
                    alert(result.error || 'Error removing URL');
                }
            } catch (error) {
                console.error('Error removing URL:', error);
                alert('Error removing URL');
            } finally {
                removeBtn.disabled = false;
                removeBtn.textContent = 'Remove URL';
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Function to initialize URL input event listeners
        function initUrlInputListeners() {
            const urlInput = document.getElementById('urlInput');
            if (urlInput) {
                urlInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        saveUrl();
                    }
                });
                console.log('✅ URL input listeners initialized');
            } else {
                console.warn('⚠️ URL input element not found');
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function (event) {
            const urlModal = document.getElementById('urlModal');
            const poDetailsModal = document.getElementById('poDetailsModal');
            const trackingDetailsModal = document.getElementById('trackingDetailsModal');
            const createTaskModal = document.getElementById('createTaskModal');

            if (event.target === urlModal) {
                closeUrlModal();
            }
            if (event.target === poDetailsModal) {
                closePoDetailsModal();
            }
            if (event.target === trackingDetailsModal) {
                closeTrackingDetailsModal();
            }
            if (event.target === createTaskModal) {
                closeCreateTaskModal();
            }
        });

        // PO Details Modal Functions
        async function openPoDetailsModal(poId, poNumber) {
            const modal = document.getElementById('poDetailsModal');
            const title = document.getElementById('poDetailsTitle');

            title.textContent = `PO Details - ${poNumber}`;
            modal.dataset.poId = poId; // Store poId for later use
            modal.style.display = 'block';

            // Set PO ID in attachment form
            const attachmentPOIdInput = document.getElementById('attachmentPOId');
            if (attachmentPOIdInput) {
                attachmentPOIdInput.value = poId;
            }

            // Reset to line items tab
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('lineItemsTab').classList.add('active');
            document.querySelector('.tab-button').classList.add('active');

            // Load line items by default
            await loadPoDetailsLineItems(poId);
        }

        function closePoDetailsModal() {
            document.getElementById('poDetailsModal').style.display = 'none';
        }

        // Load line items inline (in expandable row)
        async function loadLineItemsInline(poId, index) {
            const container = document.getElementById(`line-items-container-${index}`);
            const statusSpan = document.getElementById(`line-items-status-${index}`);
            const showReceivedBtn = document.getElementById(`show-received-${index}`);

            try {
                container.innerHTML = '<div class="loading-line-items">Loading line items...</div>';

                const response = await fetch(`/purchase-orders/${poId}/line-items`);
                const lineItems = await response.json();

                if (lineItems.length === 0) {
                    container.innerHTML = '<div class="no-line-items">No line items found for this purchase order.</div>';
                    if (statusSpan) statusSpan.textContent = '';
                } else {
                    const receivedCount = lineItems.filter(item => item.received).length;
                    const totalCount = lineItems.length;
                    const unreceivedCount = totalCount - receivedCount;

                    // Update status
                    if (statusSpan) {
                        statusSpan.textContent = `(${receivedCount}/${totalCount} received)`;
                    }

                    // Show the "Show Received" button if there are received items
                    if (showReceivedBtn && receivedCount > 0) {
                        showReceivedBtn.style.display = 'inline-block';
                        // Store the initial state
                        showReceivedBtn.dataset.showingReceived = 'false';
                    }

                    // Generate the HTML for line items table
                    const lineItemsHtml = lineItems.map(item => {
                        const displayText = item.ead || '-';
                        return `
                        <tr class="line-item-row ${item.received ? 'received' : ''}" data-item-id="${item._id}">
                            <td>${item.sku || 'N/A'}</td>
                            <td>${item.quantityExpected || '-'}</td>
                            <td class="description-cell">${escapeHtml(item.memo || 'No description')}</td>
                            <td class="received-cell">
                                <button class="received-toggle-inline ${item.received ? 'received' : ''}" 
                                        onclick="toggleReceivedInline('${item._id}', ${!item.received}, '${poId}', '${index}')">
                                    ${item.received ? '✅' : '📦'}
                                </button>
                            </td>
                            <td>${item.quantityReceived !== undefined ? item.quantityReceived : '-'}</td>
                            <td>
                                <div class="ead-container" data-item-id="${item._id}">
                                    <div class="ead-dropdown" data-value="${item.ead || ''}">
                                        <span class="ead-value">${displayText}</span>
                                        <span class="ead-dropdown-arrow">▼</span>
                                    </div>
                                    <div class="ead-menu">
                                        <div class="ead-period-option">
                                            <span>Early</span>
                                            <span class="arrow">►</span>
                                            <div class="ead-submenu">
                                                <div class="ead-month-option" data-value="Early January">January</div>
                                                <div class="ead-month-option" data-value="Early February">February</div>
                                                <div class="ead-month-option" data-value="Early March">March</div>
                                                <div class="ead-month-option" data-value="Early April">April</div>
                                                <div class="ead-month-option" data-value="Early May">May</div>
                                                <div class="ead-month-option" data-value="Early June">June</div>
                                                <div class="ead-month-option" data-value="Early July">July</div>
                                                <div class="ead-month-option" data-value="Early August">August</div>
                                                <div class="ead-month-option" data-value="Early September">September</div>
                                                <div class="ead-month-option" data-value="Early October">October</div>
                                                <div class="ead-month-option" data-value="Early November">November</div>
                                                <div class="ead-month-option" data-value="Early December">December</div>
                                            </div>
                                        </div>
                                        <div class="ead-period-option">
                                            <span>Late</span>
                                            <span class="arrow">►</span>
                                            <div class="ead-submenu">
                                                <div class="ead-month-option" data-value="Late January">January</div>
                                                <div class="ead-month-option" data-value="Late February">February</div>
                                                <div class="ead-month-option" data-value="Late March">March</div>
                                                <div class="ead-month-option" data-value="Late April">April</div>
                                                <div class="ead-month-option" data-value="Late May">May</div>
                                                <div class="ead-month-option" data-value="Late June">June</div>
                                                <div class="ead-month-option" data-value="Late July">July</div>
                                                <div class="ead-month-option" data-value="Late August">August</div>
                                                <div class="ead-month-option" data-value="Late September">September</div>
                                                <div class="ead-month-option" data-value="Late October">October</div>
                                                <div class="ead-month-option" data-value="Late November">November</div>
                                                <div class="ead-month-option" data-value="Late December">December</div>
                                            </div>
                                        </div>
                                        <div class="ead-clear-option" data-value="">Clear</div>
                                    </div>
                                </div>
                            </td>
                            <td>${item.date ? item.date : '-'}</td>
                            <td>
                                <span class="status-badge ${item.billVarianceStatus ? 'status-' + item.billVarianceStatus.toLowerCase().replace(/\s+/g, '-') : ''}">
                                    ${item.billVarianceStatus || '-'}
                                </span>
                            </td>
                            <td>${item.expectedArrivalDate ? new Date(item.expectedArrivalDate).toLocaleDateString() : '-'}</td>
                        </tr>
                    `;
                    }).join('');

                    container.innerHTML = `
                        <div class="line-items-summary">
                            <strong>Summary:</strong> ${receivedCount}/${totalCount} items received
                            ${receivedCount === totalCount ? ' ✅' : ''}
                        </div>
                        <table class="line-items-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qty Expected</th>
                                    <th>Description</th>
                                    <th>Received</th>
                                    <th>Qty Received</th>
                                    <th>Expected Availability Date</th>
                                    <th>Expected Receipt Date</th>
                                    <th>Bill Variance Status</th>
                                    <th>Expected Arrival Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lineItemsHtml}
                            </tbody>
                        </table>
                    `;

                    // Attach EAD dropdown event listeners
                    setTimeout(() => {
                        initEADDropdowns(container);
                    }, 0);
                }
            } catch (error) {
                console.error('Error loading line items:', error);
                container.innerHTML = '<div class="no-line-items">Error loading line items</div>';
            }
        }

        // Helper functions for inline line items
        async function toggleReceivedInline(itemId, received, poId, index) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ received })
                });

                if (response.ok) {
                    // Reload line items to reflect changes
                    await loadLineItemsInline(poId, index);
                    // Also reload the page to update the count in the main table
                    location.reload();
                } else {
                    console.error('Failed to update received status');
                }
            } catch (error) {
                console.error('Error updating received status:', error);
            }
        }

        // Initialize EAD dropdowns
        function initEADDropdowns(container) {
            const eadContainers = container.querySelectorAll('.ead-container');

            eadContainers.forEach(eadContainer => {
                const itemId = eadContainer.getAttribute('data-item-id');
                const dropdown = eadContainer.querySelector('.ead-dropdown');
                const menu = eadContainer.querySelector('.ead-menu');
                const valueSpan = eadContainer.querySelector('.ead-value');
                const monthOptions = eadContainer.querySelectorAll('.ead-month-option');
                const clearOption = eadContainer.querySelector('.ead-clear-option');

                // Toggle menu on dropdown click
                dropdown.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isOpen = menu.classList.contains('show');

                    // Close all other EAD menus
                    document.querySelectorAll('.ead-menu.show').forEach(m => {
                        m.classList.remove('show');
                        m.parentElement.querySelector('.ead-dropdown').classList.remove('open');
                    });

                    if (!isOpen) {
                        menu.classList.add('show');
                        dropdown.classList.add('open');
                    }
                });

                // Handle month selection (second click)
                monthOptions.forEach(option => {
                    option.addEventListener('click', async function (e) {
                        e.stopPropagation();
                        const value = this.getAttribute('data-value');
                        const displayText = value || '-';

                        console.log(`🎯 EAD selected: itemId="${itemId}", value="${value}"`);

                        // Update display
                        valueSpan.textContent = displayText;
                        dropdown.setAttribute('data-value', value);

                        // Close menu
                        menu.classList.remove('show');
                        dropdown.classList.remove('open');

                        // Save to database
                        await updateLineItemEAD(itemId, value);
                    });
                });

                // Handle clear selection
                if (clearOption) {
                    clearOption.addEventListener('click', async function (e) {
                        e.stopPropagation();

                        console.log(`🎯 EAD cleared for itemId="${itemId}"`);

                        // Update display
                        valueSpan.textContent = '-';
                        dropdown.setAttribute('data-value', '');

                        // Close menu
                        menu.classList.remove('show');
                        dropdown.classList.remove('open');

                        // Save to database
                        await updateLineItemEAD(itemId, '');
                    });
                }
            });

            // Close menus when clicking outside
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.ead-container')) {
                    document.querySelectorAll('.ead-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                        menu.parentElement.querySelector('.ead-dropdown').classList.remove('open');
                    });
                }
            });

            console.log(`✅ Initialized ${eadContainers.length} EAD dropdowns`);
        }

        // Update line item EAD
        async function updateLineItemEAD(itemId, ead) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ead })
                });

                if (response.ok) {
                    console.log(`✅ EAD updated successfully for item ${itemId}`);
                } else {
                    console.error('Failed to update EAD');
                }
            } catch (error) {
                console.error('Error updating EAD:', error);
            }
        }

        async function updateLineItemTrackingInline(itemId, poId, index) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${itemId}/update-tracking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    // Reload line items to reflect changes
                    await loadLineItemsInline(poId, index);
                } else {
                    console.error('Failed to update tracking');
                }
            } catch (error) {
                console.error('Error updating tracking:', error);
            }
        }

        async function updateTrackingNumberInline(itemId, trackingNumber, poId, index) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trackingNumber })
                });

                if (response.ok) {
                    // Reload line items to reflect changes
                    await loadLineItemsInline(poId, index);
                } else {
                    console.error('Failed to update tracking number');
                }
            } catch (error) {
                console.error('Error updating tracking number:', error);
            }
        }

        // Tracking Functions
        function toggleAdvancedFilters() {
            const advancedRow = document.getElementById('advancedFiltersRow');
            const toggleBtn = document.getElementById('advancedFiltersToggle');
            const isCurrentlyVisible = advancedRow.style.display !== 'none';

            if (isCurrentlyVisible) {
                advancedRow.style.display = 'none';
                toggleBtn.innerHTML = '⚙️ Advanced';
                toggleBtn.style.background = '#6c757d';
            } else {
                advancedRow.style.display = 'grid';
                toggleBtn.innerHTML = '⚙️ Hide Advanced';
                toggleBtn.style.background = '#28a745';
            }
        }

        function toggleTaskViewer() {
            const taskViewerSection = document.getElementById('taskViewerSection');
            const btnText = document.getElementById('taskViewerText');
            const isCurrentlyVisible = taskViewerSection.style.display !== 'none';

            if (isCurrentlyVisible) {
                // Hide task viewer
                taskViewerSection.style.display = 'none';
                btnText.textContent = 'Show Tasks';
                showTrackingToast('📋 Task viewer hidden', 'info');
            } else {
                // Show task viewer
                taskViewerSection.style.display = 'block';
                btnText.textContent = 'Hide Tasks';
                showTrackingToast('📋 Task viewer shown', 'success');
            }
        }

        function toggleTrackingColumn() {
            const table = document.getElementById('purchaseOrdersTable');
            const isCurrentlyVisible = table.classList.contains('show-tracking');

            if (isCurrentlyVisible) {
                // Hide tracking column
                table.classList.remove('show-tracking');
            } else {
                // Show tracking column
                table.classList.add('show-tracking');
            }

            // Update button state
            updateTrackingButtonState(!isCurrentlyVisible);

            // Show a toast notification
            const message = isCurrentlyVisible ? '👁️ Tracking column hidden' : '👁️ Tracking column shown';
            showTrackingToast(message, 'success');
        }

        function toggleNSStatusColumn() {
            const table = document.getElementById('purchaseOrdersTable');
            const isCurrentlyVisible = table.classList.contains('show-ns-status');

            if (isCurrentlyVisible) {
                // Hide NS Status column
                table.classList.remove('show-ns-status');
            } else {
                // Show NS Status column
                table.classList.add('show-ns-status');
            }

            // Update button text
            const btnText = document.getElementById('nsStatusColumnText');
            if (btnText) {
                btnText.textContent = isCurrentlyVisible ? 'Show NS Status' : 'Hide NS Status';
            }

            // Show a toast notification
            const message = isCurrentlyVisible ? '📦 NS Status column hidden' : '📦 NS Status column shown';
            showTrackingToast(message, 'success');
        }

        function toggleLocationColumn() {
            const table = document.getElementById('purchaseOrdersTable');
            const isCurrentlyVisible = table.classList.contains('show-location');

            if (isCurrentlyVisible) {
                // Hide Location column
                table.classList.remove('show-location');
            } else {
                // Show Location column
                table.classList.add('show-location');
            }

            // Update button text
            const btnText = document.getElementById('locationColumnText');
            if (btnText) {
                btnText.textContent = isCurrentlyVisible ? 'Show Location' : 'Hide Location';
            }

            // Show a toast notification
            const message = isCurrentlyVisible ? '📍 Location column hidden' : '📍 Location column shown';
            showTrackingToast(message, 'success');
        }

        function togglePendingSupervisorApproval() {
            const checkbox = document.getElementById('showPendingSupervisorApproval');
            const btnText = document.getElementById('pendingSupervisorText');
            const btn = document.getElementById('togglePendingSupervisorBtn');
            
            if (checkbox) {
                // Toggle the checkbox state
                checkbox.checked = !checkbox.checked;
                
                // Update button appearance and text
                if (checkbox.checked) {
                    btnText.textContent = 'Showing Only Pending Supervisor';
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-outline-success');
                } else {
                    btnText.textContent = 'Show Pending Supervisor';
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-outline-secondary');
                }
                
                // Save state to localStorage
                localStorage.setItem('filter_showPendingSupervisorApproval', checkbox.checked.toString());
                
                // Apply filters
                applyFilters();
                
                // Show a toast notification
                const message = checkbox.checked ? '📋 Showing ONLY Pending Supervisor Approval POs' : '📋 Showing all POs';
                showTrackingToast(message, 'success');
            }
        }

        async function toggleDropshipStatus(poId, poNumber, newDropshipStatus, btn) {
            try {
                console.log(`🚚 Toggling dropship status for PO ${poNumber}: ${newDropshipStatus}`);

                const response = await fetch(`/purchase-orders/${poId}/dropship`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isDropship: newDropshipStatus })
                });

                if (!response.ok) {
                    throw new Error(`Failed to update dropship status: ${response.statusText}`);
                }

                const data = await response.json();

                // Update Last Update display if PO data is returned
                if (data.po) {
                    updateLastUpdateDisplay(poId, data.po.lastUpdate, data.po.lastUpdatedBy);
                }

                // Update button visual state
                if (newDropshipStatus) {
                    btn.classList.add('is-dropship');
                    btn.setAttribute('data-is-dropship', 'true');
                    btn.setAttribute('title', 'Dropship PO - Click to unmark');
                } else {
                    btn.classList.remove('is-dropship');
                    btn.setAttribute('data-is-dropship', 'false');
                    btn.setAttribute('title', 'Click to mark as dropship');
                }

                // Update the row's data attribute
                const row = btn.closest('tr[data-po]');
                if (row) {
                    const poData = JSON.parse(row.getAttribute('data-po'));
                    poData.isDropship = newDropshipStatus;
                    row.setAttribute('data-po', JSON.stringify(poData));
                }

                // Re-apply filters to update visibility if dropship filter is active
                applyFilters();

                // Show success message
                const message = newDropshipStatus ?
                    `🚚 PO ${poNumber} marked as dropship` :
                    `📦 PO ${poNumber} unmarked as dropship`;
                showTrackingToast(message, 'success');

            } catch (error) {
                console.error('❌ Error toggling dropship status:', error);
                showTrackingToast(`Error updating dropship status: ${error.message}`, 'error');
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');

            // Close other dropdowns
            document.getElementById('optionsDropdown').classList.remove('show');
            document.getElementById('importsDropdown').classList.remove('show');
        }

        async function toggleTrackingDetails(poId) {
            // Find the PO data from the page
            const trackingBtn = document.querySelector(`[data-po-id="${poId}"].tracking-toggle-btn`);
            const tracking = trackingBtn.dataset.tracking;
            const carrier = trackingBtn.dataset.carrier;

            if (!tracking) {
                // Show a simple message if no tracking
                showTrackingDetailsModal(poId, null, null, 'No tracking information available for this PO.');
                return;
            }

            showTrackingDetailsModal(poId, tracking, carrier);
        }

        function showTrackingDetailsModal(poId, trackingNumber, carrier, message = null) {
            const modal = document.getElementById('trackingDetailsModal');
            const title = document.getElementById('trackingDetailsTitle');
            const content = document.getElementById('trackingDetailsContent');

            title.textContent = trackingNumber ? `Tracking: ${trackingNumber}` : 'Tracking Information';

            if (message) {
                content.innerHTML = `<div style="text-align: center; padding: 20px; color: #6c757d;">${message}</div>`;
            } else {
                content.innerHTML = `
                    <div class="tracking-info-section">
                        <div class="tracking-info-header">
                            <div class="tracking-number">${trackingNumber}</div>
                            <div class="carrier-info">${carrier}</div>
                        </div>
                        <div class="tracking-status-display" style="background: #ffc107; color: #212529;">
                            Click "Check Status" to get latest tracking information
                        </div>
                        <div class="tracking-actions-section">
                            <button class="tracking-action-btn primary" onclick="checkTrackingStatus('${poId}', '${trackingNumber}', '${carrier}')">
                                🔍 Check Status
                            </button>
                            <button class="tracking-action-btn secondary" onclick="updateTrackingInfo('${poId}')">
                                🔄 Update Tracking
                            </button>
                            <button class="tracking-action-btn secondary" onclick="openTrackingUrl('${trackingNumber}', '${carrier}')">
                                🌐 View on ${carrier} Website
                            </button>
                        </div>
                    </div>
                `;
            }

            modal.style.display = 'block';
        }

        function closeTrackingDetailsModal() {
            document.getElementById('trackingDetailsModal').style.display = 'none';
        }

        // Task Creation Modal Functions
        function openCreateTaskModal(poId, poNumber, vendor) {
            const modal = document.getElementById('createTaskModal');
            const poIdInput = document.getElementById('taskPOId');
            const relatedInfo = document.getElementById('taskRelatedInfo');
            const titleInput = document.getElementById('taskTitle');

            // Set hidden PO ID
            poIdInput.value = poId;

            // Display related PO and vendor info
            relatedInfo.innerHTML = `
                <div><strong>PO Number:</strong> ${poNumber}</div>
                <div><strong>Vendor:</strong> ${vendor}</div>
            `;

            // Pre-fill title with PO reference
            titleInput.value = `Follow up on PO ${poNumber} - ${vendor}`;

            modal.style.display = 'block';
        }

        function closeCreateTaskModal() {
            const modal = document.getElementById('createTaskModal');
            modal.style.display = 'none';
            document.getElementById('createTaskForm').reset();
        }

        // Handle task form submission - with null check
        const createTaskForm = document.getElementById('createTaskForm');
        if (createTaskForm) {
            createTaskForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    dueDate: document.getElementById('taskDueDate').value,
                    priority: document.getElementById('taskPriority').value,
                    relatedPOs: [document.getElementById('taskPOId').value],
                    status: 'pending'
                };

                try {
                    const response = await fetch('/tasks/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showTrackingToast('Task created successfully!', 'success');
                        closeCreateTaskModal();
                    } else {
                        showTrackingToast('Failed to create task: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error creating task:', error);
                    showTrackingToast('Error creating task', 'error');
                }
            });
        }

        // Vendor Email Row Functions (Expandable Row Approach)
        async function toggleEmailVendorRow(index) {
            const emailRow = document.getElementById(`email-vendor-row-${index}`);
            
            if (!emailRow) {
                console.error('Email vendor row not found for index:', index);
                return;
            }

            const isExpanded = emailRow.classList.contains('expanded');

            if (isExpanded) {
                // Close the email row
                emailRow.classList.remove('expanded');
            } else {
                // Open the email row and load data
                emailRow.classList.add('expanded');
                
                // Load email form data if not already loaded
                const form = document.getElementById(`email-vendor-form-${index}`);
                if (form && !form.dataset.loaded) {
                    await loadEmailVendorFormV3(index, form);
                    form.dataset.loaded = 'true';
                }
            }
        }

        async function loadEmailVendorFormV3(index, form) {
            const poId = form.dataset.poId;
            const poNumber = form.dataset.poNumber;
            const vendor = form.dataset.vendor;
            const linkedVendorId = form.dataset.linkedVendorId;

            console.log('📧 V3 - Loading email form for PO:', poNumber);
            console.log('📧 V3 - PO ID:', poId);

            try {
                // Load PO details using explicit API endpoint
                const cacheBuster = Date.now();
                const apiUrl = `/purchase-orders/api/po-details/${poId}?_=${cacheBuster}`;
                console.log('🔍 V3 - Full API URL with cache buster:', apiUrl);
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    cache: 'no-store'
                });
                
                console.log('🔍 V3 - Response status:', response.status);
                console.log('🔍 V3 - Response URL:', response.url);
                console.log('🔍 V3 - Response redirected:', response.redirected);
                console.log('🔍 V3 - Response content-type:', response.headers.get('content-type'));
                
                // Check if response is actually JSON before parsing
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('❌ V3 - Response is not JSON! Content-Type:', contentType);
                    const text = await response.text();
                    console.error('❌ V3 - Received HTML/text instead (first 500 chars):', text.substring(0, 500));
                    throw new Error(`Server returned ${contentType || 'unknown type'} instead of JSON. Check if you're logged in and the API endpoint is correct.`);
                }
                
                if (!response.ok) {
                    console.error('❌ V3 - Response not OK. Status:', response.status);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                console.log('✅ V3 - Response OK, parsing JSON...');
                const data = await response.json();
                console.log('✅ V3 - JSON parsed successfully');
                console.log('📦 V3 - Data type:', typeof data, 'Is Array:', Array.isArray(data));
                console.log('📦 V3 - Data:', data);
                console.log('📦 V3 - Data keys:', Object.keys(data));
                
                const po = data.purchaseOrder;
                console.log('✅ V3 - PO from data.purchaseOrder:', po);
                console.log('✅ V3 - PO extracted:', po?.poNumber);
                
                if (!po) {
                    console.error('❌ V3 - No purchaseOrder in data!');
                    throw new Error('API response missing purchaseOrder');
                }
                
                if (!po.lineItems || !Array.isArray(po.lineItems)) {
                    console.error('❌ V3 - No lineItems array in PO!', 'po.lineItems:', po.lineItems);
                    throw new Error('Purchase order missing lineItems');
                }
                
                console.log('✅ V3 - Line items count:', po.lineItems.length);

                // Display PO info
                const unreceivedItems = po.lineItems.filter(item => !item.received);
                const partlyReceivedItems = po.lineItems.filter(item => item.received && item.quantityReceived < item.quantityExpected);
                
                const poInfoDiv = document.querySelector(`#email-po-info-${index} .email-po-details`);
                poInfoDiv.innerHTML = `
                    <div><strong>PO Number:</strong> ${poNumber}</div>
                    <div><strong>Vendor:</strong> ${vendor}</div>
                    <div><strong>Total Items:</strong> ${po.lineItems.length}</div>
                    <div><strong>Unreceived:</strong> <span style="color: #dc3545; font-weight: 600;">${unreceivedItems.length}</span></div>
                    ${partlyReceivedItems.length > 0 ? `<div><strong>Partly Received:</strong> <span style="color: #ffc107; font-weight: 600;">${partlyReceivedItems.length}</span></div>` : ''}
                    ${po.lastEmailSent ? `<div style="grid-column: 1 / -1;"><strong>Last Contact:</strong> ${new Date(po.lastEmailSent).toLocaleString()}</div>` : ''}
                `;

                // Try to load vendor contact information
                const recipientInput = form.querySelector('.email-recipient-input');
                const suggestionsDiv = document.getElementById(`email-suggestions-${index}`);
                
                console.log('📧 V3 - About to load vendor contacts, linkedVendorId:', linkedVendorId);
                
                // Store vendor contact info for template use
                let vendorContactInfo = {
                    email: null,
                    fullName: null,
                    firstName: null,
                    vendorName: vendor
                };
                
                if (linkedVendorId) {
                    console.log('📧 V3 - Fetching vendor data for:', linkedVendorId);
                    try {
                        const vendorResponse = await fetch(`/vendors/${linkedVendorId}`);
                        console.log('📧 V3 - Vendor response status:', vendorResponse.status);
                        console.log('📧 V3 - Vendor response content-type:', vendorResponse.headers.get('content-type'));
                        
                        if (vendorResponse.ok) {
                            console.log('📧 V3 - About to parse vendor JSON...');
                            const vendorData = await vendorResponse.json();
                            console.log('📧 V3 - Vendor data received:', vendorData.name);
                            
                            // Priority: primary contact email > main email
                            if (vendorData.contactInfo?.primaryContact?.email) {
                                vendorContactInfo.email = vendorData.contactInfo.primaryContact.email;
                                vendorContactInfo.fullName = vendorData.contactInfo.primaryContact.name || null;
                                
                                // Extract first name from full name
                                if (vendorContactInfo.fullName) {
                                    const nameParts = vendorContactInfo.fullName.trim().split(/\s+/);
                                    vendorContactInfo.firstName = nameParts[0];
                                }
                                
                                console.log('📧 V3 - Using primary contact:', vendorContactInfo.fullName, 'Email:', vendorContactInfo.email);
                            } else if (vendorData.mainEmail) {
                                vendorContactInfo.email = vendorData.mainEmail;
                                console.log('📧 V3 - Using main email:', vendorContactInfo.email);
                            }
                            
                            // Set recipient email
                            if (vendorContactInfo.email) {
                                recipientInput.value = vendorContactInfo.email;
                            }
                            
                            // Show alternative contacts as suggestions
                            const alternativeContacts = [];
                            if (vendorData.mainEmail && vendorData.mainEmail !== vendorContactInfo.email) {
                                alternativeContacts.push(vendorData.mainEmail);
                            }
                            if (vendorData.contactInfo?.customerService?.email && 
                                vendorData.contactInfo.customerService.email !== vendorContactInfo.email) {
                                alternativeContacts.push(vendorData.contactInfo.customerService.email);
                            }
                            
                            if (alternativeContacts.length > 0) {
                                suggestionsDiv.innerHTML = `💡 Other contacts: ${alternativeContacts.join(', ')}`;
                            }
                            
                            console.log('📧 V3 - Vendor contact info prepared:', vendorContactInfo);
                        } else {
                            console.warn('⚠️ V3 - Vendor response not OK, status:', vendorResponse.status);
                        }
                    } catch (vendorError) {
                        console.error('❌ V3 - Error loading vendor data:', vendorError);
                        console.error('❌ V3 - Vendor error details:', vendorError.message, vendorError.stack);
                        // Continue anyway - vendor contacts are optional
                    }
                } else {
                    console.log('📧 V3 - No linkedVendorId, skipping vendor contact loading');
                }
                
                console.log('📧 V3 - Vendor loading complete, about to load email templates...');

                // Load email templates from database
                console.log('📧 V3 - CALLING loadDatabaseEmailTemplates...');
                await loadDatabaseEmailTemplates(index, form, po, unreceivedItems, partlyReceivedItems, vendorContactInfo);
                console.log('📧 V3 - loadDatabaseEmailTemplates returned successfully');

                // Setup form submission
                setupEmailFormSubmission(form, index);

            } catch (error) {
                console.error('Error loading PO details:', error);
                const poInfoDiv = document.querySelector(`#email-po-info-${index} .email-po-details`);
                poInfoDiv.innerHTML = `<div style="color: #dc3545;">Error loading PO details: ${error.message}</div>`;
            }
        }

        // Load email templates from database
        async function loadDatabaseEmailTemplates(index, form, po, unreceivedItems, partlyReceivedItems, vendorContactInfo) {
            console.log('🎯 loadDatabaseEmailTemplates CALLED with:', { index, formExists: !!form, poNumber: po?.poNumber });
            
            try {
                console.log('📧 STEP 1: About to fetch /email-templates...');
                const response = await fetch('/email-templates?isActive=true');
                console.log('📧 STEP 2: Fetch completed. Response status:', response.status);
                console.log('📧 STEP 3: Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    console.error('❌ Response not OK:', response.status, response.statusText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                console.log('📧 STEP 4: About to parse JSON...');
                const templates = await response.json();
                console.log('📧 STEP 5: JSON parsed successfully');
                console.log('📧 STEP 5: JSON parsed successfully');
                console.log('📧 Loaded templates:', templates.length, 'templates');
                console.log('📧 Template data:', templates);

                console.log('📧 STEP 6: Finding template select element...');
                const templateSelect = form.querySelector('.email-template-select');
                console.log('📧 STEP 7: Template select found:', !!templateSelect);
                
                if (!templateSelect) {
                    throw new Error('Template select element not found in form!');
                }
                
                templateSelect.innerHTML = '<option value="">-- Select Template --</option>';
                console.log('📧 STEP 8: Cleared template options');
                
                // Find default template for eta_request category
                let defaultTemplate = null;
                
                console.log('📧 STEP 9: Processing', templates.length, 'templates...');
                templates.forEach((template, idx) => {
                    console.log(`📧 Processing template ${idx + 1}:`, template.name, 'isDefault:', template.isDefault, 'category:', template.category);
                    const option = document.createElement('option');
                    option.value = template._id;
                    option.textContent = template.name;
                    option.dataset.templateData = JSON.stringify(template);
                    
                    if (template.isDefault && template.category === 'eta_request') {
                        console.log('🎯 Found default template:', template.name);
                        defaultTemplate = template;
                        option.selected = true;
                    }
                    
                    templateSelect.appendChild(option);
                });
                console.log('📧 STEP 10: All templates added to dropdown');

                // Add custom option
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = 'Custom Message';
                templateSelect.appendChild(customOption);
                console.log('📧 STEP 11: Added custom option');

                // Setup change listener
                templateSelect.addEventListener('change', function() {
                    console.log('📧 Template changed to:', this.value);
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.dataset.templateData) {
                        const template = JSON.parse(selectedOption.dataset.templateData);
                        applyDatabaseTemplate(index, form, template, po, unreceivedItems, partlyReceivedItems, vendorContactInfo);
                    } else if (this.value === 'custom') {
                        clearEmailForm(index, form);
                    }
                });
                console.log('📧 STEP 12: Change listener added');

                // Load default template automatically
                if (defaultTemplate) {
                    console.log('📧 STEP 13: Applying default template:', defaultTemplate.name);
                    await applyDatabaseTemplate(index, form, defaultTemplate, po, unreceivedItems, partlyReceivedItems, vendorContactInfo);
                    console.log('📧 STEP 14: Default template applied successfully!');
                } else {
                    console.warn('⚠️ No default template found');
                }
                
                console.log('✅ loadDatabaseEmailTemplates COMPLETED successfully');

            } catch (error) {
                console.error('❌ ERROR in loadDatabaseEmailTemplates:', error);
                console.error('❌ Error name:', error.name);
                console.error('❌ Error message:', error.message);
                console.error('❌ Error stack:', error.stack);
                
                // Show error to user
                alert(`Failed to load email templates: ${error.message}\n\nPlease check the browser console for details.`);
                
                // Fallback to basic template
                const templateSelect = form.querySelector('.email-template-select');
                if (templateSelect) {
                    templateSelect.innerHTML = '<option value="custom">Custom Message (Templates failed to load)</option>';
                }
            }
        }

        // Apply database template with variable substitution
        async function applyDatabaseTemplate(index, form, template, po, unreceivedItems, partlyReceivedItems, vendorContactInfo) {
            try {
                // Store original template for modification detection
                form.dataset.originalTemplate = template._id;
                form.dataset.originalBody = template.bodyTemplate;
                form.dataset.originalSubject = template.subject;

                // Prepare template data for Handlebars
                const templateData = {
                    poNumber: po.poNumber,
                    vendor: vendorContactInfo?.firstName || vendorContactInfo?.fullName || po.vendor,
                    vendorFullName: vendorContactInfo?.fullName || po.vendor,
                    vendorCompany: po.vendor,
                    senderName: '<%= user.name || user.username %>',
                    senderTitle: 'Supply Chain Manager',
                    senderContact: '<%= user.email || "" %>',
                    currentDate: new Date().toLocaleDateString(),
                    currentTime: new Date().toLocaleTimeString(),
                    totalItems: po.lineItems.length,
                    noEtaItems: unreceivedItems.filter(item => !item.ead),
                    overdueItems: unreceivedItems.filter(item => item.ead && new Date(item.ead) < new Date()),
                    partlyReceivedItems: partlyReceivedItems,
                    allItems: po.lineItems
                };

                // Render template with Handlebars
                const renderedSubject = await renderHandlebarsTemplate(template.subject, templateData);
                const renderedBody = await renderHandlebarsTemplate(template.bodyTemplate, templateData);

                // Set subject
                const subjectInput = form.querySelector('.email-subject-input');
                subjectInput.value = renderedSubject;

                // Set body in edit mode
                const bodyEdit = document.getElementById(`email-body-edit-${index}`);
                const bodyCode = document.getElementById(`email-body-code-${index}`);
                bodyEdit.value = renderedBody;
                bodyCode.value = template.bodyTemplate; // Store original template code

                // Show preview
                await updatePreview(index);

                // Track template usage
                await fetch(`/email-templates/${template._id}/use`, { method: 'POST' });

                // Setup modification detection
                setupModificationDetection(index, form);

            } catch (error) {
                console.error('Error applying template:', error);
            }
        }

        // Render Handlebars template (simple client-side implementation)
        async function renderHandlebarsTemplate(templateString, data) {
            let rendered = templateString;

            // Replace simple variables {{variable}}
            rendered = rendered.replace(/\{\{(\w+)\}\}/g, (match, key) => {
                return data[key] !== undefined ? data[key] : match;
            });

            // Handle {{#if}} conditionals
            rendered = rendered.replace(/\{\{#if (\w+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, key, content) => {
                const value = data[key];
                return (value && (Array.isArray(value) ? value.length > 0 : true)) ? content : '';
            });

            // Handle {{#each}} loops
            rendered = rendered.replace(/\{\{#each (\w+)\}\}([\s\S]*?)\{\{\/each\}\}/g, (match, key, itemTemplate) => {
                const array = data[key];
                if (!Array.isArray(array) || array.length === 0) return '';
                
                return array.map(item => {
                    let itemRendered = itemTemplate;
                    // Replace item properties
                    itemRendered = itemRendered.replace(/\{\{(\w+)\}\}/g, (m, prop) => {
                        if (prop === 'eta' && item[prop]) {
                            return new Date(item[prop]).toLocaleDateString();
                        }
                        return item[prop] !== undefined ? item[prop] : '';
                    });
                    return itemRendered;
                }).join('');
            });

            return rendered;
        }

        // Switch view mode (preview/edit/code)
        function switchViewMode(index, mode) {
            const preview = document.getElementById(`email-body-preview-${index}`);
            const edit = document.getElementById(`email-body-edit-${index}`);
            const code = document.getElementById(`email-body-code-${index}`);
            const tabs = document.querySelectorAll(`.view-mode-tab[data-index="${index}"]`);

            // Update tab states
            tabs.forEach(tab => {
                if (tab.dataset.mode === mode) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Show/hide appropriate view
            preview.style.display = mode === 'preview' ? 'block' : 'none';
            edit.style.display = mode === 'edit' ? 'block' : 'none';
            code.style.display = mode === 'code' ? 'block' : 'none';

            // Update preview if in preview mode
            if (mode === 'preview') {
                updatePreview(index);
            }
        }

        // Update preview from edit content
        async function updatePreview(index) {
            const edit = document.getElementById(`email-body-edit-${index}`);
            const preview = document.getElementById(`email-body-preview-${index}`);
            
            // Convert plain text to HTML with preserved formatting
            const htmlContent = edit.value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>')
                .replace(/  /g, '&nbsp;&nbsp;');
            
            preview.innerHTML = `<div style="padding: 15px; background: white; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap;">${htmlContent}</div>`;
        }

        // Setup modification detection
        function setupModificationDetection(index, form) {
            const edit = document.getElementById(`email-body-edit-${index}`);
            const code = document.getElementById(`email-body-code-${index}`);
            const notice = document.getElementById(`template-modified-${index}`);
            const updateBtn = notice?.querySelector('.update-template-btn');

            const checkModification = () => {
                const isModified = edit.value !== form.dataset.originalBody && form.dataset.originalTemplate;
                if (notice) {
                    notice.style.display = isModified ? 'flex' : 'none';
                    if (updateBtn) {
                        // Only show update button if user has permission (admin/manager)
                        updateBtn.style.display = 'inline-block';
                    }
                }
            };

            edit.addEventListener('input', checkModification);
            code.addEventListener('input', () => {
                // Sync code changes back to edit view
                edit.value = code.value;
                checkModification();
            });
        }

        // Clear email form
        function clearEmailForm(index, form) {
            const subjectInput = form.querySelector('.email-subject-input');
            const edit = document.getElementById(`email-body-edit-${index}`);
            const code = document.getElementById(`email-body-code-${index}`);
            
            subjectInput.value = `Status Update Request - PO ${form.dataset.poNumber}`;
            edit.value = '';
            code.value = '';
            
            delete form.dataset.originalTemplate;
            delete form.dataset.originalBody;
        }

        // Save as new template
        async function saveAsTemplate(index) {
            const form = document.getElementById(`email-vendor-form-${index}`);
            const edit = document.getElementById(`email-body-edit-${index}`);
            const subject = form.querySelector('.email-subject-input').value;
            
            const name = prompt('Enter a name for this template:');
            if (!name) return;
            
            try {
                const response = await fetch('/email-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: 'Created from email vendor form',
                        category: 'custom',
                        subject: subject,
                        bodyTemplate: edit.value,
                        createdBy: '<%= user.username %>'
                    })
                });
                
                if (response.ok) {
                    alert('✅ Template saved successfully!');
                    // Reload templates
                    const poResponse = await fetch(`/purchase-orders/${form.dataset.poId}`);
                    const data = await poResponse.json();
                    await loadDatabaseEmailTemplates(index, form, data.purchaseOrder, [], []);
                } else {
                    alert('❌ Failed to save template');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                alert('❌ Error saving template');
            }
        }

        // Update existing template
        async function updateTemplate(index) {
            const form = document.getElementById(`email-vendor-form-${index}`);
            const edit = document.getElementById(`email-body-edit-${index}`);
            const subject = form.querySelector('.email-subject-input').value;
            const templateId = form.dataset.originalTemplate;
            
            if (!templateId) return;
            
            if (!confirm('Update the original template with these changes?')) return;
            
            try {
                const response = await fetch(`/email-templates/${templateId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: subject,
                        bodyTemplate: edit.value,
                        updatedBy: '<%= user.username %>'
                    })
                });
                
                if (response.ok) {
                    alert('✅ Template updated successfully!');
                    form.dataset.originalBody = edit.value;
                    form.dataset.originalSubject = subject;
                    document.getElementById(`template-modified-${index}`).style.display = 'none';
                } else {
                    alert('❌ Failed to update template');
                }
            } catch (error) {
                console.error('Error updating template:', error);
                alert('❌ Error updating template');
            }
        }

        function setupEmailFormSubmission(form, index) {
            // Remove any existing listeners
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            newForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const submitBtn = this.querySelector('.email-send-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '📤 Sending...';
                submitBtn.disabled = true;

                const bodyEdit = document.getElementById(`email-body-edit-${index}`);
                
                const formData = {
                    poId: this.dataset.poId,
                    recipient: this.querySelector('.email-recipient-input').value,
                    subject: this.querySelector('.email-subject-input').value,
                    body: bodyEdit.value,
                    trackEmail: this.querySelector('.email-track-checkbox').checked
                };

                try {
                    const response = await fetch('/purchase-orders/send-vendor-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showTrackingToast('Email sent successfully!', 'success');
                        
                        // Update the button to show email was sent
                        const emailBtn = document.querySelector(`.email-vendor-btn[data-po-id="${formData.poId}"]`);
                        if (emailBtn) {
                            emailBtn.classList.add('email-sent');
                            emailBtn.title = `Last emailed: ${new Date().toLocaleDateString()} - Click to email again`;
                        }
                        
                        // Close the email row
                        const emailRow = document.getElementById(`email-vendor-row-${index}`);
                        if (emailRow) {
                            emailRow.classList.remove('expanded');
                        }
                    } else {
                        showTrackingToast('Failed to send email: ' + (result.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Error sending email:', error);
                    showTrackingToast('Error sending email: ' + error.message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        // Keep old modal functions for backwards compatibility, but they won't be used
        async function openVendorEmailModal(poId, poNumber, vendor, linkedVendorId, hasUnreceived) {
            const modal = document.getElementById('vendorEmailModal');
            const poIdInput = document.getElementById('emailPOId');
            const linkedVendorInput = document.getElementById('emailLinkedVendorId');
            const poInfoDiv = document.getElementById('vendorEmailPOInfo');
            const recipientInput = document.getElementById('recipientEmail');
            const suggestionsDiv = document.getElementById('vendorEmailSuggestions');
            const subjectInput = document.getElementById('emailSubject');
            const bodyTextarea = document.getElementById('emailBody');

            // Set hidden fields
            poIdInput.value = poId;
            linkedVendorInput.value = linkedVendorId || '';

            // Load PO details and unreceived items
            try {
                const response = await fetch(`/purchase-orders/${poId}`);
                const data = await response.json();
                const po = data.purchaseOrder;

                // Display PO info
                const unreceivedItems = po.lineItems.filter(item => !item.received);
                const partlyReceivedItems = po.lineItems.filter(item => item.received && item.quantityReceived < item.quantityExpected);
                
                poInfoDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>PO Number:</strong> ${poNumber}</div>
                        <div><strong>Vendor:</strong> ${vendor}</div>
                        <div><strong>Total Items:</strong> ${po.lineItems.length}</div>
                        <div><strong>Unreceived:</strong> <span style="color: #dc3545; font-weight: 600;">${unreceivedItems.length}</span></div>
                        ${partlyReceivedItems.length > 0 ? `<div><strong>Partly Received:</strong> <span style="color: #ffc107; font-weight: 600;">${partlyReceivedItems.length}</span></div>` : ''}
                        ${po.lastEmailSent ? `<div style="grid-column: 1 / -1;"><strong>Last Contact:</strong> ${new Date(po.lastEmailSent).toLocaleString()}</div>` : ''}
                    </div>
                `;

                // Try to load vendor contact information
                if (linkedVendorId) {
                    const vendorResponse = await fetch(`/vendors/${linkedVendorId}`);
                    if (vendorResponse.ok) {
                        const vendorData = await vendorResponse.json();
                        const contacts = [];
                        
                        if (vendorData.mainEmail) contacts.push(vendorData.mainEmail);
                        if (vendorData.contactInfo?.primaryContact?.email) contacts.push(vendorData.contactInfo.primaryContact.email);
                        if (vendorData.contactInfo?.customerService?.email) contacts.push(vendorData.contactInfo.customerService.email);
                        
                        if (contacts.length > 0) {
                            recipientInput.value = contacts[0];
                            if (contacts.length > 1) {
                                suggestionsDiv.innerHTML = `💡 Other contacts: ${contacts.slice(1).join(', ')}`;
                            }
                        }
                    }
                }

                // Set default subject
                subjectInput.value = `Status Update Request - PO ${poNumber}`;

                // Load default template
                await loadEmailTemplate('default', po, unreceivedItems, partlyReceivedItems);

            } catch (error) {
                console.error('Error loading PO details:', error);
                poInfoDiv.innerHTML = `<div style="color: #dc3545;">Error loading PO details</div>`;
            }

            modal.style.display = 'block';
        }

        function closeVendorEmailModal() {
            const modal = document.getElementById('vendorEmailModal');
            modal.style.display = 'none';
            document.getElementById('vendorEmailForm').reset();
        }

        async function loadEmailTemplate(templateType, po, unreceivedItems, partlyReceivedItems) {
            const templateSelect = document.getElementById('emailTemplate');
            const bodyTextarea = document.getElementById('emailBody');
            
            // If called without params, load from current selection
            if (!templateType) {
                templateType = templateSelect.value;
                // Reload PO data
                const poId = document.getElementById('emailPOId').value;
                const response = await fetch(`/purchase-orders/${poId}`);
                const data = await response.json();
                po = data.purchaseOrder;
                unreceivedItems = po.lineItems.filter(item => !item.received);
                partlyReceivedItems = po.lineItems.filter(item => item.received && item.quantityReceived < item.quantityExpected);
            }

            if (!templateType || templateType === 'custom') {
                bodyTextarea.value = '';
                return;
            }

            let template = '';
            const vendorName = po.vendor;
            const poNumber = po.poNumber;

            if (templateType === 'default') {
                template = `Dear ${vendorName},

I hope this email finds you well. I am writing to request a status update on Purchase Order ${poNumber}.

`;

                if (unreceivedItems.length > 0) {
                    template += `We currently have ${unreceivedItems.length} item(s) showing as not yet received:\n\n`;
                    unreceivedItems.slice(0, 10).forEach(item => {
                        template += `• ${item.memo}${item.sku ? ' (SKU: ' + item.sku + ')' : ''}\n`;
                        if (item.quantityExpected) template += `  Quantity: ${item.quantityExpected} ${item.unit || ''}\n`;
                        if (item.ead) template += `  Expected: ${new Date(item.ead).toLocaleDateString()}\n`;
                    });
                    if (unreceivedItems.length > 10) {
                        template += `\n...and ${unreceivedItems.length - 10} more items\n`;
                    }
                }

                if (partlyReceivedItems.length > 0) {
                    template += `\nAdditionally, ${partlyReceivedItems.length} item(s) have been partially received:\n\n`;
                    partlyReceivedItems.slice(0, 5).forEach(item => {
                        template += `• ${item.memo} - Received ${item.quantityReceived || 0} of ${item.quantityExpected} ${item.unit || ''}\n`;
                    });
                }

                template += `\nCould you please provide:
1. Updated delivery dates for any delayed items
2. Tracking information if items have already shipped
3. Status updates for any items on backorder

This information would be greatly appreciated as we need to update our customers and plan our operations accordingly.

Thank you for your prompt attention to this matter.

Best regards`;

            } else if (templateType === 'urgent') {
                template = `Dear ${vendorName},

URGENT: We need an immediate status update on Purchase Order ${poNumber}.

We have ${unreceivedItems.length} item(s) that are critical for our operations and have not been received. `;

                const overdueItems = unreceivedItems.filter(item => item.ead && new Date(item.ead) < new Date());
                if (overdueItems.length > 0) {
                    template += `${overdueItems.length} of these items are now OVERDUE:\n\n`;
                    overdueItems.forEach(item => {
                        template += `• ${item.memo}${item.sku ? ' (SKU: ' + item.sku + ')' : ''}\n`;
                        template += `  Expected: ${new Date(item.ead).toLocaleDateString()} - NOW OVERDUE\n`;
                    });
                }

                template += `\nWe urgently need:
1. Immediate confirmation of shipment dates
2. Tracking numbers for any shipped items  
3. Alternative solutions for any items that cannot be delivered as promised

Please respond within 24 hours.

Thank you`;
            }

            bodyTextarea.value = template;
            templateSelect.value = templateType;
        }

        // Handle vendor email form submission
        const vendorEmailForm = document.getElementById('vendorEmailForm');
        if (vendorEmailForm) {
            vendorEmailForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '📤 Sending...';
                submitBtn.disabled = true;

                const formData = {
                    poId: document.getElementById('emailPOId').value,
                    recipient: document.getElementById('recipientEmail').value,
                    subject: document.getElementById('emailSubject').value,
                    body: document.getElementById('emailBody').value,
                    trackEmail: document.getElementById('trackEmail').checked
                };

                try {
                    const response = await fetch('/purchase-orders/send-vendor-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showTrackingToast('Email sent successfully!', 'success');
                        closeVendorEmailModal();
                        
                        // Update the button to show email was sent
                        const emailBtn = document.querySelector(`.email-vendor-btn[data-po-id="${formData.poId}"]`);
                        if (emailBtn) {
                            emailBtn.classList.add('email-sent');
                            emailBtn.title = `Last emailed: ${new Date().toLocaleDateString()} - Click to email again`;
                        }
                        
                        // Optionally refresh the page to show updated data
                        // location.reload();
                    } else {
                        showTrackingToast('Failed to send email: ' + (result.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Error sending email:', error);
                    showTrackingToast('Error sending email: ' + error.message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        async function checkTrackingStatus(poId, trackingNumber, carrier) {
            const statusDiv = document.querySelector('.tracking-status-display');
            statusDiv.innerHTML = '🔄 Checking status...';
            statusDiv.style.background = '#007bff';
            statusDiv.style.color = 'white';

            try {
                // This would call your existing tracking API
                const response = await fetch('/purchase-orders/tracking-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trackingNumber, carrier })
                });

                const result = await response.json();

                if (result.success && result.trackingInfo) {
                    statusDiv.innerHTML = `📦 ${result.trackingInfo.status || 'In Transit'}`;
                    statusDiv.style.background = '#28a745';

                    if (result.trackingInfo.description) {
                        statusDiv.innerHTML += `<br><small>${result.trackingInfo.description}</small>`;
                    }
                } else {
                    statusDiv.innerHTML = '❌ Unable to get tracking status';
                    statusDiv.style.background = '#dc3545';
                }
            } catch (error) {
                console.error('Error checking tracking:', error);
                statusDiv.innerHTML = '❌ Error checking status';
                statusDiv.style.background = '#dc3545';
            }
        }

        async function updateTrackingInfo(poId) {
            try {
                const response = await fetch(`/purchase-orders/${poId}/update-tracking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    showTrackingToast('📦 Tracking information updated', 'success');
                    // Refresh the modal content or page as needed
                } else {
                    showTrackingToast('❌ Failed to update tracking', 'error');
                }
            } catch (error) {
                console.error('Error updating tracking:', error);
                showTrackingToast('❌ Error updating tracking', 'error');
            }
        }

        function openTrackingUrl(trackingNumber, carrier) {
            let url = '';

            switch (carrier.toLowerCase()) {
                case 'fedex':
                    url = `https://www.fedex.com/apps/fedextrack/?tracknumbers=${trackingNumber}`;
                    break;
                case 'ups':
                    url = `https://www.ups.com/track?tracknum=${trackingNumber}`;
                    break;
                case 'usps':
                    url = `https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${trackingNumber}`;
                    break;
                case 'dhl':
                    url = `https://www.dhl.com/us-en/home/tracking.html?tracking-id=${trackingNumber}`;
                    break;
                default:
                    alert('Tracking URL not available for this carrier');
                    return;
            }

            window.open(url, '_blank');
        }

        function showTrackingToast(message, type) {
            // Create a simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                z-index: 10000;
                font-size: 14px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
            `;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }

        // Initialize tracking column state and add keyboard shortcut
        function initializeTrackingColumn() {
            // Set initial state based on screen size
            const table = document.getElementById('purchaseOrdersTable');
            const isLargeScreen = window.innerWidth > 1400;

            if (isLargeScreen) {
                // On large screens, show tracking by default
                table.classList.add('show-tracking');
                updateTrackingButtonState(true);
            } else {
                // On smaller screens, hide tracking by default
                table.classList.remove('show-tracking');
                updateTrackingButtonState(false);
            }

            // Add keyboard shortcut (Ctrl+T)
            document.addEventListener('keydown', function (event) {
                if (event.ctrlKey && event.key === 't') {
                    event.preventDefault();
                    toggleTrackingColumn();
                }
            });

            // Handle window resize
            window.addEventListener('resize', function () {
                const newIsLargeScreen = window.innerWidth > 1400;
                const currentlyVisible = table.classList.contains('show-tracking');

                // Auto-show on large screens if not manually hidden
                if (newIsLargeScreen && !currentlyVisible) {
                    table.classList.add('show-tracking');
                    updateTrackingButtonState(true);
                }
            });
        }

        function updateTrackingButtonState(isVisible) {
            const toggleBtn = document.getElementById('toggleTrackingBtn');
            const buttonText = document.getElementById('trackingColumnText');

            if (!toggleBtn || !buttonText) return; // Elements might not exist yet

            if (isVisible) {
                toggleBtn.classList.remove('btn-outline-secondary');
                toggleBtn.classList.add('btn-outline-success');
                buttonText.textContent = 'Hide Tracking';
                toggleBtn.title = 'Hide tracking column (Ctrl+T)';
            } else {
                toggleBtn.classList.remove('btn-outline-success');
                toggleBtn.classList.add('btn-outline-secondary');
                buttonText.textContent = 'Show Tracking';
                toggleBtn.title = 'Show tracking column (Ctrl+T)';
            }
        }

        // Attachment Management Functions
        async function loadAttachments(poId) {
            const container = document.getElementById('attachmentsList');

            try {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">Loading attachments...</div>';

                const response = await fetch(`/purchase-orders/attachments/${poId}`);
                const result = await response.json();

                if (result.success) {
                    renderAttachmentsList(result.attachments);
                } else {
                    console.error('Error loading attachments:', result.error);
                    container.innerHTML = '<div class="no-attachments">Error loading attachments.</div>';
                }
            } catch (error) {
                console.error('Error loading attachments:', error);
                container.innerHTML = '<div class="no-attachments">Error loading attachments.</div>';
            }
        }

        function renderAttachmentsList(attachments) {
            const container = document.getElementById('attachmentsList');

            if (!attachments || attachments.length === 0) {
                container.innerHTML = '<div class="no-attachments">No documents uploaded yet.</div>';
                return;
            }

            const attachmentsHtml = attachments.map(attachment => {
                const uploadDate = new Date(attachment.uploadedAt).toLocaleDateString();
                const fileSize = formatFileSize(attachment.fileSize);

                return `
                    <div class="attachment-item" data-attachment-id="${attachment._id}">
                        <div class="attachment-info">
                            <div class="attachment-filename">${escapeHtml(attachment.filename)}</div>
                            <div class="attachment-meta">
                                <span class="attachment-type-badge">${escapeHtml(attachment.documentType)}</span>
                                <span>Size: ${fileSize}</span>
                                <span>Uploaded: ${uploadDate}</span>
                                <span>By: ${escapeHtml(attachment.uploadedBy)}</span>
                                ${attachment.description ? `<span>Description: ${escapeHtml(attachment.description)}</span>` : ''}
                            </div>
                        </div>
                        <div class="attachment-actions">
                            <a href="/purchase-orders/download-attachment/${attachment._id}" 
                               class="attachment-btn download-btn" 
                               title="Download ${attachment.filename}">
                                📥 Download
                            </a>
                            <button class="attachment-btn delete-btn" 
                                    onclick="deleteAttachment('${attachment._id}')"
                                    title="Delete ${attachment.filename}">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = attachmentsHtml;
        }

        async function deleteAttachment(attachmentId) {
            if (!confirm('Are you sure you want to delete this attachment? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/purchase-orders/attachments/${attachmentId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    // Remove the attachment from the UI
                    const attachmentElement = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
                    if (attachmentElement) {
                        attachmentElement.remove();
                    }

                    // Check if any attachments are left
                    const container = document.getElementById('attachmentsList');
                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="no-attachments">No documents uploaded yet.</div>';
                    }

                    showAttachmentToast('Document deleted successfully', 'success');
                } else {
                    showAttachmentToast('Error deleting document: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting attachment:', error);
                showAttachmentToast('Error deleting document', 'error');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAttachmentToast(message, type) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                z-index: 10000;
                font-size: 14px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }

        // Initialize attachment upload form when page loads
        document.addEventListener('DOMContentLoaded', function () {
            const attachmentForm = document.getElementById('attachmentUploadForm');
            if (attachmentForm) {
                attachmentForm.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const poId = document.getElementById('attachmentPOId').value;
                    const fileInput = document.getElementById('attachmentFile');
                    const documentType = document.getElementById('documentType').value;
                    const description = document.getElementById('attachmentDescription').value;

                    if (!poId) {
                        showAttachmentToast('PO ID is required', 'error');
                        return;
                    }

                    if (!fileInput.files || fileInput.files.length === 0) {
                        showAttachmentToast('Please select a file to upload', 'error');
                        return;
                    }

                    const file = fileInput.files[0];

                    // Check file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        showAttachmentToast('File size must be less than 10MB', 'error');
                        return;
                    }

                    // Show upload progress
                    const submitBtn = attachmentForm.querySelector('.upload-attachment-btn');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = '📤 Uploading...';

                    try {
                        const formData = new FormData();
                        formData.append('attachment', file);
                        formData.append('poId', poId);
                        formData.append('documentType', documentType);
                        formData.append('description', description);

                        const response = await fetch('/purchase-orders/upload-attachment', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showAttachmentToast('Document uploaded successfully', 'success');

                            // Reset form
                            attachmentForm.reset();
                            document.getElementById('attachmentPOId').value = poId; // Restore PO ID
                            document.getElementById('documentType').value = 'Other'; // Reset to default

                            // Reload attachments list
                            await loadAttachments(poId);
                        } else {
                            showAttachmentToast('Upload failed: ' + result.error, 'error');
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        showAttachmentToast('Upload failed due to network error', 'error');
                    } finally {
                        // Restore button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
        });

        // Enhanced tab function that loads content when switching
        async function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Add active class to clicked button
            event.target.classList.add('active');

            // Load content if needed
            if (tabName === 'notesHistory') {
                const modal = document.getElementById('poDetailsModal');
                const titleElement = document.getElementById('poDetailsTitle');
                const title = titleElement.textContent;
                const poNumber = title.split(' - ')[1];
                const poId = modal.dataset.poId;

                if (poId && poNumber) {
                    await loadPoDetailsNotesHistory(poId, poNumber);
                }
            } else if (tabName === 'attachments') {
                const modal = document.getElementById('poDetailsModal');
                const poId = modal.dataset.poId;

                if (poId) {
                    await loadAttachments(poId);
                }
            }
        }

        async function loadPoDetailsLineItems(poId) {
            const container = document.getElementById('poDetailsLineItems');

            try {
                container.innerHTML = '<div class="loading-line-items">Loading line items...</div>';

                const response = await fetch(`/purchase-orders/${poId}/line-items`);
                const lineItems = await response.json();

                if (lineItems.length === 0) {
                    container.innerHTML = '<div class="no-line-items">No line items found for this purchase order.</div>';
                } else {
                    const receivedCount = lineItems.filter(item => item.received).length;
                    const totalCount = lineItems.length;

                    // Generate the HTML for line items
                    const lineItemsHtml = lineItems.map(item => `
                        <div class="line-item ${item.received ? 'received' : ''}" data-item-id="${item._id}">
                            <div class="line-item-header">
                                <div class="line-item-date">${item.date ? new Date(item.date).toLocaleDateString() : 'No date'}</div>
                                <div class="line-item-status">
                                    <button class="received-toggle ${item.received ? 'received' : ''}" 
                                            onclick="toggleReceivedInModal('${item._id}', ${!item.received}, '${poId}')">
                                        ${item.received ? '✅ Received' : '📦 Mark Received'}
                                    </button>
                                </div>
                            </div>
                            <div class="line-item-memo">${escapeHtml(item.memo)}</div>
                            <div class="line-item-tracking ${!item.trackingNumber ? 'no-tracking' : ''}">
                                <div class="line-item-tracking-header">
                                    <span class="line-item-tracking-number">
                                        ${item.trackingNumber ? `📦 ${item.trackingNumber}` : '📦 No tracking assigned'}
                                    </span>
                                    <button class="line-item-tracking-update-btn" 
                                            onclick="updateLineItemTrackingInModal('${item._id}', '${poId}')"
                                            data-item-id="${item._id}"
                                            ${!item.trackingNumber ? 'disabled' : ''}>
                                        🔄 Update
                                    </button>
                                </div>
                                ${item.trackingNumber ? `
                                    <div class="line-item-tracking-status">
                                        <span class="status-badge ${getTrackingStatusClass(item.trackingStatus)}">
                                            ${item.trackingStatus || 'Pending'}
                                        </span>
                                        ${item.trackingStatusDescription ? item.trackingStatusDescription : ''}
                                    </div>
                                    ${item.trackingLastUpdate ?
                                `<div class="line-item-tracking-info">
                                            Last updated: ${new Date(item.trackingLastUpdate).toLocaleDateString()}
                                            ${item.trackingLocation ? ` • ${item.trackingLocation}` : ''}
                                        </div>` : ''}
                                ` : `
                                    <div class="line-item-tracking-status">
                                        <span class="status-badge status-pending">No Tracking</span>
                                        Enter tracking number below to enable tracking updates
                                    </div>
                                `}
                                <div class="line-item-tracking-input">
                                    <input type="text" placeholder="Enter tracking number" 
                                           value="${item.trackingNumber || ''}" 
                                           onchange="updateTrackingNumber('${item._id}', this.value, '${poId}')">
                                </div>
                            </div>
                        </div>
                    `).join('');

                    container.innerHTML = `
                        <div class="line-items-summary">
                            <strong>Summary:</strong> ${receivedCount}/${totalCount} items received
                            ${receivedCount === totalCount ? ' ✅' : ''}
                        </div>
                        ${lineItemsHtml}
                    `;
                }
            } catch (error) {
                console.error('Error loading line items:', error);
                container.innerHTML = '<div class="no-line-items">Error loading line items</div>';
            }
        }

        async function loadPoDetailsNotesHistory(poId, poNumber) {
            const container = document.getElementById('poDetailsNotesHistory');

            try {
                container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';

                const response = await fetch(`/purchase-orders/${poId}/notes-history`);
                const notes = await response.json();

                if (notes.length === 0) {
                    container.innerHTML = '<div class="no-notes">No notes found for this PO</div>';
                } else {
                    container.innerHTML = notes.map(note => `
                        <div class="note-item">
                            <div class="note-header">
                                <span class="note-date">${new Date(note.createdAt).toLocaleString()}</span>
                                <button class="note-delete-btn" onclick="deleteNote('${note._id}', '${poId}', '${poNumber}')">Delete</button>
                            </div>
                            <div class="note-content">${escapeHtml(note.content)}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading notes history:', error);
                container.innerHTML = '<div class="no-notes">Error loading notes history</div>';
            }
        }

        // Helper functions for the modal
        async function toggleReceivedInModal(itemId, received, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ received })
                });

                if (response.ok) {
                    // Reload line items to reflect changes
                    await loadPoDetailsLineItems(poId);
                } else {
                    console.error('Failed to update received status');
                }
            } catch (error) {
                console.error('Error updating received status:', error);
            }
        }

        async function updateLineItemTrackingInModal(itemId, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${itemId}/update-tracking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    // Reload line items to reflect changes
                    await loadPoDetailsLineItems(poId);
                } else {
                    console.error('Failed to update tracking');
                }
            } catch (error) {
                console.error('Error updating tracking:', error);
            }
        }

        async function updateTrackingNumber(itemId, trackingNumber, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trackingNumber })
                });

                if (response.ok) {
                    // Reload line items to reflect changes
                    await loadPoDetailsLineItems(poId);
                } else {
                    console.error('Failed to update tracking number');
                }
            } catch (error) {
                console.error('Error updating tracking number:', error);
            }
        }

        async function deleteNote(noteId, poId, poNumber) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            try {
                const response = await fetch(`/purchase-orders/notes/${noteId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    // Refresh the notes history
                    openNotesHistoryModal(poId, poNumber);
                    // Refresh the page to update the main table
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert(result.error || 'Error deleting note');
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Error deleting note');
            }
        }

        // Global variable to store line item status options
        let globalLineItemStatusOptions = [];

        // Function to load line item status options for dropdowns
        async function loadGlobalLineItemStatusOptions() {
            try {
                const response = await fetch('/purchase-orders/line-items/status-options');
                globalLineItemStatusOptions = await response.json();
            } catch (error) {
                console.error('Error loading line item status options:', error);
                globalLineItemStatusOptions = ['', 'In Stock', 'Backordered', 'Find Different Vendor', 'Substitute Product', 'Discontinued', 'Delivery Delay', 'On Order', 'Cancelled', 'Special Order'];
            }
        }

        // Function to generate status dropdown options
        function generateStatusOptions(currentStatus) {
            return globalLineItemStatusOptions.map(status =>
                `<option value="${status}" ${currentStatus === status ? 'selected' : ''}>${status || 'Select Status'}</option>`
            ).join('');
        }

        // Function to generate carrier dropdown options
        function generateCarrierOptions(currentCarrier) {
            // Set FedEx as default if no carrier is selected
            const selectedCarrier = currentCarrier || 'FedEx';

            return currentCarrierOptions.map(carrier =>
                `<option value="${carrier}" ${selectedCarrier === carrier ? 'selected' : ''}>${carrier}</option>`
            ).join('');
        }

        async function loadLineItems(index, poId) {
            const container = document.getElementById(`line-items-container-${index}`);
            const statusElement = document.getElementById(`line-items-status-${index}`);
            const toggleButton = document.getElementById(`show-received-${index}`);

            try {
                container.innerHTML = '<div class="loading-line-items">Loading line items...</div>';

                const response = await fetch(`/purchase-orders/${poId}/line-items`);
                const lineItems = await response.json();

                if (lineItems.length === 0) {
                    container.innerHTML = '<div class="no-line-items">No line items found for this purchase order.</div>';
                    statusElement.textContent = '';
                    toggleButton.style.display = 'none';
                } else {
                    const receivedCount = lineItems.filter(item => item.received).length;
                    const totalCount = lineItems.length;
                    const allReceived = receivedCount === totalCount;

                    // Generate the HTML for line items
                    const lineItemsHtml = lineItems.map(item => `
                        <div class="line-item ${item.received ? 'received hidden' : ''}" data-item-id="${item._id}">
                            <div class="line-item-header">
                                <div class="line-item-date">${item.date ? new Date(item.date).toLocaleDateString() : 'No date'}</div>
                                <div class="line-item-status">
                                    <button class="received-toggle ${item.received ? 'received' : ''}" 
                                            onclick="toggleReceived('${item._id}', ${!item.received}, ${index}, '${poId}')">
                                        ${item.received ? '✅ Received' : '📦 Mark Received'}
                                    </button>
                                </div>
                            </div>
                            <div class="line-item-memo">${escapeHtml(item.memo)}</div>
                            <div class="line-item-tracking ${!item.trackingNumber ? 'no-tracking' : ''}">
                                <div class="line-item-tracking-header">
                                    <span class="line-item-tracking-number">
                                        ${item.trackingNumber ? `📦 ${item.trackingNumber}` : '📦 No tracking assigned'}
                                    </span>
                                    <button class="line-item-tracking-update-btn" 
                                            onclick="updateLineItemTracking('${item._id}', ${index}, '${poId}')"
                                            data-item-id="${item._id}"
                                            ${!item.trackingNumber ? 'disabled' : ''}>
                                        🔄 Update
                                    </button>
                                </div>
                                ${item.trackingNumber ? `
                                    <div class="line-item-tracking-status">
                                        <span class="status-badge ${getTrackingStatusClass(item.trackingStatus)}">
                                            ${item.trackingStatus || 'Pending'}
                                        </span>
                                        ${item.trackingStatusDescription ? item.trackingStatusDescription : ''}
                                    </div>
                                    ${item.trackingLastUpdate ?
                                `<div class="line-item-tracking-info">
                                            Last updated: ${new Date(item.trackingLastUpdate).toLocaleDateString()}
                                            ${item.trackingLocation ? ` • ${item.trackingLocation}` : ''}
                                        </div>` : ''}
                                ` : `
                                    <div class="line-item-tracking-status">
                                        <span class="status-badge status-pending">No Tracking</span>
                                        Enter tracking number below to enable tracking updates
                                    </div>
                                `}
                            </div>
                            <div class="line-item-details">
                                <div class="line-item-sku">
                                    <label>SKU:</label>
                                    <input type="text" class="sku-input" placeholder="Enter SKU"
                                           value="${escapeHtml(item.sku || '')}"
                                           onchange="updateSKU('${item._id}', this.value, ${index}, '${poId}')">
                                </div>
                                <div class="line-item-status-dropdown">
                                    <label>Item Status:</label>
                                    <select class="item-status-select" 
                                            onchange="updateItemStatus('${item._id}', this.value, ${index}, '${poId}')">
                                        ${generateStatusOptions(item.itemStatus)}
                                    </select>
                                </div>
                                <div class="line-item-tracking-input">
                                    <label>Tracking Number:</label>
                                    <input type="text" class="tracking-input" placeholder="Enter tracking number"
                                           value="${escapeHtml(item.trackingNumber || '')}"
                                           onchange="updateLineItemTrackingNumber('${item._id}', this.value, ${index}, '${poId}')">
                                </div>
                                <div class="line-item-tracking-carrier">
                                    <label>Carrier:</label>
                                    <select class="carrier-select" 
                                            onchange="updateLineItemTrackingCarrier('${item._id}', this.value, ${index}, '${poId}')">
                                        ${generateCarrierOptions(item.trackingCarrier)}
                                    </select>
                                </div>
                            </div>
                            ${item.notes ? `<div class="line-item-notes">
                                <strong>Notes:</strong> ${escapeHtml(item.notes)}
                            </div>` : ''}
                            <div class="line-item-footer">
                                <div class="line-item-eta">
                                    <label>ETA:</label>
                                    <input type="date" class="eta-input" 
                                           value="${item.eta ? new Date(item.eta).toISOString().split('T')[0] : ''}"
                                           onchange="updateETA('${item._id}', this.value, ${index}, '${poId}')">
                                </div>
                                <div class="line-item-notes-input">
                                    <label>Notes:</label>
                                    <input type="text" class="notes-input" placeholder="Add notes..."
                                           value="${escapeHtml(item.notes || '')}"
                                           onchange="updateItemNotes('${item._id}', this.value, ${index}, '${poId}')">
                                </div>
                                ${item.received && item.receivedDate ?
                            `<div class="received-date">Received: ${new Date(item.receivedDate).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                    `).join('');

                    // Show completion message if all items received and none visible
                    if (allReceived) {
                        container.innerHTML = `
                            <div class="all-received-message">
                                🎉 All ${totalCount} items have been received! 
                                <br><small>Use "Show Received" to view completed items.</small>
                            </div>
                        ` + lineItemsHtml;
                        statusElement.textContent = `(${receivedCount}/${totalCount} received)`;
                    } else {
                        container.innerHTML = lineItemsHtml;
                        statusElement.textContent = `(${receivedCount}/${totalCount} received)`;
                    }

                    // Show toggle button if there are received items
                    if (receivedCount > 0) {
                        toggleButton.style.display = 'inline-block';
                        toggleButton.textContent = '👁️ Show Received';
                        toggleButton.classList.remove('active');
                    } else {
                        toggleButton.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading line items:', error);
                container.innerHTML = '<div class="no-line-items">Error loading line items.</div>';
                statusElement.textContent = '';
                toggleButton.style.display = 'none';
            }
        }

        function toggleReceivedItems(index) {
            const container = document.getElementById(`line-items-container-${index}`);
            const toggleButton = document.getElementById(`show-received-${index}`);
            const receivedItems = container.querySelectorAll('.line-item.received');

            if (toggleButton.classList.contains('active')) {
                // Hide received items
                receivedItems.forEach(item => item.classList.add('hidden'));
                toggleButton.textContent = '👁️ Show Received';
                toggleButton.classList.remove('active');
            } else {
                // Show received items
                receivedItems.forEach(item => item.classList.remove('hidden'));
                toggleButton.textContent = '🙈 Hide Received';
                toggleButton.classList.add('active');
            }
        }

        async function toggleReceived(lineItemId, received, index, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/received`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ received })
                });

                if (response.ok) {
                    // Reload line items to show updated status
                    await loadLineItems(index, poId);
                } else {
                    const error = await response.json();
                    alert('Error updating received status: ' + error.error);
                }
            } catch (error) {
                console.error('Error toggling received status:', error);
                alert('Error updating received status');
            }
        }

        async function updateETA(lineItemId, eta, index, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/eta`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ eta: eta || null })
                });

                if (response.ok) {
                    console.log('ETA updated successfully');
                } else {
                    const error = await response.json();
                    alert('Error updating ETA: ' + error.error);
                    // Reload line items to revert the input
                    await loadLineItems(index, poId);
                }
            } catch (error) {
                console.error('Error updating ETA:', error);
                alert('Error updating ETA');
                // Reload line items to revert the input
                await loadLineItems(index, poId);
            }
        }

        async function updateSKU(lineItemId, sku, index, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/sku`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sku: sku || '' })
                });

                if (response.ok) {
                    console.log('SKU updated successfully');
                } else {
                    const error = await response.json();
                    alert('Error updating SKU: ' + error.error);
                    await loadLineItems(index, poId);
                }
            } catch (error) {
                console.error('Error updating SKU:', error);
                alert('Error updating SKU');
                await loadLineItems(index, poId);
            }
        }

        async function updateItemStatus(lineItemId, itemStatus, index, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/item-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ itemStatus: itemStatus || '' })
                });

                if (response.ok) {
                    console.log('Item status updated successfully');
                } else {
                    const error = await response.json();
                    alert('Error updating item status: ' + error.error);
                    await loadLineItems(index, poId);
                }
            } catch (error) {
                console.error('Error updating item status:', error);
                alert('Error updating item status');
                await loadLineItems(index, poId);
            }
        }

        async function updateItemNotes(lineItemId, notes, index, poId) {
            try {
                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/notes`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: notes || '' })
                });

                if (response.ok) {
                    console.log('Item notes updated successfully');
                    // Refresh the line items to show the updated notes
                    await loadLineItems(index, poId);
                } else {
                    const error = await response.json();
                    alert('Error updating item notes: ' + error.error);
                    await loadLineItems(index, poId);
                }
            } catch (error) {
                console.error('Error updating item notes:', error);
                alert('Error updating item notes');
                await loadLineItems(index, poId);
            }
        }

        // Function to get CSS class for tracking status
        function getTrackingStatusClass(status) {
            if (!status) return 'status-pending';

            const normalizedStatus = status.toLowerCase();
            if (normalizedStatus.includes('delivered') || normalizedStatus.includes('delivered to recipient')) {
                return 'status-delivered';
            } else if (normalizedStatus.includes('transit') || normalizedStatus.includes('shipping') || normalizedStatus.includes('out for delivery')) {
                return 'status-transit';
            } else if (normalizedStatus.includes('alert') || normalizedStatus.includes('exception') || normalizedStatus.includes('failed')) {
                return 'status-alert';
            } else {
                return 'status-pending';
            }
        }

        // Function to update tracking for a single line item
        async function updateLineItemTracking(lineItemId, index, poId) {
            const button = document.querySelector(`[data-item-id="${lineItemId}"]`);

            // Check if tracking number exists before attempting update
            const lineItemElement = button?.closest('.line-item');
            const trackingInput = lineItemElement?.querySelector('.tracking-input');
            const trackingNumber = trackingInput?.value?.trim();

            if (!trackingNumber) {
                alert('Please enter a tracking number first');
                return;
            }

            if (button) {
                button.disabled = true;
                button.textContent = 'Updating...';
            }

            try {
                console.log(`🔄 Updating tracking for line item: ${lineItemId} with tracking: ${trackingNumber}`);

                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/tracking/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('✅ Line item tracking updated successfully');
                        // Refresh the line items to show updated tracking info
                        await loadLineItems(index, poId);
                    } else {
                        alert('No tracking information found for this item. Make sure the tracking number and carrier are correct.');
                        if (button) {
                            button.disabled = false;
                            button.textContent = '🔄 Update';
                        }
                    }
                } else {
                    const error = await response.json();
                    alert('Error updating tracking: ' + error.error);
                    if (button) {
                        button.disabled = false;
                        button.textContent = '🔄 Update';
                    }
                }
            } catch (error) {
                console.error('Error updating line item tracking:', error);
                alert('Error updating tracking information');
                if (button) {
                    button.disabled = false;
                    button.textContent = '🔄 Update';
                }
            }
        }

        // Function to update tracking number for a line item
        async function updateLineItemTrackingNumber(lineItemId, trackingNumber, index, poId) {
            try {
                // Get the current carrier, default to FedEx if empty
                const lineItemElement = document.querySelector(`[data-item-id="${lineItemId}"]`)?.closest('.line-item');
                const carrierSelect = lineItemElement?.querySelector('.carrier-select');
                let currentCarrier = carrierSelect ? carrierSelect.value : 'FedEx';

                // If no carrier selected, default to FedEx
                if (!currentCarrier || currentCarrier === '') {
                    currentCarrier = 'FedEx';
                }

                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/tracking`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trackingNumber: trackingNumber || '',
                        carrier: currentCarrier
                    })
                });

                if (response.ok) {
                    console.log('Line item tracking number updated successfully');
                    // Refresh the line items to show updated tracking info
                    await loadLineItems(index, poId);
                } else {
                    const error = await response.json();
                    alert('Error updating tracking number: ' + error.error);
                    await loadLineItems(index, poId);
                }
            } catch (error) {
                console.error('Error updating line item tracking number:', error);
                alert('Error updating tracking number');
                await loadLineItems(index, poId);
            }
        }

        // Function to update tracking carrier for a line item
        async function updateLineItemTrackingCarrier(lineItemId, carrier, index, poId) {
            try {
                // Get the current tracking number first
                const lineItems = document.querySelector(`[data-item-id="${lineItemId}"]`)?.closest('.line-item');
                const trackingInput = lineItems?.querySelector('.tracking-input');
                const currentTrackingNumber = trackingInput ? trackingInput.value : '';

                const response = await fetch(`/purchase-orders/line-items/${lineItemId}/tracking`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trackingNumber: currentTrackingNumber,
                        carrier: carrier || ''
                    })
                });

                if (response.ok) {
                    console.log('Line item tracking carrier updated successfully');
                } else {
                    const error = await response.json();
                    alert('Error updating tracking carrier: ' + error.error);
                    await loadLineItems(index, poId);
                }
            } catch (error) {
                console.error('Error updating line item tracking carrier:', error);
                alert('Error updating tracking carrier');
                await loadLineItems(index, poId);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== PACIFIC TIME UTILITIES ==========
        // Get current date/time in Pacific Time
        function getPacificDate() {
            return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
        }
        
        // Convert a date to Pacific Time ISO string
        function toPacificISO(date) {
            const ptDate = new Date(date.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
            return ptDate.toISOString();
        }
        
        // Get Pacific Time date string (YYYY-MM-DD) for date inputs
        function getPacificDateString(date = null) {
            const d = date || getPacificDate();
            const ptDate = new Date(d.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
            const year = ptDate.getFullYear();
            const month = String(ptDate.getMonth() + 1).padStart(2, '0');
            const day = String(ptDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        // ========== END PACIFIC TIME UTILITIES ==========

        // Populate location filter dropdown with unique locations from all POs
        function populateLocationFilter() {
            const locationFilter = document.getElementById('locationFilter');
            const allRows = document.querySelectorAll('#purchaseOrdersTable tbody tr[data-po]');
            const uniqueLocations = new Set();

            allRows.forEach(row => {
                const locations = row.dataset.lineItemLocations;
                if (locations) {
                    // Split by comma and trim each location
                    locations.split(',').forEach(loc => {
                        const trimmedLoc = loc.trim();
                        if (trimmedLoc) {
                            uniqueLocations.add(trimmedLoc);
                        }
                    });
                }
            });

            // Convert to array and sort alphabetically
            const sortedLocations = Array.from(uniqueLocations).sort();

            // Clear existing options except "All Locations"
            locationFilter.innerHTML = '<option value="">All Locations</option>';

            // Add each unique location as an option
            sortedLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }

        // Filtering functionality
        function applyFilters() {
            console.log('🔄 applyFilters() called');
            const searchFilterEl = document.getElementById('searchFilter');
            const searchTerm = searchFilterEl ? searchFilterEl.value.trim().toLowerCase() : '';
            const nsStatusFilterEl = document.getElementById('nsStatusFilter');
            const nsStatusFilter = nsStatusFilterEl ? nsStatusFilterEl.value : 'all';
            const statusFilterEl = document.getElementById('statusFilter');
            const statusFilter = statusFilterEl ? statusFilterEl.value : 'all';
            const notesFilterEl = document.getElementById('notesFilter');
            const notesFilter = notesFilterEl ? notesFilterEl.value : 'all';
            const priorityFilterEl = document.getElementById('priorityFilter');
            const priorityFilter = priorityFilterEl ? priorityFilterEl.value : 'all';
            const showNotMyConcernCheckbox = document.getElementById('showNotMyConcern');
            const showNotMyConcern = showNotMyConcernCheckbox ? showNotMyConcernCheckbox.checked : false;
            const showPendingBillCheckbox = document.getElementById('showPendingBill');
            const showPendingBill = showPendingBillCheckbox ? showPendingBillCheckbox.checked : false;
            const showPendingSupervisorApprovalCheckbox = document.getElementById('showPendingSupervisorApproval');
            const showPendingSupervisorApproval = showPendingSupervisorApprovalCheckbox ? showPendingSupervisorApprovalCheckbox.checked : false;
            const showOnlyMissingUrlsCheckbox = document.getElementById('showOnlyMissingUrls');
            const showOnlyMissingUrls = showOnlyMissingUrlsCheckbox ? showOnlyMissingUrlsCheckbox.checked : false;
            const showOnlyMissingEtaCheckbox = document.getElementById('showOnlyMissingEta');
            const showOnlyMissingEta = showOnlyMissingEtaCheckbox ? showOnlyMissingEtaCheckbox.checked : false;
            const showOnlyNoLineItemsCheckbox = document.getElementById('showOnlyNoLineItems');
            const showOnlyNoLineItems = showOnlyNoLineItemsCheckbox ? showOnlyNoLineItemsCheckbox.checked : false;
            const showOnlyPartialReceivesCheckbox = document.getElementById('showOnlyPartialReceives');
            const showOnlyPartialReceives = showOnlyPartialReceivesCheckbox ? showOnlyPartialReceivesCheckbox.checked : false;
            const locationFilterEl = document.getElementById('locationFilter');
            const locationFilter = locationFilterEl ? locationFilterEl.value.trim() : '';

            // PO Type filters - dynamic based on poTypeOptions
            const poTypeFilters = {};
            console.log('🔍 Loading PO Type filters...');
            <% poTypeOptions.forEach(type => { %>
                (function () {
                    const checkbox = document.getElementById('filter<%= type.name %>');
                    console.log('🔍 Checkbox for <%= type.name %>:', checkbox, 'checked:', checkbox?.checked);
                    // Default to checked (true) if checkbox not found, otherwise use actual checked state
                    poTypeFilters['<%= type.name %>'] = checkbox ? checkbox.checked : false;
                })();
            <% }) %>
                console.log('🎯 PO Type Filters:', poTypeFilters);

            const rows = document.querySelectorAll('#purchaseOrdersTable tbody tr[data-po]'); // Only main rows
            let visibleCount = 0;
            let hiddenNotMyConcernCount = 0;
            let hiddenPendingBillCount = 0;
            let hiddenPendingSupervisorApprovalCount = 0;
            let hiddenHasUrlCount = 0;
            let hiddenMissingEtaCount = 0;
            let hiddenWithLineItemsCount = 0;
            let hiddenNotPartialReceivesCount = 0;
            let hiddenLocationMismatchCount = 0;
            let hiddenPoTypeCount = 0;

            rows.forEach(row => {
                const poData = JSON.parse(row.dataset.po);
                const vendor = poData.vendor.toLowerCase();
                const poNumber = poData.poNumber.toLowerCase();
                const trackingNumber = (poData.shippingTracking || '').toLowerCase();
                const nsStatus = poData.nsStatus || '';
                const status = poData.status || '';
                const notes = poData.notes || '';
                const poUrl = poData.poUrl || '';
                const index = row.dataset.index;

                // Search filter - search vendor, PO number, or tracking number
                const matchesSearch = vendor.includes(searchTerm) || poNumber.includes(searchTerm) || trackingNumber.includes(searchTerm);

                // NS Status filter
                const matchesNSStatus = nsStatusFilter === 'all' || nsStatus === nsStatusFilter;

                // Status filter
                const matchesStatus = statusFilter === 'all' || status === statusFilter;

                // "Not my concern" filter - hide by default unless checkbox is checked
                const isNotMyConcern = status === 'Not my concern';
                const shouldShowNotMyConcern = !isNotMyConcern || showNotMyConcern;

                // "Pending Bill" NS Status filter - hide by default unless checkbox is checked
                const isPendingBill = nsStatus === 'Pending Bill';
                const shouldShowPendingBill = !isPendingBill || showPendingBill;

                // "Pending Supervisor Approval" filter - when active, show ONLY these POs
                const isPendingSupervisorApproval = nsStatus === 'Pending Supervisor Approval';
                const shouldShowPendingSupervisorApproval = !showPendingSupervisorApproval || isPendingSupervisorApproval;

                // Missing URL filter - only show POs without URLs if checkbox is checked
                const hasUrl = poUrl && poUrl.trim().length > 0;
                const shouldShowBasedOnUrl = !showOnlyMissingUrls || !hasUrl;

                // Missing ETA filter - only show POs without ETA if checkbox is checked
                const eta = poData.eta || '';
                const hasEta = eta && eta.trim().length > 0;
                const shouldShowBasedOnEta = !showOnlyMissingEta || !hasEta;

                // No line items filter - only show POs without line items if checkbox is checked
                const hasLineItems = poData.lineItems && poData.lineItems.length > 0;
                const shouldShowBasedOnLineItems = !showOnlyNoLineItems || !hasLineItems;

                // Partial receives filter - only show POs with some (but not all) items received
                let hasPartialReceives = false;
                if (hasLineItems) {
                    const totalItems = poData.lineItems.length;
                    const receivedItems = poData.lineItems.filter(item => item.received).length;
                    hasPartialReceives = receivedItems > 0 && receivedItems < totalItems;
                }
                const shouldShowBasedOnPartialReceives = !showOnlyPartialReceives || hasPartialReceives;

                // Location filter - filter by line item locations (exact match)
                const lineItemLocations = row.dataset.lineItemLocations || '';
                const locationArray = lineItemLocations.split(',').map(loc => loc.trim());
                const matchesLocation = !locationFilter || locationArray.includes(locationFilter);

                // PO Type filter - show only checked types (dynamic)
                const poType = poData.poType || 'Seed';
                const matchesPoType = poTypeFilters[poType] === true;

                // Debug logging for first few rows
                if (visibleCount < 3) {
                    console.log(`🔍 PO ${poData.poNumber}: type="${poType}", matchesPoType=${matchesPoType}, filters=`, poTypeFilters);
                }

                if (isNotMyConcern && !showNotMyConcern) {
                    hiddenNotMyConcernCount++;
                }

                if (isPendingBill && !showPendingBill) {
                    hiddenPendingBillCount++;
                }

                if (showPendingSupervisorApproval && !isPendingSupervisorApproval) {
                    hiddenPendingSupervisorApprovalCount++;
                }

                if (showOnlyMissingUrls && hasUrl) {
                    hiddenHasUrlCount++;
                }

                if (showOnlyMissingEta && hasEta) {
                    hiddenMissingEtaCount++;
                }

                if (showOnlyNoLineItems && hasLineItems) {
                    hiddenWithLineItemsCount++;
                }

                if (showOnlyPartialReceives && !hasPartialReceives) {
                    hiddenNotPartialReceivesCount++;
                }

                if (locationFilter && !matchesLocation) {
                    hiddenLocationMismatchCount++;
                }

                if (!matchesPoType) {
                    hiddenPoTypeCount++;
                }

                // Notes filter
                let matchesNotes = true;
                if (notesFilter === 'with-notes') {
                    matchesNotes = notes.trim().length > 0;
                } else if (notesFilter === 'without-notes') {
                    matchesNotes = notes.trim().length === 0;
                }

                // Priority filter
                const matchesPriority = priorityFilter === 'all' || (poData.priority && poData.priority.toString() === priorityFilter);

                if (matchesSearch && matchesNSStatus && matchesStatus && matchesNotes && matchesPriority && shouldShowNotMyConcern && shouldShowPendingBill && shouldShowPendingSupervisorApproval && shouldShowBasedOnUrl && shouldShowBasedOnEta && shouldShowBasedOnLineItems && shouldShowBasedOnPartialReceives && matchesLocation && matchesPoType) {
                    row.classList.remove('hidden');
                    // Also show the corresponding notes row if it's expanded
                    const notesRow = document.getElementById(`notes-row-${index}`);
                    if (notesRow && notesRow.classList.contains('expanded')) {
                        notesRow.classList.remove('hidden');
                    }
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                    // Also hide the corresponding notes row
                    const notesRow = document.getElementById(`notes-row-${index}`);
                    if (notesRow) {
                        notesRow.classList.add('hidden');
                    }
                }
            });

            console.log(`🔍 Filter results: ${visibleCount} visible, ${hiddenNotMyConcernCount} "Not my concern" hidden, ${hiddenPendingBillCount} "Pending Bill" hidden, ${hiddenHasUrlCount} with URLs hidden, ${hiddenMissingEtaCount} with ETA hidden, ${hiddenWithLineItemsCount} with line items hidden, ${hiddenLocationMismatchCount} location mismatch hidden, ${hiddenPoTypeCount} PO type filtered`);

            // Update results info - with null checks
            const totalCount = rows.length;
            const resultsInfo = document.getElementById('resultsInfo');
            const noResults = document.getElementById('noResults');
            const purchaseOrdersTable = document.getElementById('purchaseOrdersTable');

            if (visibleCount === 0) {
                if (resultsInfo) resultsInfo.style.display = 'none';
                if (noResults) noResults.style.display = 'block';
                if (purchaseOrdersTable) purchaseOrdersTable.style.display = 'none';
            } else {
                if (resultsInfo) resultsInfo.style.display = 'block';
                if (noResults) noResults.style.display = 'none';
                if (purchaseOrdersTable) purchaseOrdersTable.style.display = 'table';

                if (resultsInfo) {
                    if (visibleCount === totalCount) {
                        resultsInfo.textContent = `Showing all ${totalCount} purchase orders`;
                    } else {
                        resultsInfo.textContent = `Showing ${visibleCount} of ${totalCount} purchase orders`;
                    }
                }
            }

            updateStats();
        }

        // Update statistics based on visible rows
        function updateStats() {
            const visibleRows = document.querySelectorAll('#purchaseOrdersTable tbody tr[data-po]:not(.hidden)');
            let notesCount = 0;

            visibleRows.forEach(row => {
                const poData = JSON.parse(row.dataset.po);
                if (poData.notes && poData.notes.trim()) {
                    notesCount++;
                }
            });

            const visibleCountEl = document.getElementById('visibleCount');
            const notesCountEl = document.getElementById('notesCount');
            if (visibleCountEl) visibleCountEl.textContent = visibleRows.length;
            if (notesCountEl) notesCountEl.textContent = notesCount;
        }

        // Sorting functionality
        function sortTable(column) {
            const tbody = document.querySelector('#purchaseOrdersTable tbody');
            const mainRows = Array.from(tbody.querySelectorAll('tr[data-po]'));

            // Determine sort direction
            let direction = 'asc';
            if (currentSort.column === column && currentSort.direction === 'asc') {
                direction = 'desc';
            }

            // Update UI
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const headerElement = document.querySelector(`th[data-column="${column}"]`);
            headerElement.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

            // Sort main rows with their data
            mainRows.sort((a, b) => {
                const aData = JSON.parse(a.dataset.po);
                const bData = JSON.parse(b.dataset.po);

                let aValue, bValue;

                switch (column) {
                    case 'date':
                        aValue = new Date(aData.date);
                        bValue = new Date(bData.date);
                        break;
                    case 'vendor':
                        aValue = aData.vendor.toLowerCase();
                        bValue = bData.vendor.toLowerCase();
                        break;
                    case 'poNumber':
                        aValue = aData.poNumber.toLowerCase();
                        bValue = bData.poNumber.toLowerCase();
                        break;
                    case 'lineItemsCount':
                        aValue = aData.lineItems ? aData.lineItems.length : 0;
                        bValue = bData.lineItems ? bData.lineItems.length : 0;
                        break;
                    case 'nsStatus':
                        aValue = (aData.nsStatus || '').toLowerCase();
                        bValue = (bData.nsStatus || '').toLowerCase();
                        break;
                    case 'eta':
                        aValue = aData.eta ? new Date(aData.eta) : new Date(0);
                        bValue = bData.eta ? new Date(bData.eta) : new Date(0);
                        break;
                    case 'status':
                        aValue = (aData.status || '').toLowerCase();
                        bValue = (bData.status || '').toLowerCase();
                        break;
                    case 'shippingTracking':
                        aValue = (aData.shippingTracking || '').toLowerCase();
                        bValue = (bData.shippingTracking || '').toLowerCase();
                        break;
                    case 'nextUpdateDate':
                        aValue = aData.nextUpdateDate ? new Date(aData.nextUpdateDate) : new Date(0);
                        bValue = bData.nextUpdateDate ? new Date(bData.nextUpdateDate) : new Date(0);
                        break;
                    case 'updatedAt':
                        aValue = new Date(aData.updatedAt || 0);
                        bValue = new Date(bData.updatedAt || 0);
                        break;
                    case 'priority':
                        aValue = parseInt(aData.priority) || 999; // Default to 999 for no priority (sorts to bottom)
                        bValue = parseInt(bData.priority) || 999;
                        break;
                }

                if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Reappend sorted rows in groups (main row + line items row + notes row)
            mainRows.forEach(mainRow => {
                const index = mainRow.dataset.index;
                const lineItemsRow = document.getElementById(`line-items-row-${index}`);
                const notesRow = document.getElementById(`notes-row-${index}`);

                // Append the main row first
                tbody.appendChild(mainRow);

                // Then append its associated expandable rows
                if (lineItemsRow) {
                    tbody.appendChild(lineItemsRow);
                }
                if (notesRow) {
                    tbody.appendChild(notesRow);
                }
            });

            currentSort = { column, direction };
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('nsStatusFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('notesFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            document.getElementById('locationFilter').value = '';
            document.getElementById('showNotMyConcern').checked = false;
            document.getElementById('showPendingBill').checked = false;
            document.getElementById('showPendingSupervisorApproval').checked = false;
            document.getElementById('showOnlyMissingUrls').checked = false;
            document.getElementById('showOnlyNoLineItems').checked = false;
            document.getElementById('showOnlyPartialReceives').checked = false;
            document.getElementById('showOnlyDropship').checked = false;

            // Update Pending Supervisor Approval button appearance
            const pendingSupervisorBtn = document.getElementById('togglePendingSupervisorBtn');
            const pendingSupervisorText = document.getElementById('pendingSupervisorText');
            if (pendingSupervisorBtn && pendingSupervisorText) {
                pendingSupervisorBtn.classList.remove('btn-outline-success');
                pendingSupervisorBtn.classList.add('btn-outline-secondary');
                pendingSupervisorText.textContent = 'Show Pending Supervisor';
            }

            // Clear localStorage for filter states
            localStorage.removeItem('filter_showNotMyConcern');
            localStorage.removeItem('filter_showPendingBill');
            localStorage.removeItem('filter_showPendingSupervisorApproval');
            localStorage.removeItem('filter_showOnlyMissingUrls');
            localStorage.removeItem('filter_showOnlyNoLineItems');
            localStorage.removeItem('filter_showOnlyPartialReceives');

            applyFilters();
        }

        // ============ FILTER STATE PERSISTENCE ============
        // Save and restore filter checkbox states using localStorage

        // Scroll position persistence
        function saveScrollPosition() {
            try {
                const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
                localStorage.setItem('dashboard_scroll_position', scrollPos.toString());
                console.log('💾 Saved scroll position:', scrollPos);
            } catch (e) {
                console.error('Error saving scroll position:', e);
            }
        }

        function restoreScrollPosition() {
            try {
                const savedScroll = localStorage.getItem('dashboard_scroll_position');
                if (savedScroll !== null) {
                    const scrollPos = parseInt(savedScroll, 10);
                    console.log('📜 Restoring scroll position:', scrollPos);
                    // Use setTimeout to ensure DOM is ready
                    setTimeout(() => {
                        window.scrollTo(0, scrollPos);
                        // Clear the saved position after restoring
                        localStorage.removeItem('dashboard_scroll_position');
                    }, 50);
                }
            } catch (e) {
                console.error('Error restoring scroll position:', e);
            }
        }

        function saveFilterState(filterId, checked) {
            try {
                localStorage.setItem(`filter_${filterId}`, checked.toString());
            } catch (e) {
                console.error('Error saving filter state:', e);
            }
        }

        function restoreFilterStates() {
            const filters = ['showNotMyConcern', 'showPendingBill', 'showPendingSupervisorApproval', 'showOnlyMissingUrls', 'showOnlyDropship', 'showOnlyNoLineItems', 'showOnlyPartialReceives'];

            filters.forEach(filterId => {
                const savedState = localStorage.getItem(`filter_${filterId}`);
                if (savedState !== null) {
                    const checkbox = document.getElementById(filterId);
                    if (checkbox) {
                        checkbox.checked = savedState === 'true';
                        
                        // Update Pending Supervisor Approval button appearance if restored
                        if (filterId === 'showPendingSupervisorApproval') {
                            const btn = document.getElementById('togglePendingSupervisorBtn');
                            const btnText = document.getElementById('pendingSupervisorText');
                            if (btn && btnText) {
                                if (savedState === 'true') {
                                    btn.classList.remove('btn-outline-secondary');
                                    btn.classList.add('btn-outline-success');
                                    btnText.textContent = 'Showing Only Pending Supervisor';
                                } else {
                                    btn.classList.remove('btn-outline-success');
                                    btn.classList.add('btn-outline-secondary');
                                    btnText.textContent = 'Show Pending Supervisor';
                                }
                            }
                        }
                    }
                }
            });

            // Restore PO Type filters
            <% poTypeOptions.forEach(type => { %>
                (function () {
                    const filterId = 'filter<%= type.name %>';
                    const savedState = localStorage.getItem(`filter_${filterId}`);
                    const checkbox = document.getElementById(filterId);
                    if (checkbox) {
                        if (savedState !== null) {
                            // If we have a saved state, use it
                            checkbox.checked = savedState === 'true';
                            console.log('📦 Restored PO Type filter <%= type.name %> from saved state:', savedState === 'true');
                        } else {
                            // If no saved state, initialize to checked (default) and save it
                            checkbox.checked = true;
                            localStorage.setItem(`filter_${filterId}`, 'true');
                            console.log('📦 Initialized PO Type filter <%= type.name %> to checked (default)');
                        }
                    }
                })();
            <% }) %>
        }

        // Restore filter states on page load
        restoreFilterStates();

        // Add event listeners to save state when checkboxes change
        ['showNotMyConcern', 'showPendingBill', 'showPendingSupervisorApproval', 'showOnlyMissingUrls', 'showOnlyNoLineItems', 'showOnlyPartialReceives'].forEach(filterId => {
            const checkbox = document.getElementById(filterId);
            if (checkbox) {
                checkbox.addEventListener('change', function () {
                    saveFilterState(filterId, this.checked);
                });
            }
        });

        // Add event listeners for PO Type filters
        <% poTypeOptions.forEach(type => { %>
            (function () {
                const checkbox = document.getElementById('filter<%= type.name %>');
                if (checkbox) {
                    checkbox.addEventListener('change', function () {
                        saveFilterState('filter<%= type.name %>', this.checked);
                        console.log('💾 Saved PO Type filter <%= type.name %>:', this.checked);
                    });
                }
            })();
        <% }) %>

            // Apply filters after restoring state to show correct initial view
            setTimeout(() => {
                console.log('🔄 Applying filters with restored state');
                applyFilters();
                // Restore scroll position after filters are applied
                restoreScrollPosition();
                // Hide loading overlay after everything is restored
                hideLoadingOverlay();
            }, 150);

        // ============ END FILTER STATE PERSISTENCE ============

        // Intercept page reloads to save scroll position and show loading overlay
        const originalReload = window.location.reload.bind(window.location);
        window.location.reload = function() {
            showLoadingOverlay();
            saveScrollPosition();
            originalReload();
        };

        // Show loading overlay function
        function showLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        // Hide loading overlay after page loads
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Also save scroll position before unload
        window.addEventListener('beforeunload', function() {
            saveScrollPosition();
        });

        // ============ SEARCH HISTORY FUNCTIONALITY ============
        const SEARCH_HISTORY_KEY = 'po_search_history';
        const MAX_HISTORY_ITEMS = 10;

        function getSearchHistory() {
            try {
                const history = localStorage.getItem(SEARCH_HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                console.error('Error reading search history:', e);
                return [];
            }
        }

        function saveSearchHistory(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') return;

            try {
                let history = getSearchHistory();

                // Remove if already exists (to move to top)
                history = history.filter(item => item.toLowerCase() !== searchTerm.toLowerCase());

                // Add to beginning
                history.unshift(searchTerm);

                // Keep only last MAX_HISTORY_ITEMS
                history = history.slice(0, MAX_HISTORY_ITEMS);

                localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('Error saving search history:', e);
            }
        }

        function clearSearchHistory() {
            if (confirm('Clear all search history?')) {
                localStorage.removeItem(SEARCH_HISTORY_KEY);
                updateSearchHistoryDropdown();
            }
        }

        function clearSearchField() {
            const searchFilter = document.getElementById('searchFilter');
            if (searchFilter) {
                searchFilter.value = '';
                searchFilter.focus();
                toggleSearchClearBtn();
                applyFilters();
            }
        }

        function toggleSearchClearBtn() {
            const searchFilter = document.getElementById('searchFilter');
            const clearBtn = document.getElementById('searchClearBtn');
            console.log('🔘 toggleSearchClearBtn called - searchFilter:', searchFilter, 'clearBtn:', clearBtn, 'value length:', searchFilter?.value.length);
            if (searchFilter && clearBtn) {
                if (searchFilter.value.length > 0) {
                    console.log('✅ Adding visible class to clear button');
                    clearBtn.classList.add('visible');
                } else {
                    console.log('❌ Removing visible class from clear button');
                    clearBtn.classList.remove('visible');
                }
            }
        }

        function selectAllPoTypes() {
            <% poTypeOptions.forEach(type => { %>
            const checkbox<%= type.name.replace(/\s+/g, '') %> = document.getElementById('filter<%= type.name %>');
            if (checkbox<%= type.name.replace(/\s+/g, '') %>) {
                checkbox<%= type.name.replace(/\s+/g, '') %>.checked = true;
                localStorage.setItem('filter<%= type.name %>', 'true');
            }
            <% }); %>
            applyFilters();
        }

        function clearAllPoTypes() {
            <% poTypeOptions.forEach(type => { %>
            const checkbox<%= type.name.replace(/\s+/g, '') %> = document.getElementById('filter<%= type.name %>');
            if (checkbox<%= type.name.replace(/\s+/g, '') %>) {
                checkbox<%= type.name.replace(/\s+/g, '') %>.checked = false;
                localStorage.setItem('filter<%= type.name %>', 'false');
            }
            <% }); %>
            applyFilters();
        }

        function updateSearchHistoryDropdown() {
            const history = getSearchHistory();
            const list = document.getElementById('searchHistoryList');

            if (history.length === 0) {
                list.innerHTML = '<li class="search-history-empty">No recent searches</li>';
                return;
            }

            list.innerHTML = history.map(term => `
                <li onclick="selectSearchHistory('${term.replace(/'/g, "\\'")}')">
                    <span class="search-history-item-text">${escapeHtml(term)}</span>
                    <span class="search-history-item-icon">🔍</span>
                </li>
            `).join('');
        }

        function selectSearchHistory(term) {
            document.getElementById('searchFilter').value = term;
            hideSearchHistoryDropdown();
            applyFilters();
        }

        function showSearchHistoryDropdown() {
            updateSearchHistoryDropdown();
            document.getElementById('searchHistoryDropdown').style.display = 'block';
        }

        function hideSearchHistoryDropdown() {
            document.getElementById('searchHistoryDropdown').style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search input event listeners for dropdown
        const searchInput = document.getElementById('searchFilter');

        if (searchInput) {
            searchInput.addEventListener('focus', showSearchHistoryDropdown);

            searchInput.addEventListener('blur', () => {
                // Delay to allow clicking on dropdown items
                setTimeout(hideSearchHistoryDropdown, 200);
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('searchHistoryDropdown');
            const searchInput = document.getElementById('searchFilter');

            // Only close if clicking outside both the dropdown and the search input
            if (dropdown && searchInput &&
                !dropdown.contains(event.target) &&
                event.target !== searchInput &&
                !searchInput.contains(event.target)) {
                hideSearchHistoryDropdown();
            }
        });

        // ============ END SEARCH HISTORY FUNCTIONALITY ============

        // Event listeners for filters - with null checks
        const searchFilter = document.getElementById('searchFilter');
        const nsStatusFilter = document.getElementById('nsStatusFilter');
        const statusFilter = document.getElementById('statusFilter');
        const notesFilter = document.getElementById('notesFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        const locationFilter = document.getElementById('locationFilter');
        const showNotMyConcern = document.getElementById('showNotMyConcern');
        const showPendingBill = document.getElementById('showPendingBill');
        const showPendingSupervisorApproval = document.getElementById('showPendingSupervisorApproval');
        const showOnlyMissingUrls = document.getElementById('showOnlyMissingUrls');
        const showOnlyMissingEta = document.getElementById('showOnlyMissingEta');
        const showOnlyNoLineItems = document.getElementById('showOnlyNoLineItems');
        const showOnlyPartialReceives = document.getElementById('showOnlyPartialReceives');

        // Declare searchTimeout outside the if block so it persists
        let searchTimeout;

        console.log('🔍 Setting up search filter event listener...', searchFilter);
        if (searchFilter) {
            // Combined input event listener for search functionality
            searchFilter.addEventListener('input', function () {
                console.log('⌨️ Search input changed:', this.value);
                // Toggle clear button visibility
                toggleSearchClearBtn();
                // Apply filters immediately
                applyFilters();
                // Save to search history after delay
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const value = this.value.trim();
                    if (value.length >= 2) {
                        saveSearchHistory(value);
                    }
                }, 1000);
            });
            console.log('✅ Search filter event listener attached');
        } else {
            console.error('❌ searchFilter element not found!');
        }
        if (nsStatusFilter) nsStatusFilter.addEventListener('change', applyFilters);
        if (statusFilter) statusFilter.addEventListener('change', applyFilters);
        if (notesFilter) notesFilter.addEventListener('change', applyFilters);
        if (priorityFilter) priorityFilter.addEventListener('change', applyFilters);
        if (locationFilter) locationFilter.addEventListener('change', applyFilters);
        if (showNotMyConcern) showNotMyConcern.addEventListener('change', applyFilters);
        if (showPendingBill) showPendingBill.addEventListener('change', applyFilters);
        if (showPendingSupervisorApproval) showPendingSupervisorApproval.addEventListener('change', applyFilters);
        if (showOnlyMissingUrls) showOnlyMissingUrls.addEventListener('change', applyFilters);
        if (showOnlyMissingEta) showOnlyMissingEta.addEventListener('change', applyFilters);
        if (showOnlyNoLineItems) showOnlyNoLineItems.addEventListener('change', applyFilters);
        if (showOnlyPartialReceives) showOnlyPartialReceives.addEventListener('change', applyFilters);

        // Dynamic PO Type filter event listeners
        console.log('🎧 Setting up PO Type filter event listeners...');
        <% poTypeOptions.forEach(type => { %>
            (function () {
                const checkbox = document.getElementById('filter<%= type.name %>');
                console.log('🎧 Setting up listener for <%= type.name %>:', checkbox);
                if (checkbox) {
                    checkbox.addEventListener('change', function (e) {
                        console.log('🔔 <%= type.name %> filter changed to:', e.target.checked);
                        applyFilters();
                    });
                }
            })();
        <% }) %>

            // Event listeners for sorting
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    sortTable(header.dataset.column);
                });
            });

        // Status Management Functions
        let currentStatusOptions = [];

        function openStatusModal() {
            document.getElementById('statusModal').style.display = 'block';
            loadStatusOptions();
        }

        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
            document.getElementById('statusInput').value = '';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const statusModal = document.getElementById('statusModal');
            const lineItemStatusModal = document.getElementById('lineItemStatusModal');
            if (event.target === statusModal) {
                closeStatusModal();
            }
            if (event.target === lineItemStatusModal) {
                closeLineItemStatusModal();
            }
        }

        // Load status options from server
        async function loadStatusOptions() {
            try {
                const response = await fetch('/purchase-orders/status-options');
                const statusOptions = await response.json();
                currentStatusOptions = statusOptions;
                renderStatusList();
            } catch (error) {
                console.error('Error loading status options:', error);
                alert('Error loading status options');
            }
        }

        // Render the status options list
        function renderStatusList() {
            const statusList = document.getElementById('statusList');
            statusList.innerHTML = '';

            currentStatusOptions.forEach(option => {
                const statusItem = document.createElement('div');
                statusItem.className = `status-item ${option.isDefault ? 'default' : ''}`;

                statusItem.innerHTML = `
                    <span class="status-item-name">${option.name}</span>
                    <button class="status-delete-btn" onclick="deleteStatusOption('${option._id}')" 
                            ${option.isDefault ? 'disabled title="Cannot delete default status"' : ''}>
                        Delete
                    </button>
                `;

                statusList.appendChild(statusItem);
            });
        }

        // Add new status option
        async function addStatusOption() {
            const input = document.getElementById('statusInput');
            const addBtn = document.getElementById('addStatusBtn');
            const name = input.value.trim();

            if (!name) {
                alert('Please enter a status name');
                return;
            }

            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/purchase-orders/status-options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();

                if (response.ok) {
                    input.value = '';
                    await loadStatusOptions();
                    // Refresh the page to update all dropdowns
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    alert(result.error || 'Error adding status option');
                }
            } catch (error) {
                console.error('Error adding status option:', error);
                alert('Error adding status option');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add';
            }
        }

        // Delete status option
        async function deleteStatusOption(id) {
            const option = currentStatusOptions.find(opt => opt._id === id);
            if (!option) return;

            if (!confirm(`Are you sure you want to delete "${option.name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/purchase-orders/status-options/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    await loadStatusOptions();
                    // Refresh the page to update all dropdowns
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    alert(result.error || 'Error deleting status option');
                }
            } catch (error) {
                console.error('Error deleting status option:', error);
                alert('Error deleting status option');
            }
        }

        // Allow Enter key to add status - with null check
        const statusInput = document.getElementById('statusInput');
        if (statusInput) {
            statusInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    addStatusOption();
                }
            });
        }

        // Line Item Status Management Functions
        let currentLineItemStatusOptions = [];

        function openLineItemStatusModal() {
            document.getElementById('lineItemStatusModal').style.display = 'block';
            loadLineItemStatusOptions();
        }

        function closeLineItemStatusModal() {
            document.getElementById('lineItemStatusModal').style.display = 'none';
            document.getElementById('lineItemStatusInput').value = '';
        }

        // Load line item status options from server
        async function loadLineItemStatusOptions() {
            try {
                const response = await fetch('/purchase-orders/line-item-status-options');
                const statusOptions = await response.json();
                currentLineItemStatusOptions = statusOptions;
                renderLineItemStatusList();
            } catch (error) {
                console.error('Error loading line item status options:', error);
                alert('Error loading line item status options');
            }
        }

        // Render the line item status options list
        function renderLineItemStatusList() {
            const statusList = document.getElementById('lineItemStatusList');
            statusList.innerHTML = '';

            currentLineItemStatusOptions.forEach(option => {
                const statusItem = document.createElement('div');
                statusItem.className = `status-item ${option.isDefault ? 'default' : ''}`;

                statusItem.innerHTML = `
                    <span class="status-item-name">${option.name}</span>
                    <button class="status-delete-btn" onclick="deleteLineItemStatusOption('${option._id}')" 
                            ${option.isDefault ? 'disabled title="Cannot delete default status"' : ''}>
                        Delete
                    </button>
                `;

                statusList.appendChild(statusItem);
            });
        }

        // Add new line item status option
        async function addLineItemStatusOption() {
            const input = document.getElementById('lineItemStatusInput');
            const addBtn = document.getElementById('addLineItemStatusBtn');
            const name = input.value.trim();

            if (!name) {
                alert('Please enter a status name');
                return;
            }

            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/purchase-orders/line-item-status-options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();

                if (response.ok) {
                    input.value = '';
                    await loadLineItemStatusOptions();
                    alert('Line item status option added successfully');
                } else {
                    alert(result.error || 'Error adding line item status option');
                }
            } catch (error) {
                console.error('Error adding line item status option:', error);
                alert('Error adding line item status option');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add';
            }
        }

        // Delete line item status option
        async function deleteLineItemStatusOption(id) {
            const option = currentLineItemStatusOptions.find(opt => opt._id === id);
            if (!option) return;

            if (!confirm(`Are you sure you want to delete "${option.name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/purchase-orders/line-item-status-options/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    await loadLineItemStatusOptions();
                    alert('Line item status option deleted successfully');
                } else {
                    alert(result.error || 'Error deleting line item status option');
                }
            } catch (error) {
                console.error('Error deleting line item status option:', error);
                alert('Error deleting line item status option');
            }
        }

        // Allow Enter key to add line item status - with null check
        const lineItemStatusInput = document.getElementById('lineItemStatusInput');
        if (lineItemStatusInput) {
            lineItemStatusInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    addLineItemStatusOption();
                }
            });
        }

        // Carrier Management Functions
        let currentCarrierOptions = [
            'FedEx', 'UPS', 'USPS', 'DHL', 'Amazon', 'OnTrac', 'LaserShip', 'Canada Post', 'Other'
        ];

        function openCarrierModal() {
            document.getElementById('carrierModal').style.display = 'block';
            loadCarrierOptions();
        }

        function closeCarrierModal() {
            document.getElementById('carrierModal').style.display = 'none';
            document.getElementById('carrierInput').value = '';
        }

        // Load carrier options (for now using local array, could be expanded to use backend)
        async function loadCarrierOptions() {
            renderCarrierList();
        }

        // Render the carrier options list
        function renderCarrierList() {
            const carrierList = document.getElementById('carrierList');
            carrierList.innerHTML = '';

            currentCarrierOptions.forEach((carrier, index) => {
                const carrierItem = document.createElement('div');
                const isDefault = carrier === 'FedEx';
                carrierItem.className = `status-item ${isDefault ? 'default' : ''}`;

                carrierItem.innerHTML = `
                    <span class="status-item-name">${carrier} ${isDefault ? '(Default)' : ''}</span>
                    <button class="status-delete-btn" onclick="deleteCarrierOption('${carrier}')" 
                            ${isDefault ? 'disabled title="Cannot delete default carrier"' : ''}>
                        Delete
                    </button>
                `;

                carrierList.appendChild(carrierItem);
            });
        }

        // Add new carrier option
        function addCarrierOption() {
            const input = document.getElementById('carrierInput');
            const addBtn = document.getElementById('addCarrierBtn');
            const name = input.value.trim();

            if (!name) {
                alert('Please enter a carrier name');
                return;
            }

            if (currentCarrierOptions.includes(name)) {
                alert('Carrier already exists');
                return;
            }

            currentCarrierOptions.push(name);
            input.value = '';
            renderCarrierList();

            // Update the carrier options in any open line item forms
            updateAllCarrierDropdowns();
        }

        // Delete carrier option
        function deleteCarrierOption(carrier) {
            if (carrier === 'FedEx') {
                alert('Cannot delete default carrier');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${carrier}"?`)) {
                return;
            }

            const index = currentCarrierOptions.indexOf(carrier);
            if (index > -1) {
                currentCarrierOptions.splice(index, 1);
                renderCarrierList();

                // Update the carrier options in any open line item forms
                updateAllCarrierDropdowns();
            }
        }

        // Update all carrier dropdowns on the page
        function updateAllCarrierDropdowns() {
            const carrierSelects = document.querySelectorAll('.carrier-select');
            carrierSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = currentCarrierOptions.map(carrier =>
                    `<option value="${carrier}" ${currentValue === carrier ? 'selected' : ''}>${carrier}</option>`
                ).join('');
            });
        }

        // Allow Enter key to add carrier
        document.addEventListener('DOMContentLoaded', function () {
            const carrierInput = document.getElementById('carrierInput');
            if (carrierInput) {
                carrierInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        addCarrierOption();
                    }
                });
            }

            // Allow Enter key to add PO type
            const poTypeNameInput = document.getElementById('poTypeNameInput');
            if (poTypeNameInput) {
                poTypeNameInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        addPoTypeOption();
                    }
                });
            }

            // Initialize search clear button visibility
            toggleSearchClearBtn();
        });

        // PO Type Management Functions
        let currentPoTypeOptions = [];

        function openPoTypeModal() {
            document.getElementById('poTypeModal').style.display = 'block';
            loadPoTypeOptions();
        }

        function closePoTypeModal() {
            document.getElementById('poTypeModal').style.display = 'none';
            document.getElementById('poTypeNameInput').value = '';
            document.getElementById('poTypeEmojiInput').value = '';
            document.getElementById('poTypeColorInput').value = '#6c757d';
        }

        // Load PO type options from backend
        async function loadPoTypeOptions() {
            try {
                const response = await fetch('/purchase-orders/po-type-options', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load PO type options');
                }

                currentPoTypeOptions = await response.json();
                renderPoTypeList();
            } catch (error) {
                console.error('Error loading PO type options:', error);
                alert('Failed to load PO type options');
            }
        }

        // Render the PO type options list
        function renderPoTypeList() {
            const poTypeList = document.getElementById('poTypeList');
            poTypeList.innerHTML = '';

            currentPoTypeOptions.forEach((poType) => {
                const poTypeItem = document.createElement('div');
                poTypeItem.className = `status-item ${poType.isDefault ? 'default' : ''}`;

                poTypeItem.innerHTML = `
                    <span class="status-item-name" style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${poType.emoji}</span>
                        <span style="color: ${poType.color}; font-weight: 600;">${poType.name}</span>
                        ${poType.isDefault ? '<span style="color: #666; font-size: 12px;">(Default)</span>' : ''}
                    </span>
                    <button class="status-delete-btn" onclick="deletePoTypeOption('${poType._id}')" 
                            ${poType.isDefault ? 'disabled title="Cannot delete default type"' : ''}>
                        Delete
                    </button>
                `;

                poTypeList.appendChild(poTypeItem);
            });
        }

        // Add new PO type option
        async function addPoTypeOption() {
            const nameInput = document.getElementById('poTypeNameInput');
            const emojiInput = document.getElementById('poTypeEmojiInput');
            const colorInput = document.getElementById('poTypeColorInput');
            const addBtn = document.getElementById('addPoTypeBtn');

            const name = nameInput.value.trim();
            const emoji = emojiInput.value.trim() || '📦';
            const color = colorInput.value;

            if (!name) {
                alert('Please enter a type name');
                return;
            }

            // Disable button during request
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/purchase-orders/po-type-options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, emoji, color })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to add PO type');
                }

                console.log('✅ Added PO type:', data.poTypeOption.name);
                nameInput.value = '';
                emojiInput.value = '';
                colorInput.value = '#6c757d';

                await loadPoTypeOptions();

                // Reload page to update filters and dropdowns
                alert(`Successfully added PO type: ${name}. The page will reload to update all dropdowns.`);
                location.reload();

            } catch (error) {
                console.error('Error adding PO type:', error);
                alert(error.message);
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add';
            }
        }

        // Delete PO type option
        async function deletePoTypeOption(id) {
            const poType = currentPoTypeOptions.find(t => t._id === id);
            if (!poType) return;

            if (poType.isDefault) {
                alert('Cannot delete default type');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${poType.name}"?\n\nThis will fail if any POs are using this type.`)) {
                return;
            }

            try {
                const response = await fetch(`/purchase-orders/po-type-options/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete PO type');
                }

                console.log('✅ Deleted PO type:', poType.name);

                // Reload page to update filters and dropdowns
                alert(`Successfully deleted PO type: ${poType.name}. The page will reload to update all dropdowns.`);
                location.reload();

            } catch (error) {
                console.error('Error deleting PO type:', error);
                alert(error.message);
            }
        }

        // Assignee Management Functions
        let currentAssignees = [];

        function openAssigneeModal() {
            document.getElementById('assigneeModal').style.display = 'block';
            loadAssignees();
        }

        function closeAssigneeModal() {
            document.getElementById('assigneeModal').style.display = 'none';
            document.getElementById('assigneeNameInput').value = '';
            document.getElementById('assigneeInitialsInput').value = '';
            document.getElementById('assigneeEmailInput').value = '';
            document.getElementById('assigneeColorInput').value = '#3498db';
        }

        // Load assignees from backend
        async function loadAssignees() {
            try {
                const response = await fetch('/purchase-orders/assignees', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load assignees');
                }

                currentAssignees = await response.json();
                renderAssigneeList();
            } catch (error) {
                console.error('Error loading assignees:', error);
                alert('Failed to load assignees');
            }
        }

        // Render the assignee list
        function renderAssigneeList() {
            const assigneeList = document.getElementById('assigneeList');
            assigneeList.innerHTML = '';

            currentAssignees.forEach((assignee) => {
                const assigneeItem = document.createElement('div');
                assigneeItem.className = 'status-item';

                assigneeItem.innerHTML = `
                    <span class="status-item-name" style="display: flex; align-items: center; gap: 8px;">
                        <span style="background-color: ${assignee.color}; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">
                            ${assignee.initials}
                        </span>
                        <span style="font-weight: 600;">${assignee.name}</span>
                        ${assignee.email ? `<span style="color: #666; font-size: 12px;">(${assignee.email})</span>` : ''}
                    </span>
                    <button class="status-delete-btn" onclick="deleteAssignee('${assignee._id}')">
                        Delete
                    </button>
                `;

                assigneeList.appendChild(assigneeItem);
            });
        }

        // Add new assignee
        async function addAssignee() {
            const nameInput = document.getElementById('assigneeNameInput');
            const initialsInput = document.getElementById('assigneeInitialsInput');
            const emailInput = document.getElementById('assigneeEmailInput');
            const colorInput = document.getElementById('assigneeColorInput');
            const addBtn = document.getElementById('addAssigneeBtn');

            const name = nameInput.value.trim();
            const initials = initialsInput.value.trim().toUpperCase();
            const email = emailInput.value.trim();
            const color = colorInput.value;

            if (!name) {
                alert('Please enter a name');
                return;
            }

            if (!initials) {
                alert('Please enter initials');
                return;
            }

            if (initials.length > 5) {
                alert('Initials must be 5 characters or less');
                return;
            }

            // Disable button during request
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/purchase-orders/assignees', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, initials, email, color })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to add assignee');
                }

                console.log('✅ Added assignee:', data.assignee.name);
                nameInput.value = '';
                initialsInput.value = '';
                emailInput.value = '';
                colorInput.value = '#3498db';

                await loadAssignees();

                // Reload page to update dropdowns
                alert(`Successfully added assignee: ${name}. The page will reload to update all dropdowns.`);
                location.reload();

            } catch (error) {
                console.error('Error adding assignee:', error);
                alert(error.message);
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add';
            }
        }

        // Delete assignee
        async function deleteAssignee(id) {
            const assignee = currentAssignees.find(a => a._id === id);
            if (!assignee) return;

            if (!confirm(`Are you sure you want to delete "${assignee.name}"?\n\nThis will fail if any POs are assigned to this person.`)) {
                return;
            }

            try {
                const response = await fetch(`/purchase-orders/assignees/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete assignee');
                }

                console.log('✅ Deleted assignee:', assignee.name);

                // Reload page to update dropdowns
                alert(`Successfully deleted assignee: ${assignee.name}. The page will reload to update all dropdowns.`);
                location.reload();

            } catch (error) {
                console.error('Error deleting assignee:', error);
                alert(error.message);
            }
        }

        // Update PO assignment
        async function updateAssignment(selectElement) {
            const poId = selectElement.getAttribute('data-po-id');
            const assignedTo = selectElement.value || null;

            try {
                const response = await fetch(`/purchase-orders/pos/${poId}/assign`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ assignedTo })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update assignment');
                }

                console.log('✅ Updated assignment for PO:', poId);

                // Update Last Update display if PO data is returned
                if (data.po) {
                    updateLastUpdateDisplay(poId, data.po.lastUpdate, data.po.lastUpdatedBy);
                }

                // Optional: Show brief success indicator
                const originalBg = selectElement.style.backgroundColor;
                selectElement.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    selectElement.style.backgroundColor = originalBg;
                }, 1000);

            } catch (error) {
                console.error('Error updating assignment:', error);
                alert(error.message);
                // Reload to restore correct state
                location.reload();
            }
        }

        // Pre-Purchase Order Functions
        function addPrePurchaseOrder() {
            document.getElementById('prePurchaseOrderModalTitle').textContent = 'Add Pre-Purchase Order';
            document.getElementById('prePOId').value = '';
            document.getElementById('prePurchaseOrderForm').reset();
            openModal('prePurchaseOrderModal');
        }

        function editPrePurchaseOrder(id) {
            // Find the pre-purchase order data from the DOM
            const card = document.querySelector(`[data-id="${id}"]`);
            if (!card) {
                alert('Pre-purchase order not found');
                return;
            }

            // Get data from the card
            const titleElement = card.querySelector('.pre-po-title strong');
            const vendor = titleElement ? titleElement.textContent : '';
            const itemsElement = card.querySelector('.pre-po-items');
            const items = itemsElement ? itemsElement.textContent : '';
            const priority = card.dataset.priority || 'medium';
            const receiveDate = card.dataset.receiveDate || '';
            const status = card.dataset.status || 'Planning';

            document.getElementById('prePurchaseOrderModalTitle').textContent = 'Edit Pre-Purchase Order';
            document.getElementById('prePOId').value = id;
            document.getElementById('prePOVendor').value = vendor;
            document.getElementById('prePOItems').value = items;
            document.getElementById('prePOStatus').value = status;
            document.getElementById('prePOPriority').value = priority.charAt(0).toUpperCase() + priority.slice(1);

            if (receiveDate) {
                const date = new Date(receiveDate);
                if (!isNaN(date.getTime())) {
                    document.getElementById('prePOReceiveDate').value = date.toISOString().split('T')[0];
                }
            }

            openModal('prePurchaseOrderModal');
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Handle form submission - with null check
        const prePurchaseOrderForm = document.getElementById('prePurchaseOrderForm');
        if (prePurchaseOrderForm) {
            prePurchaseOrderForm.addEventListener('submit', function (e) {
                e.preventDefault();

                console.log('🔍 Form submitted!');

                const formData = new FormData(this);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (value) data[key] = value;
                }

                console.log('📝 Form data:', data);

                const isEdit = data.id;
                const url = isEdit ? `/purchase-orders/pre-purchase-orders/${data.id}` : '/purchase-orders/pre-purchase-orders';
                const method = isEdit ? 'PUT' : 'POST';

                console.log(`🔗 Making ${method} request to ${url}`);

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        console.log('📡 Response received:', response.status);
                        return response.json();
                    })
                    .then(result => {
                        console.log('✅ Response data:', result);
                        if (result.success) {
                            alert('Pre-purchase order saved successfully!');
                            closeModal('prePurchaseOrderModal');
                            location.reload();
                        } else {
                            alert('Error saving pre-purchase order: ' + result.message);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error:', error);
                        alert('Error saving pre-purchase order: ' + error.message);
                    });
            });
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('prePurchaseOrderModal');
            if (event.target === modal) {
                closeModal('prePurchaseOrderModal');
            }
        }

        function convertPrePurchaseOrder(id) {
            if (confirm('Are you sure you want to convert this pre-purchase order to an actual purchase order?')) {
                fetch(`/purchase-orders/pre-purchase-orders/${id}/convert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Pre-purchase order converted successfully!');
                            location.reload();
                        } else {
                            alert('Error converting pre-purchase order: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error converting pre-purchase order');
                    });
            }
        }

        function deletePrePurchaseOrder(id) {
            if (confirm('Are you sure you want to delete this pre-purchase order? This action cannot be undone.')) {
                fetch(`/purchase-orders/pre-purchase-orders/${id}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Pre-purchase order deleted successfully!');
                            location.reload();
                        } else {
                            alert('Error deleting pre-purchase order: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error deleting pre-purchase order');
                    });
            }
        }

        // Initialize filters on page load
        console.log('DOM initialization starting, readyState:', document.readyState);
        if (document.readyState === 'loading') {
            console.log('DOM is loading, adding event listener');
            document.addEventListener('DOMContentLoaded', function () {
                console.log('DOMContentLoaded event fired');

                // Debug: Check if PO Type filter checkboxes exist
                console.log('🔍 Checking PO Type filter checkboxes...');
                <% poTypeOptions.forEach(type => { %>
                    (function () {
                        const checkbox = document.getElementById('filter<%= type.name %>');
                        console.log('  - <%= type.name %>:', checkbox, 'exists:', !!checkbox);
                    })();
                <% }) %>

                    // Load line item status options for dropdowns
                    loadGlobalLineItemStatusOptions();
                // Initialize URL buttons - now using event delegation instead
                // console.log('About to call initUrlButtons');
                // initUrlButtons();
                // console.log('initUrlButtons called');
                // Initialize URL input listeners
                initUrlInputListeners();
                // Apply filters when DOM is loaded
                setTimeout(() => applyFilters(), 50);

                // Initialize tracking column state

                // Load forms for navigation dropdown
                loadForms();
                initializeTrackingColumn();
            });
        } else {
            console.log('DOM already loaded, initializing immediately');
            // DOM is already loaded
            loadGlobalLineItemStatusOptions();
            // Initialize URL buttons - now using event delegation instead
            // console.log('About to call initUrlButtons (immediate)');
            // initUrlButtons();
            // console.log('initUrlButtons called (immediate)');
            // Initialize URL input listeners
            initUrlInputListeners();
            setTimeout(() => applyFilters(), 50);

            // Initialize tracking column state
            initializeTrackingColumn();
        }

        // Fallback copy function for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;

            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    console.log(`📋 Fallback copy successful: ${text}`);
                } else {
                    console.error('❌ Fallback copy failed');
                }
            } catch (err) {
                console.error('❌ Fallback copy error:', err);
            }

            document.body.removeChild(textArea);
        }

        // Event delegation for PO Type select changes
        document.addEventListener('change', async function (e) {
            if (e.target && e.target.classList.contains('po-type-select')) {
                const select = e.target;
                const poId = select.dataset.id;
                const poNumber = select.dataset.po;
                const newType = select.value;

                console.log(`📋 PO Type change detected:`, { poId, poNumber, newType });

                // Validate poId exists
                if (!poId || poId === 'undefined') {
                    console.error('❌ Invalid PO ID:', poId);
                    alert('Error: Invalid PO ID. Please refresh the page and try again.');
                    return;
                }

                // Update data-type attribute for styling
                select.setAttribute('data-type', newType);

                try {
                    const url = `/purchase-orders/${poId}/type`;
                    console.log(`🔄 Updating PO ${poNumber} (ID: ${poId}) type to ${newType}`);
                    console.log(`📡 Sending request to: ${url}`);
                    console.log(`📡 Full URL: ${window.location.origin}${url}`);

                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ poType: newType }),
                        credentials: 'include'  // Include cookies for authentication
                    });

                    console.log(`📡 Response status: ${response.status}`);
                    console.log(`📡 Response URL: ${response.url}`);

                    // Check if we were redirected to login
                    if (response.redirected && response.url.includes('/splash')) {
                        console.error('❌ Session expired - redirected to login');
                        alert('Your session has expired. Please refresh the page and log in again.');
                        window.location.reload();
                        return;
                    }

                    if (response.ok) {
                        console.log(`✅ Updated PO ${poNumber} type to ${newType}`);
                        // Update the poData in the row's dataset
                        const row = select.closest('tr');
                        if (row && row.dataset.po) {
                            const poData = JSON.parse(row.dataset.po);
                            poData.poType = newType;
                            row.dataset.po = JSON.stringify(poData);
                        }
                        // Reapply filters in case type filter is active
                        applyFilters();
                    } else {
                        const error = await response.json();
                        alert(`Error updating PO type: ${error.error || error.message || 'Unknown error'}`);
                        console.error('Error updating PO type:', error);
                    }
                } catch (error) {
                    console.error('Error updating PO type:', error);
                    alert('Error updating PO type. Please try again.');
                }
            }
        });
    </script>

    <!-- Pre-Purchase Order Modals -->
    <div id="prePurchaseOrderModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('prePurchaseOrderModal')">&times;</span>
            <h3 id="prePurchaseOrderModalTitle">Add Pre-Purchase Order</h3>
            <form id="prePurchaseOrderForm">
                <input type="hidden" id="prePOId" name="id">

                <div class="form-group">
                    <label for="prePOVendor">Vendor: <span style="color: red;">*</span></label>
                    <input type="text" id="prePOVendor" name="vendor" required>
                </div>

                <div class="form-group">
                    <label for="prePOItems">Items:</label>
                    <textarea id="prePOItems" name="items" rows="4"
                        placeholder="Paste item information here (will be used for NetSuite CSV import)"></textarea>
                </div>

                <div class="form-group">
                    <label for="prePOStatus">Status:</label>
                    <select id="prePOStatus" name="status">
                        <option value="Planning" selected>Planning</option>
                        <% statusOptions.forEach(option=> { %>
                            <% if (option !=='Planning' ) { %>
                                <option value="<%= option %>">
                                    <%= option %>
                                </option>
                                <% } %>
                                    <% }); %>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prePOPriority">Priority:</label>
                    <select id="prePOPriority" name="priority">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prePOReceiveDate">Receive Date:</label>
                    <input type="date" id="prePOReceiveDate" name="receiveDate">
                </div>

                <div class="form-actions">
                    <button type="button" onclick="closeModal('prePurchaseOrderModal')">Cancel</button>
                    <button type="submit" id="savePrePOBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.9);
            }
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #333;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .form-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .form-actions button[type="button"] {
            background: #6c757d;
            color: white;
        }

        .form-actions button[type="submit"] {
            background: #007bff;
            color: white;
        }

        .form-actions button:hover {
            opacity: 0.9;
        }
    </style>

    <!-- Sticky Header and Filters Scroll Handler -->
    <script>
        // Handle scroll behavior for sticky header and filters
        let lastScrollTop = 0;
        const header = document.querySelector('.header');
        const filtersSection = document.getElementById('filtersSection');
        const tableHeader = document.querySelector('#purchaseOrdersTable thead');

        window.addEventListener('scroll', function () {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            // Add/remove scrolled class to header
            if (scrollTop > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }

            // Add/remove scrolled class to filters
            if (filtersSection) {
                if (scrollTop > 200) {
                    filtersSection.classList.add('scrolled');
                } else {
                    filtersSection.classList.remove('scrolled');
                }
            }

            // Dynamically adjust table header sticky position
            if (tableHeader) {
                const headerHeight = header.offsetHeight;
                const filtersHeight = filtersSection ? filtersSection.offsetHeight : 0;
                const statsHeight = document.querySelector('.stats-combined')?.offsetHeight || 0;

                // Calculate total offset (header + filters)
                const topOffset = headerHeight + filtersHeight;
                tableHeader.style.top = topOffset + 'px';
            }

            lastScrollTop = scrollTop;
        });
    </script>

    <!-- Final initialization script to ensure DOM is ready -->
    <script>
        // Ensure filters are applied after everything is loaded
        window.addEventListener('load', function () {
            console.log('🔄 Window loaded, applying final filter initialization...');

            // Populate location dropdown with unique locations
            populateLocationFilter();

            const notMyConcernCheckbox = document.getElementById('showNotMyConcern');
            const pendingBillCheckbox = document.getElementById('showPendingBill');

            if (notMyConcernCheckbox && pendingBillCheckbox) {
                notMyConcernCheckbox.checked = false; // Ensure unchecked
                pendingBillCheckbox.checked = false; // Ensure unchecked
                console.log('✅ Final filter initialization complete, applying filters...');
                applyFilters();
            } else {
                console.log('❌ One or more checkboxes not found in final initialization');
            }
        });

        // Handle URL search parameter (from unreceived items report)
        const urlParams = new URLSearchParams(window.location.search);
        const searchParam = urlParams.get('search');
        if (searchParam) {
            console.log('🔍 Search parameter found:', searchParam);
            const searchInput = document.getElementById('searchFilter');
            if (searchInput) {
                searchInput.value = searchParam;
                // Trigger filter application
                applyFilters();
                // Focus on the search input
                setTimeout(() => {
                    searchInput.focus();
                    searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
            }
        }
    </script>

    <!-- Task Edit Modal -->
    <div id="taskEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
        <div style="max-width: 700px; margin: 50px auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 0;">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; font-weight: 600;">✏️ Edit Task</h4>
                <button onclick="closeTaskEditModal()" style="background: rgba(255,255,255,0.2); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    ×
                </button>
            </div>
            
            <!-- Modal Body -->
            <div style="padding: 30px;">
                <form id="taskEditForm">
                    <input type="hidden" id="editTaskId">
                    
                    <!-- Title -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Title <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="editTaskTitle" required style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'">
                    </div>
                    
                    <!-- Description -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Description</label>
                        <textarea id="editTaskDescription" rows="3" style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Priority -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Priority <span style="color: #dc3545;">*</span></label>
                            <select id="editTaskPriority" required style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'">
                                <option value="low">🟢 Low</option>
                                <option value="medium">🟡 Medium</option>
                                <option value="high">🟠 High</option>
                                <option value="critical">🔴 Critical</option>
                            </select>
                        </div>
                        
                        <!-- Status -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Status <span style="color: #dc3545;">*</span></label>
                            <select id="editTaskStatus" required style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'">
                                <option value="pending">⏳ Pending</option>
                                <option value="in-progress">🔄 In Progress</option>
                                <option value="completed">✅ Completed</option>
                                <option value="on-hold">⏸️ On Hold</option>
                                <option value="cancelled">❌ Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Category -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Category</label>
                            <select id="editTaskCategory" style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'">
                                <option value="general">General</option>
                                <option value="seed-sourcing">Seed Sourcing</option>
                                <option value="po-management">PO Management</option>
                                <option value="vendor-contact">Vendor Contact</option>
                                <option value="quality-check">Quality Check</option>
                                <option value="inventory">Inventory</option>
                                <option value="shipping">Shipping</option>
                            </select>
                        </div>
                        
                        <!-- Assigned To -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Assigned To</label>
                            <input type="text" id="editTaskAssignedTo" style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'">
                        </div>
                    </div>
                    
                    <!-- Due Date -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Due Date <span style="color: #dc3545;">*</span></label>
                        <input type="date" id="editTaskDueDate" required style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'">
                    </div>
                    
                    <!-- Related PO Numbers -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Related PO Numbers (comma-separated)</label>
                        <input type="text" id="editTaskPONumbers" placeholder="PO12001, PO12002" style="width: 100%; padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e9ecef'">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #e9ecef;">
                        <button type="button" onclick="closeTaskEditModal()" style="padding: 10px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#5c636a'" onmouseout="this.style.background='#6c757d'">
                            Cancel
                        </button>
                        <button type="submit" style="padding: 10px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'">
                            💾 Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Task Management Functions
        async function editTaskFromViewer(taskId) {
            try {
                // Fetch task details
                const response = await fetch(`/tasks/api/${taskId}`);
                if (!response.ok) throw new Error('Failed to fetch task');
                
                const data = await response.json();
                const task = data.task;
                
                // Populate form
                document.getElementById('editTaskId').value = task._id;
                document.getElementById('editTaskTitle').value = task.title;
                document.getElementById('editTaskDescription').value = task.description || '';
                document.getElementById('editTaskPriority').value = task.priority;
                document.getElementById('editTaskStatus').value = task.status;
                document.getElementById('editTaskCategory').value = task.category;
                document.getElementById('editTaskAssignedTo').value = task.assignedTo || '';
                
                // Format date for input
                const dueDate = new Date(task.dueDate);
                document.getElementById('editTaskDueDate').value = dueDate.toISOString().split('T')[0];
                
                // Set PO numbers
                document.getElementById('editTaskPONumbers').value = task.relatedPONumbers ? task.relatedPONumbers.join(', ') : '';
                
                // Show modal
                document.getElementById('taskEditModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Error loading task:', error);
                showTrackingToast('❌ Failed to load task details', 'error');
            }
        }

        function closeTaskEditModal() {
            document.getElementById('taskEditModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Event delegation for task action buttons and card clicks
        document.addEventListener('click', function(e) {
            // Handle edit button - STOP propagation first
            if (e.target.closest('.task-edit-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const taskId = e.target.closest('.task-edit-btn').dataset.taskId;
                editTaskFromViewer(taskId);
                return;
            }
            
            // Handle archive button - STOP propagation first
            if (e.target.closest('.task-archive-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const taskId = e.target.closest('.task-archive-btn').dataset.taskId;
                archiveTaskFromViewer(taskId, e.target.closest('.task-archive-btn'));
                return;
            }
            
            // Handle delete button - STOP propagation first
            if (e.target.closest('.task-delete-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const btn = e.target.closest('.task-delete-btn');
                const taskId = btn.dataset.taskId;
                const taskTitle = btn.dataset.taskTitle;
                deleteTaskFromViewer(taskId, taskTitle, btn);
                return;
            }
            
            // Handle task card clicks (only if not clicking a button)
            const taskCard = e.target.closest('.task-card-clickable');
            if (taskCard) {
                const taskUrl = taskCard.dataset.taskUrl;
                if (taskUrl) {
                    window.location.href = taskUrl;
                }
            }
        });

        document.getElementById('taskEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskId = document.getElementById('editTaskId').value;
            const poNumbersStr = document.getElementById('editTaskPONumbers').value;
            const poNumbers = poNumbersStr ? poNumbersStr.split(',').map(p => p.trim()).filter(p => p) : [];
            
            const taskData = {
                title: document.getElementById('editTaskTitle').value,
                description: document.getElementById('editTaskDescription').value,
                priority: document.getElementById('editTaskPriority').value,
                status: document.getElementById('editTaskStatus').value,
                category: document.getElementById('editTaskCategory').value,
                assignedTo: document.getElementById('editTaskAssignedTo').value,
                dueDate: document.getElementById('editTaskDueDate').value,
                relatedPONumbers: poNumbers
            };
            
            try {
                const response = await fetch(`/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) throw new Error('Failed to update task');
                
                showTrackingToast('✅ Task updated successfully', 'success');
                closeTaskEditModal();
                
                // Reload page to show updated task
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                console.error('Error updating task:', error);
                showTrackingToast('❌ Failed to update task', 'error');
            }
        });

        async function archiveTaskFromViewer(taskId, button) {
            try {
                const response = await fetch(`/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ archived: true })
                });
                
                if (!response.ok) throw new Error('Failed to archive task');
                
                showTrackingToast('✅ Task archived successfully', 'success');
                
                // Remove task card from view with animation
                const taskCard = button.closest('.task-card-clickable');
                if (taskCard) {
                    taskCard.style.transition = 'all 0.3s ease';
                    taskCard.style.opacity = '0';
                    taskCard.style.transform = 'scale(0.9)';
                    setTimeout(() => taskCard.remove(), 300);
                }
            } catch (error) {
                console.error('Error archiving task:', error);
                showTrackingToast('❌ Failed to archive task', 'error');
            }
        }

        async function deleteTaskFromViewer(taskId, taskTitle, button) {
            if (!confirm(`Are you sure you want to delete task "${taskTitle}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete task');
                
                showTrackingToast('✅ Task deleted successfully', 'success');
                
                // Remove task card from view with animation
                const taskCard = button.closest('.task-card-clickable');
                if (taskCard) {
                    taskCard.style.transition = 'all 0.3s ease';
                    taskCard.style.opacity = '0';
                    taskCard.style.transform = 'scale(0.9)';
                    setTimeout(() => taskCard.remove(), 300);
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showTrackingToast('❌ Failed to delete task', 'error');
            }
        }

        // Close modal when clicking outside
        document.getElementById('taskEditModal').addEventListener('click', (e) => {
            if (e.target.id === 'taskEditModal') {
                closeTaskEditModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('taskEditModal').style.display === 'block') {
                closeTaskEditModal();
            }
        });

        // Task filtering functions for compact view
        let currentTaskFilter = 'all';

        function filterTasksCompact(filterType) {
            console.log('🔍 filterTasksCompact called with:', filterType);
            currentTaskFilter = filterType;
            const allTasks = window.allTasksData || [];
            console.log('📊 Total tasks available:', allTasks.length);
            let filteredTasks = [...allTasks];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Apply filter
            if (filterType === 'today') {
                // Tasks created today OR due today
                filteredTasks = allTasks.filter(task => {
                    const createdDate = new Date(task.createdAt);
                    createdDate.setHours(0, 0, 0, 0);
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    
                    return (createdDate.getTime() === today.getTime()) || (dueDate.getTime() === today.getTime());
                });
            } else if (filterType === 'high') {
                // High or critical priority
                filteredTasks = allTasks.filter(task => 
                    task.priority === 'high' || task.priority === 'critical'
                );
            } else if (filterType === 'oldest') {
                // Sort by oldest creation date first
                filteredTasks.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            }
            
            // Update button styles
            document.querySelectorAll('#todayTasksBtn, #highPriorityBtn, #oldestTasksBtn, #allTasksBtn').forEach(btn => {
                btn.style.background = '#e8eaf6';
                btn.style.color = '#5e35b1';
                btn.style.border = '1px solid #5e35b1';
                btn.style.fontWeight = '500';
            });
            
            const activeBtn = document.getElementById(
                filterType === 'today' ? 'todayTasksBtn' : 
                filterType === 'high' ? 'highPriorityBtn' : 
                filterType === 'oldest' ? 'oldestTasksBtn' : 
                'allTasksBtn'
            );
            if (activeBtn) {
                activeBtn.style.background = '#5e35b1';
                activeBtn.style.color = 'white';
                activeBtn.style.border = '1px solid #5e35b1';
                activeBtn.style.fontWeight = '600';
            }
            
            // Update task count
            document.getElementById('taskCountSpan').textContent = `(${filteredTasks.length} tasks)`;
            
            console.log('✅ Filtered tasks count:', filteredTasks.length);
            console.log('🎨 Rendering first', Math.min(8, filteredTasks.length), 'tasks');
            
            // Render tasks (limit to 8 for 2 rows)
            renderCompactTasks(filteredTasks.slice(0, 8));
        }

        function renderCompactTasks(tasks) {
            console.log('🎨 renderCompactTasks called with', tasks.length, 'tasks');
            const grid = document.getElementById('compactTasksGrid');
            if (!grid) {
                console.error('❌ Grid element not found!');
                return;
            }
            console.log('✅ Grid element found:', grid);
            
            const priorityColors = {
                'critical': '#dc3545',
                'high': '#fd7e14',
                'medium': '#ffc107',
                'low': '#28a745'
            };
            const statusColors = {
                'pending': '#6c757d',
                'in-progress': '#0dcaf0',
                'completed': '#198754',
                'cancelled': '#adb5bd',
                'on-hold': '#fd7e14'
            };
            const statusIcons = {
                'pending': '⏳',
                'in-progress': '🔄',
                'completed': '✅',
                'cancelled': '❌',
                'on-hold': '⏸️'
            };
            const priorityIcons = {
                'critical': '🔴',
                'high': '🟠',
                'medium': '🟡',
                'low': '🟢'
            };
            
            // Clear existing tasks
            grid.innerHTML = '';
            
            console.log('🔄 Cleared grid, now rendering', tasks.length, 'task cards');
            
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                const isOverdue = dueDate < now && task.status !== 'completed';
                const dueDateStr = dueDate.toLocaleDateString();
                
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card-clickable';
                taskCard.setAttribute('data-task-url', `/tasks?taskId=${task._id}`);
                taskCard.style.cssText = `background: ${isOverdue ? '#fff5f5' : '#f8f9fa'}; border-left: 4px solid ${priorityColors[task.priority]}; border-radius: 8px; padding: 15px; transition: all 0.3s ease; cursor: pointer;`;
                taskCard.onmouseover = () => { taskCard.style.transform = 'translateY(-2px)'; taskCard.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; };
                taskCard.onmouseout = () => { taskCard.style.transform = 'translateY(0)'; taskCard.style.boxShadow = 'none'; };
                
                taskCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1; padding-right: 10px;">
                            <div style="font-weight: 600; color: #2c3e50; font-size: 0.95rem; margin-bottom: 5px; line-height: 1.3;">
                                ${task.title}
                            </div>
                            ${task.description ? `
                                <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 8px; line-height: 1.4; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis;">
                                    ${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 5px; flex-shrink: 0;">
                            <button class="task-edit-btn" data-task-id="${task._id}"
                                    style="background: #0d6efd; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#0b5ed7'" onmouseout="this.style.background='#0d6efd'"
                                    title="Edit task">
                                ✏️ Edit
                            </button>
                            <button class="task-archive-btn" data-task-id="${task._id}"
                                    style="background: #6c757d; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#5c636a'" onmouseout="this.style.background='#6c757d'"
                                    title="Archive task">
                                📦 Archive
                            </button>
                            <button class="task-delete-btn" data-task-id="${task._id}" data-task-title="${task.title}"
                                    style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#bb2d3b'" onmouseout="this.style.background='#dc3545'"
                                    title="Delete task">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                        <span style="background: ${statusColors[task.status]}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">
                            ${statusIcons[task.status]} ${task.status.replace('-', ' ').toUpperCase()}
                        </span>
                        <span style="background: ${priorityColors[task.priority]}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">
                            ${priorityIcons[task.priority]} ${task.priority.toUpperCase()}
                        </span>
                        ${task.category ? `
                            <span style="background: #e9ecef; color: #495057; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                📁 ${task.category.replace('-', ' ').toUpperCase()}
                            </span>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #6c757d; padding-top: 10px; border-top: 1px solid #e9ecef;">
                        <div>
                            ${isOverdue ? 
                                '<span style="color: #dc3545; font-weight: 600;">⚠️ OVERDUE</span>' : 
                                `<span>📅 Due: ${dueDateStr}</span>`
                            }
                        </div>
                        <div>
                            ${task.assignedTo ? 
                                `<span>👤 ${task.assignedTo}</span>` : 
                                '<span style="color: #adb5bd;">Unassigned</span>'
                            }
                        </div>
                    </div>
                    
                    ${task.relatedPONumbers && task.relatedPONumbers.length > 0 ? `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef; font-size: 0.75rem;">
                            <span style="color: #6c757d;">🔗 POs: </span>
                            ${task.relatedPONumbers.slice(0, 3).map(poNum => 
                                `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 8px; margin-right: 4px; font-weight: 500;">${poNum}</span>`
                            ).join('')}
                            ${task.relatedPONumbers.length > 3 ? `<span style="color: #6c757d;">+${task.relatedPONumbers.length - 3} more</span>` : ''}
                        </div>
                    ` : ''}
                `;
                
                grid.appendChild(taskCard);
            });
            
            console.log('✅ Rendered', tasks.length, 'task cards');
            console.log('📊 Grid now has', grid.children.length, 'children');
            
            // Re-attach event listeners
            attachTaskEventListeners();
        }

        function attachTaskEventListeners() {
            // Task card click handler
            document.querySelectorAll('.task-card-clickable').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        window.location.href = card.getAttribute('data-task-url');
                    }
                });
            });

            // Edit button handlers
            document.querySelectorAll('.task-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openTaskEditModal(btn.getAttribute('data-task-id'));
                });
            });

            // Archive button handlers
            document.querySelectorAll('.task-archive-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    archiveTaskFromViewer(btn.getAttribute('data-task-id'), btn);
                });
            });

            // Delete button handlers
            document.querySelectorAll('.task-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTaskFromViewer(
                        btn.getAttribute('data-task-id'),
                        btn.getAttribute('data-task-title'),
                        btn
                    );
                });
            });
        }

        // Initialize event listeners on page load
        document.addEventListener('DOMContentLoaded', () => {
            attachTaskEventListeners();
            checkReminders(); // Check for task reminders on load
            setInterval(checkReminders, 60000); // Check every minute
        });

        // Task Reminder System
        async function checkReminders() {
            try {
                const response = await fetch('/tasks/api/reminders/active');
                const data = await response.json();
                
                if (data.success && data.reminders && data.reminders.length > 0) {
                    data.reminders.forEach(reminder => {
                        showReminderNotification(reminder);
                    });
                }
            } catch (error) {
                console.error('Error checking reminders:', error);
            }
        }

        function showReminderNotification(task) {
            const container = document.getElementById('reminderContainer');
            if (!container) return;
            
            // Check if reminder already exists
            if (document.getElementById(`reminder-${task._id}`)) {
                return;
            }
            
            const priorityColors = {
                'low': '#28a745',
                'medium': '#ffc107',
                'high': '#fd7e14',
                'critical': '#dc3545'
            };
            
            const notification = document.createElement('div');
            notification.id = `reminder-${task._id}`;
            notification.style.cssText = `
                background: white;
                border-left: 4px solid ${priorityColors[task.priority] || '#6c757d'};
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease-out;
            `;
            
            const dueDate = new Date(task.dueDate);
            const dueDateStr = dueDate.toLocaleDateString();
            const recurringBadge = task.isRecurring ? 
                `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-left: 8px;">
                    🔄 ${task.recurringType.toUpperCase()}
                </span>` : '';
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #2c3e50; font-size: 0.95rem; margin-bottom: 5px;">
                            🔔 Task Reminder
                        </div>
                        <div style="font-weight: 600; color: #495057; font-size: 0.9rem;">
                            ${task.title}
                            ${recurringBadge}
                        </div>
                    </div>
                    <button onclick="dismissReminder('${task._id}', ${task.isRecurring || false})" 
                            style="background: transparent; border: none; color: #6c757d; font-size: 1.2rem; cursor: pointer; padding: 0; margin-left: 10px;"
                            title="Dismiss">
                        ×
                    </button>
                </div>
                ${task.description ? `
                    <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 10px; line-height: 1.4;">
                        ${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}
                    </div>
                ` : ''}
                <div style="font-size: 0.75rem; color: #6c757d; margin-bottom: 12px;">
                    📅 Due: ${dueDateStr}
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button onclick="snoozeReminder('${task._id}', 60)" 
                            style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s;"
                            onmouseover="this.style.background='#5568d3'" 
                            onmouseout="this.style.background='#667eea'">
                        ⏰ Snooze 1 hour
                    </button>
                    <button onclick="snoozeReminder('${task._id}', 240)" 
                            style="background: #764ba2; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s;"
                            onmouseover="this.style.background='#6a4391'" 
                            onmouseout="this.style.background='#764ba2'">
                        ⏰ Snooze 4 hours
                    </button>
                    <button onclick="window.location.href='/tasks?taskId=${task._id}'" 
                            style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s;"
                            onmouseover="this.style.background='#218838'" 
                            onmouseout="this.style.background='#28a745'">
                        📋 View Task
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Add slide-in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            if (!document.getElementById('reminder-animations')) {
                style.id = 'reminder-animations';
                document.head.appendChild(style);
            }
        }

        async function snoozeReminder(taskId, minutes) {
            try {
                const response = await fetch(`/tasks/api/reminders/${taskId}/snooze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ minutes })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    removeReminderNotification(taskId);
                    showTrackingToast(`⏰ Reminder snoozed for ${minutes} minutes`, 'success');
                }
            } catch (error) {
                console.error('Error snoozing reminder:', error);
                showTrackingToast('❌ Failed to snooze reminder', 'error');
            }
        }

        async function dismissReminder(taskId, isRecurring) {
            try {
                if (!isRecurring) {
                    // Only dismiss one-time reminders permanently
                    const response = await fetch(`/tasks/api/reminders/${taskId}/dismiss`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error('Failed to dismiss reminder');
                    }
                } else {
                    // For recurring reminders, just snooze for 24 hours
                    await snoozeReminder(taskId, 1440); // 24 hours
                    return;
                }
                
                removeReminderNotification(taskId);
                showTrackingToast('✅ Reminder dismissed', 'success');
            } catch (error) {
                console.error('Error dismissing reminder:', error);
                showTrackingToast('❌ Failed to dismiss reminder', 'error');
            }
        }

        function removeReminderNotification(taskId) {
            const notification = document.getElementById(`reminder-${taskId}`);
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Quick Task Management Functions
        function showQuickTaskForm() {
            document.getElementById('quickTaskForm').style.display = 'block';
            document.getElementById('quickTaskTitle').focus();
        }

        function hideQuickTaskForm() {
            document.getElementById('quickTaskForm').style.display = 'none';
            document.getElementById('quickTaskTitle').value = '';
            document.getElementById('quickTaskNote').value = '';
            document.getElementById('quickTaskCompleted').checked = false;
        }

        async function saveQuickTask(event) {
            event.preventDefault();
            
            const title = document.getElementById('quickTaskTitle').value.trim();
            const description = document.getElementById('quickTaskNote').value.trim();
            const isCompleted = document.getElementById('quickTaskCompleted').checked;
            const position = document.querySelector('input[name="taskPosition"]:checked').value;
            
            if (!title) {
                showTrackingToast('❌ Please enter a task title', 'error');
                return;
            }
            
            // Calculate due date (default to today + 7 days) in Pacific Time
            const ptNow = getPacificDate();
            const dueDate = new Date(ptNow);
            dueDate.setDate(dueDate.getDate() + 7);
            
            const taskData = {
                title: title,
                description: description,
                priority: 'medium',
                status: isCompleted ? 'completed' : 'pending',
                category: 'general',
                dueDate: dueDate.toISOString(),
                createdBy: '<%= user ? user.username : "unknown" %>',
                assignedTo: '<%= user ? (user.firstName + " " + user.lastName) : "" %>'
            };
            
            // Add completed fields if task is marked as completed (in Pacific Time)
            if (isCompleted) {
                taskData.completedAt = toPacificISO(ptNow);
                taskData.completedBy = '<%= user ? user.username : "unknown" %>';
                console.log('📅 Task completed at (Pacific Time):', taskData.completedAt, '| Browser time:', new Date().toISOString());
            }
            
            try {
                const response = await fetch('/tasks/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showTrackingToast(`✅ Task ${isCompleted ? 'completed' : 'created'} successfully!`, 'success');
                    hideQuickTaskForm();
                    
                    // Reload page to show new task
                    setTimeout(() => location.reload(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to create task');
                }
            } catch (error) {
                console.error('Error creating task:', error);
                showTrackingToast('❌ Failed to create task: ' + error.message, 'error');
            }
        }

        async function exportAccomplishments() {
            try {
                const response = await fetch('/tasks/api/export/accomplishments');
                const data = await response.json();
                
                if (data.success && data.reportContent) {
                    // Download the report as file
                    const blob = new Blob([data.reportContent], { type: 'text/markdown' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `accomplishments_${new Date().toISOString().split('T')[0]}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showTrackingToast('📥 Accomplishments exported successfully!', 'success');
                } else {
                    throw new Error(data.error || 'No completed tasks found');
                }
            } catch (error) {
                console.error('Error exporting accomplishments:', error);
                showTrackingToast('❌ Failed to export: ' + error.message, 'error');
            }
        }

        // Accomplishments Modal Functions
        let currentReportData = null;

        function showAccomplishmentsModal() {
            document.getElementById('accomplishmentsModal').style.display = 'block';
            setTodayRange();
        }

        function hideAccomplishmentsModal() {
            document.getElementById('accomplishmentsModal').style.display = 'none';
            document.getElementById('accomplishmentReportContent').innerHTML = '<p style="text-align: center; color: #6c757d;">Select a date range and click "Generate Report" to view accomplishments.</p>';
            document.getElementById('saveReportBtn').disabled = true;
            document.getElementById('downloadReportBtn').disabled = true;
            document.getElementById('copyReportBtn').disabled = true;
            document.getElementById('emailReportBtn').disabled = true;
            currentReportData = null;
        }

        function setTodayRange() {
            const today = getPacificDateString();
            document.getElementById('accomplishmentStartDate').value = today;
            document.getElementById('accomplishmentEndDate').value = today;
            console.log('📅 Set date range to today (Pacific):', today);
        }

        function setThisWeekRange() {
            const today = getPacificDate();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            
            const firstDay = new Date(today);
            firstDay.setDate(today.getDate() - dayOfWeek); // Sunday
            
            const lastDay = new Date(today);
            lastDay.setDate(today.getDate() + (6 - dayOfWeek)); // Saturday
            
            document.getElementById('accomplishmentStartDate').value = getPacificDateString(firstDay);
            document.getElementById('accomplishmentEndDate').value = getPacificDateString(lastDay);
            console.log('📅 Set date range to this week (Pacific):', getPacificDateString(firstDay), 'to', getPacificDateString(lastDay));
        }

        async function loadAccomplishments() {
            const startDate = document.getElementById('accomplishmentStartDate').value;
            const endDate = document.getElementById('accomplishmentEndDate').value;
            
            if (!startDate || !endDate) {
                showTrackingToast('❌ Please select both start and end dates', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/tasks/api/export/accomplishments?startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                
                if (data.success) {
                    currentReportData = data;
                    
                    // Display the report
                    const reportDiv = document.getElementById('accomplishmentReportContent');
                    reportDiv.innerHTML = data.reportContent || '<p style="text-align: center; color: #6c757d;">No completed tasks found for this period.</p>';
                    
                    // Enable action buttons
                    document.getElementById('saveReportBtn').disabled = data.tasks.length === 0;
                    document.getElementById('downloadReportBtn').disabled = data.tasks.length === 0;
                    document.getElementById('copyReportBtn').disabled = data.tasks.length === 0;
                    document.getElementById('emailReportBtn').disabled = data.tasks.length === 0;
                    
                    if (data.tasks.length > 0) {
                        showTrackingToast(`✅ Found ${data.tasks.length} completed tasks`, 'success');
                    } else {
                        showTrackingToast('ℹ️ No completed tasks in this period', 'info');
                    }
                } else {
                    throw new Error(data.error || 'Failed to load accomplishments');
                }
            } catch (error) {
                console.error('Error loading accomplishments:', error);
                showTrackingToast('❌ Failed to load accomplishments: ' + error.message, 'error');
            }
        }

        async function saveAccomplishmentReport() {
            if (!currentReportData) {
                showTrackingToast('❌ No report to save', 'error');
                return;
            }
            
            const notes = document.getElementById('reportNotes').value.trim();
            
            try {
                const response = await fetch('/tasks/api/accomplishment-reports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: currentReportData.startDate,
                        endDate: currentReportData.endDate,
                        tasks: currentReportData.tasks.map(task => ({
                            taskId: task._id,
                            title: task.title,
                            description: task.description,
                            category: task.category,
                            priority: task.priority,
                            completedAt: task.completedAt,
                            assignedTo: task.assignedTo
                        })),
                        reportContent: currentReportData.reportContent,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showTrackingToast('✅ Report saved successfully!', 'success');
                    document.getElementById('reportNotes').value = '';
                } else {
                    throw new Error(data.error || 'Failed to save report');
                }
            } catch (error) {
                console.error('Error saving report:', error);
                showTrackingToast('❌ Failed to save report: ' + error.message, 'error');
            }
        }

        function downloadAccomplishmentReport() {
            if (!currentReportData || !currentReportData.reportContent) {
                showTrackingToast('❌ No report to download', 'error');
                return;
            }
            
            const blob = new Blob([currentReportData.reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const startDate = currentReportData.startDate || new Date().toISOString().split('T')[0];
            a.download = `accomplishments_${startDate}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showTrackingToast('📥 Report downloaded successfully!', 'success');
        }

        function copyAccomplishmentReport() {
            if (!currentReportData || !currentReportData.reportContent) {
                showTrackingToast('❌ No report to copy', 'error');
                return;
            }
            
            // Copy the report content to clipboard
            navigator.clipboard.writeText(currentReportData.reportContent).then(() => {
                showTrackingToast('📋 Report copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback method
                const textarea = document.createElement('textarea');
                textarea.value = currentReportData.reportContent;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showTrackingToast('📋 Report copied to clipboard!', 'success');
                } catch (err) {
                    showTrackingToast('❌ Failed to copy report', 'error');
                }
                document.body.removeChild(textarea);
            });
        }

        async function emailAccomplishmentReport() {
            if (!currentReportData || !currentReportData.reportContent) {
                showTrackingToast('❌ No report to email', 'error');
                return;
            }
            
            // Prompt for email address
            const email = prompt('Enter email address to send report to:');
            if (!email || !email.trim()) {
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email.trim())) {
                showTrackingToast('❌ Invalid email address', 'error');
                return;
            }
            
            try {
                const response = await fetch('/tasks/api/email-accomplishments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email.trim(),
                        startDate: currentReportData.startDate,
                        endDate: currentReportData.endDate,
                        reportContent: currentReportData.reportContent
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showTrackingToast(`✅ Report sent to ${email}!`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to send email');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showTrackingToast('❌ Failed to send email: ' + error.message, 'error');
            }
        }

        async function viewPastReports() {
            try {
                const response = await fetch('/tasks/api/accomplishment-reports');
                const data = await response.json();
                
                if (data.success && data.reports && data.reports.length > 0) {
                    // Show modal with past reports list
                    let reportsList = '# Past Accomplishment Reports\n\n';
                    reportsList += `Total Reports: ${data.reports.length}\n\n`;
                    reportsList += '═══════════════════════════════════════════════════════\n\n';
                    
                    data.reports.forEach((report, index) => {
                        const reportDate = new Date(report.reportDate).toLocaleDateString();
                        const startDate = new Date(report.startDate).toLocaleDateString();
                        const endDate = new Date(report.endDate).toLocaleDateString();
                        
                        reportsList += `Report ${index + 1} - ${reportDate}\n`;
                        reportsList += `${'─'.repeat(55)}\n`;
                        reportsList += `Period: ${startDate} - ${endDate}\n`;
                        reportsList += `Tasks: ${report.totalTasks}\n`;
                        reportsList += `Generated by: ${report.generatedBy}\n`;
                        if (report.notes) {
                            reportsList += `Notes: ${report.notes}\n`;
                        }
                        reportsList += '\n';
                    });
                    
                    document.getElementById('accomplishmentReportContent').textContent = reportsList;
                    document.getElementById('saveReportBtn').disabled = true;
                    document.getElementById('downloadReportBtn').disabled = true;
                    
                    showTrackingToast(`📚 Found ${data.reports.length} past reports`, 'success');
                } else {
                    document.getElementById('accomplishmentReportContent').textContent = 'No past reports found.\n\nCreate your first report by selecting a date range and clicking "Generate Report".';
                    showTrackingToast('ℹ️ No past reports found', 'info');
                }
            } catch (error) {
                console.error('Error loading past reports:', error);
                document.getElementById('accomplishmentReportContent').textContent = 'Error loading past reports.\n\nPlease try again or check the console for more details.';
                showTrackingToast('❌ Failed to load past reports: ' + error.message, 'error');
            }
        }

        // ============================================================
        // SESSION KEEPALIVE - Prevent session timeout during active use
        // ============================================================
        (function initSessionKeepalive() {
            let lastActivity = Date.now();
            const KEEPALIVE_INTERVAL = 5 * 60 * 1000; // 5 minutes
            const ACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutes of inactivity before stopping
            
            // Track user activity
            const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart'];
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    lastActivity = Date.now();
                }, { passive: true });
            });
            
            // Keepalive function
            async function sendKeepalive() {
                const timeSinceActivity = Date.now() - lastActivity;
                
                // Only send keepalive if user has been active recently
                if (timeSinceActivity < ACTIVITY_TIMEOUT) {
                    try {
                        const response = await fetch('/api/keepalive', {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (!result.authenticated) {
                            console.warn('⚠️ Session expired - user needs to log in again');
                            // Optionally show a notification that session expired
                            if (typeof showTrackingToast === 'function') {
                                showTrackingToast('⏱️ Your session expired. Please refresh and log in again.', 'warning');
                            }
                        } else {
                            console.log('✅ Session keepalive successful');
                        }
                    } catch (error) {
                        console.error('❌ Keepalive failed:', error);
                    }
                } else {
                    console.log('⏸️ User inactive - skipping keepalive');
                }
            }
            
            // Send initial keepalive after 1 minute
            setTimeout(sendKeepalive, 60 * 1000);
            
            // Then send periodically
            setInterval(sendKeepalive, KEEPALIVE_INTERVAL);
            
            console.log('✅ Session keepalive initialized (pinging every 5 minutes while active)');
        })();
    </script>
</body>

</html>