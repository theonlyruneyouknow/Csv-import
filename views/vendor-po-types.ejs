<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Vendor Default PO Types</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .vendor-row {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }
        .vendor-row:hover {
            background: #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .vendor-info {
            flex: 1;
            margin-right: 20px;
        }
        .vendor-name {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }
        .vendor-code {
            color: #6c757d;
            font-size: 0.9em;
        }
        .po-type-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .po-type-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }
        .po-type-btn:hover {
            border-color: #667eea;
            background: #e7f3ff;
        }
        .po-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: 600;
        }
        .po-type-btn.saving {
            opacity: 0.6;
            cursor: wait;
        }
        .search-box {
            margin-bottom: 20px;
        }
        .stats-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∑Ô∏è Manage Vendor Default PO Types</h1>
            <p class="mb-0">Set default PO types for vendors - new POs will automatically inherit these types</p>
        </div>

        <div class="search-box">
            <input type="text" 
                   id="searchInput" 
                   class="form-control" 
                   placeholder="üîç Search vendors by name or code..."
                   onkeyup="filterVendors()">
        </div>

        <div id="statsBox" class="stats-box" style="display: none;">
            <div id="statsContent"></div>
        </div>

        <div id="loadingBox" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading vendors...</p>
        </div>

        <div id="vendorsContainer" style="display: none;">
            <div id="vendorsList"></div>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>No Vendors Found</h3>
            <p>No vendors match your search criteria</p>
        </div>

        <div class="text-center mt-4">
            <a href="/purchase-orders" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <script>
        let allVendors = [];
        const poTypes = ['Seed', 'Dropship', 'Greengood', 'Hardgood', 'Supplies'];

        // Load vendors on page load
        async function loadVendors() {
            try {
                const response = await fetch('/vendors/api/po-types');
                const data = await response.json();

                if (data.success) {
                    allVendors = data.vendors;
                    displayVendors(allVendors);
                    updateStats();
                } else {
                    throw new Error(data.error || 'Failed to load vendors');
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
                document.getElementById('loadingBox').innerHTML = 
                    '<div class="alert alert-danger">Error loading vendors: ' + error.message + '</div>';
            }
        }

        function displayVendors(vendors) {
            const container = document.getElementById('vendorsList');
            document.getElementById('loadingBox').style.display = 'none';
            
            if (vendors.length === 0) {
                document.getElementById('vendorsContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('vendorsContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            container.innerHTML = vendors.map(vendor => `
                <div class="vendor-row" data-vendor-id="${vendor._id}">
                    <div class="vendor-info">
                        <div class="vendor-name">${vendor.vendorName}</div>
                        <div class="vendor-code">Code: ${vendor.vendorCode || 'N/A'} ${vendor.internalId ? '| ID: ' + vendor.internalId : ''}</div>
                    </div>
                    <div class="po-type-buttons">
                        ${poTypes.map(type => `
                            <button class="po-type-btn ${vendor.defaultPoType === type ? 'active' : ''}" 
                                    onclick="setPoType('${vendor._id}', '${type}', this)"
                                    data-type="${type}">
                                ${type}
                            </button>
                        `).join('')}
                        <button class="po-type-btn ${!vendor.defaultPoType ? 'active' : ''}" 
                                onclick="setPoType('${vendor._id}', '', this)"
                                data-type="">
                            None
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function setPoType(vendorId, poType, button) {
            // Disable all buttons in this row while saving
            const row = button.closest('.vendor-row');
            const buttons = row.querySelectorAll('.po-type-btn');
            buttons.forEach(btn => btn.classList.add('saving'));

            try {
                const response = await fetch(`/vendors/api/po-types/${vendorId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ defaultPoType: poType })
                });

                const data = await response.json();

                if (data.success) {
                    // Update UI - remove active from all buttons in row
                    buttons.forEach(btn => btn.classList.remove('active'));
                    // Add active to clicked button
                    button.classList.add('active');

                    // Update local data
                    const vendor = allVendors.find(v => v._id === vendorId);
                    if (vendor) {
                        vendor.defaultPoType = poType;
                        updateStats();
                    }
                } else {
                    throw new Error(data.error || 'Failed to update');
                }
            } catch (error) {
                console.error('Error updating PO type:', error);
                alert('Error updating PO type: ' + error.message);
            } finally {
                // Re-enable buttons
                buttons.forEach(btn => btn.classList.remove('saving'));
            }
        }

        function filterVendors() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allVendors.filter(vendor => 
                vendor.vendorName.toLowerCase().includes(searchTerm) ||
                (vendor.vendorCode && vendor.vendorCode.toLowerCase().includes(searchTerm)) ||
                (vendor.internalId && vendor.internalId.toLowerCase().includes(searchTerm))
            );
            displayVendors(filtered);
        }

        function updateStats() {
            const statsBox = document.getElementById('statsBox');
            const statsContent = document.getElementById('statsContent');

            const withTypes = allVendors.filter(v => v.defaultPoType && v.defaultPoType !== '').length;
            const withoutTypes = allVendors.length - withTypes;

            const typeBreakdown = {};
            poTypes.forEach(type => {
                typeBreakdown[type] = allVendors.filter(v => v.defaultPoType === type).length;
            });

            statsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Total Vendors:</strong> ${allVendors.length}<br>
                        <strong>With Default Type:</strong> ${withTypes}<br>
                        <strong>Without Default Type:</strong> ${withoutTypes}
                    </div>
                    <div class="col-md-6">
                        <strong>Type Breakdown:</strong><br>
                        ${Object.entries(typeBreakdown).map(([type, count]) => 
                            `${type}: ${count}`
                        ).join('<br>')}
                    </div>
                </div>
            `;
            statsBox.style.display = 'block';
        }

        // Load vendors when page loads
        document.addEventListener('DOMContentLoaded', loadVendors);
    </script>
</body>
</html>
