<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= vendor.displayName %> - Vendor Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .vendor-header {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .vendor-icon {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .vendor-info h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 600;
        }

        .vendor-code {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            display: inline-block;
            margin-top: 5px;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 25px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-value {
            color: #2c3e50;
            font-size: 1rem;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .table th {
            background: #f8f9fa;
            border: none;
            padding: 15px;
            font-weight: 600;
            color: #495057;
        }

        .table td {
            padding: 15px;
            border: none;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
            transform: translateY(-1px);
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .document-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .document-meta {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .item-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            background: white;
            transition: transform 0.2s ease;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .item-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .item-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 10px;
        }

        .tracking-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .tracking-delivered {
            background: #d4edda;
            color: #155724;
        }

        .tracking-transit {
            background: #fff3cd;
            color: #856404;
        }

        .tracking-pending {
            background: #f8d7da;
            color: #721c24;
        }

        .po-link {
            color: #007bff;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .po-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="vendor-header">
                        <div class="vendor-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="vendor-info">
                            <h1><%= vendor.displayName %></h1>
                            <span class="vendor-code">Type: <%= vendor.vendorType || 'N/A' %></span>
                            <span class="status-badge status-<%= (vendor.status || 'active').toLowerCase().replace(' ', '-') %> ms-3">
                                <%= vendor.status || 'Active' %>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="btn-group">
                        <a href="/vendors/<%= vendor._id %>/edit" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Edit Vendor
                        </a>
                        <a href="/vendors" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Performance Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number"><%= poStats.totalPOs %></div>
                <div class="stat-label">Total Purchase Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">$<%= (poStats.totalValue || 0).toLocaleString() %></div>
                <div class="stat-label">Total Order Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">$<%= (poStats.avgValue || 0).toFixed(0) %></div>
                <div class="stat-label">Average Order Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><%= vendor.totalActiveItems || 0 %></div>
                <div class="stat-label">Active Items</div>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="content-card">
            <div class="card-header">
                <h3><i class="fas fa-address-book"></i> Contact Information</h3>
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <% 
                    // Get primary contact from new structure or fall back to legacy
                    const primaryContact = vendor.primaryContact || (vendor.contactInfo && vendor.contactInfo.primaryContact);
                    const mainPhone = vendor.mainPhone || (primaryContact && primaryContact.phone);
                    const mainEmail = vendor.mainEmail || (primaryContact && primaryContact.email);
                    %>
                    
                    <% if (primaryContact || mainPhone || mainEmail) { %>
                    <div class="info-item">
                        <div class="info-label">Primary Contact</div>
                        <div class="info-value">
                            <%= (primaryContact && primaryContact.name) || 'N/A' %>
                            <% if (primaryContact && primaryContact.title) { %>
                                <br><small class="text-muted"><%= primaryContact.title %></small>
                            <% } %>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value">
                            <% if (mainEmail) { %>
                                <a href="mailto:<%= mainEmail %>">
                                    <%= mainEmail %>
                                </a>
                            <% } else { %>
                                N/A
                            <% } %>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Phone</div>
                        <div class="info-value">
                            <% if (mainPhone) { %>
                                <a href="tel:<%= mainPhone %>">
                                    <%= mainPhone %>
                                </a>
                            <% } else { %>
                                N/A
                            <% } %>
                        </div>
                    </div>
                    <% } else { %>
                    <div class="info-item">
                        <div class="info-label">Primary Contact</div>
                        <div class="info-value">N/A</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value">N/A</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Phone</div>
                        <div class="info-value">N/A</div>
                    </div>
                    <% } %>
                    
                    <% if (vendor.address) { %>
                    <div class="info-item">
                        <div class="info-label">Address</div>
                        <div class="info-value">
                            <%= vendor.address.street || '' %><br>
                            <%= vendor.address.city || '' %>, <%= vendor.address.state || '' %> <%= vendor.address.zipCode || '' %><br>
                            <%= vendor.address.country || 'United States' %>
                        </div>
                    </div>
                    <% } %>

                    <% if (vendor.businessInfo && vendor.businessInfo.website) { %>
                    <div class="info-item">
                        <div class="info-label">Website</div>
                        <div class="info-value">
                            <a href="<%= vendor.formattedWebsite || vendor.businessInfo.website %>" target="_blank">
                                <%= vendor.businessInfo.website %>
                                <i class="fas fa-external-link-alt ms-1"></i>
                            </a>
                        </div>
                    </div>
                    <% } %>

                    <% if (vendor.paymentTerms && vendor.paymentTerms.terms) { %>
                    <div class="info-item">
                        <div class="info-label">Payment Terms</div>
                        <div class="info-value">
                            <%= vendor.paymentTerms.terms %>
                            <% if (vendor.paymentTerms.customTerms) { %>
                                <br><small class="text-muted"><%= vendor.paymentTerms.customTerms %></small>
                            <% } %>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Tabbed Content -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('purchase-orders')">
                <i class="fas fa-file-invoice"></i> Purchase Orders (<%= poStats.totalPOs %>)
            </button>
            <button class="tab" onclick="showTab('unreceived')">
                <i class="fas fa-clock"></i> Unreceived Items (<span id="unreceivedCount">0</span>)
            </button>
            <button class="tab" onclick="showTab('items')">
                <i class="fas fa-seedling"></i> Items (<%= vendor.totalActiveItems || 0 %>)
            </button>
            <% if (vendor.contacts && vendor.contacts.length > 1) { %>
            <button class="tab" onclick="showTab('contacts')">
                <i class="fas fa-address-book"></i> All Contacts (<%= vendor.contacts.length %>)
            </button>
            <% } %>
            <button class="tab" onclick="showTab('tracking')">
                <i class="fas fa-truck"></i> Tracking (<%= trackingData.length %>)
            </button>
            <button class="tab" onclick="showTab('documents')">
                <i class="fas fa-folder"></i> Documents (<%= vendor.totalActiveDocuments || 0 %>)
            </button>
        </div>

        <!-- Tab Content: Purchase Orders -->
        <div id="purchase-orders" class="tab-content active">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Recent Purchase Orders</h4>
                <% if (purchaseOrders && purchaseOrders.length > 0) { %>
                <button class="btn btn-primary btn-sm" onclick="window.open('/purchase-orders?vendor=<%= encodeURIComponent(vendor.vendorName) %>', '_blank')">
                    <i class="fas fa-external-link-alt"></i> View All POs
                </button>
                <% } else { %>
                <button class="btn btn-primary btn-sm" onclick="window.open('/purchase-orders', '_blank')">
                    <i class="fas fa-external-link-alt"></i> View PO Dashboard
                </button>
                <% } %>
            </div>

            <% if (purchaseOrders && purchaseOrders.length > 0) { %>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>PO Number</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Tracking</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% purchaseOrders.slice(0, 10).forEach(po => { %>
                        <tr>
                            <td>
                                <strong><%= po.poNumber %></strong>
                                <% if (po.notes) { %>
                                    <br><small class="text-muted"><%= po.notes %></small>
                                <% } %>
                            </td>
                            <td><%= po.poDate ? new Date(po.poDate).toLocaleDateString() : 'N/A' %></td>
                            <td>$<%= (po.totalAmount || 0).toFixed(2) %></td>
                            <td>
                                <span class="status-badge status-<%= (po.status || 'pending').toLowerCase() %>">
                                    <%= po.status || 'Pending' %>
                                </span>
                            </td>
                            <td>
                                <% if (po.trackingNumber) { %>
                                    <div><%= po.trackingNumber %></div>
                                    <small class="text-muted"><%= po.carrier || 'Unknown carrier' %></small>
                                <% } else { %>
                                    <span class="text-muted">No tracking</span>
                                <% } %>
                            </td>
                            <td>
                                <% if (po.poUrl) { %>
                                    <a href="<%= po.poUrl %>" target="_blank" class="btn btn-outline-primary btn-sm" title="View in NetSuite">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                <% } else { %>
                                    <button class="btn btn-outline-secondary btn-sm" disabled title="No NetSuite link available">
                                        <i class="fas fa-eye-slash"></i>
                                    </button>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <% } else { %>
            <div class="text-center py-5 text-muted">
                <i class="fas fa-file-invoice fa-3x mb-3"></i>
                <div>No purchase orders found for this vendor</div>
            </div>
            <% } %>
        </div>

        <!-- Tab Content: Unreceived Items -->
        <div id="unreceived" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Unreceived Items</h4>
                <button class="btn btn-sm btn-outline-primary" onclick="loadUnreceivedItems()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>

            <div id="unreceivedLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading unreceived items...</p>
            </div>

            <div id="unreceivedContent" style="display: none;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>PO Number</th>
                                <th>PO Date</th>
                                <th>ETA</th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Item Status</th>
                                <th>PO Status</th>
                            </tr>
                        </thead>
                        <tbody id="unreceivedItemsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="unreceivedEmpty" class="text-center py-5 text-muted" style="display: none;">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <div>All items from this vendor have been received!</div>
            </div>
        </div>

        <!-- Tab Content: Items -->
        <div id="items" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Vendor Items & Products</h4>
                <button class="btn btn-primary btn-sm" onclick="showAddItemModal()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>

            <% if (vendor.items && vendor.items.length > 0) { %>
            <div class="item-grid">
                <% vendor.items.filter(item => item.isActive !== false).forEach(item => { %>
                <div class="item-card">
                    <div class="item-name"><%= item.itemName || 'Unnamed Item' %></div>
                    <div class="item-price">$<%= (item.currentPrice || 0).toFixed(2) %></div>
                    <div class="mb-2">
                        <small class="text-muted">Code: </small><%= item.itemCode || 'N/A' %>
                    </div>
                    <% if (item.category) { %>
                    <div class="mb-2">
                        <span class="vendor-type-badge"><%= item.category %></span>
                    </div>
                    <% } %>
                    <% if (item.description) { %>
                    <div class="text-muted small mb-2"><%= item.description %></div>
                    <% } %>
                    <div class="row text-center small">
                        <div class="col">
                            <div class="fw-bold"><%= item.minimumOrder || 1 %></div>
                            <div class="text-muted">Min Order</div>
                        </div>
                        <div class="col">
                            <div class="fw-bold"><%= item.unitOfMeasure || 'ea' %></div>
                            <div class="text-muted">Unit</div>
                        </div>
                        <div class="col">
                            <div class="fw-bold"><%= item.leadTime || 'N/A' %></div>
                            <div class="text-muted">Lead Time</div>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
            <% } else { %>
            <div class="text-center py-5 text-muted">
                <i class="fas fa-seedling fa-3x mb-3"></i>
                <div>No items found for this vendor</div>
                <button class="btn btn-primary mt-3" onclick="showAddItemModal()">
                    <i class="fas fa-plus"></i> Add First Item
                </button>
            </div>
            <% } %>
        </div>

        <!-- Tab Content: All Contacts -->
        <% if (vendor.contacts && vendor.contacts.length > 1) { %>
        <div id="contacts" class="tab-content" style="display: none;">
            <h4>All Contacts</h4>
            
            <div class="row">
                <% vendor.contacts.forEach((contact, index) => { %>
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title mb-1">
                                    <%= contact.name || `Contact ${index + 1}` %>
                                    <% if (contact.isPrimary) { %>
                                        <span class="badge bg-primary ms-2">Primary</span>
                                    <% } %>
                                </h6>
                            </div>
                            
                            <% if (contact.title || contact.department) { %>
                            <div class="text-muted mb-2">
                                <% if (contact.title) { %>
                                    <%= contact.title %>
                                    <% if (contact.department) { %> - <%= contact.department %><% } %>
                                <% } else if (contact.department) { %>
                                    <%= contact.department %>
                                <% } %>
                            </div>
                            <% } %>
                            
                            <div class="contact-details">
                                <% if (contact.email) { %>
                                <div class="mb-1">
                                    <i class="fas fa-envelope text-muted me-2"></i>
                                    <a href="mailto:<%= contact.email %>"><%= contact.email %></a>
                                </div>
                                <% } %>
                                
                                <% if (contact.phone) { %>
                                <div class="mb-1">
                                    <i class="fas fa-phone text-muted me-2"></i>
                                    <a href="tel:<%= contact.phone %>"><%= contact.phone %></a>
                                </div>
                                <% } %>
                                
                                <% if (contact.mobile) { %>
                                <div class="mb-1">
                                    <i class="fas fa-mobile-alt text-muted me-2"></i>
                                    <a href="tel:<%= contact.mobile %>"><%= contact.mobile %></a>
                                </div>
                                <% } %>
                            </div>
                            
                            <% if (contact.notes) { %>
                            <div class="mt-2">
                                <small class="text-muted"><%= contact.notes %></small>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
        <% } %>

        <!-- Tab Content: Tracking -->
        <div id="tracking" class="tab-content" style="display: none;">
            <h4>Shipment Tracking</h4>

            <% if (trackingData && trackingData.length > 0) { %>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>PO Number</th>
                            <th>Tracking Number</th>
                            <th>Carrier</th>
                            <th>Ship Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% trackingData.forEach(tracking => { %>
                        <tr>
                            <td><%= tracking.poNumber %></td>
                            <td>
                                <span class="font-monospace"><%= tracking.trackingNumber %></span>
                            </td>
                            <td><%= tracking.carrier %></td>
                            <td><%= tracking.shipDate ? new Date(tracking.shipDate).toLocaleDateString() : 'N/A' %></td>
                            <td>
                                <span class="tracking-status tracking-<%= (tracking.status || 'unknown').toLowerCase() %>">
                                    <%= tracking.status || 'Unknown' %>
                                </span>
                            </td>
                            <td>
                                <% if (tracking.trackingNumber) { %>
                                <a href="#" class="btn btn-outline-primary btn-sm" onclick="openTrackingWindow('<%= tracking.trackingNumber %>', '<%= tracking.carrier %>')">
                                    <i class="fas fa-external-link-alt"></i> Track
                                </a>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <% } else { %>
            <div class="text-center py-5 text-muted">
                <i class="fas fa-truck fa-3x mb-3"></i>
                <div>No tracking information available</div>
            </div>
            <% } %>
        </div>

        <!-- Tab Content: Documents -->
        <div id="documents" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Documents & Files</h4>
            </div>

            <!-- Upload Area -->
            <div class="upload-area mb-4" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                <div class="h5">Drop files here or click to upload</div>
                <div class="text-muted">Supports PDF, DOC, DOCX, XLS, XLSX, JPG, PNG files (max 10MB)</div>
                <input type="file" id="fileInput" style="display: none;" multiple 
                       accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt,.csv"
                       onchange="uploadFiles(this.files)">
            </div>

            <!-- Documents List -->
            <% if (vendor.documents && vendor.documents.length > 0) { %>
                <% vendor.documents.filter(doc => doc.isActive !== false).forEach(doc => { %>
                <div class="document-item">
                    <div class="document-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="document-info">
                        <div class="document-name"><%= doc.originalName || doc.filename %></div>
                        <div class="document-meta">
                            <%= doc.category || 'Other' %> • 
                            <%= (doc.size / 1024).toFixed(1) %>KB • 
                            <%= new Date(doc.uploadDate).toLocaleDateString() %>
                            <% if (doc.description) { %>
                                • <%= doc.description %>
                            <% } %>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <a href="/vendors/<%= vendor._id %>/documents/<%= doc._id %>/download" class="btn btn-outline-primary">
                            <i class="fas fa-download"></i>
                        </a>
                        <button class="btn btn-outline-danger" onclick="deleteDocument('<%= doc._id %>')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <% }); %>
            <% } else { %>
            <div class="text-center py-5 text-muted">
                <i class="fas fa-folder-open fa-3x mb-3"></i>
                <div>No documents uploaded yet</div>
            </div>
            <% } %>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/vendors/<%= vendor._id %>/items">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Item Code</label>
                                <input type="text" class="form-control" name="itemCode" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Item Name</label>
                                <input type="text" class="form-control" name="itemName" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="2"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category">
                                    <option value="Seeds">Seeds</option>
                                    <option value="Tools">Tools</option>
                                    <option value="Fertilizer">Fertilizer</option>
                                    <option value="Supplies">Supplies</option>
                                    <option value="Equipment">Equipment</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Variety</label>
                                <input type="text" class="form-control" name="variety">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Price</label>
                                <input type="number" class="form-control" name="currentPrice" step="0.01" min="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Unit</label>
                                <input type="text" class="form-control" name="unitOfMeasure" placeholder="lbs, ea, packets">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Min Order</label>
                                <input type="number" class="form-control" name="minimumOrder" min="1" value="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Lead Time</label>
                                <input type="text" class="form-control" name="leadTime" placeholder="2-3 weeks">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Availability</label>
                                <select class="form-select" name="availability">
                                    <option value="In Stock">In Stock</option>
                                    <option value="Limited Stock">Limited Stock</option>
                                    <option value="Out of Stock">Out of Stock</option>
                                    <option value="Seasonal">Seasonal</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Tab functionality
        function showTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).style.display = 'block';
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load unreceived items when that tab is shown
            if (tabId === 'unreceived') {
                loadUnreceivedItems();
            }
        }

        // Load unreceived items for this vendor
        let unreceivedItemsLoaded = false;
        async function loadUnreceivedItems() {
            // Only load once unless explicitly refreshed
            if (unreceivedItemsLoaded && event && event.type !== 'click') {
                return;
            }

            const loading = document.getElementById('unreceivedLoading');
            const content = document.getElementById('unreceivedContent');
            const empty = document.getElementById('unreceivedEmpty');
            const tbody = document.getElementById('unreceivedItemsBody');

            loading.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';

            try {
                const response = await fetch('/purchase-orders/unreceived-items');
                const data = await response.json();

                if (data.success) {
                    console.log('Total unreceived items:', data.items.length);
                    console.log('Looking for vendor ID:', '<%= vendor._id %>');
                    console.log('Looking for vendor name:', '<%= vendor.vendorName %>');

                    // Filter items for this vendor by vendorId (more reliable than name matching)
                    const vendorId = '<%= vendor._id %>';
                    const vendorItems = data.items.filter(item => {
                        // Match by vendorId if available
                        if (item.vendorId) {
                            return item.vendorId === vendorId;
                        }
                        // Fallback: match by vendor name (may include number prefix)
                        return item.vendor && item.vendor.includes('<%= vendor.vendorName %>');
                    });

                    console.log('Filtered items for this vendor:', vendorItems.length);

                    // Update count
                    document.getElementById('unreceivedCount').textContent = vendorItems.length;

                    if (vendorItems.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                    } else {
                        tbody.innerHTML = vendorItems.map(item => {
                            const poLink = item.poUrl || '#';
                            return `
                                <tr>
                                    <td>
                                        ${item.poUrl 
                                            ? `<a href="${poLink}" target="_blank" class="po-link">${item.poNumber}</a>`
                                            : item.poNumber
                                        }
                                    </td>
                                    <td>${item.poDate || 'N/A'}</td>
                                    <td>${item.eta ? new Date(item.eta).toLocaleDateString() : 'N/A'}</td>
                                    <td><strong>${item.sku || 'N/A'}</strong></td>
                                    <td style="max-width: 400px;" title="${item.memo || ''}">${item.memo || 'N/A'}</td>
                                    <td>${item.itemStatus ? `<span class="badge bg-info">${item.itemStatus}</span>` : 'N/A'}</td>
                                    <td>${item.poStatus ? `<span class="badge bg-warning">${item.poStatus}</span>` : 'N/A'}</td>
                                </tr>
                            `;
                        }).join('');

                        loading.style.display = 'none';
                        content.style.display = 'block';
                    }

                    unreceivedItemsLoaded = true;
                } else {
                    throw new Error(data.error || 'Failed to load unreceived items');
                }
            } catch (error) {
                console.error('Error loading unreceived items:', error);
                loading.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error loading unreceived items: ${error.message}
                    </div>
                `;
            }
        }

        // Show add item modal
        function showAddItemModal() {
            new bootstrap.Modal(document.getElementById('addItemModal')).show();
        }

        // File upload functionality
        function uploadFiles(files) {
            if (!files || files.length === 0) return;

            const formData = new FormData();
            Array.from(files).forEach(file => {
                formData.append('document', file);
            });

            // Show upload progress
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i><div class="h5">Uploading...</div>';

            fetch(`/vendors/<%= vendor._id %>/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh to show new document
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                    resetUploadArea();
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
                resetUploadArea();
            });
        }

        function resetUploadArea() {
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                <div class="h5">Drop files here or click to upload</div>
                <div class="text-muted">Supports PDF, DOC, DOCX, XLS, XLSX, JPG, PNG files (max 10MB)</div>
            `;
        }

        // Drag and drop functionality
        const uploadArea = document.querySelector('.upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            uploadFiles(e.dataTransfer.files);
        });

        // Tracking functions
        function openTrackingWindow(trackingNumber, carrier) {
            let url = '';
            switch (carrier.toLowerCase()) {
                case 'ups':
                    url = `https://www.ups.com/track?loc=en_US&tracknum=${trackingNumber}`;
                    break;
                case 'fedex':
                    url = `https://www.fedex.com/fedextrack/?trknbr=${trackingNumber}`;
                    break;
                case 'usps':
                    url = `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}`;
                    break;
                default:
                    url = `https://www.google.com/search?q=track+package+${trackingNumber}`;
            }
            window.open(url, '_blank');
        }

        // Delete document
        function deleteDocument(docId) {
            if (confirm('Are you sure you want to delete this document?')) {
                fetch(`/vendors/<%= vendor._id %>/documents/${docId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete document');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete document');
                });
            }
        }

        // Show success messages
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success')) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> Operation completed successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.stats-grid'));
        }

        // Load unreceived items count on page load
        async function loadUnreceivedCount() {
            try {
                const response = await fetch('/purchase-orders/unreceived-items');
                const data = await response.json();

                if (data.success) {
                    const vendorId = '<%= vendor._id %>';
                    const vendorItems = data.items.filter(item => {
                        if (item.vendorId) {
                            return item.vendorId === vendorId;
                        }
                        return item.vendor && item.vendor.includes('<%= vendor.vendorName %>');
                    });

                    document.getElementById('unreceivedCount').textContent = vendorItems.length;
                }
            } catch (error) {
                console.error('Error loading unreceived count:', error);
            }
        }

        // Load the count when page loads
        loadUnreceivedCount();
    </script>
</body>

</html>
