<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-box me-2"></i><%= title %></h2>
            <a href="/grocery/items" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Items
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form id="itemForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Item Name *</label>
                        <input type="text" class="form-control" name="name" value="<%= item ? item.name : '' %>" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" name="brand" value="<%= item ? item.brand || '' : '' %>">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <div class="input-group">
                            <select class="form-select" name="category" id="categorySelect" required>
                                <option value="">Select a category...</option>
                                <% categories.forEach(cat => { %>
                                    <option value="<%= cat._id %>" <%= item && item.category && item.category._id.toString() === cat._id.toString() ? 'selected' : '' %>><%= cat.icon %> <%= cat.name %></option>
                                <% }); %>
                            </select>
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                <i class="fas fa-plus"></i> New
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Group</label>
                        <input type="text" class="form-control" name="group" value="<%= item ? item.group || '' : '' %>" placeholder="e.g., Breakfast, Snacks, Dinner" list="groupSuggestions">
                        <datalist id="groupSuggestions">
                            <option value="Breakfast">
                            <option value="Lunch">
                            <option value="Dinner">
                            <option value="Snacks">
                            <option value="Beverages">
                            <option value="Condiments">
                            <option value="Baking">
                            <option value="Household">
                        </datalist>
                        <small class="form-text text-muted">Optional: Organize items into groups</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Brand Type</label>
                        <select class="form-select" name="brandType">
                            <option value="name-brand" <%= item && item.brandType === 'name-brand' ? 'selected' : !item ? 'selected' : '' %>>Name Brand</option>
                            <option value="store-brand" <%= item && item.brandType === 'store-brand' ? 'selected' : '' %>>Store Brand</option>
                            <option value="generic" <%= item && item.brandType === 'generic' ? 'selected' : '' %>>Generic</option>
                            <option value="premium" <%= item && item.brandType === 'premium' ? 'selected' : '' %>>Premium</option>
                            <option value="organic" <%= item && item.brandType === 'organic' ? 'selected' : '' %>>Organic</option>
                        </select>
                        <small class="form-text text-muted">Used for brand comparison and analysis</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" name="sku" value="<%= item ? item.sku || '' : '' %>" placeholder="Product SKU">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Item Image</label>
                        <input type="file" class="form-control" id="imageFile" accept="image/*">
                        <small class="form-text text-muted">Or provide an image URL below</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Image URL</label>
                        <input type="url" class="form-control" name="image" id="imageUrl" value="<%= item ? item.image || '' : '' %>" placeholder="https://example.com/image.jpg">
                        <div id="imagePreview" class="mt-2" style="<%= item && item.image ? 'display: block;' : 'display: none;' %>">
                            <img id="previewImg" src="<%= item && item.image ? item.image : '' %>" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Size Value</label>
                            <input type="number" step="0.01" class="form-control" name="sizeValue" value="<%= item && item.size && item.size.value ? item.size.value : '' %>">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Size Unit</label>
                            <select class="form-select" name="sizeUnit">
                                <option value="">Select unit...</option>
                                <option value="oz" <%= item && item.size && item.size.unit === 'oz' ? 'selected' : '' %>>oz</option>
                                <option value="lb" <%= item && item.size && item.size.unit === 'lb' ? 'selected' : '' %>>lb</option>
                                <option value="g" <%= item && item.size && item.size.unit === 'g' ? 'selected' : '' %>>g</option>
                                <option value="kg" <%= item && item.size && item.size.unit === 'kg' ? 'selected' : '' %>>kg</option>
                                <option value="ml" <%= item && item.size && item.size.unit === 'ml' ? 'selected' : '' %>>ml</option>
                                <option value="l" <%= item && item.size && item.size.unit === 'l' ? 'selected' : '' %>>l</option>
                                <option value="gal" <%= item && item.size && item.size.unit === 'gal' ? 'selected' : '' %>>gal</option>
                                <option value="count" <%= item && item.size && item.size.unit === 'count' ? 'selected' : '' %>>count</option>
                                <option value="each" <%= item && item.size && item.size.unit === 'each' ? 'selected' : '' %>>each</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority">
                            <option value="low" <%= item && item.priority === 'low' ? 'selected' : '' %>>Low</option>
                            <option value="medium" <%= item && item.priority === 'medium' ? 'selected' : !item ? 'selected' : '' %>>Medium</option>
                            <option value="high" <%= item && item.priority === 'high' ? 'selected' : '' %>>High</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Purchase Frequency</label>
                        <select class="form-select" name="purchaseFrequency">
                            <option value="weekly" <%= item && item.purchaseFrequency === 'weekly' ? 'selected' : '' %>>Weekly</option>
                            <option value="biweekly" <%= item && item.purchaseFrequency === 'biweekly' ? 'selected' : '' %>>Bi-weekly</option>
                            <option value="monthly" <%= item && item.purchaseFrequency === 'monthly' ? 'selected' : '' %>>Monthly</option>
                            <option value="occasional" <%= item && item.purchaseFrequency === 'occasional' ? 'selected' : !item ? 'selected' : '' %>>Occasional</option>
                            <option value="rare" <%= item && item.purchaseFrequency === 'rare' ? 'selected' : '' %>>Rare</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Item
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="mb-3">
                            <label class="form-label">Category Name *</label>
                            <input type="text" class="form-control" id="newCategoryName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Icon/Emoji</label>
                            <input type="text" class="form-control" id="newCategoryIcon" placeholder="ðŸ›’" maxlength="2">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="newCategoryColor" value="#6c757d">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewCategory()">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Image preview
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('imageUrl').addEventListener('input', function(e) {
            const url = e.target.value;
            if (url) {
                document.getElementById('previewImg').src = url;
                document.getElementById('imagePreview').style.display = 'block';
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
        });

        // Save new category
        async function saveNewCategory() {
            const name = document.getElementById('newCategoryName').value;
            const icon = document.getElementById('newCategoryIcon').value || 'ðŸ›’';
            const color = document.getElementById('newCategoryColor').value;

            if (!name) {
                alert('Please enter a category name');
                return;
            }

            try {
                const res = await fetch('/grocery/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, icon, color })
                });

                if (res.ok) {
                    const data = await res.json();
                    const select = document.getElementById('categorySelect');
                    const option = new Option(`${icon} ${name}`, data.category._id, true, true);
                    select.add(option);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                    modal.hide();
                    
                    // Clear form
                    document.getElementById('categoryForm').reset();
                } else {
                    alert('Error creating category');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Submit item form
        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Handle image file upload
            const imageFile = document.getElementById('imageFile').files[0];
            if (imageFile) {
                // Convert to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    formData.set('imageData', e.target.result);
                    await submitForm(formData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                await submitForm(formData);
            }
        });

        async function submitForm(formData) {
            const data = Object.fromEntries(formData);

            try {
                <% if (item) { %>
                const res = await fetch('/grocery/items/<%= item._id %>', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                <% } else { %>
                const res = await fetch('/grocery/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                <% } %>

                if (res.ok) {
                    window.location.href = '/grocery/items';
                } else {
                    alert('Error saving item');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>
